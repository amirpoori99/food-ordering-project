<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RestaurantRepository.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.restaurant</a> &gt; <span class="el_source">RestaurantRepository.java</span></div><h1>RestaurantRepository.java</h1><pre class="source lang-java linenums">package com.myapp.restaurant;

import com.myapp.common.models.Restaurant;
import com.myapp.common.models.RestaurantStatus;
import com.myapp.common.utils.DatabaseUtil;
import org.hibernate.Session;
import org.hibernate.Transaction;
import org.hibernate.query.Query;

import java.util.List;
import java.util.Optional;

/**
 * Repository رستوران - لایه دسترسی به داده
 * این کلاس مسئول تمام عملیات دیتابیس مربوط به رستوران‌هاست
 * از الگوی Repository Pattern برای جداسازی منطق دیتابیس استفاده می‌کند
 */
<span class="fc" id="L18">public class RestaurantRepository {</span>

    /**
     * ذخیره رستوران جدید در دیتابیس
     * شناسه به صورت خودکار توسط Hibernate تولید می‌شود
     * 
     * @param toPersist رستوران برای ذخیره
     * @return رستوران ذخیره شده همراه با شناسه تولید شده
     */
    public Restaurant saveNew(Restaurant toPersist) {
<span class="fc" id="L28">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L29">            Transaction tx = session.beginTransaction();</span>
<span class="fc" id="L30">            session.persist(toPersist);   // شناسه به صورت خودکار تولید می‌شود</span>
<span class="fc" id="L31">            tx.commit();</span>
<span class="fc" id="L32">            return toPersist;</span>
        }
    }

    /**
     * یافتن رستوران با شناسه
     * 
     * @param id شناسه رستوران
     * @return Optional حاوی رستوران یا خالی در صورت عدم وجود
     */
    public Optional&lt;Restaurant&gt; findById(long id) {
<span class="fc" id="L43">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L44">            return Optional.ofNullable(session.get(Restaurant.class, id));</span>
        }
    }

    /**
     * دریافت همه رستوران‌های متعلق به یک مالک
     * 
     * @param ownerId شناسه مالک
     * @return لیست رستوران‌های مالک
     */
    public List&lt;Restaurant&gt; listByOwner(long ownerId) {
<span class="fc" id="L55">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L56">            Query&lt;Restaurant&gt; q = session.createQuery(</span>
                    &quot;from Restaurant where ownerId = :o&quot;, Restaurant.class);
<span class="fc" id="L58">            q.setParameter(&quot;o&quot;, ownerId);</span>
<span class="fc" id="L59">            return q.getResultList();</span>
        }
    }

    /**
     * دریافت همه رستوران‌های تأیید شده
     * این متد برای نمایش عمومی رستوران‌ها استفاده می‌شود
     * 
     * @return لیست رستوران‌های با وضعیت APPROVED
     */
    public List&lt;Restaurant&gt; listApproved() {
<span class="fc" id="L70">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L71">            Query&lt;Restaurant&gt; q = session.createQuery(</span>
                    &quot;from Restaurant where status = :s&quot;, Restaurant.class);
<span class="fc" id="L73">            q.setParameter(&quot;s&quot;, RestaurantStatus.APPROVED);</span>
<span class="fc" id="L74">            return q.getResultList();</span>
        }
    }

    /**
     * به‌روزرسانی وضعیت رستوران
     * 
     * @param id شناسه رستوران
     * @param status وضعیت جدید
     */
    public void updateStatus(long id, RestaurantStatus status) {
<span class="fc" id="L85">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L86">            Transaction tx = session.beginTransaction();</span>
<span class="fc" id="L87">            Restaurant r = session.get(Restaurant.class, id);</span>
<span class="fc bfc" id="L88" title="All 2 branches covered.">            if (r != null) r.setStatus(status);  // تنها در صورت وجود رستوران به‌روزرسانی می‌شود</span>
<span class="fc" id="L89">            tx.commit();</span>
        }
<span class="fc" id="L91">    }</span>

    /**
     * حذف همه رستوران‌ها (متد کمکی برای تست‌ها)
     * این متد فقط در محیط تست استفاده می‌شود
     */
    public void deleteAll() {
<span class="fc" id="L98">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L99">            Transaction tx = session.beginTransaction();</span>
<span class="fc" id="L100">            session.createQuery(&quot;delete from Restaurant&quot;).executeUpdate();</span>
<span class="fc" id="L101">            tx.commit();</span>
        }
<span class="fc" id="L103">    }</span>

    /**
     * ذخیره یا به‌روزرسانی رستوران
     * اگر شناسه null باشد، رستوران جدید ایجاد می‌شود
     * در غیر اینصورت رستوران موجود به‌روزرسانی می‌شود
     * 
     * @param restaurant رستوران برای ذخیره/به‌روزرسانی
     * @return رستوران ذخیره شده
     */
    public Restaurant save(Restaurant restaurant) {
<span class="fc bfc" id="L114" title="All 2 branches covered.">        if (restaurant.getId() == null) {</span>
<span class="fc" id="L115">            return saveNew(restaurant);  // ایجاد رستوران جدید</span>
        } else {
<span class="fc" id="L117">            try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L118">                Transaction tx = session.beginTransaction();</span>
<span class="fc" id="L119">                session.merge(restaurant);  // به‌روزرسانی رستوران موجود</span>
<span class="fc" id="L120">                tx.commit();</span>
<span class="fc" id="L121">                return restaurant;</span>
            }
        }
    }

    /**
     * دریافت همه رستوران‌ها
     * 
     * @return لیست همه رستوران‌ها
     */
    public List&lt;Restaurant&gt; findAll() {
<span class="fc" id="L132">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L133">            Query&lt;Restaurant&gt; q = session.createQuery(&quot;from Restaurant&quot;, Restaurant.class);</span>
<span class="fc" id="L134">            return q.getResultList();</span>
        }
    }

    /**
     * دریافت رستوران‌ها بر اساس وضعیت
     * 
     * @param status وضعیت مورد نظر
     * @return لیست رستوران‌ها با وضعیت مشخص
     */
    public List&lt;Restaurant&gt; findByStatus(RestaurantStatus status) {
<span class="fc" id="L145">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L146">            Query&lt;Restaurant&gt; q = session.createQuery(</span>
                    &quot;from Restaurant where status = :s&quot;, Restaurant.class);
<span class="fc" id="L148">            q.setParameter(&quot;s&quot;, status);</span>
<span class="fc" id="L149">            return q.getResultList();</span>
        }
    }

    /**
     * حذف رستوران با شناسه
     * 
     * @param id شناسه رستوران برای حذف
     */
    public void delete(Long id) {
<span class="fc" id="L159">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L160">            Transaction tx = session.beginTransaction();</span>
<span class="fc" id="L161">            Restaurant restaurant = session.get(Restaurant.class, id);</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">            if (restaurant != null) {</span>
<span class="fc" id="L163">                session.remove(restaurant);  // حذف تنها در صورت وجود رستوران</span>
            }
<span class="fc" id="L165">            tx.commit();</span>
        }
<span class="fc" id="L167">    }</span>
    
    /**
     * بررسی وجود رستوران با شناسه
     * 
     * @param id شناسه رستوران
     * @return true اگر رستوران وجود داشته باشد
     */
    public boolean existsById(Long id) {
<span class="fc" id="L176">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L177">            Restaurant restaurant = session.get(Restaurant.class, id);</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">            return restaurant != null;</span>
        }
    }
    
    /**
     * به‌روزرسانی رستوران موجود
     * 
     * @param restaurant رستوران برای به‌روزرسانی
     * @return رستوران به‌روزرسانی شده
     */
    public Restaurant update(Restaurant restaurant) {
<span class="nc" id="L189">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="nc" id="L190">            Transaction tx = session.beginTransaction();</span>
<span class="nc" id="L191">            Restaurant updated = (Restaurant) session.merge(restaurant);  // merge برای به‌روزرسانی</span>
<span class="nc" id="L192">            tx.commit();</span>
<span class="nc" id="L193">            return updated;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>