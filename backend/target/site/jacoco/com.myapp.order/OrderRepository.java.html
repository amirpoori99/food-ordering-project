<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OrderRepository.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.order</a> &gt; <span class="el_source">OrderRepository.java</span></div><h1>OrderRepository.java</h1><pre class="source lang-java linenums">package com.myapp.order;

import com.myapp.common.models.Order;
import com.myapp.common.models.OrderStatus;
import com.myapp.common.utils.DatabaseUtil;
import org.hibernate.Session;
import org.hibernate.Transaction;
import org.hibernate.query.Query;

import java.util.List;
import java.util.Optional;

/**
 * Repository سفارشات - لایه دسترسی به داده
 * این کلاس مسئول تمام عملیات دیتابیس مربوط به سفارشات است
 * از الگوی Repository Pattern برای جداسازی منطق دیتابیس استفاده می‌کند
 * شامل eager loading برای بارگذاری کامل اطلاعات سفارش و آیتم‌ها
 */
<span class="fc" id="L19">public class OrderRepository {</span>

    /**
     * ذخیره سفارش جدید در دیتابیس
     * شناسه به صورت خودکار توسط Hibernate تولید می‌شود
     * 
     * @param order سفارش برای ذخیره
     * @return سفارش ذخیره شده همراه با شناسه تولید شده
     */
    public Order saveNew(Order order) {
<span class="fc" id="L29">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L30">            Transaction tx = session.beginTransaction();</span>
<span class="fc" id="L31">            session.persist(order);   // شناسه به صورت خودکار تولید می‌شود</span>
<span class="fc" id="L32">            tx.commit();</span>
<span class="fc" id="L33">            return order;</span>
        }
    }

    /**
     * ذخیره یا به‌روزرسانی سفارش
     * اگر شناسه null باشد، سفارش جدید ایجاد می‌شود
     * در غیر اینصورت سفارش موجود به‌روزرسانی می‌شود
     * 
     * @param order سفارش برای ذخیره/به‌روزرسانی
     * @return سفارش ذخیره شده
     */
    public Order save(Order order) {
<span class="pc bpc" id="L46" title="1 of 2 branches missed.">        if (order.getId() == null) {</span>
<span class="nc" id="L47">            return saveNew(order);  // ایجاد سفارش جدید</span>
        } else {
<span class="fc" id="L49">            try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L50">                Transaction tx = session.beginTransaction();</span>
<span class="fc" id="L51">                session.merge(order);  // به‌روزرسانی سفارش موجود</span>
<span class="fc" id="L52">                tx.commit();</span>
<span class="fc" id="L53">                return order;</span>
            }
        }
    }

    /**
     * یافتن سفارش با شناسه همراه با بارگذاری کامل آیتم‌ها
     * از left join fetch برای بارگذاری eager استفاده می‌کند
     * 
     * @param id شناسه سفارش
     * @return Optional حاوی سفارش کامل یا خالی در صورت عدم وجود
     */
    public Optional&lt;Order&gt; findById(Long id) {
<span class="fc" id="L66">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L67">            Query&lt;Order&gt; q = session.createQuery(</span>
                    &quot;select o from Order o left join fetch o.orderItems oi left join fetch oi.foodItem where o.id = :id&quot;, Order.class);
<span class="fc" id="L69">            q.setParameter(&quot;id&quot;, id);</span>
<span class="fc" id="L70">            return q.uniqueResultOptional();</span>
        }
    }

    /**
     * دریافت همه سفارشات یک مشتری همراه با آیتم‌ها
     * مرتب شده بر اساس تاریخ سفارش (جدیدترین اول)
     * 
     * @param customerId شناسه مشتری
     * @return لیست سفارشات مشتری
     */
    public List&lt;Order&gt; findByCustomer(Long customerId) {
<span class="fc" id="L82">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L83">            Query&lt;Order&gt; q = session.createQuery(</span>
                    &quot;select distinct o from Order o left join fetch o.orderItems oi left join fetch oi.foodItem where o.customer.id = :customerId order by o.orderDate desc&quot;, Order.class);
<span class="fc" id="L85">            q.setParameter(&quot;customerId&quot;, customerId);</span>
<span class="fc" id="L86">            return q.getResultList();</span>
        }
    }

    /**
     * دریافت همه سفارشات یک رستوران همراه با آیتم‌ها
     * مرتب شده بر اساس تاریخ سفارش (جدیدترین اول)
     * 
     * @param restaurantId شناسه رستوران
     * @return لیست سفارشات رستوران
     */
    public List&lt;Order&gt; findByRestaurant(Long restaurantId) {
<span class="fc" id="L98">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L99">            Query&lt;Order&gt; q = session.createQuery(</span>
                    &quot;select distinct o from Order o left join fetch o.orderItems oi left join fetch oi.foodItem where o.restaurant.id = :restaurantId order by o.orderDate desc&quot;, Order.class);
<span class="fc" id="L101">            q.setParameter(&quot;restaurantId&quot;, restaurantId);</span>
<span class="fc" id="L102">            return q.getResultList();</span>
        }
    }

    /**
     * دریافت سفارشات بر اساس وضعیت
     * مرتب شده بر اساس تاریخ سفارش (جدیدترین اول)
     * 
     * @param status وضعیت مورد نظر
     * @return لیست سفارشات با وضعیت مشخص
     */
    public List&lt;Order&gt; findByStatus(OrderStatus status) {
<span class="fc" id="L114">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L115">            Query&lt;Order&gt; q = session.createQuery(</span>
                    &quot;from Order where status = :status order by orderDate desc&quot;, Order.class);
<span class="fc" id="L117">            q.setParameter(&quot;status&quot;, status);</span>
<span class="fc" id="L118">            return q.getResultList();</span>
        }
    }

    /**
     * دریافت سفارشات مشتری با وضعیت خاص
     * 
     * @param customerId شناسه مشتری
     * @param status وضعیت مورد نظر
     * @return لیست سفارشات مشتری با وضعیت مشخص
     */
    public List&lt;Order&gt; findByCustomerAndStatus(Long customerId, OrderStatus status) {
<span class="nc" id="L130">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="nc" id="L131">            Query&lt;Order&gt; q = session.createQuery(</span>
                    &quot;from Order where customer.id = :customerId and status = :status order by orderDate desc&quot;, 
                    Order.class);
<span class="nc" id="L134">            q.setParameter(&quot;customerId&quot;, customerId);</span>
<span class="nc" id="L135">            q.setParameter(&quot;status&quot;, status);</span>
<span class="nc" id="L136">            return q.getResultList();</span>
        }
    }

    /**
     * دریافت سفارشات رستوران با وضعیت خاص
     * 
     * @param restaurantId شناسه رستوران
     * @param status وضعیت مورد نظر
     * @return لیست سفارشات رستوران با وضعیت مشخص
     */
    public List&lt;Order&gt; findByRestaurantAndStatus(Long restaurantId, OrderStatus status) {
<span class="nc" id="L148">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="nc" id="L149">            Query&lt;Order&gt; q = session.createQuery(</span>
                    &quot;from Order where restaurant.id = :restaurantId and status = :status order by orderDate desc&quot;, 
                    Order.class);
<span class="nc" id="L152">            q.setParameter(&quot;restaurantId&quot;, restaurantId);</span>
<span class="nc" id="L153">            q.setParameter(&quot;status&quot;, status);</span>
<span class="nc" id="L154">            return q.getResultList();</span>
        }
    }

    /**
     * دریافت سفارشات در انتظار تأیید
     * مرتب شده بر اساس تاریخ سفارش (قدیمی‌ترین اول برای پردازش)
     * 
     * @return لیست سفارشات PENDING
     */
    public List&lt;Order&gt; findPendingOrders() {
<span class="fc" id="L165">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L166">            Query&lt;Order&gt; q = session.createQuery(</span>
                    &quot;from Order where status = :pending order by orderDate asc&quot;, Order.class);
<span class="fc" id="L168">            q.setParameter(&quot;pending&quot;, OrderStatus.PENDING);</span>
<span class="fc" id="L169">            return q.getResultList();</span>
        }
    }

    /**
     * دریافت سفارشات فعال (غیر از تحویل شده و لغو شده)
     * مرتب شده بر اساس تاریخ سفارش (جدیدترین اول)
     * 
     * @return لیست سفارشات فعال
     */
    public List&lt;Order&gt; findActiveOrders() {
<span class="fc" id="L180">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L181">            Query&lt;Order&gt; q = session.createQuery(</span>
                    &quot;from Order where status in (:statuses) order by orderDate desc&quot;, Order.class);
<span class="fc" id="L183">            q.setParameterList(&quot;statuses&quot;, List.of(</span>
                OrderStatus.PENDING,         // در انتظار
                OrderStatus.CONFIRMED,       // تأیید شده
                OrderStatus.PREPARING,       // در حال آماده‌سازی
                OrderStatus.READY,           // آماده
                OrderStatus.OUT_FOR_DELIVERY // در حال تحویل
            ));
<span class="fc" id="L190">            return q.getResultList();</span>
        }
    }

    /**
     * دریافت همه سفارشات
     * مرتب شده بر اساس تاریخ سفارش (جدیدترین اول)
     * 
     * @return لیست همه سفارشات
     */
    public List&lt;Order&gt; findAll() {
<span class="nc" id="L201">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="nc" id="L202">            Query&lt;Order&gt; q = session.createQuery(&quot;from Order order by orderDate desc&quot;, Order.class);</span>
<span class="nc" id="L203">            return q.getResultList();</span>
        }
    }

    /**
     * به‌روزرسانی وضعیت سفارش
     * 
     * @param id شناسه سفارش
     * @param status وضعیت جدید
     */
    public void updateStatus(Long id, OrderStatus status) {
<span class="fc" id="L214">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L215">            Transaction tx = session.beginTransaction();</span>
<span class="fc" id="L216">            Order order = session.get(Order.class, id);</span>
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">            if (order != null) {</span>
<span class="fc" id="L218">                order.setStatus(status);  // تنها در صورت وجود سفارش به‌روزرسانی می‌شود</span>
            }
<span class="fc" id="L220">            tx.commit();</span>
        }
<span class="fc" id="L222">    }</span>

    /**
     * حذف سفارش با شناسه
     * 
     * @param id شناسه سفارش برای حذف
     */
    public void delete(Long id) {
<span class="nc" id="L230">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="nc" id="L231">            Transaction tx = session.beginTransaction();</span>
<span class="nc" id="L232">            Order order = session.get(Order.class, id);</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">            if (order != null) {</span>
<span class="nc" id="L234">                session.remove(order);  // حذف تنها در صورت وجود سفارش</span>
            }
<span class="nc" id="L236">            tx.commit();</span>
        }
<span class="nc" id="L238">    }</span>

    /**
     * بررسی وجود سفارش با شناسه
     * 
     * @param id شناسه سفارش
     * @return true اگر سفارش وجود داشته باشد
     */
    public boolean existsById(Long id) {
<span class="nc bnc" id="L247" title="All 4 branches missed.">        if (id == null || id &lt;= 0) {</span>
<span class="nc" id="L248">            return false;</span>
        }
<span class="nc" id="L250">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="nc" id="L251">            Query&lt;Long&gt; query = session.createQuery(&quot;SELECT COUNT(o) FROM Order o WHERE o.id = :id&quot;, Long.class);</span>
<span class="nc" id="L252">            query.setParameter(&quot;id&quot;, id);</span>
<span class="nc" id="L253">            Long count = query.uniqueResult();</span>
<span class="nc bnc" id="L254" title="All 4 branches missed.">            return count != null &amp;&amp; count &gt; 0;</span>
        }
    }

    /**
     * به‌روزرسانی سفارش موجود
     * 
     * @param order سفارش برای به‌روزرسانی
     * @return سفارش به‌روزرسانی شده
     */
    public Order update(Order order) {
<span class="nc" id="L265">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="nc" id="L266">            Transaction tx = session.beginTransaction();</span>
<span class="nc" id="L267">            Order updated = (Order) session.merge(order);  // merge برای به‌روزرسانی</span>
<span class="nc" id="L268">            tx.commit();</span>
<span class="nc" id="L269">            return updated;</span>
        }
    }

    /**
     * حذف همه سفارشات (متد کمکی برای تست‌ها)
     * این متد فقط در محیط تست استفاده می‌شود
     */
    public void deleteAll() {
<span class="nc" id="L278">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="nc" id="L279">            Transaction tx = session.beginTransaction();</span>
<span class="nc" id="L280">            session.createQuery(&quot;delete from Order&quot;).executeUpdate();</span>
<span class="nc" id="L281">            tx.commit();</span>
        }
<span class="nc" id="L283">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>