<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OrderController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.order</a> &gt; <span class="el_source">OrderController.java</span></div><h1>OrderController.java</h1><pre class="source lang-java linenums">package com.myapp.order;

import com.myapp.common.exceptions.NotFoundException;
import com.myapp.common.models.Order;
import com.myapp.common.models.OrderStatus;
import com.myapp.item.ItemRepository;
import com.myapp.restaurant.RestaurantRepository;
import com.sun.net.httpserver.HttpExchange;
import com.sun.net.httpserver.HttpHandler;

import java.io.IOException;
import java.io.OutputStream;
import java.net.URI;
import java.util.List;
import java.util.Map;
import java.util.HashMap;

/**
 * کنترلر REST API مدیریت سفارشات و سبد خرید
 * 
 * این کلاس تمام عملیات HTTP مربوط به مدیریت سفارشات را پیاده‌سازی می‌کند:
 * 
 * === عملیات سبد خرید ===
 * POST   /api/orders                           - ایجاد سفارش جدید (سبد خرید)
 * POST   /api/orders/{orderId}/items           - افزودن آیتم به سبد
 * PUT    /api/orders/{orderId}/items/{itemId}  - به‌روزرسانی مقدار آیتم در سبد
 * DELETE /api/orders/{orderId}/items/{itemId}  - حذف آیتم از سبد
 * 
 * === مدیریت سفارش ===
 * GET    /api/orders/{orderId}                 - دریافت جزئیات سفارش
 * POST   /api/orders/{orderId}/place           - ثبت نهایی سفارش (پرداخت)
 * PUT    /api/orders/{orderId}/cancel          - لغو سفارش
 * PUT    /api/orders/{orderId}/status          - به‌روزرسانی وضعیت سفارش
 * 
 * === جستجو و فیلتر ===
 * GET    /api/orders/customer/{customerId}     - سفارشات مشتری
 * GET    /api/orders/restaurant/{restaurantId} - سفارشات رستوران
 * GET    /api/orders/status/{status}           - سفارشات بر اساس وضعیت
 * GET    /api/orders/active                    - سفارشات فعال
 * GET    /api/orders/pending                   - سفارشات در انتظار
 * 
 * === گزارش و آمار ===
 * GET    /api/orders/customer/{customerId}/statistics - آمار سفارشات مشتری
 * 
 * ویژگی‌های کلیدی:
 * - RESTful Design: طراحی REST استاندارد
 * - Shopping Cart: مدیریت کامل سبد خرید
 * - Order Lifecycle: مدیریت چرخه حیات سفارش
 * - Status Management: مدیریت وضعیت‌های مختلف
 * - Error Handling: مدیریت جامع خطاها
 * - JSON Processing: پردازش کامل JSON
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 */
public class OrderController implements HttpHandler {
    
    /** سرویس اصلی مدیریت سفارشات */
    private final OrderService orderService;
    
    /**
     * سازنده پیش‌فرض کنترلر
     * 
     * تمام dependency ها را به صورت خودکار ایجاد می‌کند
     * برای استفاده در محیط production
     */
<span class="nc" id="L68">    public OrderController() {</span>
<span class="nc" id="L69">        this.orderService = new OrderService(</span>
            new OrderRepository(), 
            new ItemRepository(), 
            new RestaurantRepository()
        );
<span class="nc" id="L74">    }</span>
    
    /**
     * سازنده برای تزریق وابستگی
     * 
     * برای تست‌ها و dependency injection استفاده می‌شود
     * 
     * @param orderService سرویس سفارشات از خارج تزریق شده
     */
<span class="fc" id="L83">    public OrderController(OrderService orderService) {</span>
<span class="fc" id="L84">        this.orderService = orderService;</span>
<span class="fc" id="L85">    }</span>
    
    /**
     * متد اصلی مدیریت درخواست‌های HTTP
     * 
     * تمام درخواست‌های HTTP را دریافت و بر اساس method و path آن‌ها
     * را به متدهای مناسب هدایت می‌کند.
     * 
     * شامل مدیریت جامع خطاها:
     * - 400 Bad Request: برای پارامترهای نامعتبر
     * - 404 Not Found: برای منابع یافت نشده
     * - 405 Method Not Allowed: برای HTTP method های غیرمجاز
     * - 500 Internal Server Error: برای خطاهای سرور
     * 
     * @param exchange شیء HttpExchange شامل request و response
     * @throws IOException در صورت خطا در ارتباط HTTP
     */
    @Override
    public void handle(HttpExchange exchange) throws IOException {
<span class="nc" id="L104">        String method = exchange.getRequestMethod();</span>
<span class="nc" id="L105">        String path = exchange.getRequestURI().getPath();</span>
        
        try {
            // مسیریابی بر اساس HTTP method
<span class="nc bnc" id="L109" title="All 5 branches missed.">            switch (method) {</span>
                case &quot;GET&quot;:
<span class="nc" id="L111">                    handleGet(exchange, path);</span>
<span class="nc" id="L112">                    break;</span>
                case &quot;POST&quot;:
<span class="nc" id="L114">                    handlePost(exchange, path);</span>
<span class="nc" id="L115">                    break;</span>
                case &quot;PUT&quot;:
<span class="nc" id="L117">                    handlePut(exchange, path);</span>
<span class="nc" id="L118">                    break;</span>
                case &quot;DELETE&quot;:
<span class="nc" id="L120">                    handleDelete(exchange, path);</span>
<span class="nc" id="L121">                    break;</span>
                default:
<span class="nc" id="L123">                    sendErrorResponse(exchange, 405, &quot;Method not allowed&quot;);</span>
            }
<span class="nc" id="L125">        } catch (IllegalArgumentException e) {</span>
            // خطای پارامتر نامعتبر - 400 Bad Request
<span class="nc" id="L127">            sendErrorResponse(exchange, 400, e.getMessage());</span>
<span class="nc" id="L128">        } catch (NotFoundException e) {</span>
            // خطای یافت نشدن منبع - 404 Not Found
<span class="nc" id="L130">            sendErrorResponse(exchange, 404, e.getMessage());</span>
<span class="nc" id="L131">        } catch (Exception e) {</span>
            // خطای سرور - 500 Internal Server Error
<span class="nc" id="L133">            sendErrorResponse(exchange, 500, &quot;Internal server error: &quot; + e.getMessage());</span>
<span class="nc" id="L134">        }</span>
<span class="nc" id="L135">    }</span>
    
    // ==================== GET ENDPOINTS ====================
    
    /**
     * مدیریت تمام درخواست‌های GET
     * 
     * بر اساس pattern های مختلف URL، درخواست‌ها را به متدهای مناسب هدایت می‌کند.
     * از regex pattern matching برای شناسایی مسیرها استفاده می‌کند.
     * 
     * @param exchange HttpExchange شامل request و response
     * @param path مسیر URL درخواست
     * @throws IOException در صورت خطا در ارسال پاسخ
     */
    private void handleGet(HttpExchange exchange, String path) throws IOException {
<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (path.matches(&quot;/api/orders/\\d+&quot;)) {</span>
            // GET /api/orders/{orderId} - Get order details
<span class="nc" id="L152">            Long orderId = extractOrderIdFromPath(path);</span>
<span class="nc" id="L153">            getOrderDetails(exchange, orderId);</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">        } else if (path.matches(&quot;/api/orders/customer/\\d+&quot;)) {</span>
            // GET /api/orders/customer/{customerId} - Get customer orders
<span class="nc" id="L156">            Long customerId = extractIdFromPath(path, &quot;/api/orders/customer/&quot;);</span>
<span class="nc" id="L157">            getCustomerOrders(exchange, customerId);</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">        } else if (path.matches(&quot;/api/orders/restaurant/\\d+&quot;)) {</span>
            // GET /api/orders/restaurant/{restaurantId} - Get restaurant orders
<span class="nc" id="L160">            Long restaurantId = extractIdFromPath(path, &quot;/api/orders/restaurant/&quot;);</span>
<span class="nc" id="L161">            getRestaurantOrders(exchange, restaurantId);</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">        } else if (path.matches(&quot;/api/orders/status/\\w+&quot;)) {</span>
            // GET /api/orders/status/{status} - Get orders by status
<span class="nc" id="L164">            String statusStr = extractStatusFromPath(path);</span>
<span class="nc" id="L165">            getOrdersByStatus(exchange, statusStr);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">        } else if (path.equals(&quot;/api/orders/active&quot;)) {</span>
            // GET /api/orders/active - Get active orders
<span class="nc" id="L168">            getActiveOrders(exchange);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">        } else if (path.equals(&quot;/api/orders/pending&quot;)) {</span>
            // GET /api/orders/pending - Get pending orders
<span class="nc" id="L171">            getPendingOrders(exchange);</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">        } else if (path.matches(&quot;/api/orders/customer/\\d+/statistics&quot;)) {</span>
            // GET /api/orders/customer/{customerId}/statistics - Get customer statistics
<span class="nc" id="L174">            Long customerId = extractIdFromPath(path, &quot;/api/orders/customer/&quot;, &quot;/statistics&quot;);</span>
<span class="nc" id="L175">            getCustomerStatistics(exchange, customerId);</span>
<span class="nc" id="L176">        } else {</span>
<span class="nc" id="L177">            sendErrorResponse(exchange, 404, &quot;Endpoint not found&quot;);</span>
        }
<span class="nc" id="L179">    }</span>
    
    /**
     * دریافت جزئیات کامل یک سفارش
     * 
     * @param exchange HttpExchange object
     * @param orderId شناسه سفارش
     * @throws IOException در صورت خطا در ارسال پاسخ
     */
    private void getOrderDetails(HttpExchange exchange, Long orderId) throws IOException {
<span class="nc" id="L189">        Order order = orderService.getOrder(orderId);</span>
<span class="nc" id="L190">        sendJsonResponse(exchange, 200, order);</span>
<span class="nc" id="L191">    }</span>
    
    /**
     * دریافت تمام سفارشات یک مشتری
     * 
     * @param exchange HttpExchange object
     * @param customerId شناسه مشتری
     * @throws IOException در صورت خطا در ارسال پاسخ
     */
    private void getCustomerOrders(HttpExchange exchange, Long customerId) throws IOException {
<span class="nc" id="L201">        List&lt;Order&gt; orders = orderService.getCustomerOrders(customerId);</span>
<span class="nc" id="L202">        sendJsonResponse(exchange, 200, orders);</span>
<span class="nc" id="L203">    }</span>
    
    /**
     * دریافت تمام سفارشات یک رستوران
     * 
     * @param exchange HttpExchange object
     * @param restaurantId شناسه رستوران
     * @throws IOException در صورت خطا در ارسال پاسخ
     */
    private void getRestaurantOrders(HttpExchange exchange, Long restaurantId) throws IOException {
<span class="nc" id="L213">        List&lt;Order&gt; orders = orderService.getRestaurantOrders(restaurantId);</span>
<span class="nc" id="L214">        sendJsonResponse(exchange, 200, orders);</span>
<span class="nc" id="L215">    }</span>
    
    private void getOrdersByStatus(HttpExchange exchange, String statusStr) throws IOException {
        try {
<span class="nc" id="L219">            OrderStatus status = OrderStatus.valueOf(statusStr.toUpperCase());</span>
<span class="nc" id="L220">            List&lt;Order&gt; orders = orderService.getOrdersByStatus(status);</span>
<span class="nc" id="L221">            sendJsonResponse(exchange, 200, orders);</span>
<span class="nc" id="L222">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L223">            sendErrorResponse(exchange, 400, &quot;Invalid status: &quot; + statusStr);</span>
<span class="nc" id="L224">        }</span>
<span class="nc" id="L225">    }</span>
    
    private void getActiveOrders(HttpExchange exchange) throws IOException {
<span class="nc" id="L228">        List&lt;Order&gt; orders = orderService.getActiveOrders();</span>
<span class="nc" id="L229">        sendJsonResponse(exchange, 200, orders);</span>
<span class="nc" id="L230">    }</span>
    
    private void getPendingOrders(HttpExchange exchange) throws IOException {
<span class="nc" id="L233">        List&lt;Order&gt; orders = orderService.getPendingOrders();</span>
<span class="nc" id="L234">        sendJsonResponse(exchange, 200, orders);</span>
<span class="nc" id="L235">    }</span>
    
    private void getCustomerStatistics(HttpExchange exchange, Long customerId) throws IOException {
<span class="nc" id="L238">        OrderService.OrderStatistics stats = orderService.getCustomerOrderStatistics(customerId);</span>
<span class="nc" id="L239">        sendJsonResponse(exchange, 200, stats);</span>
<span class="nc" id="L240">    }</span>
    
    // ==================== POST ENDPOINTS ====================
    
    /**
     * مدیریت تمام درخواست‌های POST
     * 
     * شامل عملیات ایجاد و افزودن:
     * - ایجاد سفارش جدید (سبد خرید)
     * - افزودن آیتم به سبد خرید
     * - ثبت نهایی سفارش (checkout)
     * 
     * @param exchange HttpExchange object
     * @param path مسیر URL درخواست
     * @throws IOException در صورت خطا در پردازش
     */
    private void handlePost(HttpExchange exchange, String path) throws IOException {
<span class="nc bnc" id="L257" title="All 2 branches missed.">        if (path.equals(&quot;/api/orders&quot;)) {</span>
            // POST /api/orders - Create new order (shopping cart)
<span class="nc" id="L259">            createOrder(exchange);</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">        } else if (path.matches(&quot;/api/orders/\\d+/items&quot;)) {</span>
            // POST /api/orders/{orderId}/items - Add item to cart
<span class="nc" id="L262">            Long orderId = extractOrderIdFromPath(path, &quot;/items&quot;);</span>
<span class="nc" id="L263">            addItemToCart(exchange, orderId);</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">        } else if (path.matches(&quot;/api/orders/\\d+/place&quot;)) {</span>
            // POST /api/orders/{orderId}/place - Place order (checkout)
<span class="nc" id="L266">            Long orderId = extractOrderIdFromPath(path, &quot;/place&quot;);</span>
<span class="nc" id="L267">            placeOrder(exchange, orderId);</span>
<span class="nc" id="L268">        } else {</span>
<span class="nc" id="L269">            sendErrorResponse(exchange, 404, &quot;Endpoint not found&quot;);</span>
        }
<span class="nc" id="L271">    }</span>
    
    /**
     * ایجاد سفارش جدید (سبد خرید خالی)
     * 
     * JSON Request Body:
     * {
     *   &quot;customerId&quot;: number,
     *   &quot;restaurantId&quot;: number,
     *   &quot;deliveryAddress&quot;: string,
     *   &quot;phone&quot;: string
     * }
     * 
     * @param exchange HttpExchange object
     * @throws IOException در صورت خطا در پردازش
     */
    private void createOrder(HttpExchange exchange) throws IOException {
<span class="nc" id="L288">        Map&lt;String, Object&gt; requestData = parseJsonRequest(exchange);</span>
        
        // استخراج اطلاعات مورد نیاز از JSON
<span class="nc" id="L291">        Long customerId = getLongFromMap(requestData, &quot;customerId&quot;);</span>
<span class="nc" id="L292">        Long restaurantId = getLongFromMap(requestData, &quot;restaurantId&quot;);</span>
<span class="nc" id="L293">        String deliveryAddress = getStringFromMap(requestData, &quot;deliveryAddress&quot;);</span>
<span class="nc" id="L294">        String phone = getStringFromMap(requestData, &quot;phone&quot;);</span>
        
        // ایجاد سفارش جدید و ارسال پاسخ
<span class="nc" id="L297">        Order order = orderService.createOrder(customerId, restaurantId, deliveryAddress, phone);</span>
<span class="nc" id="L298">        sendJsonResponse(exchange, 201, order);</span>
<span class="nc" id="L299">    }</span>
    
    private void addItemToCart(HttpExchange exchange, Long orderId) throws IOException {
<span class="nc" id="L302">        Map&lt;String, Object&gt; requestData = parseJsonRequest(exchange);</span>
        
<span class="nc" id="L304">        Long itemId = getLongFromMap(requestData, &quot;itemId&quot;);</span>
<span class="nc" id="L305">        Integer quantity = getIntegerFromMap(requestData, &quot;quantity&quot;);</span>
        
<span class="nc bnc" id="L307" title="All 2 branches missed.">        if (quantity == null) {</span>
<span class="nc" id="L308">            sendErrorResponse(exchange, 400, &quot;Quantity is required&quot;);</span>
<span class="nc" id="L309">            return;</span>
        }
        
<span class="nc" id="L312">        Order order = orderService.addItemToCart(orderId, itemId, quantity);</span>
<span class="nc" id="L313">        sendJsonResponse(exchange, 200, order);</span>
<span class="nc" id="L314">    }</span>
    
    private void placeOrder(HttpExchange exchange, Long orderId) throws IOException {
<span class="nc" id="L317">        Order order = orderService.placeOrder(orderId);</span>
<span class="nc" id="L318">        sendJsonResponse(exchange, 200, order);</span>
<span class="nc" id="L319">    }</span>
    
    // ==================== PUT ENDPOINTS ====================
    
    private void handlePut(HttpExchange exchange, String path) throws IOException {
<span class="nc bnc" id="L324" title="All 2 branches missed.">        if (path.matches(&quot;/api/orders/\\d+/items/\\d+&quot;)) {</span>
            // PUT /api/orders/{orderId}/items/{itemId} - Update item quantity in cart
<span class="nc" id="L326">            Long orderId = extractOrderIdFromPath(path, &quot;/items/\\d+&quot;);</span>
<span class="nc" id="L327">            Long itemId = extractItemIdFromPath(path);</span>
<span class="nc" id="L328">            updateItemQuantity(exchange, orderId, itemId);</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">        } else if (path.matches(&quot;/api/orders/\\d+/cancel&quot;)) {</span>
            // PUT /api/orders/{orderId}/cancel - Cancel order
<span class="nc" id="L331">            Long orderId = extractOrderIdFromPath(path, &quot;/cancel&quot;);</span>
<span class="nc" id="L332">            cancelOrder(exchange, orderId);</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">        } else if (path.matches(&quot;/api/orders/\\d+/status&quot;)) {</span>
            // PUT /api/orders/{orderId}/status - Update order status
<span class="nc" id="L335">            Long orderId = extractOrderIdFromPath(path, &quot;/status&quot;);</span>
<span class="nc" id="L336">            updateOrderStatus(exchange, orderId);</span>
<span class="nc" id="L337">        } else {</span>
<span class="nc" id="L338">            sendErrorResponse(exchange, 404, &quot;Endpoint not found&quot;);</span>
        }
<span class="nc" id="L340">    }</span>
    
    private void updateItemQuantity(HttpExchange exchange, Long orderId, Long itemId) throws IOException {
<span class="nc" id="L343">        Map&lt;String, Object&gt; requestData = parseJsonRequest(exchange);</span>
<span class="nc" id="L344">        Integer quantity = getIntegerFromMap(requestData, &quot;quantity&quot;);</span>
        
<span class="nc bnc" id="L346" title="All 2 branches missed.">        if (quantity == null) {</span>
<span class="nc" id="L347">            sendErrorResponse(exchange, 400, &quot;Quantity is required&quot;);</span>
<span class="nc" id="L348">            return;</span>
        }
        
<span class="nc" id="L351">        Order order = orderService.updateItemQuantity(orderId, itemId, quantity);</span>
<span class="nc" id="L352">        sendJsonResponse(exchange, 200, order);</span>
<span class="nc" id="L353">    }</span>
    
    private void cancelOrder(HttpExchange exchange, Long orderId) throws IOException {
<span class="nc" id="L356">        Map&lt;String, Object&gt; requestData = parseJsonRequest(exchange);</span>
<span class="nc" id="L357">        String reason = getStringFromMap(requestData, &quot;reason&quot;);</span>
        
<span class="nc" id="L359">        Order order = orderService.cancelOrder(orderId, reason);</span>
<span class="nc" id="L360">        sendJsonResponse(exchange, 200, order);</span>
<span class="nc" id="L361">    }</span>
    
    private void updateOrderStatus(HttpExchange exchange, Long orderId) throws IOException {
<span class="nc" id="L364">        Map&lt;String, Object&gt; requestData = parseJsonRequest(exchange);</span>
<span class="nc" id="L365">        String statusStr = getStringFromMap(requestData, &quot;status&quot;);</span>
        
        try {
<span class="nc" id="L368">            OrderStatus status = OrderStatus.valueOf(statusStr.toUpperCase());</span>
<span class="nc" id="L369">            Order order = orderService.updateOrderStatus(orderId, status);</span>
<span class="nc" id="L370">            sendJsonResponse(exchange, 200, order);</span>
<span class="nc" id="L371">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L372">            sendErrorResponse(exchange, 400, &quot;Invalid status: &quot; + statusStr);</span>
<span class="nc" id="L373">        }</span>
<span class="nc" id="L374">    }</span>
    
    // ==================== DELETE ENDPOINTS ====================
    
    private void handleDelete(HttpExchange exchange, String path) throws IOException {
<span class="nc bnc" id="L379" title="All 2 branches missed.">        if (path.matches(&quot;/api/orders/\\d+/items/\\d+&quot;)) {</span>
            // DELETE /api/orders/{orderId}/items/{itemId} - Remove item from cart
<span class="nc" id="L381">            Long orderId = extractOrderIdFromPath(path, &quot;/items/\\d+&quot;);</span>
<span class="nc" id="L382">            Long itemId = extractItemIdFromPath(path);</span>
<span class="nc" id="L383">            removeItemFromCart(exchange, orderId, itemId);</span>
<span class="nc" id="L384">        } else {</span>
<span class="nc" id="L385">            sendErrorResponse(exchange, 404, &quot;Endpoint not found&quot;);</span>
        }
<span class="nc" id="L387">    }</span>
    
    private void removeItemFromCart(HttpExchange exchange, Long orderId, Long itemId) throws IOException {
<span class="nc" id="L390">        Order order = orderService.removeItemFromCart(orderId, itemId);</span>
<span class="nc" id="L391">        sendJsonResponse(exchange, 200, order);</span>
<span class="nc" id="L392">    }</span>
    
    // ==================== UTILITY METHODS ====================
    
    /**
     * استخراج شناسه سفارش از مسیر URL
     * 
     * برای مسیرهای با فرمت /api/orders/{orderId}
     * 
     * @param path مسیر URL کامل
     * @return شناسه سفارش
     */
    private Long extractOrderIdFromPath(String path) {
        // استخراج از /api/orders/{orderId}
<span class="nc" id="L406">        String[] parts = path.split(&quot;/&quot;);</span>
<span class="nc" id="L407">        return Long.parseLong(parts[3]); // /api/orders/{orderId}</span>
    }
    
    private Long extractOrderIdFromPath(String path, String suffix) {
        // Extract from /api/orders/{orderId}/suffix
<span class="nc" id="L412">        String pathWithoutSuffix = path.substring(0, path.lastIndexOf(suffix));</span>
<span class="nc" id="L413">        String[] parts = pathWithoutSuffix.split(&quot;/&quot;);</span>
<span class="nc" id="L414">        return Long.parseLong(parts[3]);</span>
    }
    
    private Long extractItemIdFromPath(String path) {
        // Extract from /api/orders/{orderId}/items/{itemId}
<span class="nc" id="L419">        String[] parts = path.split(&quot;/&quot;);</span>
<span class="nc" id="L420">        return Long.parseLong(parts[5]); // /api/orders/{orderId}/items/{itemId}</span>
    }
    
    private Long extractIdFromPath(String path, String prefix) {
<span class="nc" id="L424">        String idStr = path.substring(prefix.length());</span>
<span class="nc" id="L425">        return Long.parseLong(idStr);</span>
    }
    
    private Long extractIdFromPath(String path, String prefix, String suffix) {
<span class="nc" id="L429">        String withoutPrefix = path.substring(prefix.length());</span>
<span class="nc" id="L430">        String idStr = withoutPrefix.substring(0, withoutPrefix.indexOf(suffix));</span>
<span class="nc" id="L431">        return Long.parseLong(idStr);</span>
    }
    
    private String extractStatusFromPath(String path) {
<span class="nc" id="L435">        String[] parts = path.split(&quot;/&quot;);</span>
<span class="nc" id="L436">        return parts[parts.length - 1];</span>
    }
    
    /**
     * پارس کردن درخواست JSON از HTTP request body
     * 
     * این متد ساده JSON parsing انجام می‌دهد. در محیط production
     * بهتر است از کتابخانه‌هایی مثل Jackson یا Gson استفاده کرد.
     * 
     * ویژگی‌ها:
     * - پشتیبانی از String، Number، Boolean
     * - تشخیص خودکار نوع داده
     * - مدیریت فیلدهای خالی
     * 
     * @param exchange HttpExchange حاوی request body
     * @return Map شامل key-value های JSON
     * @throws IOException در صورت خطا در خواندن request body
     */
    private Map&lt;String, Object&gt; parseJsonRequest(HttpExchange exchange) throws IOException {
        // JSON parsing ساده - در production از Jackson یا Gson استفاده کنید
<span class="nc" id="L456">        String requestBody = new String(exchange.getRequestBody().readAllBytes());</span>
<span class="nc" id="L457">        Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();</span>
        
        // پارسینگ JSON ساده (پیاده‌سازی ساده شده)
<span class="nc bnc" id="L460" title="All 2 branches missed.">        if (requestBody.trim().isEmpty()) {</span>
<span class="nc" id="L461">            return result;</span>
        }
        
        // حذف آکولاد و تقسیم بر اساس کاما
<span class="nc" id="L465">        String content = requestBody.trim().replaceAll(&quot;[{}]&quot;, &quot;&quot;);</span>
<span class="nc" id="L466">        String[] pairs = content.split(&quot;,&quot;);</span>
        
<span class="nc bnc" id="L468" title="All 2 branches missed.">        for (String pair : pairs) {</span>
<span class="nc" id="L469">            String[] keyValue = pair.split(&quot;:&quot;);</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">            if (keyValue.length == 2) {</span>
<span class="nc" id="L471">                String key = keyValue[0].trim().replaceAll(&quot;\&quot;&quot;, &quot;&quot;);</span>
<span class="nc" id="L472">                String value = keyValue[1].trim().replaceAll(&quot;\&quot;&quot;, &quot;&quot;);</span>
                
                // تلاش برای پارس کردن به عنوان عدد یا boolean
                try {
<span class="nc bnc" id="L476" title="All 4 branches missed.">                    if (value.equals(&quot;true&quot;) || value.equals(&quot;false&quot;)) {</span>
<span class="nc" id="L477">                        result.put(key, Boolean.parseBoolean(value));</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">                    } else if (value.contains(&quot;.&quot;)) {</span>
<span class="nc" id="L479">                        result.put(key, Double.parseDouble(value));</span>
                    } else {
<span class="nc" id="L481">                        result.put(key, Long.parseLong(value));</span>
                    }
<span class="nc" id="L483">                } catch (NumberFormatException e) {</span>
<span class="nc" id="L484">                    result.put(key, value);</span>
<span class="nc" id="L485">                }</span>
            }
        }
        
<span class="nc" id="L489">        return result;</span>
    }
    
    private String getStringFromMap(Map&lt;String, Object&gt; map, String key) {
<span class="nc" id="L493">        Object value = map.get(key);</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">        return value != null ? value.toString() : null;</span>
    }
    
    private Long getLongFromMap(Map&lt;String, Object&gt; map, String key) {
<span class="nc" id="L498">        Object value = map.get(key);</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">        if (value == null) return null;</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">        if (value instanceof Long) return (Long) value;</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">        if (value instanceof Number) return ((Number) value).longValue();</span>
        try {
<span class="nc" id="L503">            return Long.parseLong(value.toString());</span>
<span class="nc" id="L504">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L505">            throw new IllegalArgumentException(&quot;Invalid number format for &quot; + key + &quot;: &quot; + value);</span>
        }
    }
    
    private Integer getIntegerFromMap(Map&lt;String, Object&gt; map, String key) {
<span class="nc" id="L510">        Object value = map.get(key);</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">        if (value == null) return null;</span>
<span class="nc bnc" id="L512" title="All 2 branches missed.">        if (value instanceof Integer) return (Integer) value;</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">        if (value instanceof Number) return ((Number) value).intValue();</span>
        try {
<span class="nc" id="L515">            return Integer.parseInt(value.toString());</span>
<span class="nc" id="L516">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L517">            throw new IllegalArgumentException(&quot;Invalid number format for &quot; + key + &quot;: &quot; + value);</span>
        }
    }
    
    private void sendJsonResponse(HttpExchange exchange, int statusCode, Object data) throws IOException {
<span class="nc" id="L522">        String jsonResponse = convertToJson(data);</span>
        
<span class="nc" id="L524">        exchange.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<span class="nc" id="L525">        exchange.sendResponseHeaders(statusCode, jsonResponse.getBytes().length);</span>
        
<span class="nc" id="L527">        try (OutputStream os = exchange.getResponseBody()) {</span>
<span class="nc" id="L528">            os.write(jsonResponse.getBytes());</span>
        }
<span class="nc" id="L530">    }</span>
    
    private void sendErrorResponse(HttpExchange exchange, int statusCode, String message) throws IOException {
<span class="nc" id="L533">        Map&lt;String, Object&gt; error = Map.of(</span>
<span class="nc" id="L534">            &quot;error&quot;, true,</span>
            &quot;message&quot;, message,
<span class="nc" id="L536">            &quot;status&quot;, statusCode</span>
        );
<span class="nc" id="L538">        sendJsonResponse(exchange, statusCode, error);</span>
<span class="nc" id="L539">    }</span>
    
    private String convertToJson(Object data) {
        // Simple JSON serialization - in production, use Jackson or Gson
<span class="nc bnc" id="L543" title="All 2 branches missed.">        if (data == null) {</span>
<span class="nc" id="L544">            return &quot;null&quot;;</span>
        }
        
<span class="nc bnc" id="L547" title="All 2 branches missed.">        if (data instanceof String) {</span>
<span class="nc" id="L548">            return &quot;\&quot;&quot; + data + &quot;\&quot;&quot;;</span>
        }
        
<span class="nc bnc" id="L551" title="All 4 branches missed.">        if (data instanceof Number || data instanceof Boolean) {</span>
<span class="nc" id="L552">            return data.toString();</span>
        }
        
<span class="nc bnc" id="L555" title="All 2 branches missed.">        if (data instanceof Map) {</span>
<span class="nc" id="L556">            Map&lt;?, ?&gt; map = (Map&lt;?, ?&gt;) data;</span>
<span class="nc" id="L557">            StringBuilder sb = new StringBuilder(&quot;{&quot;);</span>
<span class="nc" id="L558">            boolean first = true;</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">            for (Map.Entry&lt;?, ?&gt; entry : map.entrySet()) {</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">                if (!first) sb.append(&quot;,&quot;);</span>
<span class="nc" id="L561">                sb.append(&quot;\&quot;&quot;).append(entry.getKey()).append(&quot;\&quot;:&quot;);</span>
<span class="nc" id="L562">                sb.append(convertToJson(entry.getValue()));</span>
<span class="nc" id="L563">                first = false;</span>
<span class="nc" id="L564">            }</span>
<span class="nc" id="L565">            sb.append(&quot;}&quot;);</span>
<span class="nc" id="L566">            return sb.toString();</span>
        }
        
<span class="nc bnc" id="L569" title="All 2 branches missed.">        if (data instanceof List) {</span>
<span class="nc" id="L570">            List&lt;?&gt; list = (List&lt;?&gt;) data;</span>
<span class="nc" id="L571">            StringBuilder sb = new StringBuilder(&quot;[&quot;);</span>
<span class="nc" id="L572">            boolean first = true;</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">            for (Object item : list) {</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">                if (!first) sb.append(&quot;,&quot;);</span>
<span class="nc" id="L575">                sb.append(convertToJson(item));</span>
<span class="nc" id="L576">                first = false;</span>
<span class="nc" id="L577">            }</span>
<span class="nc" id="L578">            sb.append(&quot;]&quot;);</span>
<span class="nc" id="L579">            return sb.toString();</span>
        }
        
        // For complex objects like Order, use reflection-based serialization
<span class="nc" id="L583">        return serializeObject(data);</span>
    }
    
    private String serializeObject(Object obj) {
        // Simple object serialization for Order and other entities
<span class="nc bnc" id="L588" title="All 2 branches missed.">        if (obj instanceof Order) {</span>
<span class="nc" id="L589">            Order order = (Order) obj;</span>
<span class="nc" id="L590">            return String.format(</span>
                &quot;{\&quot;id\&quot;:%d,\&quot;customerId\&quot;:%d,\&quot;restaurantId\&quot;:%d,\&quot;status\&quot;:\&quot;%s\&quot;,\&quot;totalAmount\&quot;:%.2f,\&quot;deliveryAddress\&quot;:\&quot;%s\&quot;,\&quot;phone\&quot;:\&quot;%s\&quot;,\&quot;orderDate\&quot;:\&quot;%s\&quot;,\&quot;itemCount\&quot;:%d}&quot;,
<span class="nc" id="L592">                order.getId(), order.getCustomer().getId(), order.getRestaurant().getId(),</span>
<span class="nc" id="L593">                order.getStatus(), order.getTotalAmount(), order.getDeliveryAddress(),</span>
<span class="nc" id="L594">                order.getPhone(), order.getOrderDate(), order.getOrderItems().size()</span>
            );
        }
        
<span class="nc bnc" id="L598" title="All 2 branches missed.">        if (obj instanceof OrderService.OrderStatistics) {</span>
<span class="nc" id="L599">            OrderService.OrderStatistics stats = (OrderService.OrderStatistics) obj;</span>
<span class="nc" id="L600">            return String.format(</span>
                &quot;{\&quot;totalOrders\&quot;:%d,\&quot;completedOrders\&quot;:%d,\&quot;cancelledOrders\&quot;:%d,\&quot;totalSpent\&quot;:%.2f,\&quot;activeOrders\&quot;:%d,\&quot;averageOrderValue\&quot;:%.2f}&quot;,
<span class="nc" id="L602">                stats.getTotalOrders(), stats.getCompletedOrders(), stats.getCancelledOrders(),</span>
<span class="nc" id="L603">                stats.getTotalSpent(), stats.getActiveOrders(), stats.getAverageOrderValue()</span>
            );
        }
        
        // Fallback to toString
<span class="nc" id="L608">        return &quot;\&quot;&quot; + obj.toString() + &quot;\&quot;&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>