<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ServerApp.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp</a> &gt; <span class="el_source">ServerApp.java</span></div><h1>ServerApp.java</h1><pre class="source lang-java linenums">package com.myapp;

import com.myapp.auth.AuthRepository;
import com.myapp.auth.AuthService;
import com.myapp.auth.AuthResult;
import com.myapp.auth.AuthMiddleware;
import com.myapp.restaurant.RestaurantRepository;
import com.myapp.restaurant.RestaurantController;
import com.myapp.admin.AdminRepository;
import com.myapp.admin.AdminService;
import com.myapp.admin.AdminController;
import com.myapp.order.OrderRepository;
import com.myapp.order.OrderController;
import com.myapp.payment.PaymentRepository;
import com.myapp.payment.PaymentController;
import com.myapp.payment.WalletController;
import com.myapp.payment.WalletService;
import com.myapp.payment.TransactionController;
import com.myapp.courier.DeliveryRepository;
import com.myapp.courier.DeliveryController;
import com.myapp.item.ItemController;
import com.myapp.menu.MenuController;
import com.myapp.vendor.VendorController;
import com.myapp.favorites.FavoritesRepository;
import com.myapp.favorites.FavoritesService;
import com.myapp.favorites.FavoritesController;
import com.myapp.notification.NotificationRepository;
import com.myapp.notification.NotificationService;
import com.myapp.notification.NotificationController;
import com.myapp.common.utils.DatabaseUtil;
import com.myapp.common.utils.PasswordUtil;
import com.myapp.common.models.User;
import com.myapp.common.constants.ApplicationConstants;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.JsonNode;
import com.sun.net.httpserver.HttpServer;
import com.sun.net.httpserver.HttpHandler;
import com.sun.net.httpserver.HttpExchange;

import java.io.IOException;
import java.io.OutputStream;
import java.net.InetSocketAddress;
import java.util.concurrent.Executors;

/**
 * کلاس اصلی سرور پروژه سیستم سفارش غذا
 * این کلاس مسئول راه‌اندازی و مدیریت کل سرور backend است
 * شامل تمام endpoint های REST API و مدیریت درخواست‌ها
 */
<span class="nc" id="L50">public class ServerApp {</span>
    
    // تعریف متغیرهای static برای سرویس‌ها و کنترلرهای مختلف
    private static AuthService authService;                    // سرویس احراز هویت
    private static AdminController adminController;            // کنترلر پنل مدیریت
    private static RestaurantController restaurantController;  // کنترلر مدیریت رستوران‌ها
    private static OrderController orderController;            // کنترلر مدیریت سفارشات
    private static PaymentController paymentController;        // کنترلر سیستم پرداخت
    private static WalletController walletController;          // کنترلر کیف پول
    private static TransactionController transactionController; // کنترلر تراکنش‌ها
    private static DeliveryController deliveryController;      // کنترلر سیستم تحویل
    private static ItemController itemController;              // کنترلر مدیریت آیتم‌ها
    private static MenuController menuController;              // کنترلر مدیریت منو
    private static VendorController vendorController;          // کنترلر سیستم فروشندگان
    private static FavoritesController favoritesController;    // کنترلر علاقه‌مندی‌ها
    private static NotificationController notificationController; // کنترلر اعلان‌ها
    
    /**
     * متد اصلی main که نقطه شروع برنامه است
     * مسئول راه‌اندازی تمام سرویس‌ها، کنترلرها و سرور HTTP
     */
    public static void main(String[] args) throws IOException {
        // نمایش پیام شروع سرور
<span class="nc" id="L73">        System.out.println(&quot;🚀 Starting Food Ordering Backend Server...&quot;);</span>
        
        // مرحله 1: راه‌اندازی Repository ها (لایه دسترسی به داده)
<span class="nc" id="L76">        AuthRepository authRepo = new AuthRepository();                   // Repository احراز هویت</span>
<span class="nc" id="L77">        authService = new AuthService(authRepo);                          // سرویس احراز هویت</span>
        
<span class="nc" id="L79">        RestaurantRepository restaurantRepo = new RestaurantRepository(); // Repository رستوران‌ها</span>
<span class="nc" id="L80">        OrderRepository orderRepo = new OrderRepository();               // Repository سفارشات</span>
<span class="nc" id="L81">        PaymentRepository paymentRepo = new PaymentRepository();         // Repository پرداخت‌ها</span>
<span class="nc" id="L82">        DeliveryRepository deliveryRepo = new DeliveryRepository();       // Repository تحویل‌ها</span>
<span class="nc" id="L83">        FavoritesRepository favoritesRepo = new FavoritesRepository();   // Repository علاقه‌مندی‌ها</span>
<span class="nc" id="L84">        NotificationRepository notificationRepo = new NotificationRepository(); // Repository اعلان‌ها</span>
        
        // مرحله 2: راه‌اندازی سرویس‌های مدیریت (Admin services)
<span class="nc" id="L87">        AdminRepository adminRepo = new AdminRepository();</span>
        // ایجاد سرویس مدیریت با تمام Repository های لازم
<span class="nc" id="L89">        AdminService adminService = new AdminService(adminRepo, authRepo, restaurantRepo, orderRepo, paymentRepo, deliveryRepo);</span>
<span class="nc" id="L90">        adminController = new AdminController(adminService);             // کنترلر پنل مدیریت</span>
        
        // مرحله 3: راه‌اندازی سرویس علاقه‌مندی‌ها
<span class="nc" id="L93">        FavoritesService favoritesService = new FavoritesService(favoritesRepo, authRepo, restaurantRepo);</span>
        
        // مرحله 4: راه‌اندازی سرویس اعلان‌ها
<span class="nc" id="L96">        NotificationService notificationService = new NotificationService(notificationRepo, authRepo);</span>
        
        // مرحله 5: راه‌اندازی سرویس کیف پول برای کنترلر تراکنش‌ها
<span class="nc" id="L99">        WalletService walletService = new WalletService(paymentRepo, authRepo);</span>
        
        // مرحله 6: راه‌اندازی سایر کنترلرها
<span class="nc" id="L102">        restaurantController = new RestaurantController();               // کنترلر رستوران‌ها</span>
<span class="nc" id="L103">        orderController = new OrderController();                        // کنترلر سفارشات</span>
<span class="nc" id="L104">        paymentController = new PaymentController();                    // کنترلر پرداخت‌ها</span>
<span class="nc" id="L105">        walletController = new WalletController();                      // کنترلر کیف پول</span>
<span class="nc" id="L106">        transactionController = new TransactionController(walletService, paymentRepo); // کنترلر تراکنش‌ها</span>
<span class="nc" id="L107">        deliveryController = new DeliveryController();                  // کنترلر تحویل‌ها</span>
<span class="nc" id="L108">        itemController = new ItemController();                          // کنترلر آیتم‌ها</span>
<span class="nc" id="L109">        menuController = new MenuController();                          // کنترلر منو</span>
<span class="nc" id="L110">        vendorController = new VendorController();                      // کنترلر فروشندگان</span>
<span class="nc" id="L111">        favoritesController = new FavoritesController(favoritesService); // کنترلر علاقه‌مندی‌ها</span>
<span class="nc" id="L112">        notificationController = new NotificationController(notificationService); // کنترلر اعلان‌ها</span>
        
        // مرحله 7: تست اتصال به پایگاه داده
<span class="nc" id="L115">        System.out.println(&quot;Testing Hibernate connection...&quot;);</span>
        try {
            // تلاش برای اتصال به پایگاه داده از طریق Hibernate
<span class="nc" id="L118">            DatabaseUtil.getSessionFactory();</span>
<span class="nc" id="L119">            System.out.println(&quot;✅ Database connection successful!&quot;);</span>
<span class="nc" id="L120">        } catch (Exception e) {</span>
            // در صورت خطا در اتصال، نمایش پیام خطا و خروج از برنامه
<span class="nc" id="L122">            System.err.println(&quot;❌ Database connection failed: &quot; + e.getMessage());</span>
<span class="nc" id="L123">            e.printStackTrace();</span>
<span class="nc" id="L124">            return; // خروج از برنامه در صورت عدم اتصال به دیتابیس</span>
<span class="nc" id="L125">        }</span>
        
        // مرحله 8: ایجاد سرور HTTP روی پورت پیکربندی شده
<span class="nc" id="L128">        int serverPort = Integer.parseInt(System.getProperty(&quot;server.port&quot;, &quot;8081&quot;));</span>
<span class="nc" id="L129">        HttpServer server = HttpServer.create(new InetSocketAddress(serverPort), 0);</span>
        
        // مرحله 9: اضافه کردن endpoint های اصلی (Authentication &amp; Health)
<span class="nc" id="L132">        server.createContext(&quot;/api/test&quot;, new TestHandler());              // endpoint تست</span>
<span class="nc" id="L133">        server.createContext(&quot;/api/auth/register&quot;, new RegisterHandler()); // ثبت نام کاربران</span>
<span class="nc" id="L134">        server.createContext(&quot;/api/auth/login&quot;, new LoginHandler());       // ورود کاربران</span>
<span class="nc" id="L135">        server.createContext(&quot;/api/auth/refresh&quot;, new RefreshTokenHandler()); // تجدید token</span>
<span class="nc" id="L136">        server.createContext(&quot;/api/auth/validate&quot;, new ValidateTokenHandler()); // اعتبارسنجی token</span>
<span class="nc" id="L137">        server.createContext(&quot;/api/auth/logout&quot;, new LogoutHandler());     // خروج کاربران</span>
<span class="nc" id="L138">        server.createContext(&quot;/health&quot;, new HealthHandler());              // بررسی سلامت سرور</span>
        
        // مرحله 10: اضافه کردن endpoint های کنترلرها (Business Logic)
<span class="nc" id="L141">        server.createContext(&quot;/api/admin/&quot;, adminController);              // endpoint های پنل مدیریت</span>
<span class="nc" id="L142">        server.createContext(&quot;/api/restaurants/&quot;, restaurantController);   // endpoint های رستوران‌ها</span>
<span class="nc" id="L143">        server.createContext(&quot;/api/orders/&quot;, orderController);             // endpoint های سفارشات</span>
<span class="nc" id="L144">        server.createContext(&quot;/api/payments/&quot;, paymentController);         // endpoint های پرداخت</span>
<span class="nc" id="L145">        server.createContext(&quot;/api/wallet/&quot;, walletController);            // endpoint های کیف پول</span>
<span class="nc" id="L146">        server.createContext(&quot;/api/transactions/&quot;, transactionController); // endpoint های تراکنش‌ها</span>
<span class="nc" id="L147">        server.createContext(&quot;/api/deliveries/&quot;, deliveryController);      // endpoint های تحویل</span>
<span class="nc" id="L148">        server.createContext(&quot;/api/items/&quot;, itemController);               // endpoint های آیتم‌ها</span>
<span class="nc" id="L149">        server.createContext(&quot;/api/menu/&quot;, menuController);                // endpoint های منو</span>
<span class="nc" id="L150">        server.createContext(&quot;/api/vendors/&quot;, vendorController);           // endpoint های فروشندگان</span>
<span class="nc" id="L151">        server.createContext(&quot;/api/favorites/&quot;, favoritesController);      // endpoint های علاقه‌مندی‌ها</span>
<span class="nc" id="L152">        server.createContext(&quot;/api/notifications/&quot;, notificationController); // endpoint های اعلان‌ها</span>
<span class="nc" id="L153">        server.createContext(&quot;/api/notification/&quot;, notificationController);  // endpoint جایگزین اعلان‌ها</span>
        
        // مرحله 11: تنظیم Thread Pool برای پردازش همزمان درخواست‌ها
<span class="nc" id="L156">        server.setExecutor(Executors.newFixedThreadPool(10)); // حداکثر 10 thread همزمان</span>
        
        // مرحله 12: شروع سرور و نمایش اطلاعات
<span class="nc" id="L159">        server.start();</span>
<span class="nc" id="L160">        System.out.println(&quot;🚀 Server started on http://localhost:&quot; + serverPort);</span>
<span class="nc" id="L161">        System.out.println(&quot;📋 Available endpoints:&quot;);</span>
        
        // نمایش لیست تمام endpoint های موجود برای راهنمایی توسعه‌دهندگان
<span class="nc" id="L164">        System.out.println(&quot;   GET  /health - Health check&quot;);</span>
<span class="nc" id="L165">        System.out.println(&quot;   GET  /api/test - Simple test&quot;);</span>
<span class="nc" id="L166">        System.out.println(&quot;   POST /api/auth/register - User registration&quot;);</span>
<span class="nc" id="L167">        System.out.println(&quot;   POST /api/auth/login - User login (with JWT tokens)&quot;);</span>
<span class="nc" id="L168">        System.out.println(&quot;   POST /api/auth/refresh - Refresh access token&quot;);</span>
<span class="nc" id="L169">        System.out.println(&quot;   GET  /api/auth/validate - Validate access token&quot;);</span>
<span class="nc" id="L170">        System.out.println(&quot;   POST /api/auth/logout - User logout&quot;);</span>
        
        // نمایش endpoint های پنل مدیریت (18+ endpoint)
<span class="nc" id="L173">        System.out.println(&quot;   🔧 Admin Dashboard (18+ endpoints):&quot;);</span>
<span class="nc" id="L174">        System.out.println(&quot;   GET  /api/admin/dashboard - Admin statistics&quot;);</span>
<span class="nc" id="L175">        System.out.println(&quot;   GET  /api/admin/users - User management&quot;);</span>
<span class="nc" id="L176">        System.out.println(&quot;   GET  /api/admin/restaurants - Restaurant management&quot;);</span>
<span class="nc" id="L177">        System.out.println(&quot;   GET  /api/admin/orders - Order management&quot;);</span>
<span class="nc" id="L178">        System.out.println(&quot;   GET  /api/admin/transactions - Transaction monitoring&quot;);</span>
<span class="nc" id="L179">        System.out.println(&quot;   GET  /api/admin/deliveries - Delivery tracking&quot;);</span>
        
        // نمایش endpoint های مدیریت رستوران (16+ endpoint)
<span class="nc" id="L182">        System.out.println(&quot;   🏪 Restaurant Management (16+ endpoints):&quot;);</span>
<span class="nc" id="L183">        System.out.println(&quot;   GET  /api/restaurants/ - All restaurants&quot;);</span>
<span class="nc" id="L184">        System.out.println(&quot;   POST /api/restaurants/ - Create restaurant&quot;);</span>
        
        // نمایش endpoint های مدیریت سفارشات (20+ endpoint)
<span class="nc" id="L187">        System.out.println(&quot;   🛒 Order Management (20+ endpoints):&quot;);</span>
<span class="nc" id="L188">        System.out.println(&quot;   GET  /api/orders/ - All orders&quot;);</span>
<span class="nc" id="L189">        System.out.println(&quot;   POST /api/orders/ - Create order&quot;);</span>
        
        // نمایش endpoint های سیستم پرداخت (8+ endpoint)
<span class="nc" id="L192">        System.out.println(&quot;   💳 Payment System (8+ endpoints):&quot;);</span>
<span class="nc" id="L193">        System.out.println(&quot;   GET  /api/payments/ - Payment history&quot;);</span>
<span class="nc" id="L194">        System.out.println(&quot;   POST /api/payments/ - Process payment&quot;);</span>
        
        // نمایش endpoint های سیستم کیف پول (6+ endpoint)
<span class="nc" id="L197">        System.out.println(&quot;   💰 Wallet System (6+ endpoints):&quot;);</span>
<span class="nc" id="L198">        System.out.println(&quot;   GET  /api/wallet/ - Wallet balance&quot;);</span>
<span class="nc" id="L199">        System.out.println(&quot;   POST /api/wallet/ - Add funds&quot;);</span>
        
        // نمایش endpoint های سیستم تراکنش‌ها (5+ endpoint)
<span class="nc" id="L202">        System.out.println(&quot;   💸 Transaction System (5+ endpoints):&quot;);</span>
<span class="nc" id="L203">        System.out.println(&quot;   GET  /api/transactions/wallet/history - Transaction history&quot;);</span>
<span class="nc" id="L204">        System.out.println(&quot;   GET  /api/transactions/wallet/statistics - Wallet statistics&quot;);</span>
        
        // نمایش endpoint های سیستم تحویل (16+ endpoint)
<span class="nc" id="L207">        System.out.println(&quot;   🚚 Delivery System (16+ endpoints):&quot;);</span>
<span class="nc" id="L208">        System.out.println(&quot;   GET  /api/deliveries/ - All deliveries&quot;);</span>
<span class="nc" id="L209">        System.out.println(&quot;   POST /api/deliveries/ - Create delivery&quot;);</span>
        
        // نمایش endpoint های مدیریت آیتم‌ها (13+ endpoint)
<span class="nc" id="L212">        System.out.println(&quot;   🍔 Item Management (13+ endpoints):&quot;);</span>
<span class="nc" id="L213">        System.out.println(&quot;   GET  /api/items/ - All items&quot;);</span>
<span class="nc" id="L214">        System.out.println(&quot;   POST /api/items/ - Create item&quot;);</span>
        
        // نمایش endpoint های مدیریت منو (6+ endpoint)
<span class="nc" id="L217">        System.out.println(&quot;   📋 Menu Management (6+ endpoints):&quot;);</span>
<span class="nc" id="L218">        System.out.println(&quot;   GET  /api/menu/ - Menu items&quot;);</span>
<span class="nc" id="L219">        System.out.println(&quot;   POST /api/menu/ - Add menu item&quot;);</span>
        
        // نمایش endpoint های سیستم فروشندگان (10+ endpoint)
<span class="nc" id="L222">        System.out.println(&quot;   🏬 Vendor System (10+ endpoints):&quot;);</span>
<span class="nc" id="L223">        System.out.println(&quot;   GET  /api/vendors/ - All vendors&quot;);</span>
<span class="nc" id="L224">        System.out.println(&quot;   GET  /api/vendors/search - Search vendors&quot;);</span>
        
        // نمایش endpoint های سیستم علاقه‌مندی‌ها (6+ endpoint)
<span class="nc" id="L227">        System.out.println(&quot;   ⭐ Favorites System (6+ endpoints):&quot;);</span>
<span class="nc" id="L228">        System.out.println(&quot;   GET  /api/favorites/ - User favorites&quot;);</span>
<span class="nc" id="L229">        System.out.println(&quot;   POST /api/favorites/add - Add to favorites&quot;);</span>
<span class="nc" id="L230">        System.out.println(&quot;   DELETE /api/favorites/remove - Remove favorite&quot;);</span>
        
        // نمایش endpoint های سیستم اعلان‌ها (6+ endpoint)
<span class="nc" id="L233">        System.out.println(&quot;   🔔 Notification System (6+ endpoints):&quot;);</span>
<span class="nc" id="L234">        System.out.println(&quot;   GET  /api/notifications/{userId} - User notifications&quot;);</span>
<span class="nc" id="L235">        System.out.println(&quot;   POST /api/notifications/ - Create notification&quot;);</span>
<span class="nc" id="L236">        System.out.println(&quot;   PUT  /api/notification/{id}/read - Mark as read&quot;);</span>
<span class="nc" id="L237">        System.out.println(&quot;   DELETE /api/notification/{id} - Delete notification&quot;);</span>
        
        // مرحله 13: تنظیم Graceful Shutdown برای خاموش کردن صحیح سرور
<span class="nc" id="L240">        Runtime.getRuntime().addShutdownHook(new Thread(() -&gt; {</span>
<span class="nc" id="L241">            System.out.println(&quot;🛑 Shutting down server...&quot;);</span>
<span class="nc" id="L242">            server.stop(2); // توقف سرور با 2 ثانیه انتظار</span>
<span class="nc" id="L243">            DatabaseUtil.shutdown(); // بستن اتصالات پایگاه داده</span>
<span class="nc" id="L244">            System.out.println(&quot;✅ Server stopped gracefully&quot;);</span>
<span class="nc" id="L245">        }));</span>
<span class="nc" id="L246">    }</span>
    
    /**
     * کلاس Handler برای endpoint بررسی سلامت سرور (/health)
     * این endpoint برای monitoring، health check و load balancer استفاده می‌شود
     * 
     * عملکرد این Handler:
     * - بازگشت وضعیت سرور (UP/DOWN)
     * - اطلاعات نام سرویس
     * - بدون نیاز به احراز هویت
     * 
     * این endpoint معمولاً توسط:
     * - Load balancers برای تشخیص سرورهای سالم
     * - Monitoring systems برای نظارت بر سرور
     * - CI/CD pipelines برای تست deployment
     * استفاده می‌شود
     * 
     * فرمت پاسخ:
     * &lt;pre&gt;
     * {
     *   &quot;status&quot;: &quot;UP&quot;,
     *   &quot;service&quot;: &quot;food-ordering-backend&quot;
     * }
     * &lt;/pre&gt;
     * 
     * @author Food Ordering System Team
     * @version 1.0
     * @since 2024
     */
<span class="nc" id="L275">    static class HealthHandler implements HttpHandler {</span>
        
        /**
         * پردازش درخواست health check
         * همیشه وضعیت UP برمی‌گرداند مگر اینکه سرور خراب باشد
         * 
         * @param exchange شیء HttpExchange شامل اطلاعات درخواست
         * @throws IOException در صورت خطا در ارسال پاسخ
         */
        @Override
        public void handle(HttpExchange exchange) throws IOException {
            // پاسخ JSON ساده برای نشان دادن سلامت سرور
<span class="nc" id="L287">            String response = &quot;{\&quot;status\&quot;:\&quot;UP\&quot;,\&quot;service\&quot;:\&quot;food-ordering-backend\&quot;}&quot;;</span>
<span class="nc" id="L288">            sendResponse(exchange, 200, response);</span>
<span class="nc" id="L289">        }</span>
    }
    
    /**
     * کلاس Handler برای endpoint تست (/api/test)
     * این endpoint برای تست اولیه کارکرد سرور و API استفاده می‌شود
     * 
     * عملکرد این Handler:
     * - تست اتصال به API
     * - نمایش زمان فعلی سرور
     * - بررسی عملکرد JSON response
     * - بدون نیاز به احراز هویت
     * 
     * این endpoint مفید است برای:
     * - تست اولیه پس از راه‌اندازی سرور
     * - بررسی connectivity کلاینت به سرور
     * - Debug مشکلات اتصال
     * - مثال ساده برای توسعه‌دهندگان
     * 
     * فرمت پاسخ:
     * &lt;pre&gt;
     * {
     *   &quot;message&quot;: &quot;Hello from Food Ordering Backend!&quot;,
     *   &quot;timestamp&quot;: &quot;2024-01-01T12:00:00.000Z&quot;
     * }
     * &lt;/pre&gt;
     * 
     * @author Food Ordering System Team
     * @version 1.0
     * @since 2024
     */
<span class="nc" id="L320">    static class TestHandler implements HttpHandler {</span>
        
        /**
         * پردازش درخواست تست
         * پیام خوش‌آمدگویی به همراه timestamp فعلی برمی‌گرداند
         * 
         * @param exchange شیء HttpExchange شامل اطلاعات درخواست
         * @throws IOException در صورت خطا در ارسال پاسخ
         */
        @Override
        public void handle(HttpExchange exchange) throws IOException {
            // پاسخ JSON شامل پیام تست و زمان فعلی
            String response = &quot;{\&quot;message\&quot;:\&quot;Hello from Food Ordering Backend!\&quot;,\&quot;timestamp\&quot;:\&quot;&quot; + 
<span class="nc" id="L333">                            java.time.Instant.now() + &quot;\&quot;}&quot;;</span>
<span class="nc" id="L334">            sendResponse(exchange, 200, response);</span>
<span class="nc" id="L335">        }</span>
    }
    
    /**
     * کلاس Handler برای ثبت نام کاربران (/api/auth/register)
     * مسئول پردازش درخواست‌های ثبت نام کاربران جدید در سیستم
     * 
     * عملکرد این Handler:
     * 1. دریافت و اعتبارسنجی داده‌های ثبت نام (fullName, phone, password)
     * 2. هش کردن رمز عبور با BCrypt برای امنیت
     * 3. ایجاد و ذخیره کاربر جدید در پایگاه داده
     * 4. بازگشت اطلاعات کاربر ثبت نام شده
     * 
     * فرمت درخواست JSON:
     * &lt;pre&gt;
     * {
     *   &quot;fullName&quot;: &quot;نام کامل کاربر&quot;,
     *   &quot;phone&quot;: &quot;09123456789&quot;,
     *   &quot;password&quot;: &quot;رمز عبور قوی&quot;,
     *   &quot;email&quot;: &quot;user@example.com&quot;,     // اختیاری
     *   &quot;address&quot;: &quot;آدرس کاربر&quot;          // اختیاری
     * }
     * &lt;/pre&gt;
     * 
     * @author Food Ordering System Team
     * @version 1.0
     * @since 2024
     */
<span class="nc" id="L363">    static class RegisterHandler implements HttpHandler {</span>
        
        /**
         * ObjectMapper برای تبدیل JSON به Java objects و برعکس
         * استفاده از Jackson library برای پردازش سریع و دقیق JSON
         */
<span class="nc" id="L369">        private final ObjectMapper objectMapper = new ObjectMapper();</span>
        
        @Override
        public void handle(HttpExchange exchange) throws IOException {
            // بررسی نوع درخواست - فقط POST قبول می‌شود
<span class="nc bnc" id="L374" title="All 2 branches missed.">            if (&quot;POST&quot;.equals(exchange.getRequestMethod())) {</span>
                try {
                    // خواندن محتوای درخواست (request body)
<span class="nc" id="L377">                    String requestBody = new String(exchange.getRequestBody().readAllBytes());</span>
<span class="nc" id="L378">                    System.out.println(&quot;📥 Registration request received&quot;);</span>
                    
                    // تبدیل JSON به JsonNode برای پردازش
<span class="nc" id="L381">                    JsonNode json = objectMapper.readTree(requestBody);</span>
                    
                    // اعتبارسنجی فیلدهای ضروری
<span class="nc bnc" id="L384" title="All 6 branches missed.">                    if (!json.has(&quot;fullName&quot;) || !json.has(&quot;phone&quot;) || !json.has(&quot;password&quot;)) {</span>
<span class="nc" id="L385">                        sendResponse(exchange, 400, &quot;{\&quot;error\&quot;:\&quot;Missing required fields: fullName, phone, password\&quot;}&quot;);</span>
<span class="nc" id="L386">                        return;</span>
                    }
                    
                    // استخراج اطلاعات از JSON
<span class="nc" id="L390">                    String fullName = json.get(&quot;fullName&quot;).asText();          // نام و نام خانوادگی</span>
<span class="nc" id="L391">                    String phone = json.get(&quot;phone&quot;).asText();                // شماره تلفن</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">                    String email = json.has(&quot;email&quot;) ? json.get(&quot;email&quot;).asText() : &quot;&quot;; // ایمیل (اختیاری)</span>
<span class="nc" id="L393">                    String password = json.get(&quot;password&quot;).asText();          // رمز عبور</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">                    String address = json.has(&quot;address&quot;) ? json.get(&quot;address&quot;).asText() : &quot;&quot;; // آدرس (اختیاری)</span>
                    
                    // اعتبارسنجی داده‌های دریافتی - بررسی خالی نبودن فیلدهای ضروری
<span class="nc bnc" id="L397" title="All 6 branches missed.">                    if (fullName.trim().isEmpty() || phone.trim().isEmpty() || password.trim().isEmpty()) {</span>
<span class="nc" id="L398">                        sendResponse(exchange, 400, &quot;{\&quot;error\&quot;:\&quot;fullName, phone, and password cannot be empty\&quot;}&quot;);</span>
<span class="nc" id="L399">                        return;</span>
                    }
                    
                    // هش کردن رمز عبور با BCrypt
<span class="nc" id="L403">                    String passwordHash = com.myapp.common.utils.PasswordUtil.hashPassword(password);</span>
                    
                    // ایجاد شیء کاربر جدید
<span class="nc" id="L406">                    User user = User.forRegistration(fullName, phone, email, passwordHash, address);</span>
                    
                    // ذخیره کاربر در پایگاه داده
<span class="nc" id="L409">                    User savedUser = authService.registerUser(user);</span>
                    
                    // ایجاد پاسخ موفقیت‌آمیز
<span class="nc" id="L412">                    String response = &quot;{\&quot;message\&quot;:\&quot;User registered successfully!\&quot;,\&quot;status\&quot;:\&quot;success\&quot;,\&quot;userId\&quot;:&quot; + </span>
<span class="nc" id="L413">                                    savedUser.getId() + &quot;,\&quot;fullName\&quot;:\&quot;&quot; + savedUser.getFullName() + &quot;\&quot;,\&quot;phone\&quot;:\&quot;&quot; + savedUser.getPhone() + &quot;\&quot;}&quot;;</span>
<span class="nc" id="L414">                    sendResponse(exchange, 201, response);</span>
                    
                    // نمایش پیام موفقیت در کنسول سرور
<span class="nc" id="L417">                    System.out.println(&quot;✅ User registered: &quot; + savedUser.getFullName() + &quot; (ID: &quot; + savedUser.getId() + &quot;)&quot;);</span>
                    
<span class="nc" id="L419">                } catch (Exception e) {</span>
                    // مدیریت خطاهای احتمالی در فرآیند ثبت نام
<span class="nc" id="L421">                    System.err.println(&quot;❌ Registration error: &quot; + e.getMessage());</span>
<span class="nc" id="L422">                    e.printStackTrace();</span>
<span class="nc" id="L423">                    String errorResponse = &quot;{\&quot;error\&quot;:\&quot;Registration failed\&quot;,\&quot;message\&quot;:\&quot;&quot; + e.getMessage().replace(&quot;\&quot;&quot;, &quot;'&quot;) + &quot;\&quot;}&quot;;</span>
<span class="nc" id="L424">                    sendResponse(exchange, 500, errorResponse);</span>
<span class="nc" id="L425">                }</span>
            } else {
                // اگر نوع درخواست POST نباشد، خطای Method Not Allowed برگردانده می‌شود
<span class="nc" id="L428">                sendResponse(exchange, 405, &quot;{\&quot;error\&quot;:\&quot;Method not allowed\&quot;}&quot;);</span>
            }
<span class="nc" id="L430">        }</span>
    }
    
    /**
     * کلاس Handler برای ورود کاربران (/api/auth/login)
     * مسئول پردازش درخواست‌های ورود و ایجاد JWT token برای احراز هویت
     * 
     * عملکرد این Handler:
     * 1. دریافت اطلاعات ورود (شماره تلفن و رمز عبور)
     * 2. احراز هویت کاربر با بررسی رمز عبور
     * 3. ایجاد Access Token و Refresh Token
     * 4. بازگشت token ها به همراه اطلاعات کاربر
     * 
     * فرمت درخواست JSON:
     * &lt;pre&gt;
     * {
     *   &quot;phone&quot;: &quot;09123456789&quot;,
     *   &quot;password&quot;: &quot;رمز عبور کاربر&quot;
     * }
     * &lt;/pre&gt;
     * 
     * فرمت پاسخ موفق:
     * &lt;pre&gt;
     * {
     *   &quot;message&quot;: &quot;Login successful!&quot;,
     *   &quot;status&quot;: &quot;success&quot;,
     *   &quot;userId&quot;: 123,
     *   &quot;fullName&quot;: &quot;نام کاربر&quot;,
     *   &quot;phone&quot;: &quot;09123456789&quot;,
     *   &quot;role&quot;: &quot;BUYER&quot;,
     *   &quot;accessToken&quot;: &quot;eyJ0eXAi...&quot;,
     *   &quot;refreshToken&quot;: &quot;eyJ0eXAi...&quot;,
     *   &quot;tokenType&quot;: &quot;Bearer&quot;,
     *   &quot;expiresIn&quot;: 900
     * }
     * &lt;/pre&gt;
     * 
     * @author Food Ordering System Team
     * @version 1.0
     * @since 2024
     */
<span class="nc" id="L471">    static class LoginHandler implements HttpHandler {</span>
        
        /**
         * ObjectMapper برای تبدیل JSON به Java objects و برعکس
         * استفاده از Jackson library برای پردازش دقیق JSON
         */
<span class="nc" id="L477">        private final ObjectMapper objectMapper = new ObjectMapper();</span>
        
        @Override
        public void handle(HttpExchange exchange) throws IOException {
            // بررسی نوع درخواست - فقط POST قبول می‌شود
<span class="nc bnc" id="L482" title="All 2 branches missed.">            if (&quot;POST&quot;.equals(exchange.getRequestMethod())) {</span>
                try {
                    // خواندن محتوای درخواست
<span class="nc" id="L485">                    String requestBody = new String(exchange.getRequestBody().readAllBytes());</span>
<span class="nc" id="L486">                    System.out.println(&quot;📥 Login request received&quot;);</span>
                    
                    // تبدیل JSON به JsonNode
<span class="nc" id="L489">                    JsonNode json = objectMapper.readTree(requestBody);</span>
                    
                    // اعتبارسنجی فیلدهای ضروری
<span class="nc bnc" id="L492" title="All 4 branches missed.">                    if (!json.has(&quot;phone&quot;) || !json.has(&quot;password&quot;)) {</span>
<span class="nc" id="L493">                        sendResponse(exchange, 400, &quot;{\&quot;error\&quot;:\&quot;Missing required fields: phone, password\&quot;}&quot;);</span>
<span class="nc" id="L494">                        return;</span>
                    }
                    
                    // استخراج اطلاعات ورود
<span class="nc" id="L498">                    String phone = json.get(&quot;phone&quot;).asText();        // شماره تلفن</span>
<span class="nc" id="L499">                    String password = json.get(&quot;password&quot;).asText();  // رمز عبور</span>
                    
                    // اعتبارسنجی داده‌های دریافتی
<span class="nc bnc" id="L502" title="All 4 branches missed.">                    if (phone.trim().isEmpty() || password.trim().isEmpty()) {</span>
<span class="nc" id="L503">                        sendResponse(exchange, 400, &quot;{\&quot;error\&quot;:\&quot;Phone and password cannot be empty\&quot;}&quot;);</span>
<span class="nc" id="L504">                        return;</span>
                    }
                    
                    // هش کردن رمز عبور برای مقایسه (در واقع باید از verify استفاده شود)
                    // String passwordHash = &quot;hashed_&quot; + password;
                    
                    // احراز هویت کاربر و دریافت JWT token
<span class="nc" id="L511">                    AuthResult authResult = authService.loginWithTokens(phone, password);</span>
                    
                    // بررسی موفقیت احراز هویت
<span class="nc bnc" id="L514" title="All 2 branches missed.">                    if (!authResult.isAuthenticated()) {</span>
<span class="nc" id="L515">                        sendResponse(exchange, 401, &quot;{\&quot;error\&quot;:\&quot;&quot; + authResult.getErrorMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L516">                        return;</span>
                    }
                    
                    // ایجاد پاسخ موفقیت‌آمیز شامل JWT token ها
<span class="nc" id="L520">                    String response = String.format(</span>
                        &quot;{\&quot;message\&quot;:\&quot;Login successful!\&quot;,\&quot;status\&quot;:\&quot;success\&quot;,\&quot;userId\&quot;:%d,&quot; +
                        &quot;\&quot;fullName\&quot;:\&quot;%s\&quot;,\&quot;phone\&quot;:\&quot;%s\&quot;,\&quot;role\&quot;:\&quot;%s\&quot;,&quot; +
                        &quot;\&quot;accessToken\&quot;:\&quot;%s\&quot;,\&quot;refreshToken\&quot;:\&quot;%s\&quot;,&quot; +
                        &quot;\&quot;tokenType\&quot;:\&quot;Bearer\&quot;,\&quot;expiresIn\&quot;:%d}&quot;,
<span class="nc" id="L525">                        authResult.getUserId(),                         // شناسه کاربر</span>
<span class="nc" id="L526">                        authResult.getPhone().replace(&quot;\&quot;&quot;, &quot;\\\&quot;&quot;),    // نام کاربر (با escape کردن &quot;)</span>
<span class="nc" id="L527">                        authResult.getPhone(),                          // شماره تلفن</span>
<span class="nc" id="L528">                        authResult.getRole(),                           // نقش کاربر</span>
<span class="nc" id="L529">                        authResult.getAccessToken(),                    // Access Token</span>
<span class="nc" id="L530">                        authResult.getRefreshToken(),                   // Refresh Token</span>
<span class="nc" id="L531">                        com.myapp.common.utils.JWTUtil.getAccessTokenValidity() / 1000 // مدت اعتبار token به ثانیه</span>
                    );
<span class="nc" id="L533">                    sendResponse(exchange, 200, response);</span>
                    
                    // نمایش پیام موفقیت در کنسول سرور
<span class="nc" id="L536">                    System.out.println(&quot;✅ User logged in with JWT tokens: &quot; + authResult.getPhone() + &quot; (ID: &quot; + authResult.getUserId() + &quot;)&quot;);</span>
                    
<span class="nc" id="L538">                } catch (com.myapp.common.exceptions.InvalidCredentialsException e) {</span>
                    // مدیریت خطای اعتبارات نامعتبر
<span class="nc" id="L540">                    sendResponse(exchange, 401, &quot;{\&quot;error\&quot;:\&quot;Invalid phone or password\&quot;}&quot;);</span>
<span class="nc" id="L541">                } catch (Exception e) {</span>
                    // مدیریت سایر خطاهای احتمالی
<span class="nc" id="L543">                    System.err.println(&quot;❌ Login error: &quot; + e.getMessage());</span>
<span class="nc" id="L544">                    e.printStackTrace();</span>
<span class="nc" id="L545">                    String errorResponse = &quot;{\&quot;error\&quot;:\&quot;Login failed\&quot;,\&quot;message\&quot;:\&quot;&quot; + e.getMessage().replace(&quot;\&quot;&quot;, &quot;'&quot;) + &quot;\&quot;}&quot;;</span>
<span class="nc" id="L546">                    sendResponse(exchange, 500, errorResponse);</span>
<span class="nc" id="L547">                }</span>
            } else {
                // خطای Method Not Allowed برای سایر نوع درخواست‌ها
<span class="nc" id="L550">                sendResponse(exchange, 405, &quot;{\&quot;error\&quot;:\&quot;Method not allowed\&quot;}&quot;);</span>
            }
<span class="nc" id="L552">        }</span>
    }
    
    /**
     * کلاس Handler برای تجدید JWT token (/api/auth/refresh)
     * مسئول تجدید Access Token با استفاده از Refresh Token معتبر
     * 
     * عملکرد این Handler:
     * 1. دریافت Refresh Token از کلاینت
     * 2. اعتبارسنجی Refresh Token
     * 3. ایجاد Access Token و Refresh Token جدید
     * 4. بازگشت token های جدید
     * 
     * این endpoint زمانی استفاده می‌شود که Access Token منقضی شده
     * ولی Refresh Token هنوز معتبر است
     * 
     * فرمت درخواست JSON:
     * &lt;pre&gt;
     * {
     *   &quot;refreshToken&quot;: &quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...&quot;
     * }
     * &lt;/pre&gt;
     * 
     * @author Food Ordering System Team
     * @version 1.0
     * @since 2024
     */
<span class="nc" id="L579">    static class RefreshTokenHandler implements HttpHandler {</span>
        
        /**
         * ObjectMapper برای پردازش JSON درخواست‌ها
         */
<span class="nc" id="L584">        private final ObjectMapper objectMapper = new ObjectMapper();</span>
        
        @Override
        public void handle(HttpExchange exchange) throws IOException {
            // بررسی نوع درخواست - فقط POST قبول می‌شود
<span class="nc bnc" id="L589" title="All 2 branches missed.">            if (&quot;POST&quot;.equals(exchange.getRequestMethod())) {</span>
                try {
                    // خواندن محتوای درخواست
<span class="nc" id="L592">                    String requestBody = new String(exchange.getRequestBody().readAllBytes());</span>
<span class="nc" id="L593">                    JsonNode json = objectMapper.readTree(requestBody);</span>
                    
                    // بررسی وجود Refresh Token
<span class="nc bnc" id="L596" title="All 2 branches missed.">                    if (!json.has(&quot;refreshToken&quot;)) {</span>
<span class="nc" id="L597">                        sendResponse(exchange, 400, &quot;{\&quot;error\&quot;:\&quot;Missing refreshToken field\&quot;}&quot;);</span>
<span class="nc" id="L598">                        return;</span>
                    }
                    
                    // استخراج Refresh Token
<span class="nc" id="L602">                    String refreshToken = json.get(&quot;refreshToken&quot;).asText();</span>
                    
                    // تجدید token از طریق سرویس احراز هویت
<span class="nc" id="L605">                    AuthResult authResult = authService.refreshToken(refreshToken);</span>
                    
                    // بررسی موفقیت تجدید token
<span class="nc bnc" id="L608" title="All 2 branches missed.">                    if (!authResult.isAuthenticated()) {</span>
<span class="nc" id="L609">                        sendResponse(exchange, 401, &quot;{\&quot;error\&quot;:\&quot;&quot; + authResult.getErrorMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L610">                        return;</span>
                    }
                    
                    // ایجاد پاسخ شامل token های جدید
<span class="nc" id="L614">                    String response = String.format(</span>
                        &quot;{\&quot;message\&quot;:\&quot;Token refreshed successfully\&quot;,\&quot;status\&quot;:\&quot;success\&quot;,&quot; +
                        &quot;\&quot;accessToken\&quot;:\&quot;%s\&quot;,\&quot;refreshToken\&quot;:\&quot;%s\&quot;,&quot; +
                        &quot;\&quot;tokenType\&quot;:\&quot;Bearer\&quot;,\&quot;expiresIn\&quot;:%d}&quot;,
<span class="nc" id="L618">                        authResult.getAccessToken(),                    // Access Token جدید</span>
<span class="nc" id="L619">                        authResult.getRefreshToken(),                   // Refresh Token جدید</span>
<span class="nc" id="L620">                        com.myapp.common.utils.JWTUtil.getAccessTokenValidity() / 1000 // مدت اعتبار</span>
                    );
<span class="nc" id="L622">                    sendResponse(exchange, 200, response);</span>
                    
<span class="nc" id="L624">                } catch (Exception e) {</span>
                    // مدیریت خطاهای تجدید token
<span class="nc" id="L626">                    System.err.println(&quot;❌ Token refresh error: &quot; + e.getMessage());</span>
<span class="nc" id="L627">                    String errorResponse = &quot;{\&quot;error\&quot;:\&quot;Token refresh failed\&quot;,\&quot;message\&quot;:\&quot;&quot; + e.getMessage().replace(&quot;\&quot;&quot;, &quot;'&quot;) + &quot;\&quot;}&quot;;</span>
<span class="nc" id="L628">                    sendResponse(exchange, 500, errorResponse);</span>
<span class="nc" id="L629">                }</span>
            } else {
<span class="nc" id="L631">                sendResponse(exchange, 405, &quot;{\&quot;error\&quot;:\&quot;Method not allowed\&quot;}&quot;);</span>
            }
<span class="nc" id="L633">        }</span>
    }
    
    /**
     * کلاس Handler برای اعتبارسنجی JWT token (/api/auth/validate)
     * مسئول بررسی معتبر بودن Access Token و بازگشت اطلاعات کاربر
     * 
     * عملکرد این Handler:
     * 1. دریافت Access Token از header Authorization
     * 2. اعتبارسنجی token (امضا، انقضا، ساختار)
     * 3. استخراج اطلاعات کاربر از token
     * 4. بازگشت اطلاعات کاربر در صورت معتبر بودن
     * 
     * این endpoint برای بررسی وضعیت احراز هویت کاربر
     * بدون نیاز به ورود مجدد استفاده می‌شود
     * 
     * Header مورد نیاز:
     * Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...
     * 
     * فرمت پاسخ موفق:
     * &lt;pre&gt;
     * {
     *   &quot;valid&quot;: true,
     *   &quot;userId&quot;: 123,
     *   &quot;phone&quot;: &quot;09123456789&quot;,
     *   &quot;role&quot;: &quot;BUYER&quot;
     * }
     * &lt;/pre&gt;
     * 
     * @author Food Ordering System Team
     * @version 1.0
     * @since 2024
     */
<span class="nc" id="L666">    static class ValidateTokenHandler implements HttpHandler {</span>
        @Override
        public void handle(HttpExchange exchange) throws IOException {
            // بررسی نوع درخواست - فقط GET قبول می‌شود
<span class="nc bnc" id="L670" title="All 2 branches missed.">            if (&quot;GET&quot;.equals(exchange.getRequestMethod())) {</span>
                try {
                    // اعتبارسنجی token از طریق middleware احراز هویت
<span class="nc" id="L673">                    AuthResult authResult = AuthMiddleware.authenticate(exchange);</span>
                    
                    // بررسی موفقیت اعتبارسنجی
<span class="nc bnc" id="L676" title="All 2 branches missed.">                    if (!authResult.isAuthenticated()) {</span>
<span class="nc" id="L677">                        sendResponse(exchange, 401, &quot;{\&quot;error\&quot;:\&quot;&quot; + authResult.getErrorMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L678">                        return;</span>
                    }
                    
                    // ایجاد پاسخ شامل اطلاعات کاربر
<span class="nc" id="L682">                    String response = String.format(</span>
                        &quot;{\&quot;valid\&quot;:true,\&quot;userId\&quot;:%d,\&quot;phone\&quot;:\&quot;%s\&quot;,\&quot;role\&quot;:\&quot;%s\&quot;}&quot;,
<span class="nc" id="L684">                        authResult.getUserId(),    // شناسه کاربر</span>
<span class="nc" id="L685">                        authResult.getPhone(),     // شماره تلفن کاربر</span>
<span class="nc" id="L686">                        authResult.getRole()       // نقش کاربر</span>
                    );
<span class="nc" id="L688">                    sendResponse(exchange, 200, response);</span>
                    
<span class="nc" id="L690">                } catch (Exception e) {</span>
                    // مدیریت خطاهای اعتبارسنجی
<span class="nc" id="L692">                    System.err.println(&quot;❌ Token validation error: &quot; + e.getMessage());</span>
<span class="nc" id="L693">                    String errorResponse = &quot;{\&quot;valid\&quot;:false,\&quot;error\&quot;:\&quot;Token validation failed\&quot;}&quot;;</span>
<span class="nc" id="L694">                    sendResponse(exchange, 401, errorResponse);</span>
<span class="nc" id="L695">                }</span>
            } else {
<span class="nc" id="L697">                sendResponse(exchange, 405, &quot;{\&quot;error\&quot;:\&quot;Method not allowed\&quot;}&quot;);</span>
            }
<span class="nc" id="L699">        }</span>
    }
    
    /**
     * کلاس Handler برای خروج کاربران (/api/auth/logout)
     * مسئول پردازش درخواست‌های خروج و invalidate کردن token های کاربر
     * 
     * عملکرد این Handler:
     * 1. احراز هویت کاربر از طریق Access Token
     * 2. invalidate کردن تمام token های کاربر
     * 3. پاک کردن session کاربر از سرور
     * 4. بازگشت تأیید خروج موفق
     * 
     * پس از خروج، کاربر باید مجدداً وارد شود تا بتواند
     * از سرویس‌های محافظت شده استفاده کند
     * 
     * Header مورد نیاز:
     * Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...
     * 
     * فرمت پاسخ موفق:
     * &lt;pre&gt;
     * {
     *   &quot;message&quot;: &quot;Logged out successfully&quot;,
     *   &quot;status&quot;: &quot;success&quot;
     * }
     * &lt;/pre&gt;
     * 
     * @author Food Ordering System Team
     * @version 1.0
     * @since 2024
     */
<span class="nc" id="L730">    static class LogoutHandler implements HttpHandler {</span>
        @Override
        public void handle(HttpExchange exchange) throws IOException {
            // بررسی نوع درخواست - فقط POST قبول می‌شود
<span class="nc bnc" id="L734" title="All 2 branches missed.">            if (&quot;POST&quot;.equals(exchange.getRequestMethod())) {</span>
                try {
                    // اعتبارسنجی token کاربر
<span class="nc" id="L737">                    AuthResult authResult = AuthMiddleware.authenticate(exchange);</span>
                    
                    // بررسی معتبر بودن token
<span class="nc bnc" id="L740" title="All 2 branches missed.">                    if (!authResult.isAuthenticated()) {</span>
<span class="nc" id="L741">                        sendResponse(exchange, 401, &quot;{\&quot;error\&quot;:\&quot;&quot; + authResult.getErrorMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L742">                        return;</span>
                    }
                    
                    // پردازش خروج کاربر از سیستم
<span class="nc" id="L746">                    String message = authService.logout(authResult.getUserId());</span>
<span class="nc" id="L747">                    String response = &quot;{\&quot;message\&quot;:\&quot;&quot; + message + &quot;\&quot;,\&quot;status\&quot;:\&quot;success\&quot;}&quot;;</span>
<span class="nc" id="L748">                    sendResponse(exchange, 200, response);</span>
                    
                    // نمایش پیام خروج در کنسول سرور
<span class="nc" id="L751">                    System.out.println(&quot;✅ User logged out: &quot; + authResult.getPhone() + &quot; (ID: &quot; + authResult.getUserId() + &quot;)&quot;);</span>
                    
<span class="nc" id="L753">                } catch (Exception e) {</span>
                    // مدیریت خطاهای فرآیند خروج
<span class="nc" id="L755">                    System.err.println(&quot;❌ Logout error: &quot; + e.getMessage());</span>
<span class="nc" id="L756">                    String errorResponse = &quot;{\&quot;error\&quot;:\&quot;Logout failed\&quot;,\&quot;message\&quot;:\&quot;&quot; + e.getMessage().replace(&quot;\&quot;&quot;, &quot;'&quot;) + &quot;\&quot;}&quot;;</span>
<span class="nc" id="L757">                    sendResponse(exchange, 500, errorResponse);</span>
<span class="nc" id="L758">                }</span>
            } else {
<span class="nc" id="L760">                sendResponse(exchange, 405, &quot;{\&quot;error\&quot;:\&quot;Method not allowed\&quot;}&quot;);</span>
            }
<span class="nc" id="L762">        }</span>
    }
    
    /**
     * متد کمکی برای ارسال پاسخ HTTP استاندارد
     * این متد header های مناسب را تنظیم کرده و پاسخ را به کلاینت ارسال می‌کند
     * 
     * ویژگی‌های این متد:
     * - تنظیم Content-Type به application/json
     * - تنظیم CORS headers برای دسترسی cross-origin
     * - مدیریت صحیح طول محتوا
     * - بستن خودکار streams
     * 
     * کدهای وضعیت متداول:
     * - 200: OK - درخواست موفق
     * - 201: Created - منبع جدید ایجاد شد
     * - 400: Bad Request - درخواست نامعتبر
     * - 401: Unauthorized - احراز هویت لازم
     * - 404: Not Found - منبع یافت نشد
     * - 405: Method Not Allowed - HTTP method پشتیبانی نمی‌شود
     * - 500: Internal Server Error - خطای سرور
     * 
     * @param exchange شیء HttpExchange برای مدیریت درخواست/پاسخ HTTP
     * @param statusCode کد وضعیت HTTP (200, 400, 401, 404, 500, etc.)
     * @param response محتوای پاسخ (معمولاً JSON string)
     * @throws IOException در صورت خطا در نوشتن پاسخ به کلاینت
     * 
     * @author Food Ordering System Team
     * @version 1.0
     * @since 2024
     */
    private static void sendResponse(HttpExchange exchange, int statusCode, String response) throws IOException {
        // تنظیم header Content-Type برای JSON
<span class="nc" id="L795">        exchange.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
        
        // تنظیم CORS header برای امکان دسترسی از سایر domain ها
<span class="nc" id="L798">        exchange.getResponseHeaders().set(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);</span>
        
        // ارسال header های پاسخ شامل کد وضعیت و طول محتوا
<span class="nc" id="L801">        exchange.sendResponseHeaders(statusCode, response.getBytes().length);</span>
        
        // نوشتن محتوای پاسخ و بستن stream
<span class="nc" id="L804">        try (OutputStream os = exchange.getResponseBody()) {</span>
<span class="nc" id="L805">            os.write(response.getBytes());</span>
        }
<span class="nc" id="L807">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>