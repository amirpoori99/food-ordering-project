<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ItemController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.item</a> &gt; <span class="el_source">ItemController.java</span></div><h1>ItemController.java</h1><pre class="source lang-java linenums">package com.myapp.item;

import com.myapp.common.constants.ApplicationConstants;
import com.myapp.common.exceptions.NotFoundException;
import com.myapp.common.models.FoodItem;
import com.myapp.common.utils.JsonUtil;
import com.myapp.common.utils.MapParsingUtil;
import com.sun.net.httpserver.HttpExchange;
import com.sun.net.httpserver.HttpHandler;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.io.OutputStream;
import java.net.URI;
import java.util.List;
import java.util.Map;
import java.util.HashMap;

/**
 * کنترلر REST API برای مدیریت آیتم‌های غذایی
 * 
 * این کلاس تمام endpoint های مربوط به آیتم‌های غذایی را مدیریت می‌کند:
 * 
 * === عملیات CRUD آیتم‌ها ===
 * POST   /api/items                          - افزودن آیتم غذایی جدید
 * GET    /api/items/{id}                     - دریافت آیتم بر اساس شناسه
 * PUT    /api/items/{id}                     - به‌روزرسانی آیتم غذایی
 * DELETE /api/items/{id}                     - حذف آیتم غذایی
 * 
 * === مدیریت موجودی ===
 * PUT    /api/items/{id}/availability        - به‌روزرسانی وضعیت در دسترس بودن
 * PUT    /api/items/{id}/quantity           - به‌روزرسانی موجودی آیتم
 * 
 * === جستجو و فیلتر ===
 * GET    /api/items/restaurant/{restaurantId} - دریافت آیتم‌های رستوران
 * GET    /api/items/restaurant/{restaurantId}/available - آیتم‌های در دسترس رستوران
 * GET    /api/items/search                   - جستجو بر اساس کلیدواژه
 * GET    /api/items/category/{category}      - آیتم‌ها بر اساس دسته‌بندی
 * 
 * === گزارش و آمار ===
 * GET    /api/items/restaurant/{restaurantId}/categories - دسته‌بندی‌های رستوران
 * GET    /api/items/restaurant/{restaurantId}/low-stock - آیتم‌های کم موجودی
 * GET    /api/items/restaurant/{restaurantId}/statistics - آمار منوی رستوران
 * 
 * ویژگی‌های کلیدی:
 * - RESTful API Design: طراحی مطابق استانداردهای REST
 * - Advanced Error Handling: مدیریت پیشرفته خطاها
 * - Logging Integration: یکپارچگی با سیستم لاگ
 * - JSON Processing: پردازش JSON با utility classes
 * - Query Parameters: پشتیبانی از پارامترهای جستجو
 * - HTTP Status Codes: کدهای وضعیت مناسب HTTP
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 */
public class ItemController implements HttpHandler {
    
    /** Logger برای ثبت رویدادهای کنترلر */
<span class="nc" id="L61">    private static final Logger logger = LoggerFactory.getLogger(ItemController.class);</span>
    
    /** سرویس مدیریت آیتم‌های غذایی */
    private final ItemService itemService;
    
    /**
     * سازنده پیش‌فرض
     * Dependencies را به صورت خودکار ایجاد می‌کند
     */
<span class="nc" id="L70">    public ItemController() {</span>
<span class="nc" id="L71">        this.itemService = new ItemService(new ItemRepository(), new com.myapp.restaurant.RestaurantRepository());</span>
<span class="nc" id="L72">    }</span>
    
    /**
     * سازنده برای dependency injection (تست)
     * 
     * @param itemService سرویس آیتم‌ها تزریق شده
     */
<span class="nc" id="L79">    public ItemController(ItemService itemService) {</span>
<span class="nc" id="L80">        this.itemService = itemService;</span>
<span class="nc" id="L81">    }</span>
    
    /**
     * هندلر اصلی HTTP requests
     * 
     * تمام درخواست‌ها را بر اساس HTTP method و path مسیریابی می‌کند
     * Error handling جامع برای انواع مختلف exceptions
     * 
     * @param exchange شیء HTTP request/response
     */
    @Override
    public void handle(HttpExchange exchange) throws IOException {
<span class="nc" id="L93">        String method = exchange.getRequestMethod();</span>
<span class="nc" id="L94">        String path = exchange.getRequestURI().getPath();</span>
        
        try {
            // مسیریابی بر اساس HTTP method
<span class="nc bnc" id="L98" title="All 5 branches missed.">            switch (method) {</span>
                case &quot;GET&quot;:
<span class="nc" id="L100">                    handleGet(exchange, path);</span>
<span class="nc" id="L101">                    break;</span>
                case &quot;POST&quot;:
<span class="nc" id="L103">                    handlePost(exchange, path);</span>
<span class="nc" id="L104">                    break;</span>
                case &quot;PUT&quot;:
<span class="nc" id="L106">                    handlePut(exchange, path);</span>
<span class="nc" id="L107">                    break;</span>
                case &quot;DELETE&quot;:
<span class="nc" id="L109">                    handleDelete(exchange, path);</span>
<span class="nc" id="L110">                    break;</span>
                default:
<span class="nc" id="L112">                    sendErrorResponse(exchange, 405, &quot;Method not allowed&quot;);</span>
            }
<span class="nc" id="L114">        } catch (IllegalArgumentException e) {</span>
            // خطای پارامتر نامعتبر - 400 Bad Request
<span class="nc" id="L116">            sendErrorResponse(exchange, 400, e.getMessage());</span>
<span class="nc" id="L117">        } catch (NotFoundException e) {</span>
            // خطای یافت نشدن - 404 Not Found
<span class="nc" id="L119">            sendErrorResponse(exchange, 404, e.getMessage());</span>
<span class="nc" id="L120">        } catch (Exception e) {</span>
            // خطای سرور - 500 Internal Server Error
<span class="nc" id="L122">            sendErrorResponse(exchange, 500, &quot;Internal server error: &quot; + e.getMessage());</span>
<span class="nc" id="L123">        }</span>
<span class="nc" id="L124">    }</span>
    
    // ==================== GET ENDPOINTS ====================
    
    /**
     * مدیریت تمام GET requests
     * 
     * بر اساس pattern های مختلف URL، درخواست‌ها را مسیریابی می‌کند
     * از regex pattern matching برای انعطاف‌پذیری استفاده می‌کند
     * 
     * @param exchange HTTP exchange object
     * @param path مسیر درخواست
     */
    private void handleGet(HttpExchange exchange, String path) throws IOException {
<span class="nc bnc" id="L138" title="All 2 branches missed.">        if (path.matches(&quot;/api/items/\\d+&quot;)) {</span>
            // GET /api/items/{id} - دریافت آیتم بر اساس شناسه
<span class="nc" id="L140">            Long id = extractIdFromPath(path, &quot;/api/items/&quot;);</span>
<span class="nc" id="L141">            getItemById(exchange, id);</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        } else if (path.matches(&quot;/api/items/restaurant/\\d+$&quot;)) {</span>
            // GET /api/items/restaurant/{restaurantId} - آیتم‌های رستوران
<span class="nc" id="L144">            Long restaurantId = extractIdFromPath(path, &quot;/api/items/restaurant/&quot;);</span>
<span class="nc" id="L145">            getItemsByRestaurant(exchange, restaurantId);</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">        } else if (path.matches(&quot;/api/items/restaurant/\\d+/available&quot;)) {</span>
            // GET /api/items/restaurant/{restaurantId}/available - آیتم‌های در دسترس
<span class="nc" id="L148">            Long restaurantId = extractIdFromPath(path, &quot;/api/items/restaurant/&quot;, &quot;/available&quot;);</span>
<span class="nc" id="L149">            getAvailableItemsByRestaurant(exchange, restaurantId);</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">        } else if (path.matches(&quot;/api/items/restaurant/\\d+/categories&quot;)) {</span>
            // GET /api/items/restaurant/{restaurantId}/categories - دسته‌بندی‌ها
<span class="nc" id="L152">            Long restaurantId = extractIdFromPath(path, &quot;/api/items/restaurant/&quot;, &quot;/categories&quot;);</span>
<span class="nc" id="L153">            getCategoriesByRestaurant(exchange, restaurantId);</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">        } else if (path.matches(&quot;/api/items/restaurant/\\d+/low-stock&quot;)) {</span>
            // GET /api/items/restaurant/{restaurantId}/low-stock - آیتم‌های کم موجودی
<span class="nc" id="L156">            Long restaurantId = extractIdFromPath(path, &quot;/api/items/restaurant/&quot;, &quot;/low-stock&quot;);</span>
<span class="nc" id="L157">            getLowStockItems(exchange, restaurantId);</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">        } else if (path.matches(&quot;/api/items/restaurant/\\d+/statistics&quot;)) {</span>
            // GET /api/items/restaurant/{restaurantId}/statistics - آمار منو
<span class="nc" id="L160">            Long restaurantId = extractIdFromPath(path, &quot;/api/items/restaurant/&quot;, &quot;/statistics&quot;);</span>
<span class="nc" id="L161">            getMenuStatistics(exchange, restaurantId);</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">        } else if (path.equals(&quot;/api/items/search&quot;)) {</span>
            // GET /api/items/search?keyword={keyword} - جستجوی آیتم‌ها
<span class="nc" id="L164">            searchItems(exchange);</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">        } else if (path.matches(&quot;/api/items/category/.+&quot;)) {</span>
            // GET /api/items/category/{category} - آیتم‌ها بر اساس دسته‌بندی
<span class="nc" id="L167">            String category = extractStringFromPath(path, &quot;/api/items/category/&quot;);</span>
<span class="nc" id="L168">            getItemsByCategory(exchange, category);</span>
<span class="nc" id="L169">        } else {</span>
<span class="nc" id="L170">            sendErrorResponse(exchange, 404, &quot;Endpoint not found&quot;);</span>
        }
<span class="nc" id="L172">    }</span>
    
    /**
     * دریافت آیتم غذایی بر اساس شناسه
     * 
     * @param exchange HTTP exchange
     * @param id شناسه آیتم
     */
    private void getItemById(HttpExchange exchange, Long id) throws IOException {
<span class="nc" id="L181">        FoodItem item = itemService.getItem(id);</span>
<span class="nc" id="L182">        sendJsonResponse(exchange, 200, item);</span>
<span class="nc" id="L183">    }</span>
    
    /**
     * دریافت تمام آیتم‌های یک رستوران
     * 
     * @param exchange HTTP exchange
     * @param restaurantId شناسه رستوران
     */
    private void getItemsByRestaurant(HttpExchange exchange, Long restaurantId) throws IOException {
<span class="nc" id="L192">        List&lt;FoodItem&gt; items = itemService.getRestaurantItems(restaurantId);</span>
<span class="nc" id="L193">        sendJsonResponse(exchange, 200, items);</span>
<span class="nc" id="L194">    }</span>
    
    /**
     * دریافت آیتم‌های در دسترس یک رستوران
     * 
     * @param exchange HTTP exchange
     * @param restaurantId شناسه رستوران
     */
    private void getAvailableItemsByRestaurant(HttpExchange exchange, Long restaurantId) throws IOException {
<span class="nc" id="L203">        List&lt;FoodItem&gt; items = itemService.getAvailableItems(restaurantId);</span>
<span class="nc" id="L204">        sendJsonResponse(exchange, 200, items);</span>
<span class="nc" id="L205">    }</span>
    
    /**
     * دریافت دسته‌بندی‌های رستوران
     * 
     * @param exchange HTTP exchange
     * @param restaurantId شناسه رستوران
     */
    private void getCategoriesByRestaurant(HttpExchange exchange, Long restaurantId) throws IOException {
<span class="nc" id="L214">        List&lt;String&gt; categories = itemService.getRestaurantCategories(restaurantId);</span>
<span class="nc" id="L215">        Map&lt;String, Object&gt; response = Map.of(&quot;categories&quot;, categories);</span>
<span class="nc" id="L216">        sendJsonResponse(exchange, 200, response);</span>
<span class="nc" id="L217">    }</span>
    
    /**
     * دریافت آیتم‌های کم موجودی رستوران
     * 
     * Query parameter threshold برای تنظیم آستانه کم موجودی
     * 
     * @param exchange HTTP exchange
     * @param restaurantId شناسه رستوران
     */
    private void getLowStockItems(HttpExchange exchange, Long restaurantId) throws IOException {
<span class="nc" id="L228">        String query = exchange.getRequestURI().getQuery();</span>
<span class="nc" id="L229">        int threshold = 5; // آستانه پیش‌فرض</span>
<span class="nc bnc" id="L230" title="All 4 branches missed.">        if (query != null &amp;&amp; query.contains(&quot;threshold=&quot;)) {</span>
            try {
<span class="nc" id="L232">                threshold = Integer.parseInt(extractQueryParam(query, &quot;threshold&quot;));</span>
<span class="nc" id="L233">            } catch (NumberFormatException e) {</span>
                // استفاده از مقدار پیش‌فرض
<span class="nc" id="L235">            }</span>
        }
        
<span class="nc" id="L238">        List&lt;FoodItem&gt; items = itemService.getLowStockItems(restaurantId, threshold);</span>
<span class="nc" id="L239">        Map&lt;String, Object&gt; response = Map.of(&quot;items&quot;, items, &quot;threshold&quot;, threshold);</span>
<span class="nc" id="L240">        sendJsonResponse(exchange, 200, response);</span>
<span class="nc" id="L241">    }</span>
    
    /**
     * دریافت آمار منوی رستوران
     * 
     * @param exchange HTTP exchange
     * @param restaurantId شناسه رستوران
     */
    private void getMenuStatistics(HttpExchange exchange, Long restaurantId) throws IOException {
<span class="nc" id="L250">        ItemService.MenuStatistics stats = itemService.getMenuStatistics(restaurantId);</span>
<span class="nc" id="L251">        sendJsonResponse(exchange, 200, stats);</span>
<span class="nc" id="L252">    }</span>
    
    /**
     * جستجوی آیتم‌ها بر اساس کلیدواژه
     * 
     * Query parameter keyword الزامی است
     * 
     * @param exchange HTTP exchange
     */
    private void searchItems(HttpExchange exchange) throws IOException {
<span class="nc" id="L262">        String query = exchange.getRequestURI().getQuery();</span>
<span class="nc bnc" id="L263" title="All 4 branches missed.">        if (query == null || !query.contains(&quot;keyword=&quot;)) {</span>
<span class="nc" id="L264">            sendErrorResponse(exchange, 400, &quot;Missing keyword parameter&quot;);</span>
<span class="nc" id="L265">            return;</span>
        }
        
<span class="nc" id="L268">        String keyword = extractQueryParam(query, &quot;keyword&quot;);</span>
<span class="nc" id="L269">        List&lt;FoodItem&gt; items = itemService.searchItems(keyword);</span>
<span class="nc" id="L270">        Map&lt;String, Object&gt; response = Map.of(&quot;items&quot;, items, &quot;keyword&quot;, keyword);</span>
<span class="nc" id="L271">        sendJsonResponse(exchange, 200, response);</span>
<span class="nc" id="L272">    }</span>
    
    /**
     * دریافت آیتم‌ها بر اساس دسته‌بندی
     * 
     * @param exchange HTTP exchange
     * @param category نام دسته‌بندی
     */
    private void getItemsByCategory(HttpExchange exchange, String category) throws IOException {
<span class="nc" id="L281">        List&lt;FoodItem&gt; items = itemService.getItemsByCategory(category);</span>
<span class="nc" id="L282">        Map&lt;String, Object&gt; response = Map.of(&quot;items&quot;, items, &quot;category&quot;, category);</span>
<span class="nc" id="L283">        sendJsonResponse(exchange, 200, response);</span>
<span class="nc" id="L284">    }</span>
    
    // ==================== POST ENDPOINTS ====================
    
    /**
     * مدیریت تمام POST requests
     * 
     * @param exchange HTTP exchange
     * @param path مسیر درخواست
     */
    private void handlePost(HttpExchange exchange, String path) throws IOException {
<span class="nc bnc" id="L295" title="All 2 branches missed.">        if (path.equals(&quot;/api/items&quot;)) {</span>
            // POST /api/items - افزودن آیتم جدید
<span class="nc" id="L297">            addItem(exchange);</span>
        } else {
<span class="nc" id="L299">            sendErrorResponse(exchange, 404, &quot;Endpoint not found&quot;);</span>
        }
<span class="nc" id="L301">    }</span>
    
    /**
     * افزودن آیتم غذایی جدید
     * 
     * JSON Request Body:
     * {
     *   &quot;restaurantId&quot;: number,
     *   &quot;name&quot;: string,
     *   &quot;description&quot;: string (اختیاری),
     *   &quot;price&quot;: number,
     *   &quot;category&quot;: string,
     *   &quot;imageUrl&quot;: string (اختیاری),
     *   &quot;quantity&quot;: number (اختیاری، پیش‌فرض 1)
     * }
     * 
     * @param exchange HTTP exchange
     */
    private void addItem(HttpExchange exchange) throws IOException {
        try {
<span class="nc" id="L321">            Map&lt;String, Object&gt; requestData = parseJsonRequest(exchange);</span>
            
            // اعتبارسنجی فیلدهای الزامی
<span class="nc" id="L324">            MapParsingUtil.validateRequiredFields(requestData, &quot;restaurantId&quot;, &quot;name&quot;, &quot;price&quot;, &quot;category&quot;);</span>
            
<span class="nc" id="L326">            Long restaurantId = MapParsingUtil.getLongFromMap(requestData, &quot;restaurantId&quot;);</span>
<span class="nc" id="L327">            String name = MapParsingUtil.getStringFromMap(requestData, &quot;name&quot;);</span>
<span class="nc" id="L328">            String description = MapParsingUtil.getOptionalStringFromMap(requestData, &quot;description&quot;, &quot;&quot;);</span>
<span class="nc" id="L329">            Double price = MapParsingUtil.getDoubleFromMap(requestData, &quot;price&quot;);</span>
<span class="nc" id="L330">            String category = MapParsingUtil.getStringFromMap(requestData, &quot;category&quot;);</span>
<span class="nc" id="L331">            String imageUrl = MapParsingUtil.getOptionalStringFromMap(requestData, &quot;imageUrl&quot;, null);</span>
<span class="nc" id="L332">            Integer quantity = MapParsingUtil.getOptionalIntegerFromMap(requestData, &quot;quantity&quot;, 1);</span>
            
<span class="nc" id="L334">            logger.info(&quot;Adding new item: {} for restaurant: {}&quot;, name, restaurantId);</span>
<span class="nc" id="L335">            FoodItem item = itemService.addItem(restaurantId, name, description, price, category, imageUrl, quantity);</span>
            
<span class="nc" id="L337">            sendJsonResponse(exchange, ApplicationConstants.HTTP_STATUS.CREATED, item);</span>
<span class="nc" id="L338">        } catch (Exception e) {</span>
<span class="nc" id="L339">            logger.error(&quot;Error adding item: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L340">            throw e;</span>
<span class="nc" id="L341">        }</span>
<span class="nc" id="L342">    }</span>
    
    // ==================== PUT ENDPOINTS ====================
    
    /**
     * مدیریت تمام PUT requests
     * 
     * شامل عملیات‌های به‌روزرسانی آیتم‌ها
     * 
     * @param exchange HTTP exchange
     * @param path مسیر درخواست
     */
    private void handlePut(HttpExchange exchange, String path) throws IOException {
<span class="nc bnc" id="L355" title="All 2 branches missed.">        if (path.matches(&quot;/api/items/\\d+$&quot;)) {</span>
            // PUT /api/items/{id} - به‌روزرسانی آیتم
<span class="nc" id="L357">            Long id = extractIdFromPath(path, &quot;/api/items/&quot;);</span>
<span class="nc" id="L358">            updateItem(exchange, id);</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">        } else if (path.matches(&quot;/api/items/\\d+/availability&quot;)) {</span>
            // PUT /api/items/{id}/availability - به‌روزرسانی وضعیت در دسترس بودن
<span class="nc" id="L361">            Long id = extractIdFromPath(path, &quot;/api/items/&quot;, &quot;/availability&quot;);</span>
<span class="nc" id="L362">            updateItemAvailability(exchange, id);</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">        } else if (path.matches(&quot;/api/items/\\d+/quantity&quot;)) {</span>
            // PUT /api/items/{id}/quantity - به‌روزرسانی موجودی
<span class="nc" id="L365">            Long id = extractIdFromPath(path, &quot;/api/items/&quot;, &quot;/quantity&quot;);</span>
<span class="nc" id="L366">            updateItemQuantity(exchange, id);</span>
<span class="nc" id="L367">        } else {</span>
<span class="nc" id="L368">            sendErrorResponse(exchange, 404, &quot;Endpoint not found&quot;);</span>
        }
<span class="nc" id="L370">    }</span>
    
    /**
     * به‌روزرسانی آیتم غذایی
     * 
     * فقط فیلدهای ارائه شده در JSON به‌روزرسانی می‌شوند
     * 
     * JSON Request Body:
     * {
     *   &quot;name&quot;: string (اختیاری),
     *   &quot;description&quot;: string (اختیاری),
     *   &quot;price&quot;: number (اختیاری),
     *   &quot;category&quot;: string (اختیاری),
     *   &quot;imageUrl&quot;: string (اختیاری),
     *   &quot;quantity&quot;: number (اختیاری)
     * }
     * 
     * @param exchange HTTP exchange
     * @param id شناسه آیتم
     */
    private void updateItem(HttpExchange exchange, Long id) throws IOException {
<span class="nc" id="L391">        Map&lt;String, Object&gt; requestData = parseJsonRequest(exchange);</span>
        
<span class="nc" id="L393">        String name = MapParsingUtil.getOptionalStringFromMap(requestData, &quot;name&quot;, null);</span>
<span class="nc" id="L394">        String description = MapParsingUtil.getOptionalStringFromMap(requestData, &quot;description&quot;, null);</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">        Double price = requestData.containsKey(&quot;price&quot;) ? MapParsingUtil.getDoubleFromMap(requestData, &quot;price&quot;) : null;</span>
<span class="nc" id="L396">        String category = MapParsingUtil.getOptionalStringFromMap(requestData, &quot;category&quot;, null);</span>
<span class="nc" id="L397">        String imageUrl = MapParsingUtil.getOptionalStringFromMap(requestData, &quot;imageUrl&quot;, null);</span>
<span class="nc" id="L398">        Integer quantity = MapParsingUtil.getOptionalIntegerFromMap(requestData, &quot;quantity&quot;, null);</span>
        
<span class="nc" id="L400">        FoodItem item = itemService.updateItem(id, name, description, price, category, imageUrl, quantity);</span>
<span class="nc" id="L401">        sendJsonResponse(exchange, 200, item);</span>
<span class="nc" id="L402">    }</span>
    
    /**
     * به‌روزرسانی وضعیت در دسترس بودن آیتم
     * 
     * JSON Request Body:
     * {
     *   &quot;available&quot;: boolean
     * }
     * 
     * @param exchange HTTP exchange
     * @param id شناسه آیتم
     */
    private void updateItemAvailability(HttpExchange exchange, Long id) throws IOException {
        try {
<span class="nc" id="L417">            Map&lt;String, Object&gt; requestData = parseJsonRequest(exchange);</span>
<span class="nc" id="L418">            Boolean available = MapParsingUtil.getBooleanFromMap(requestData, &quot;available&quot;);</span>
            
<span class="nc" id="L420">            logger.info(&quot;Updating availability for item {} to {}&quot;, id, available);</span>
<span class="nc" id="L421">            itemService.updateAvailability(id, available);</span>
            
<span class="nc" id="L423">            sendJsonResponse(exchange, ApplicationConstants.HTTP_STATUS.OK, </span>
<span class="nc" id="L424">                Map.of(&quot;message&quot;, ApplicationConstants.SUCCESS_MESSAGES.ITEM_UPDATED));</span>
<span class="nc" id="L425">        } catch (Exception e) {</span>
<span class="nc" id="L426">            logger.error(&quot;Error updating item availability: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L427">            throw e;</span>
<span class="nc" id="L428">        }</span>
<span class="nc" id="L429">    }</span>
    
    /**
     * به‌روزرسانی موجودی آیتم
     * 
     * JSON Request Body:
     * {
     *   &quot;quantity&quot;: number
     * }
     * 
     * @param exchange HTTP exchange
     * @param id شناسه آیتم
     */
    private void updateItemQuantity(HttpExchange exchange, Long id) throws IOException {
<span class="nc" id="L443">        Map&lt;String, Object&gt; requestData = parseJsonRequest(exchange);</span>
<span class="nc" id="L444">        Integer quantity = MapParsingUtil.getIntegerFromMap(requestData, &quot;quantity&quot;);</span>
        
<span class="nc" id="L446">        itemService.updateQuantity(id, quantity);</span>
<span class="nc" id="L447">        sendJsonResponse(exchange, 200, Map.of(&quot;message&quot;, &quot;Item quantity updated successfully&quot;));</span>
<span class="nc" id="L448">    }</span>
    
    // ==================== DELETE ENDPOINTS ====================
    
    /**
     * مدیریت تمام DELETE requests
     * 
     * @param exchange HTTP exchange
     * @param path مسیر درخواست
     */
    private void handleDelete(HttpExchange exchange, String path) throws IOException {
<span class="nc bnc" id="L459" title="All 2 branches missed.">        if (path.matches(&quot;/api/items/\\d+&quot;)) {</span>
            // DELETE /api/items/{id} - حذف آیتم
<span class="nc" id="L461">            Long id = extractIdFromPath(path, &quot;/api/items/&quot;);</span>
<span class="nc" id="L462">            deleteItem(exchange, id);</span>
<span class="nc" id="L463">        } else {</span>
<span class="nc" id="L464">            sendErrorResponse(exchange, 404, &quot;Endpoint not found&quot;);</span>
        }
<span class="nc" id="L466">    }</span>
    
    /**
     * حذف آیتم غذایی
     * 
     * @param exchange HTTP exchange
     * @param id شناسه آیتم
     */
    private void deleteItem(HttpExchange exchange, Long id) throws IOException {
<span class="nc" id="L475">        itemService.deleteItem(id);</span>
<span class="nc" id="L476">        sendJsonResponse(exchange, 200, Map.of(&quot;message&quot;, &quot;Item deleted successfully&quot;));</span>
<span class="nc" id="L477">    }</span>
    
    // ==================== UTILITY METHODS ====================
    
    /**
     * استخراج شناسه از مسیر URL با prefix
     * 
     * @param path مسیر URL
     * @param prefix پیشوند برای حذف
     * @return شناسه استخراج شده
     */
    private Long extractIdFromPath(String path, String prefix) {
<span class="nc" id="L489">        return Long.parseLong(path.substring(prefix.length()));</span>
    }
    
    /**
     * استخراج شناسه از مسیر URL با prefix و suffix
     * 
     * @param path مسیر URL
     * @param prefix پیشوند برای حذف
     * @param suffix پسوند برای حذف
     * @return شناسه استخراج شده
     */
    private Long extractIdFromPath(String path, String prefix, String suffix) {
<span class="nc" id="L501">        int start = prefix.length();</span>
<span class="nc" id="L502">        int end = path.indexOf(suffix, start);</span>
<span class="nc" id="L503">        return Long.parseLong(path.substring(start, end));</span>
    }
    
    /**
     * استخراج رشته از مسیر URL
     * 
     * @param path مسیر URL
     * @param prefix پیشوند برای حذف
     * @return رشته استخراج شده
     */
    private String extractStringFromPath(String path, String prefix) {
<span class="nc" id="L514">        return path.substring(prefix.length());</span>
    }
    
    /**
     * استخراج پارامتر از query string
     * 
     * @param query رشته query
     * @param param نام پارامتر
     * @return مقدار پارامتر یا null
     */
    private String extractQueryParam(String query, String param) {
<span class="nc" id="L525">        String[] pairs = query.split(&quot;&amp;&quot;);</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">        for (String pair : pairs) {</span>
<span class="nc" id="L527">            String[] kv = pair.split(&quot;=&quot;);</span>
<span class="nc bnc" id="L528" title="All 4 branches missed.">            if (kv.length == 2 &amp;&amp; kv[0].equals(param)) {</span>
<span class="nc" id="L529">                return java.net.URLDecoder.decode(kv[1], java.nio.charset.StandardCharsets.UTF_8);</span>
            }
        }
<span class="nc" id="L532">        return null;</span>
    }
    
    /**
     * پارس درخواست JSON از HTTP request body
     * 
     * از JsonUtil استفاده می‌کند برای سریال‌سازی
     * 
     * @param exchange HTTP exchange
     * @return Map حاوی داده‌های JSON
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    private Map&lt;String, Object&gt; parseJsonRequest(HttpExchange exchange) throws IOException {
<span class="nc" id="L545">        String requestBody = new String(exchange.getRequestBody().readAllBytes());</span>
<span class="nc" id="L546">        return JsonUtil.fromJson(requestBody, Map.class);</span>
    }
    
    /**
     * ارسال پاسخ JSON
     * 
     * از JsonUtil برای تبدیل Object به JSON استفاده می‌کند
     * 
     * @param exchange HTTP exchange
     * @param statusCode کد وضعیت HTTP
     * @param data داده برای serialize
     */
    private void sendJsonResponse(HttpExchange exchange, int statusCode, Object data) throws IOException {
<span class="nc" id="L559">        String jsonResponse = JsonUtil.toJson(data);</span>
<span class="nc" id="L560">        exchange.getResponseHeaders().set(&quot;Content-Type&quot;, ApplicationConstants.CONTENT_TYPE.APPLICATION_JSON);</span>
<span class="nc" id="L561">        exchange.sendResponseHeaders(statusCode, jsonResponse.getBytes().length);</span>
<span class="nc" id="L562">        try (OutputStream os = exchange.getResponseBody()) {</span>
<span class="nc" id="L563">            os.write(jsonResponse.getBytes());</span>
        }
<span class="nc" id="L565">    }</span>
    
    /**
     * ارسال پاسخ خطا
     * 
     * شامل timestamp و جزئیات بیشتر خطا
     * 
     * @param exchange HTTP exchange
     * @param statusCode کد خطای HTTP
     * @param message پیام خطا
     */
    private void sendErrorResponse(HttpExchange exchange, int statusCode, String message) throws IOException {
<span class="nc" id="L577">        Map&lt;String, Object&gt; errorResponse = Map.of(</span>
            &quot;error&quot;, message,
<span class="nc" id="L579">            &quot;status&quot;, statusCode,</span>
<span class="nc" id="L580">            &quot;timestamp&quot;, java.time.Instant.now().toString()</span>
        );
<span class="nc" id="L582">        logger.warn(&quot;Sending error response: {} - {}&quot;, statusCode, message);</span>
<span class="nc" id="L583">        sendJsonResponse(exchange, statusCode, errorResponse);</span>
<span class="nc" id="L584">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>