<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ItemRepository.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.item</a> &gt; <span class="el_source">ItemRepository.java</span></div><h1>ItemRepository.java</h1><pre class="source lang-java linenums">package com.myapp.item;

import com.myapp.common.models.FoodItem;
import com.myapp.common.utils.DatabaseUtil;
import org.hibernate.Session;
import org.hibernate.Transaction;
import org.hibernate.query.Query;

import java.util.List;
import java.util.Optional;

/**
 * Repository لایه دسترسی به داده‌های آیتم‌های غذایی
 * 
 * این کلاس مسئول تمام عملیات دیتابیس مربوط به آیتم‌های غذایی است:
 * 
 * === عملیات CRUD ===
 * - ایجاد آیتم جدید
 * - خواندن آیتم‌ها با معیارهای مختلف
 * - به‌روزرسانی آیتم‌های موجود
 * - حذف آیتم‌ها
 * 
 * === جستجو و فیلتر ===
 * - جستجو بر اساس کلیدواژه
 * - فیلتر بر اساس رستوران
 * - فیلتر بر اساس دسته‌بندی
 * - یافتن آیتم‌های در دسترس
 * - یافتن آیتم‌های کم موجودی
 * 
 * === مدیریت موجودی ===
 * - به‌روزرسانی وضعیت در دسترس بودن
 * - به‌روزرسانی مقدار موجودی
 * - یافتن آیتم‌های کم موجودی
 * 
 * === گزارش و آمار ===
 * - شمارش آیتم‌ها
 * - دسته‌بندی‌های رستوران
 * - آمار موجودی
 * 
 * ویژگی‌های کلیدی:
 * - HQL Queries: استفاده از Hibernate Query Language
 * - Transaction Management: مدیریت تراکنش‌ها
 * - Resource Management: مدیریت Session ها
 * - Query Optimization: بهینه‌سازی پرس و جوها
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 */
<span class="fc" id="L50">public class ItemRepository {</span>

    /**
     * ذخیره آیتم غذایی جدید در دیتابیس
     * 
     * این متد برای ایجاد آیتم‌های جدید استفاده می‌شود که ID آن‌ها توسط دیتابیس
     * به صورت خودکار تولید می‌شود.
     * 
     * @param foodItem آیتم غذایی جدید برای ذخیره
     * @return آیتم ذخیره شده همراه با ID تولید شده
     */
    public FoodItem saveNew(FoodItem foodItem) {
<span class="fc" id="L62">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L63">            Transaction tx = session.beginTransaction();</span>
<span class="fc" id="L64">            session.persist(foodItem);   // شناسه به صورت خودکار تولید می‌شود</span>
<span class="fc" id="L65">            tx.commit();</span>
<span class="fc" id="L66">            return foodItem;</span>
        }
    }

    /**
     * ذخیره یا به‌روزرسانی آیتم غذایی
     * 
     * این متد بسته به وجود یا عدم وجود ID، آیتم را ایجاد یا به‌روزرسانی می‌کند:
     * - اگر ID وجود نداشته باشد: آیتم جدید ایجاد می‌شود
     * - اگر ID موجود باشد: آیتم موجود به‌روزرسانی می‌شود
     * 
     * @param foodItem آیتم غذایی برای ذخیره یا به‌روزرسانی
     * @return آیتم ذخیره شده
     */
    public FoodItem save(FoodItem foodItem) {
<span class="fc bfc" id="L81" title="All 2 branches covered.">        if (foodItem.getId() == null) {</span>
<span class="fc" id="L82">            return saveNew(foodItem);</span>
        } else {
<span class="fc" id="L84">            try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L85">                Transaction tx = session.beginTransaction();</span>
<span class="fc" id="L86">                session.merge(foodItem);</span>
<span class="fc" id="L87">                tx.commit();</span>
<span class="fc" id="L88">                return foodItem;</span>
            }
        }
    }

    /**
     * جستجوی آیتم غذایی بر اساس شناسه
     * 
     * @param id شناسه آیتم غذایی
     * @return Optional حاوی آیتم یافت شده یا خالی اگر وجود نداشته باشد
     */
    public Optional&lt;FoodItem&gt; findById(Long id) {
<span class="fc" id="L100">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L101">            return Optional.ofNullable(session.get(FoodItem.class, id));</span>
        }
    }

    /**
     * دریافت تمام آیتم‌های غذایی یک رستوران
     * 
     * این متد تمام آیتم‌های یک رستوران را برمی‌گرداند بدون در نظر گیری
     * وضعیت available یا موجودی آن‌ها.
     * 
     * @param restaurantId شناسه رستوران
     * @return لیست تمام آیتم‌های رستوران
     */
    public List&lt;FoodItem&gt; findByRestaurant(Long restaurantId) {
<span class="fc" id="L115">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L116">            Query&lt;FoodItem&gt; q = session.createQuery(</span>
                    &quot;from FoodItem where restaurant.id = :restaurantId&quot;, FoodItem.class);
<span class="fc" id="L118">            q.setParameter(&quot;restaurantId&quot;, restaurantId);</span>
<span class="fc" id="L119">            return q.getResultList();</span>
        }
    }

    /**
     * دریافت آیتم‌های در دسترس یک رستوران
     * 
     * این متد فقط آیتم‌هایی را برمی‌گرداند که:
     * - متعلق به رستوران مشخص شده باشند
     * - وضعیت available آن‌ها true باشد
     * - موجودی آن‌ها بیشتر از صفر باشد
     * 
     * @param restaurantId شناسه رستوران
     * @return لیست آیتم‌های قابل سفارش رستوران
     */
    public List&lt;FoodItem&gt; findAvailableByRestaurant(Long restaurantId) {
<span class="fc" id="L135">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L136">            Query&lt;FoodItem&gt; q = session.createQuery(</span>
                    &quot;from FoodItem where restaurant.id = :restaurantId and available = true and quantity &gt; 0&quot;, 
                    FoodItem.class);
<span class="fc" id="L139">            q.setParameter(&quot;restaurantId&quot;, restaurantId);</span>
<span class="fc" id="L140">            return q.getResultList();</span>
        }
    }

    /**
     * جستجوی آیتم‌ها بر اساس دسته‌بندی
     * 
     * این متد فقط آیتم‌های در دسترس (available = true) را برمی‌گرداند
     * که در دسته‌بندی مشخص شده قرار دارند.
     * 
     * @param category نام دسته‌بندی مورد نظر
     * @return لیست آیتم‌های در دسترس در آن دسته‌بندی
     */
    public List&lt;FoodItem&gt; findByCategory(String category) {
<span class="fc" id="L154">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L155">            Query&lt;FoodItem&gt; q = session.createQuery(</span>
                    &quot;from FoodItem where category = :category and available = true&quot;, FoodItem.class);
<span class="fc" id="L157">            q.setParameter(&quot;category&quot;, category);</span>
<span class="fc" id="L158">            return q.getResultList();</span>
        }
    }

    /**
     * جستجوی آیتم‌ها بر اساس کلیدواژه
     * 
     * این متد در نام و کلیدواژه‌های آیتم‌ها جستجو می‌کند:
     * - جستجو case-insensitive است
     * - هم در نام و هم در فیلد keywords جستجو می‌شود
     * - فقط آیتم‌های در دسترس (available = true) برگردانده می‌شوند
     * - اگر کلیدواژه خالی باشد، لیست خالی برگردانده می‌شود
     * 
     * @param keyword کلیدواژه جستجو
     * @return لیست آیتم‌های یافت شده
     */
    public List&lt;FoodItem&gt; searchByKeyword(String keyword) {
        // برگرداندن لیست خالی اگر کلیدواژه null یا خالی باشد
<span class="pc bpc" id="L176" title="1 of 4 branches missed.">        if (keyword == null || keyword.trim().isEmpty()) {</span>
<span class="fc" id="L177">            return List.of();</span>
        }
        
<span class="fc" id="L180">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L181">            Query&lt;FoodItem&gt; q = session.createQuery(</span>
                    &quot;from FoodItem where (lower(name) like :keyword or lower(keywords) like :keyword) and available = true&quot;, 
                    FoodItem.class);
<span class="fc" id="L184">            q.setParameter(&quot;keyword&quot;, &quot;%&quot; + keyword.toLowerCase().trim() + &quot;%&quot;);</span>
<span class="fc" id="L185">            return q.getResultList();</span>
        }
    }

    /**
     * دریافت تمام آیتم‌های غذایی موجود در سیستم
     * 
     * این متد بدون هیچ فیلتری تمام آیتم‌ها را برمی‌گرداند.
     * معمولاً برای مدیریت سیستم و گزارش‌گیری استفاده می‌شود.
     * 
     * @return لیست تمام آیتم‌های غذایی
     */
    public List&lt;FoodItem&gt; findAll() {
<span class="fc" id="L198">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L199">            Query&lt;FoodItem&gt; q = session.createQuery(&quot;from FoodItem&quot;, FoodItem.class);</span>
<span class="fc" id="L200">            return q.getResultList();</span>
        }
    }

    /**
     * حذف آیتم غذایی بر اساس شناسه
     * 
     * این متد آیتم را از دیتابیس حذف می‌کند. اگر آیتم با شناسه مشخص شده
     * وجود نداشته باشد، هیچ عملی انجام نمی‌شود.
     * 
     * @param id شناسه آیتم برای حذف
     */
    public void delete(Long id) {
<span class="fc" id="L213">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L214">            Transaction tx = session.beginTransaction();</span>
<span class="fc" id="L215">            FoodItem foodItem = session.get(FoodItem.class, id);</span>
<span class="fc bfc" id="L216" title="All 2 branches covered.">            if (foodItem != null) {</span>
<span class="fc" id="L217">                session.remove(foodItem);</span>
            }
<span class="fc" id="L219">            tx.commit();</span>
        }
<span class="fc" id="L221">    }</span>

    /**
     * به‌روزرسانی وضعیت در دسترس بودن آیتم
     * 
     * این متد وضعیت available یک آیتم را تغییر می‌دهد.
     * اگر آیتم با شناسه مشخص شده وجود نداشته باشد، هیچ عملی انجام نمی‌شود.
     * 
     * @param id شناسه آیتم
     * @param available وضعیت جدید در دسترس بودن
     */
    public void updateAvailability(Long id, boolean available) {
<span class="fc" id="L233">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L234">            Transaction tx = session.beginTransaction();</span>
<span class="fc" id="L235">            FoodItem foodItem = session.get(FoodItem.class, id);</span>
<span class="fc bfc" id="L236" title="All 2 branches covered.">            if (foodItem != null) {</span>
<span class="fc" id="L237">                foodItem.setAvailable(available);</span>
            }
<span class="fc" id="L239">            tx.commit();</span>
        }
<span class="fc" id="L241">    }</span>

    /**
     * به‌روزرسانی موجودی آیتم
     * 
     * این متد مقدار موجودی یک آیتم را تغییر می‌دهد.
     * اگر آیتم با شناسه مشخص شده وجود نداشته باشد، هیچ عملی انجام نمی‌شود.
     * 
     * @param id شناسه آیتم
     * @param quantity مقدار جدید موجودی
     */
    public void updateQuantity(Long id, Integer quantity) {
<span class="fc" id="L253">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L254">            Transaction tx = session.beginTransaction();</span>
<span class="fc" id="L255">            FoodItem foodItem = session.get(FoodItem.class, id);</span>
<span class="fc bfc" id="L256" title="All 2 branches covered.">            if (foodItem != null) {</span>
<span class="fc" id="L257">                foodItem.setQuantity(quantity);</span>
            }
<span class="fc" id="L259">            tx.commit();</span>
        }
<span class="fc" id="L261">    }</span>

    /**
     * حذف تمام آیتم‌های غذایی از دیتابیس
     * 
     * این متد utility برای پاک‌سازی دیتابیس در طول تست‌ها استفاده می‌شود.
     * تمام آیتم‌ها را بدون در نظر گیری رستوران یا سایر شرایط حذف می‌کند.
     * 
     * ⚠️ توجه: این متد تمام داده‌ها را پاک می‌کند
     */
    public void deleteAll() {
<span class="fc" id="L272">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L273">            Transaction tx = session.beginTransaction();</span>
<span class="fc" id="L274">            session.createQuery(&quot;delete from FoodItem&quot;).executeUpdate();</span>
<span class="fc" id="L275">            tx.commit();</span>
        }
<span class="fc" id="L277">    }</span>
    
    /**
     * بررسی وجود آیتم بر اساس شناسه
     * 
     * این متد چک می‌کند که آیا آیتمی با شناسه مشخص شده در دیتابیس وجود دارد یا خیر.
     * 
     * @param id شناسه آیتم برای بررسی
     * @return true اگر آیتم وجود داشته باشد، در غیر این صورت false
     */
    public boolean existsById(Long id) {
<span class="fc" id="L288">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L289">            FoodItem foodItem = session.get(FoodItem.class, id);</span>
<span class="fc bfc" id="L290" title="All 2 branches covered.">            return foodItem != null;</span>
        }
    }
    
    /**
     * جستجوی آیتم‌ها بر اساس رستوران و دسته‌بندی
     * 
     * این متد آیتم‌هایی را برمی‌گرداند که هم متعلق به رستوران مشخص شده
     * و هم در دسته‌بندی مورد نظر قرار دارند.
     * 
     * @param restaurantId شناسه رستوران
     * @param category نام دسته‌بندی
     * @return لیست آیتم‌های یافت شده
     */
    public List&lt;FoodItem&gt; findByRestaurantAndCategory(Long restaurantId, String category) {
<span class="fc" id="L305">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L306">            Query&lt;FoodItem&gt; q = session.createQuery(</span>
                    &quot;from FoodItem where restaurant.id = :restaurantId and category = :category&quot;, 
                    FoodItem.class);
<span class="fc" id="L309">            q.setParameter(&quot;restaurantId&quot;, restaurantId);</span>
<span class="fc" id="L310">            q.setParameter(&quot;category&quot;, category);</span>
<span class="fc" id="L311">            return q.getResultList();</span>
        }
    }
    
    /**
     * دریافت لیست دسته‌بندی‌های موجود در رستوران
     * 
     * این متد تمام دسته‌بندی‌های منحصر به فردی که در رستوران مشخص شده
     * استفاده می‌شوند را برمی‌گرداند.
     * 
     * @param restaurantId شناسه رستوران
     * @return لیست نام دسته‌بندی‌های منحصر به فرد
     */
    public List&lt;String&gt; getCategoriesByRestaurant(Long restaurantId) {
<span class="fc" id="L325">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L326">            Query&lt;String&gt; q = session.createQuery(</span>
                    &quot;select distinct category from FoodItem where restaurant.id = :restaurantId&quot;, 
                    String.class);
<span class="fc" id="L329">            q.setParameter(&quot;restaurantId&quot;, restaurantId);</span>
<span class="fc" id="L330">            return q.getResultList();</span>
        }
    }
    
    /**
     * جستجوی آیتم‌های کم موجودی در رستوران
     * 
     * این متد آیتم‌هایی را برمی‌گرداند که موجودی آن‌ها کمتر یا مساوی
     * حد آستانه مشخص شده باشد.
     * 
     * @param restaurantId شناسه رستوران
     * @param threshold حد آستانه موجودی
     * @return لیست آیتم‌های کم موجودی
     */
    public List&lt;FoodItem&gt; findLowStockByRestaurant(Long restaurantId, int threshold) {
<span class="fc" id="L345">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L346">            Query&lt;FoodItem&gt; q = session.createQuery(</span>
                    &quot;from FoodItem where restaurant.id = :restaurantId and quantity &lt;= :threshold&quot;, 
                    FoodItem.class);
<span class="fc" id="L349">            q.setParameter(&quot;restaurantId&quot;, restaurantId);</span>
<span class="fc" id="L350">            q.setParameter(&quot;threshold&quot;, threshold);</span>
<span class="fc" id="L351">            return q.getResultList();</span>
        }
    }
    
    /**
     * شمارش کل آیتم‌های غذایی رستوران
     * 
     * این متد تعداد کل آیتم‌های یک رستوران را بدون در نظر گیری
     * وضعیت availability یا موجودی برمی‌گرداند.
     * 
     * @param restaurantId شناسه رستوران
     * @return تعداد کل آیتم‌های رستوران
     */
    public int countByRestaurant(Long restaurantId) {
<span class="nc" id="L365">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="nc" id="L366">            Query&lt;Long&gt; q = session.createQuery(</span>
                    &quot;select count(*) from FoodItem where restaurant.id = :restaurantId&quot;, 
                    Long.class);
<span class="nc" id="L369">            q.setParameter(&quot;restaurantId&quot;, restaurantId);</span>
<span class="nc" id="L370">            return q.getSingleResult().intValue();</span>
        }
    }
    
    /**
     * شمارش آیتم‌های در دسترس رستوران
     * 
     * این متد تعداد آیتم‌هایی را برمی‌گرداند که:
     * - متعلق به رستوران مشخص شده باشند
     * - وضعیت available آن‌ها true باشد
     * - موجودی آن‌ها بیشتر از صفر باشد
     * 
     * @param restaurantId شناسه رستوران
     * @return تعداد آیتم‌های قابل سفارش رستوران
     */
    public int countAvailableByRestaurant(Long restaurantId) {
<span class="nc" id="L386">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="nc" id="L387">            Query&lt;Long&gt; q = session.createQuery(</span>
                    &quot;select count(*) from FoodItem where restaurant.id = :restaurantId and available = true and quantity &gt; 0&quot;, 
                    Long.class);
<span class="nc" id="L390">            q.setParameter(&quot;restaurantId&quot;, restaurantId);</span>
<span class="nc" id="L391">            return q.getSingleResult().intValue();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>