<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TransactionController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.payment</a> &gt; <span class="el_source">TransactionController.java</span></div><h1>TransactionController.java</h1><pre class="source lang-java linenums">package com.myapp.payment;

import com.myapp.common.models.Transaction;
import com.myapp.common.models.TransactionType;
import com.myapp.common.utils.JsonUtil;
import com.sun.net.httpserver.HttpExchange;
import com.sun.net.httpserver.HttpHandler;

import java.io.IOException;
import java.net.URI;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Map;
import java.util.Optional;

/**
 * کنترلر تراکنش‌ها - مدیریت تاریخچه و API های مدیریت تراکنش
 * 
 * این کلاس REST endpoints برای جستجو و گزارش‌گیری تراکنش‌ها ارائه می‌دهد:
 * - تاریخچه تراکنش‌های کیف پول
 * - تاریخچه شارژ و برداشت
 * - آمار تراکنش‌ها
 * - جستجوی تراکنش بر اساس ID
 * - فیلتر کردن بر اساس تاریخ
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 */
public class TransactionController implements HttpHandler {

    private final WalletService walletService;
    private final PaymentRepository paymentRepository;

<span class="fc" id="L36">    public TransactionController(WalletService walletService, PaymentRepository paymentRepository) {</span>
<span class="fc" id="L37">        this.walletService = walletService;</span>
<span class="fc" id="L38">        this.paymentRepository = paymentRepository;</span>
<span class="fc" id="L39">    }</span>

    @Override
    public void handle(HttpExchange exchange) throws IOException {
<span class="fc" id="L43">        String method = exchange.getRequestMethod();</span>
<span class="fc" id="L44">        URI uri = exchange.getRequestURI();</span>
<span class="fc" id="L45">        String path = uri.getPath();</span>

        try {
<span class="fc bfc" id="L48" title="All 2 branches covered.">            switch (method) {</span>
                case &quot;GET&quot;:
<span class="fc" id="L50">                    handleGetRequest(exchange, path, uri.getQuery());</span>
<span class="fc" id="L51">                    break;</span>
                default:
<span class="fc" id="L53">                    sendMethodNotAllowed(exchange);</span>
            }
<span class="nc" id="L55">        } catch (Exception e) {</span>
<span class="nc" id="L56">            sendErrorResponse(exchange, 500, &quot;Internal server error: &quot; + e.getMessage());</span>
<span class="fc" id="L57">        }</span>
<span class="fc" id="L58">    }</span>

    // ==================== GET ENDPOINTS ====================

    private void handleGetRequest(HttpExchange exchange, String path, String query) throws IOException {
        // Parse query parameters
<span class="fc" id="L64">        Map&lt;String, String&gt; params = parseQueryString(query);</span>

<span class="fc bfc" id="L66" title="All 2 branches covered.">        if (path.equals(&quot;/api/transactions/wallet/history&quot;)) {</span>
<span class="fc" id="L67">            handleGetWalletHistory(exchange, params);</span>
<span class="fc bfc" id="L68" title="All 2 branches covered.">        } else if (path.equals(&quot;/api/transactions/wallet/charges&quot;)) {</span>
<span class="fc" id="L69">            handleGetWalletCharges(exchange, params);</span>
<span class="fc bfc" id="L70" title="All 2 branches covered.">        } else if (path.equals(&quot;/api/transactions/wallet/withdrawals&quot;)) {</span>
<span class="fc" id="L71">            handleGetWalletWithdrawals(exchange, params);</span>
<span class="fc bfc" id="L72" title="All 2 branches covered.">        } else if (path.equals(&quot;/api/transactions/wallet/statistics&quot;)) {</span>
<span class="fc" id="L73">            handleGetWalletStatistics(exchange, params);</span>
<span class="pc bpc" id="L74" title="1 of 2 branches missed.">        } else if (path.startsWith(&quot;/api/transactions/&quot;)) {</span>
<span class="fc" id="L75">            handleGetTransactionById(exchange, path);</span>
        } else {
<span class="nc" id="L77">            sendNotFoundResponse(exchange);</span>
        }
<span class="fc" id="L79">    }</span>

    /**
     * GET /api/transactions/wallet/history?userId={userId}&amp;startDate={date}&amp;endDate={date}
     * دریافت تاریخچه تراکنش‌های کیف پول برای کاربر
     * 
     * این endpoint امکان دریافت تاریخچه کامل یا در بازه زمانی مشخص را فراهم می‌کند
     * 
     * @param exchange شیء HttpExchange
     * @param params پارامترهای query شامل userId و تاریخ‌ها
     * @throws IOException در صورت خطا در ورودی/خروجی
     */
    private void handleGetWalletHistory(HttpExchange exchange, Map&lt;String, String&gt; params) throws IOException {
        try {
<span class="fc" id="L93">            String userIdStr = params.get(&quot;userId&quot;);</span>
<span class="fc bfc" id="L94" title="All 2 branches covered.">            if (userIdStr == null) {</span>
<span class="fc" id="L95">                sendErrorResponse(exchange, 400, &quot;User ID is required&quot;);</span>
<span class="fc" id="L96">                return;</span>
            }

<span class="fc" id="L99">            Long userId = Long.parseLong(userIdStr);</span>
            List&lt;Transaction&gt; transactions;

<span class="fc" id="L102">            String startDateStr = params.get(&quot;startDate&quot;);</span>
<span class="fc" id="L103">            String endDateStr = params.get(&quot;endDate&quot;);</span>

<span class="pc bpc" id="L105" title="1 of 4 branches missed.">            if (startDateStr != null &amp;&amp; endDateStr != null) {</span>
                // Get history within date range
<span class="fc" id="L107">                LocalDateTime startDate = LocalDateTime.parse(startDateStr, DateTimeFormatter.ISO_LOCAL_DATE_TIME);</span>
<span class="fc" id="L108">                LocalDateTime endDate = LocalDateTime.parse(endDateStr, DateTimeFormatter.ISO_LOCAL_DATE_TIME);</span>
<span class="fc" id="L109">                transactions = walletService.getWalletTransactionHistory(userId, startDate, endDate);</span>
<span class="fc" id="L110">            } else {</span>
                // Get all history
<span class="fc" id="L112">                transactions = walletService.getWalletTransactionHistory(userId);</span>
            }

<span class="fc" id="L115">            String jsonResponse = JsonUtil.toJson(transactions);</span>
<span class="fc" id="L116">            sendSuccessResponse(exchange, jsonResponse);</span>

<span class="fc" id="L118">        } catch (NumberFormatException e) {</span>
<span class="fc" id="L119">            sendErrorResponse(exchange, 400, &quot;Invalid user ID format&quot;);</span>
<span class="fc" id="L120">        } catch (Exception e) {</span>
<span class="fc" id="L121">            sendErrorResponse(exchange, 400, &quot;Invalid date format or other error: &quot; + e.getMessage());</span>
<span class="fc" id="L122">        }</span>
<span class="fc" id="L123">    }</span>

    /**
     * GET /api/transactions/wallet/charges?userId={userId}
     * Get wallet charge history for a user
     */
    private void handleGetWalletCharges(HttpExchange exchange, Map&lt;String, String&gt; params) throws IOException {
        try {
<span class="fc" id="L131">            String userIdStr = params.get(&quot;userId&quot;);</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">            if (userIdStr == null) {</span>
<span class="fc" id="L133">                sendErrorResponse(exchange, 400, &quot;User ID is required&quot;);</span>
<span class="fc" id="L134">                return;</span>
            }

<span class="fc" id="L137">            Long userId = Long.parseLong(userIdStr);</span>
<span class="fc" id="L138">            List&lt;Transaction&gt; chargeHistory = walletService.getWalletChargeHistory(userId);</span>

<span class="fc" id="L140">            String jsonResponse = JsonUtil.toJson(chargeHistory);</span>
<span class="fc" id="L141">            sendSuccessResponse(exchange, jsonResponse);</span>

<span class="nc" id="L143">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L144">            sendErrorResponse(exchange, 400, &quot;Invalid user ID format&quot;);</span>
<span class="nc" id="L145">        } catch (Exception e) {</span>
<span class="nc" id="L146">            sendErrorResponse(exchange, 500, &quot;Error retrieving charge history: &quot; + e.getMessage());</span>
<span class="pc" id="L147">        }</span>
<span class="fc" id="L148">    }</span>

    /**
     * GET /api/transactions/wallet/withdrawals?userId={userId}
     * Get wallet withdrawal history for a user
     */
    private void handleGetWalletWithdrawals(HttpExchange exchange, Map&lt;String, String&gt; params) throws IOException {
        try {
<span class="fc" id="L156">            String userIdStr = params.get(&quot;userId&quot;);</span>
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">            if (userIdStr == null) {</span>
<span class="nc" id="L158">                sendErrorResponse(exchange, 400, &quot;User ID is required&quot;);</span>
<span class="nc" id="L159">                return;</span>
            }

<span class="fc" id="L162">            Long userId = Long.parseLong(userIdStr);</span>
<span class="fc" id="L163">            List&lt;Transaction&gt; withdrawalHistory = walletService.getWalletWithdrawalHistory(userId);</span>

<span class="fc" id="L165">            String jsonResponse = JsonUtil.toJson(withdrawalHistory);</span>
<span class="fc" id="L166">            sendSuccessResponse(exchange, jsonResponse);</span>

<span class="nc" id="L168">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L169">            sendErrorResponse(exchange, 400, &quot;Invalid user ID format&quot;);</span>
<span class="fc" id="L170">        } catch (Exception e) {</span>
<span class="fc" id="L171">            sendErrorResponse(exchange, 500, &quot;Error retrieving withdrawal history: &quot; + e.getMessage());</span>
<span class="pc" id="L172">        }</span>
<span class="fc" id="L173">    }</span>

    /**
     * GET /api/transactions/wallet/statistics?userId={userId}
     * Get wallet transaction statistics for a user
     */
    private void handleGetWalletStatistics(HttpExchange exchange, Map&lt;String, String&gt; params) throws IOException {
        try {
<span class="fc" id="L181">            String userIdStr = params.get(&quot;userId&quot;);</span>
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">            if (userIdStr == null) {</span>
<span class="nc" id="L183">                sendErrorResponse(exchange, 400, &quot;User ID is required&quot;);</span>
<span class="nc" id="L184">                return;</span>
            }

<span class="fc" id="L187">            Long userId = Long.parseLong(userIdStr);</span>
<span class="fc" id="L188">            var statistics = walletService.getWalletStatistics(userId);</span>

<span class="fc" id="L190">            String jsonResponse = JsonUtil.toJson(statistics);</span>
<span class="fc" id="L191">            sendSuccessResponse(exchange, jsonResponse);</span>

<span class="fc" id="L193">        } catch (NumberFormatException e) {</span>
<span class="fc" id="L194">            sendErrorResponse(exchange, 400, &quot;Invalid user ID format&quot;);</span>
<span class="nc" id="L195">        } catch (Exception e) {</span>
<span class="nc" id="L196">            sendErrorResponse(exchange, 500, &quot;Error retrieving wallet statistics: &quot; + e.getMessage());</span>
<span class="fc" id="L197">        }</span>
<span class="fc" id="L198">    }</span>

    /**
     * GET /api/transactions/{transactionId}
     * Get transaction by ID
     */
    private void handleGetTransactionById(HttpExchange exchange, String path) throws IOException {
        try {
<span class="fc" id="L206">            String[] pathParts = path.split(&quot;/&quot;);</span>
<span class="fc bfc" id="L207" title="All 2 branches covered.">            if (pathParts.length &lt; 4) {</span>
<span class="fc" id="L208">                sendErrorResponse(exchange, 400, &quot;Transaction ID is required&quot;);</span>
<span class="fc" id="L209">                return;</span>
            }

<span class="fc" id="L212">            Long transactionId = Long.parseLong(pathParts[3]);</span>
<span class="fc" id="L213">            Optional&lt;Transaction&gt; transactionOpt = paymentRepository.findById(transactionId);</span>

<span class="fc bfc" id="L215" title="All 2 branches covered.">            if (transactionOpt.isEmpty()) {</span>
<span class="fc" id="L216">                sendNotFoundResponse(exchange, &quot;Transaction not found&quot;);</span>
<span class="fc" id="L217">                return;</span>
            }

<span class="fc" id="L220">            Transaction transaction = transactionOpt.get();</span>

<span class="fc" id="L222">            String jsonResponse = JsonUtil.toJson(transaction);</span>
<span class="fc" id="L223">            sendSuccessResponse(exchange, jsonResponse);</span>

<span class="fc" id="L225">        } catch (NumberFormatException e) {</span>
<span class="fc" id="L226">            sendErrorResponse(exchange, 400, &quot;Invalid transaction ID format&quot;);</span>
<span class="nc" id="L227">        } catch (Exception e) {</span>
<span class="nc" id="L228">            sendErrorResponse(exchange, 500, &quot;Error retrieving transaction: &quot; + e.getMessage());</span>
<span class="fc" id="L229">        }</span>
<span class="fc" id="L230">    }</span>

    // ==================== UTILITY METHODS ====================

    private Map&lt;String, String&gt; parseQueryString(String query) {
<span class="fc" id="L235">        Map&lt;String, String&gt; params = new java.util.HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L236" title="All 2 branches covered.">        if (query != null) {</span>
<span class="fc" id="L237">            String[] pairs = query.split(&quot;&amp;&quot;);</span>
<span class="fc bfc" id="L238" title="All 2 branches covered.">            for (String pair : pairs) {</span>
<span class="fc" id="L239">                String[] keyValue = pair.split(&quot;=&quot;);</span>
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">                if (keyValue.length == 2) {</span>
<span class="fc" id="L241">                    params.put(keyValue[0], keyValue[1]);</span>
                }
            }
        }
<span class="fc" id="L245">        return params;</span>
    }

    private void sendSuccessResponse(HttpExchange exchange, String responseBody) throws IOException {
<span class="fc" id="L249">        exchange.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<span class="fc" id="L250">        exchange.sendResponseHeaders(200, responseBody.getBytes().length);</span>
<span class="fc" id="L251">        exchange.getResponseBody().write(responseBody.getBytes());</span>
<span class="fc" id="L252">        exchange.getResponseBody().close();</span>
<span class="fc" id="L253">    }</span>

    private void sendErrorResponse(HttpExchange exchange, int statusCode, String message) throws IOException {
<span class="fc" id="L256">        String errorResponse = &quot;{\&quot;error\&quot;:\&quot;&quot; + message + &quot;\&quot;}&quot;;</span>
<span class="fc" id="L257">        exchange.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<span class="fc" id="L258">        exchange.sendResponseHeaders(statusCode, errorResponse.getBytes().length);</span>
<span class="fc" id="L259">        exchange.getResponseBody().write(errorResponse.getBytes());</span>
<span class="fc" id="L260">        exchange.getResponseBody().close();</span>
<span class="fc" id="L261">    }</span>

    private void sendNotFoundResponse(HttpExchange exchange) throws IOException {
<span class="nc" id="L264">        sendNotFoundResponse(exchange, &quot;Resource not found&quot;);</span>
<span class="nc" id="L265">    }</span>

    private void sendNotFoundResponse(HttpExchange exchange, String message) throws IOException {
<span class="fc" id="L268">        sendErrorResponse(exchange, 404, message);</span>
<span class="fc" id="L269">    }</span>

    private void sendMethodNotAllowed(HttpExchange exchange) throws IOException {
<span class="fc" id="L272">        sendErrorResponse(exchange, 405, &quot;Method not allowed&quot;);</span>
<span class="fc" id="L273">    }</span>
}

/*
 * TRANSACTION CONTROLLER API ENDPOINTS:
 * 
 * ✅ GET /api/transactions/wallet/history?userId={id}&amp;startDate={date}&amp;endDate={date}
 *    - Returns wallet transaction history for user
 *    - Supports date range filtering
 * 
 * ✅ GET /api/transactions/wallet/charges?userId={id}
 *    - Returns wallet charge transaction history
 * 
 * ✅ GET /api/transactions/wallet/withdrawals?userId={id}
 *    - Returns wallet withdrawal transaction history
 * 
 * ✅ GET /api/transactions/wallet/statistics?userId={id}
 *    - Returns wallet transaction statistics and summaries
 * 
 * ✅ GET /api/transactions/{transactionId}
 *    - Returns specific transaction details by ID
 * 
 * FUNCTIONALITY COVERED:
 * - Transaction history queries
 * - Date range filtering
 * - Transaction type filtering
 * - Statistical reporting
 * - Individual transaction lookup
 * - Error handling and validation
 */
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>