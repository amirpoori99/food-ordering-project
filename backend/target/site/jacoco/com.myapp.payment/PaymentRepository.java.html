<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PaymentRepository.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.payment</a> &gt; <span class="el_source">PaymentRepository.java</span></div><h1>PaymentRepository.java</h1><pre class="source lang-java linenums">package com.myapp.payment;

import com.myapp.common.models.Transaction;
import com.myapp.common.models.TransactionStatus;
import com.myapp.common.models.TransactionType;
import com.myapp.common.utils.DatabaseUtil;
import org.hibernate.Session;
import org.hibernate.SessionFactory;
import org.hibernate.query.Query;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;

/**
 * Repository برای مدیریت عملیات دیتابیس مربوط به تراکنش‌ها و پرداخت‌ها
 * 
 * این کلاس مسئول:
 * - عملیات CRUD روی تراکنش‌ها
 * - جستجوهای پیچیده و فیلترینگ
 * - محاسبه موجودی کیف پول
 * - تولید آمار و گزارش‌های مالی
 * - مدیریت ارتباط با دیتابیس از طریق Hibernate
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 */

/**
 * Repository برای مدیریت عملیات Entity تراکنش
 * 
 * این کلاس مسئول تمام عملیات دیتابیس مربوط به:
 * - تراکنش‌های پرداخت و استرداد
 * - تراکنش‌های کیف پول (شارژ و برداشت)
 * - محاسبه موجودی کیف پول
 * - جستجو و فیلتر کردن تراکنش‌ها
 * - تولید آمار و گزارش‌های مالی
 * 
 * Pattern های استفاده شده:
 * - Repository Pattern: انتزاع لایه دسترسی به داده
 * - Session-per-Request: مدیریت session های Hibernate
 * - Query Optimization: استفاده از HQL و Native Query ها
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 */
public class PaymentRepository {
    
    /** SessionFactory برای مدیریت ارتباط با دیتابیس */
    private final SessionFactory sessionFactory;
    
    /**
     * سازنده پیش‌فرض - دریافت SessionFactory از DatabaseUtil
     */
<span class="fc" id="L57">    public PaymentRepository() {</span>
<span class="fc" id="L58">        this.sessionFactory = DatabaseUtil.getSessionFactory();</span>
<span class="fc" id="L59">    }</span>
    
    /**
     * سازنده برای تزریق وابستگی (Dependency Injection)
     * برای تست‌ها و configuration سفارشی استفاده می‌شود
     * 
     * @param sessionFactory SessionFactory سفارشی
     */
<span class="nc" id="L67">    public PaymentRepository(SessionFactory sessionFactory) {</span>
<span class="nc" id="L68">        this.sessionFactory = sessionFactory;</span>
<span class="nc" id="L69">    }</span>
    
    /**
     * ذخیره تراکنش جدید در دیتابیس
     * 
     * @param transaction تراکنش جدید برای ذخیره
     * @return تراکنش ذخیره شده با ID تولید شده
     */
    public Transaction save(Transaction transaction) {
<span class="fc" id="L78">        try (Session session = sessionFactory.openSession()) {</span>
<span class="fc" id="L79">            session.beginTransaction();</span>
<span class="fc" id="L80">            session.persist(transaction); // Hibernate 6+ syntax</span>
<span class="fc" id="L81">            session.getTransaction().commit();</span>
<span class="fc" id="L82">            return transaction;</span>
        }
    }
    
    /**
     * به‌روزرسانی تراکنش موجود
     * 
     * @param transaction تراکنش برای به‌روزرسانی
     * @return تراکنش به‌روزرسانی شده
     */
    public Transaction update(Transaction transaction) {
<span class="nc" id="L93">        try (Session session = sessionFactory.openSession()) {</span>
<span class="nc" id="L94">            session.beginTransaction();</span>
<span class="nc" id="L95">            Transaction updated = session.merge(transaction); // merge برای update</span>
<span class="nc" id="L96">            session.getTransaction().commit();</span>
<span class="nc" id="L97">            return updated;</span>
        }
    }
    
    /**
     * یافتن تراکنش بر اساس ID
     * 
     * @param id شناسه تراکنش
     * @return Optional حاوی تراکنش یا خالی
     */
    public Optional&lt;Transaction&gt; findById(Long id) {
<span class="fc" id="L108">        try (Session session = sessionFactory.openSession()) {</span>
<span class="fc" id="L109">            session.beginTransaction();</span>
<span class="fc" id="L110">            Transaction transaction = session.get(Transaction.class, id);</span>
<span class="fc" id="L111">            session.getTransaction().commit();</span>
<span class="fc" id="L112">            return Optional.ofNullable(transaction);</span>
        }
    }
    
    /**
     * یافتن تراکنش بر اساس شناسه مرجع
     * 
     * شناسه مرجع توسط payment gateway ها تولید می‌شود
     * برای tracking و reconciliation استفاده می‌شود
     * 
     * @param referenceId شناسه مرجع از payment gateway
     * @return Optional حاوی تراکنش یا خالی
     */
    public Optional&lt;Transaction&gt; findByReferenceId(String referenceId) {
<span class="nc" id="L126">        try (Session session = sessionFactory.openSession()) {</span>
<span class="nc" id="L127">            session.beginTransaction();</span>
<span class="nc" id="L128">            Query&lt;Transaction&gt; query = session.createQuery(</span>
                &quot;FROM Transaction t WHERE t.referenceId = :referenceId&quot;, Transaction.class);
<span class="nc" id="L130">            query.setParameter(&quot;referenceId&quot;, referenceId);</span>
<span class="nc" id="L131">            Transaction transaction = query.uniqueResult();</span>
<span class="nc" id="L132">            session.getTransaction().commit();</span>
<span class="nc" id="L133">            return Optional.ofNullable(transaction);</span>
        }
    }
    
    /**
     * یافتن تمام تراکنش‌های یک کاربر
     * 
     * نتایج بر اساس تاریخ ایجاد به صورت نزولی مرتب می‌شوند (جدیدترین ابتدا)
     * 
     * @param userId شناسه کاربر
     * @return لیست تراکنش‌های کاربر
     */
    public List&lt;Transaction&gt; findByUserId(Long userId) {
<span class="fc" id="L146">        try (Session session = sessionFactory.openSession()) {</span>
<span class="fc" id="L147">            session.beginTransaction();</span>
<span class="fc" id="L148">            Query&lt;Transaction&gt; query = session.createQuery(</span>
                &quot;FROM Transaction t WHERE t.userId = :userId ORDER BY t.createdAt DESC&quot;, Transaction.class);
<span class="fc" id="L150">            query.setParameter(&quot;userId&quot;, userId);</span>
<span class="fc" id="L151">            List&lt;Transaction&gt; transactions = query.getResultList();</span>
<span class="fc" id="L152">            session.getTransaction().commit();</span>
<span class="fc" id="L153">            return transactions;</span>
        }
    }
    
    /**
     * یافتن تمام تراکنش‌های مربوط به سفارش خاص
     * 
     * شامل تراکنش پرداخت و احتمالی استرداد آن سفارش
     * 
     * @param orderId شناسه سفارش
     * @return لیست تراکنش‌های مربوط به سفارش
     */
    public List&lt;Transaction&gt; findByOrderId(Long orderId) {
<span class="nc" id="L166">        try (Session session = sessionFactory.getCurrentSession()) {</span>
<span class="nc" id="L167">            session.beginTransaction();</span>
<span class="nc" id="L168">            Query&lt;Transaction&gt; query = session.createQuery(</span>
                &quot;FROM Transaction t WHERE t.orderId = :orderId ORDER BY t.createdAt DESC&quot;, Transaction.class);
<span class="nc" id="L170">            query.setParameter(&quot;orderId&quot;, orderId);</span>
<span class="nc" id="L171">            List&lt;Transaction&gt; transactions = query.getResultList();</span>
<span class="nc" id="L172">            session.getTransaction().commit();</span>
<span class="nc" id="L173">            return transactions;</span>
        }
    }
    
    /**
     * یافتن تراکنش‌ها بر اساس وضعیت
     * 
     * وضعیت‌های موجود: PENDING, COMPLETED, FAILED, CANCELLED
     * 
     * @param status وضعیت تراکنش
     * @return لیست تراکنش‌های با وضعیت مشخص
     */
    public List&lt;Transaction&gt; findByStatus(TransactionStatus status) {
<span class="fc" id="L186">        try (Session session = sessionFactory.openSession()) {</span>
<span class="fc" id="L187">            session.beginTransaction();</span>
<span class="fc" id="L188">            Query&lt;Transaction&gt; query = session.createQuery(</span>
                &quot;FROM Transaction t WHERE t.status = :status ORDER BY t.createdAt DESC&quot;, Transaction.class);
<span class="fc" id="L190">            query.setParameter(&quot;status&quot;, status);</span>
<span class="fc" id="L191">            List&lt;Transaction&gt; transactions = query.getResultList();</span>
<span class="fc" id="L192">            session.getTransaction().commit();</span>
<span class="fc" id="L193">            return transactions;</span>
        }
    }
    
    /**
     * یافتن تراکنش‌ها بر اساس نوع
     * 
     * انواع تراکنش: PAYMENT, REFUND, WALLET_CHARGE, WALLET_WITHDRAWAL
     * 
     * @param type نوع تراکنش
     * @return لیست تراکنش‌های با نوع مشخص
     */
    public List&lt;Transaction&gt; findByType(TransactionType type) {
<span class="nc" id="L206">        try (Session session = sessionFactory.getCurrentSession()) {</span>
<span class="nc" id="L207">            session.beginTransaction();</span>
<span class="nc" id="L208">            Query&lt;Transaction&gt; query = session.createQuery(</span>
                &quot;FROM Transaction t WHERE t.type = :type ORDER BY t.createdAt DESC&quot;, Transaction.class);
<span class="nc" id="L210">            query.setParameter(&quot;type&quot;, type);</span>
<span class="nc" id="L211">            List&lt;Transaction&gt; transactions = query.getResultList();</span>
<span class="nc" id="L212">            session.getTransaction().commit();</span>
<span class="nc" id="L213">            return transactions;</span>
        }
    }
    
    /**
     * یافتن تراکنش‌های کاربر با وضعیت مشخص
     * 
     * ترکیب فیلتر کاربر و وضعیت برای جستجوی دقیق‌تر
     * 
     * @param userId شناسه کاربر
     * @param status وضعیت تراکنش
     * @return لیست تراکنش‌های فیلتر شده
     */
    public List&lt;Transaction&gt; findByUserIdAndStatus(Long userId, TransactionStatus status) {
<span class="nc" id="L227">        try (Session session = sessionFactory.getCurrentSession()) {</span>
<span class="nc" id="L228">            session.beginTransaction();</span>
<span class="nc" id="L229">            Query&lt;Transaction&gt; query = session.createQuery(</span>
                &quot;FROM Transaction t WHERE t.userId = :userId AND t.status = :status ORDER BY t.createdAt DESC&quot;, 
                Transaction.class);
<span class="nc" id="L232">            query.setParameter(&quot;userId&quot;, userId);</span>
<span class="nc" id="L233">            query.setParameter(&quot;status&quot;, status);</span>
<span class="nc" id="L234">            List&lt;Transaction&gt; transactions = query.getResultList();</span>
<span class="nc" id="L235">            session.getTransaction().commit();</span>
<span class="nc" id="L236">            return transactions;</span>
        }
    }
    
    /**
     * یافتن تراکنش‌های کاربر با نوع مشخص
     * 
     * @param userId شناسه کاربر
     * @param type نوع تراکنش
     * @return لیست تراکنش‌های فیلتر شده
     */
    public List&lt;Transaction&gt; findByUserIdAndType(Long userId, TransactionType type) {
<span class="nc" id="L248">        try (Session session = sessionFactory.getCurrentSession()) {</span>
<span class="nc" id="L249">            session.beginTransaction();</span>
<span class="nc" id="L250">            Query&lt;Transaction&gt; query = session.createQuery(</span>
                &quot;FROM Transaction t WHERE t.userId = :userId AND t.type = :type ORDER BY t.createdAt DESC&quot;, 
                Transaction.class);
<span class="nc" id="L253">            query.setParameter(&quot;userId&quot;, userId);</span>
<span class="nc" id="L254">            query.setParameter(&quot;type&quot;, type);</span>
<span class="nc" id="L255">            List&lt;Transaction&gt; transactions = query.getResultList();</span>
<span class="nc" id="L256">            session.getTransaction().commit();</span>
<span class="nc" id="L257">            return transactions;</span>
        }
    }
    
    /**
     * یافتن تراکنش‌های کیف پول برای کاربر
     * 
     * شامل تراکنش‌های شارژ (WALLET_CHARGE) و برداشت (WALLET_WITHDRAWAL)
     * 
     * @param userId شناسه کاربر
     * @return لیست تراکنش‌های کیف پول
     */
    public List&lt;Transaction&gt; findWalletTransactions(Long userId) {
<span class="nc" id="L270">        try (Session session = sessionFactory.getCurrentSession()) {</span>
<span class="nc" id="L271">            session.beginTransaction();</span>
<span class="nc" id="L272">            Query&lt;Transaction&gt; query = session.createQuery(</span>
                &quot;FROM Transaction t WHERE t.userId = :userId AND t.type IN (:walletTypes) ORDER BY t.createdAt DESC&quot;, 
                Transaction.class);
<span class="nc" id="L275">            query.setParameter(&quot;userId&quot;, userId);</span>
<span class="nc" id="L276">            query.setParameter(&quot;walletTypes&quot;, List.of(TransactionType.WALLET_CHARGE, TransactionType.WALLET_WITHDRAWAL));</span>
<span class="nc" id="L277">            List&lt;Transaction&gt; transactions = query.getResultList();</span>
<span class="nc" id="L278">            session.getTransaction().commit();</span>
<span class="nc" id="L279">            return transactions;</span>
        }
    }
    
    /**
     * یافتن تراکنش‌های پرداخت برای کاربر
     * 
     * شامل تراکنش‌های پرداخت (PAYMENT) و استرداد (REFUND)
     * 
     * @param userId شناسه کاربر
     * @return لیست تراکنش‌های پرداخت
     */
    public List&lt;Transaction&gt; findPaymentTransactions(Long userId) {
<span class="nc" id="L292">        try (Session session = sessionFactory.getCurrentSession()) {</span>
<span class="nc" id="L293">            session.beginTransaction();</span>
<span class="nc" id="L294">            Query&lt;Transaction&gt; query = session.createQuery(</span>
                &quot;FROM Transaction t WHERE t.userId = :userId AND t.type IN (:paymentTypes) ORDER BY t.createdAt DESC&quot;, 
                Transaction.class);
<span class="nc" id="L297">            query.setParameter(&quot;userId&quot;, userId);</span>
<span class="nc" id="L298">            query.setParameter(&quot;paymentTypes&quot;, List.of(TransactionType.PAYMENT, TransactionType.REFUND));</span>
<span class="nc" id="L299">            List&lt;Transaction&gt; transactions = query.getResultList();</span>
<span class="nc" id="L300">            session.getTransaction().commit();</span>
<span class="nc" id="L301">            return transactions;</span>
        }
    }
    
    /**
     * یافتن تراکنش‌ها در بازه زمانی مشخص
     * 
     * @param startDate تاریخ شروع
     * @param endDate تاریخ پایان
     * @return لیست تراکنش‌ها در بازه زمانی
     */
    public List&lt;Transaction&gt; findByDateRange(LocalDateTime startDate, LocalDateTime endDate) {
<span class="nc" id="L313">        try (Session session = sessionFactory.getCurrentSession()) {</span>
<span class="nc" id="L314">            session.beginTransaction();</span>
<span class="nc" id="L315">            Query&lt;Transaction&gt; query = session.createQuery(</span>
                &quot;FROM Transaction t WHERE t.createdAt BETWEEN :startDate AND :endDate ORDER BY t.createdAt DESC&quot;, 
                Transaction.class);
<span class="nc" id="L318">            query.setParameter(&quot;startDate&quot;, startDate);</span>
<span class="nc" id="L319">            query.setParameter(&quot;endDate&quot;, endDate);</span>
<span class="nc" id="L320">            List&lt;Transaction&gt; transactions = query.getResultList();</span>
<span class="nc" id="L321">            session.getTransaction().commit();</span>
<span class="nc" id="L322">            return transactions;</span>
        }
    }
    
    /**
     * یافتن تراکنش‌های کاربر در بازه زمانی مشخص
     * 
     * @param userId شناسه کاربر
     * @param startDate تاریخ شروع
     * @param endDate تاریخ پایان
     * @return لیست تراکنش‌های کاربر در بازه زمانی
     */
    public List&lt;Transaction&gt; findByUserIdAndDateRange(Long userId, LocalDateTime startDate, LocalDateTime endDate) {
<span class="nc" id="L335">        try (Session session = sessionFactory.getCurrentSession()) {</span>
<span class="nc" id="L336">            session.beginTransaction();</span>
<span class="nc" id="L337">            Query&lt;Transaction&gt; query = session.createQuery(</span>
                &quot;FROM Transaction t WHERE t.userId = :userId AND t.createdAt BETWEEN :startDate AND :endDate ORDER BY t.createdAt DESC&quot;, 
                Transaction.class);
<span class="nc" id="L340">            query.setParameter(&quot;userId&quot;, userId);</span>
<span class="nc" id="L341">            query.setParameter(&quot;startDate&quot;, startDate);</span>
<span class="nc" id="L342">            query.setParameter(&quot;endDate&quot;, endDate);</span>
<span class="nc" id="L343">            List&lt;Transaction&gt; transactions = query.getResultList();</span>
<span class="nc" id="L344">            session.getTransaction().commit();</span>
<span class="nc" id="L345">            return transactions;</span>
        }
    }
    
    /**
     * محاسبه موجودی کل کیف پول برای کاربر
     * 
     * این متد با استفاده از aggregate function موجودی را محاسبه می‌کند:
     * - تراکنش‌های شارژ (WALLET_CHARGE) به موجودی اضافه می‌شوند
     * - تراکنش‌های برداشت (WALLET_WITHDRAWAL) از موجودی کم می‌شوند
     * - فقط تراکنش‌های موفق (COMPLETED) محاسبه می‌شوند
     * 
     * @param userId شناسه کاربر
     * @return موجودی فعلی کیف پول
     */
    public Double calculateWalletBalance(Long userId) {
<span class="fc" id="L361">        try (Session session = sessionFactory.getCurrentSession()) {</span>
<span class="fc" id="L362">            session.beginTransaction();</span>
<span class="fc" id="L363">            Query&lt;Double&gt; query = session.createQuery(</span>
                &quot;SELECT COALESCE(SUM(CASE &quot; +
                &quot;WHEN t.type = :charge THEN t.amount &quot; +
                &quot;WHEN t.type = :withdrawal THEN -t.amount &quot; +
                &quot;ELSE 0 END), 0.0) &quot; +
                &quot;FROM Transaction t WHERE t.userId = :userId AND t.status = :status AND t.type IN (:walletTypes)&quot;, 
                Double.class);
<span class="fc" id="L370">            query.setParameter(&quot;userId&quot;, userId);</span>
<span class="fc" id="L371">            query.setParameter(&quot;charge&quot;, TransactionType.WALLET_CHARGE);</span>
<span class="fc" id="L372">            query.setParameter(&quot;withdrawal&quot;, TransactionType.WALLET_WITHDRAWAL);</span>
<span class="fc" id="L373">            query.setParameter(&quot;status&quot;, TransactionStatus.COMPLETED);</span>
<span class="fc" id="L374">            query.setParameter(&quot;walletTypes&quot;, List.of(TransactionType.WALLET_CHARGE, TransactionType.WALLET_WITHDRAWAL));</span>
<span class="fc" id="L375">            Double balance = query.uniqueResult();</span>
<span class="fc" id="L376">            session.getTransaction().commit();</span>
<span class="pc bpc" id="L377" title="1 of 2 branches missed.">            return balance != null ? balance : 0.0;</span>
        }
    }
    
    /**
     * دریافت آمار کامل تراکنش‌های کاربر
     * 
     * این متد مجموعه‌ای از query های aggregate برای محاسبه آمار اجرا می‌کند:
     * - تعداد کل تراکنش‌ها
     * - تعداد تراکنش‌های موفق/ناموفق/در انتظار
     * - مجموع مبلغ خرج شده (پرداخت‌های موفق)
     * - مجموع مبلغ استرداد شده
     * 
     * @param userId شناسه کاربر
     * @return آمار کامل تراکنش‌های کاربر
     */
    public TransactionStatistics getUserTransactionStatistics(Long userId) {
<span class="fc" id="L394">        try (Session session = sessionFactory.openSession()) {</span>
<span class="fc" id="L395">            session.beginTransaction();</span>
            
            // تعداد کل تراکنش‌ها
<span class="fc" id="L398">            Query&lt;Long&gt; totalQuery = session.createQuery(</span>
                &quot;SELECT COUNT(t) FROM Transaction t WHERE t.userId = :userId&quot;, Long.class);
<span class="fc" id="L400">            totalQuery.setParameter(&quot;userId&quot;, userId);</span>
<span class="fc" id="L401">            Long totalTransactions = totalQuery.uniqueResult();</span>
            
            // تعداد تراکنش‌های موفق
<span class="fc" id="L404">            Query&lt;Long&gt; completedQuery = session.createQuery(</span>
                &quot;SELECT COUNT(t) FROM Transaction t WHERE t.userId = :userId AND t.status = :status&quot;, Long.class);
<span class="fc" id="L406">            completedQuery.setParameter(&quot;userId&quot;, userId);</span>
<span class="fc" id="L407">            completedQuery.setParameter(&quot;status&quot;, TransactionStatus.COMPLETED);</span>
<span class="fc" id="L408">            Long completedTransactions = completedQuery.uniqueResult();</span>
            
            // تعداد تراکنش‌های در انتظار
<span class="fc" id="L411">            Query&lt;Long&gt; pendingQuery = session.createQuery(</span>
                &quot;SELECT COUNT(t) FROM Transaction t WHERE t.userId = :userId AND t.status = :status&quot;, Long.class);
<span class="fc" id="L413">            pendingQuery.setParameter(&quot;userId&quot;, userId);</span>
<span class="fc" id="L414">            pendingQuery.setParameter(&quot;status&quot;, TransactionStatus.PENDING);</span>
<span class="fc" id="L415">            Long pendingTransactions = pendingQuery.uniqueResult();</span>
            
            // تعداد تراکنش‌های ناموفق
<span class="fc" id="L418">            Query&lt;Long&gt; failedQuery = session.createQuery(</span>
                &quot;SELECT COUNT(t) FROM Transaction t WHERE t.userId = :userId AND t.status = :status&quot;, Long.class);
<span class="fc" id="L420">            failedQuery.setParameter(&quot;userId&quot;, userId);</span>
<span class="fc" id="L421">            failedQuery.setParameter(&quot;status&quot;, TransactionStatus.FAILED);</span>
<span class="fc" id="L422">            Long failedTransactions = failedQuery.uniqueResult();</span>
            
            // مجموع مبلغ خرج شده (پرداخت‌های موفق)
<span class="fc" id="L425">            Query&lt;Double&gt; spentQuery = session.createQuery(</span>
                &quot;SELECT COALESCE(SUM(t.amount), 0.0) FROM Transaction t WHERE t.userId = :userId AND t.type = :type AND t.status = :status&quot;, 
                Double.class);
<span class="fc" id="L428">            spentQuery.setParameter(&quot;userId&quot;, userId);</span>
<span class="fc" id="L429">            spentQuery.setParameter(&quot;type&quot;, TransactionType.PAYMENT);</span>
<span class="fc" id="L430">            spentQuery.setParameter(&quot;status&quot;, TransactionStatus.COMPLETED);</span>
<span class="fc" id="L431">            Double totalSpent = spentQuery.uniqueResult();</span>
            
            // مجموع مبلغ استرداد شده
<span class="fc" id="L434">            Query&lt;Double&gt; refundQuery = session.createQuery(</span>
                &quot;SELECT COALESCE(SUM(t.amount), 0.0) FROM Transaction t WHERE t.userId = :userId AND t.type = :type AND t.status = :status&quot;, 
                Double.class);
<span class="fc" id="L437">            refundQuery.setParameter(&quot;userId&quot;, userId);</span>
<span class="fc" id="L438">            refundQuery.setParameter(&quot;type&quot;, TransactionType.REFUND);</span>
<span class="fc" id="L439">            refundQuery.setParameter(&quot;status&quot;, TransactionStatus.COMPLETED);</span>
<span class="fc" id="L440">            Double totalRefunded = refundQuery.uniqueResult();</span>
            
<span class="fc" id="L442">            session.getTransaction().commit();</span>
            
            // ایجاد شیء آمار با تمام اطلاعات محاسبه شده
<span class="fc" id="L445">            return new TransactionStatistics(</span>
<span class="pc bpc" id="L446" title="1 of 2 branches missed.">                totalTransactions != null ? totalTransactions : 0L,</span>
<span class="pc bpc" id="L447" title="1 of 2 branches missed.">                completedTransactions != null ? completedTransactions : 0L,</span>
<span class="pc bpc" id="L448" title="1 of 2 branches missed.">                pendingTransactions != null ? pendingTransactions : 0L,</span>
<span class="pc bpc" id="L449" title="1 of 2 branches missed.">                failedTransactions != null ? failedTransactions : 0L,</span>
<span class="pc bpc" id="L450" title="1 of 2 branches missed.">                totalSpent != null ? totalSpent : 0.0,</span>
<span class="pc bpc" id="L451" title="1 of 2 branches missed.">                totalRefunded != null ? totalRefunded : 0.0</span>
            );
        }
    }
    
    /**
     * بررسی وجود تراکنش با شناسه مشخص
     * 
     * @param id شناسه تراکنش
     * @return true اگر وجود داشته باشد، در غیر این صورت false
     */
    public boolean existsById(Long id) {
<span class="nc" id="L463">        try (Session session = sessionFactory.getCurrentSession()) {</span>
<span class="nc" id="L464">            session.beginTransaction();</span>
<span class="nc" id="L465">            Query&lt;Long&gt; query = session.createQuery(</span>
                &quot;SELECT COUNT(t) FROM Transaction t WHERE t.id = :id&quot;, Long.class);
<span class="nc" id="L467">            query.setParameter(&quot;id&quot;, id);</span>
<span class="nc" id="L468">            Long count = query.uniqueResult();</span>
<span class="nc" id="L469">            session.getTransaction().commit();</span>
<span class="nc bnc" id="L470" title="All 4 branches missed.">            return count != null &amp;&amp; count &gt; 0;</span>
        }
    }
    
    /**
     * حذف تراکنش (به ندرت استفاده می‌شود - بیشتر برای تست)
     * 
     * توجه: در محیط production، معمولاً تراکنش‌ها حذف نمی‌شوند
     * بلکه وضعیت آنها تغییر می‌کند
     * 
     * @param id شناسه تراکنش برای حذف
     */
    public void delete(Long id) {
<span class="nc" id="L483">        try (Session session = sessionFactory.openSession()) {</span>
<span class="nc" id="L484">            session.beginTransaction();</span>
<span class="nc" id="L485">            Transaction transaction = session.get(Transaction.class, id);</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">            if (transaction != null) {</span>
<span class="nc" id="L487">                session.remove(transaction);</span>
            }
<span class="nc" id="L489">            session.getTransaction().commit();</span>
        }
<span class="nc" id="L491">    }</span>
    
    /**
     * حذف تمام تراکنش‌ها (فقط برای تست‌ها)
     * 
     * این متد تمام تراکنش‌ها را حذف می‌کند و باید فقط در محیط تست استفاده شود
     * در محیط production، تراکنش‌ها هرگز حذف نمی‌شوند
     */
    public void deleteAll() {
<span class="fc" id="L500">        try (Session session = sessionFactory.openSession()) {</span>
<span class="fc" id="L501">            session.beginTransaction();</span>
<span class="fc" id="L502">            Query&lt;?&gt; query = session.createQuery(&quot;DELETE FROM Transaction&quot;);</span>
<span class="fc" id="L503">            query.executeUpdate();</span>
<span class="fc" id="L504">            session.getTransaction().commit();</span>
        }
<span class="fc" id="L506">    }</span>
    
    /**
     * کلاس داخلی برای نگهداری آمار تراکنش‌ها
     * 
     * این کلاس حاوی تمام اطلاعات آماری مربوط به فعالیت‌های مالی کاربر است
     * و محاسبات اضافی نیز انجام می‌دهد
     */
    public static class TransactionStatistics {
        private final Long totalTransactions;
        private final Long completedTransactions;
        private final Long pendingTransactions;
        private final Long failedTransactions;
        private final Double totalSpent;
        private final Double totalRefunded;
        
        /**
         * سازنده کلاس آمار
         * 
         * @param totalTransactions تعداد کل تراکنش‌ها
         * @param completedTransactions تعداد تراکنش‌های موفق
         * @param pendingTransactions تعداد تراکنش‌های در انتظار
         * @param failedTransactions تعداد تراکنش‌های ناموفق
         * @param totalSpent مجموع مبلغ خرج شده
         * @param totalRefunded مجموع مبلغ استرداد شده
         */
        public TransactionStatistics(Long totalTransactions, Long completedTransactions, 
                                   Long pendingTransactions, Long failedTransactions,
<span class="fc" id="L534">                                   Double totalSpent, Double totalRefunded) {</span>
<span class="fc" id="L535">            this.totalTransactions = totalTransactions;</span>
<span class="fc" id="L536">            this.completedTransactions = completedTransactions;</span>
<span class="fc" id="L537">            this.pendingTransactions = pendingTransactions;</span>
<span class="fc" id="L538">            this.failedTransactions = failedTransactions;</span>
<span class="fc" id="L539">            this.totalSpent = totalSpent;</span>
<span class="fc" id="L540">            this.totalRefunded = totalRefunded;</span>
<span class="fc" id="L541">        }</span>
        
        // ==================== GETTER METHODS ====================
        
        /** @return تعداد کل تراکنش‌ها */
<span class="fc" id="L546">        public Long getTotalTransactions() { return totalTransactions; }</span>
        
        /** @return تعداد تراکنش‌های موفق */
<span class="nc" id="L549">        public Long getCompletedTransactions() { return completedTransactions; }</span>
        
        /** @return تعداد تراکنش‌های در انتظار */
<span class="nc" id="L552">        public Long getPendingTransactions() { return pendingTransactions; }</span>
        
        /** @return تعداد تراکنش‌های ناموفق */
<span class="nc" id="L555">        public Long getFailedTransactions() { return failedTransactions; }</span>
        
        /** @return مجموع مبلغ خرج شده */
<span class="fc" id="L558">        public Double getTotalSpent() { return totalSpent; }</span>
        
        /** @return مجموع مبلغ استرداد شده */
<span class="nc" id="L561">        public Double getTotalRefunded() { return totalRefunded; }</span>
        
        /** @return مبلغ خالص خرج شده (خرج شده منهای استرداد شده) */
<span class="nc" id="L564">        public Double getNetSpent() { return totalSpent - totalRefunded; }</span>
        
        /** @return درصد موفقیت تراکنش‌ها */
        public Double getSuccessRate() { 
<span class="nc bnc" id="L568" title="All 2 branches missed.">            return totalTransactions &gt; 0 ? (double) completedTransactions / totalTransactions * 100 : 0.0; </span>
        }
    }
} 
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>