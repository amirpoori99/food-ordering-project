<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WalletController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.payment</a> &gt; <span class="el_source">WalletController.java</span></div><h1>WalletController.java</h1><pre class="source lang-java linenums">package com.myapp.payment;

import com.myapp.common.models.Transaction;
import com.sun.net.httpserver.HttpExchange;
import com.sun.net.httpserver.HttpHandler;

import java.io.IOException;
import java.io.OutputStream;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeParseException;
import java.util.List;
import java.util.Map;

/**
 * کنترلر REST API برای عملیات کیف پول
 * 
 * این کلاس مسئول مدیریت تمام درخواست‌های HTTP مربوط به:
 * - مشاهده موجودی کیف پول
 * - شارژ کیف پول از طریق روش‌های مختلف
 * - برداشت از کیف پول
 * - تاریخچه تراکنش‌های کیف پول
 * - آمار و گزارش‌گیری کیف پول
 * - عملیات مدیریتی توسط ادمین
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 */
public class WalletController implements HttpHandler {
    
    private final WalletService walletService;
    
<span class="nc" id="L34">    public WalletController() {</span>
<span class="nc" id="L35">        this.walletService = new WalletService();</span>
<span class="nc" id="L36">    }</span>
    
<span class="fc" id="L38">    public WalletController(WalletService walletService) {</span>
<span class="fc" id="L39">        this.walletService = walletService;</span>
<span class="fc" id="L40">    }</span>
    
    @Override
    public void handle(HttpExchange exchange) throws IOException {
<span class="nc" id="L44">        String method = exchange.getRequestMethod();</span>
<span class="nc" id="L45">        String path = exchange.getRequestURI().getPath();</span>
        
        try {
<span class="nc bnc" id="L48" title="All 3 branches missed.">            switch (method) {</span>
                case &quot;GET&quot;:
<span class="nc" id="L50">                    handleGetRequest(exchange, path);</span>
<span class="nc" id="L51">                    break;</span>
                case &quot;POST&quot;:
<span class="nc" id="L53">                    handlePostRequest(exchange, path);</span>
<span class="nc" id="L54">                    break;</span>
                default:
<span class="nc" id="L56">                    sendResponse(exchange, 405, &quot;{\&quot;error\&quot;:\&quot;Method not allowed\&quot;}&quot;);</span>
                    break;
            }
<span class="nc" id="L59">        } catch (Exception e) {</span>
<span class="nc" id="L60">            sendResponse(exchange, 500, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L61">        }</span>
<span class="nc" id="L62">    }</span>
    
    // ==================== GET ENDPOINTS ====================
    
    private void handleGetRequest(HttpExchange exchange, String path) throws IOException {
<span class="nc bnc" id="L67" title="All 4 branches missed.">        if (path.startsWith(&quot;/api/wallet/&quot;) &amp;&amp; path.endsWith(&quot;/balance&quot;)) {</span>
<span class="nc" id="L68">            getWalletBalance(exchange, path);</span>
<span class="nc bnc" id="L69" title="All 4 branches missed.">        } else if (path.startsWith(&quot;/api/wallet/&quot;) &amp;&amp; path.endsWith(&quot;/transactions&quot;)) {</span>
<span class="nc" id="L70">            getWalletTransactionHistory(exchange, path);</span>
<span class="nc bnc" id="L71" title="All 4 branches missed.">        } else if (path.startsWith(&quot;/api/wallet/&quot;) &amp;&amp; path.endsWith(&quot;/charges&quot;)) {</span>
<span class="nc" id="L72">            getWalletChargeHistory(exchange, path);</span>
<span class="nc bnc" id="L73" title="All 4 branches missed.">        } else if (path.startsWith(&quot;/api/wallet/&quot;) &amp;&amp; path.endsWith(&quot;/withdrawals&quot;)) {</span>
<span class="nc" id="L74">            getWalletWithdrawalHistory(exchange, path);</span>
<span class="nc bnc" id="L75" title="All 4 branches missed.">        } else if (path.startsWith(&quot;/api/wallet/&quot;) &amp;&amp; path.endsWith(&quot;/statistics&quot;)) {</span>
<span class="nc" id="L76">            getWalletStatistics(exchange, path);</span>
<span class="nc bnc" id="L77" title="All 4 branches missed.">        } else if (path.startsWith(&quot;/api/wallet/&quot;) &amp;&amp; path.contains(&quot;/sufficient-balance/&quot;)) {</span>
<span class="nc" id="L78">            checkSufficientBalance(exchange, path);</span>
        } else {
<span class="nc" id="L80">            sendResponse(exchange, 404, &quot;{\&quot;error\&quot;:\&quot;Endpoint not found\&quot;}&quot;);</span>
        }
<span class="nc" id="L82">    }</span>
    
    /**
     * GET /api/wallet/{userId}/balance - دریافت موجودی کیف پول کاربر
     * 
     * این endpoint موجودی فعلی کیف پول کاربر را برمی‌گرداند
     * 
     * @param exchange شیء HttpExchange
     * @param path مسیر درخواست حاوی userId
     * @throws IOException در صورت خطا در ورودی/خروجی
     */
    private void getWalletBalance(HttpExchange exchange, String path) throws IOException {
        try {
<span class="nc" id="L95">            Long userId = extractPathParameter(path, &quot;/api/wallet/&quot;, &quot;/balance&quot;);</span>
            
<span class="nc" id="L97">            Double balance = walletService.getWalletBalance(userId);</span>
            
<span class="nc" id="L99">            String response = &quot;{\&quot;userId\&quot;:&quot; + userId + &quot;,\&quot;balance\&quot;:&quot; + balance + &quot;}&quot;;</span>
<span class="nc" id="L100">            sendResponse(exchange, 200, response);</span>
            
<span class="nc" id="L102">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L103">            sendResponse(exchange, 400, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L104">        } catch (Exception e) {</span>
<span class="nc" id="L105">            sendResponse(exchange, 404, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L106">        }</span>
<span class="nc" id="L107">    }</span>
    
    /**
     * GET /api/wallet/{userId}/transactions - دریافت تاریخچه تراکنش‌های کیف پول
     * 
     * این endpoint تاریخچه کامل یا در بازه زمانی مشخص تراکنش‌های کیف پول را برمی‌گرداند
     * پشتیبانی از query parameters برای فیلتر زمانی:
     * - startDate: تاریخ شروع (ISO format)
     * - endDate: تاریخ پایان (ISO format)
     */
    private void getWalletTransactionHistory(HttpExchange exchange, String path) throws IOException {
        try {
<span class="nc" id="L119">            Long userId = extractPathParameter(path, &quot;/api/wallet/&quot;, &quot;/transactions&quot;);</span>
            
<span class="nc" id="L121">            String query = exchange.getRequestURI().getQuery();</span>
<span class="nc bnc" id="L122" title="All 6 branches missed.">            if (query != null &amp;&amp; query.contains(&quot;startDate&quot;) &amp;&amp; query.contains(&quot;endDate&quot;)) {</span>
                // پردازش جستجو در بازه زمانی
<span class="nc" id="L124">                Map&lt;String, String&gt; params = parseQueryParams(query);</span>
<span class="nc" id="L125">                String startDateStr = params.get(&quot;startDate&quot;);</span>
<span class="nc" id="L126">                String endDateStr = params.get(&quot;endDate&quot;);</span>
                
<span class="nc" id="L128">                LocalDateTime startDate = LocalDateTime.parse(startDateStr, DateTimeFormatter.ISO_LOCAL_DATE_TIME);</span>
<span class="nc" id="L129">                LocalDateTime endDate = LocalDateTime.parse(endDateStr, DateTimeFormatter.ISO_LOCAL_DATE_TIME);</span>
                
<span class="nc" id="L131">                List&lt;Transaction&gt; transactions = walletService.getWalletTransactionHistory(userId, startDate, endDate);</span>
<span class="nc" id="L132">                String response = serializeTransactionList(transactions);</span>
<span class="nc" id="L133">                sendResponse(exchange, 200, response);</span>
<span class="nc" id="L134">            } else {</span>
                // دریافت تمام تراکنش‌های کیف پول
<span class="nc" id="L136">                List&lt;Transaction&gt; transactions = walletService.getWalletTransactionHistory(userId);</span>
<span class="nc" id="L137">                String response = serializeTransactionList(transactions);</span>
<span class="nc" id="L138">                sendResponse(exchange, 200, response);</span>
            }
            
<span class="nc" id="L141">        } catch (DateTimeParseException e) {</span>
<span class="nc" id="L142">            sendResponse(exchange, 400, &quot;{\&quot;error\&quot;:\&quot;Invalid date format. Use ISO format: yyyy-MM-ddTHH:mm:ss\&quot;}&quot;);</span>
<span class="nc" id="L143">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L144">            sendResponse(exchange, 400, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L145">        } catch (Exception e) {</span>
<span class="nc" id="L146">            sendResponse(exchange, 404, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L147">        }</span>
<span class="nc" id="L148">    }</span>
    
    /**
     * GET /api/wallet/{userId}/charges - دریافت تاریخچه شارژ کیف پول
     * 
     * فقط تراکنش‌های شارژ کیف پول را برمی‌گرداند
     */
    private void getWalletChargeHistory(HttpExchange exchange, String path) throws IOException {
        try {
<span class="nc" id="L157">            Long userId = extractPathParameter(path, &quot;/api/wallet/&quot;, &quot;/charges&quot;);</span>
            
<span class="nc" id="L159">            List&lt;Transaction&gt; transactions = walletService.getWalletChargeHistory(userId);</span>
            
<span class="nc" id="L161">            String response = serializeTransactionList(transactions);</span>
<span class="nc" id="L162">            sendResponse(exchange, 200, response);</span>
            
<span class="nc" id="L164">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L165">            sendResponse(exchange, 400, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L166">        } catch (Exception e) {</span>
<span class="nc" id="L167">            sendResponse(exchange, 404, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L168">        }</span>
<span class="nc" id="L169">    }</span>
    
    /**
     * GET /api/wallet/{userId}/withdrawals - دریافت تاریخچه برداشت از کیف پول
     * 
     * فقط تراکنش‌های برداشت از کیف پول را برمی‌گرداند
     */
    private void getWalletWithdrawalHistory(HttpExchange exchange, String path) throws IOException {
        try {
<span class="nc" id="L178">            Long userId = extractPathParameter(path, &quot;/api/wallet/&quot;, &quot;/withdrawals&quot;);</span>
            
<span class="nc" id="L180">            List&lt;Transaction&gt; transactions = walletService.getWalletWithdrawalHistory(userId);</span>
            
<span class="nc" id="L182">            String response = serializeTransactionList(transactions);</span>
<span class="nc" id="L183">            sendResponse(exchange, 200, response);</span>
            
<span class="nc" id="L185">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L186">            sendResponse(exchange, 400, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L187">        } catch (Exception e) {</span>
<span class="nc" id="L188">            sendResponse(exchange, 404, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L189">        }</span>
<span class="nc" id="L190">    }</span>
    
    /**
     * GET /api/wallet/{userId}/statistics - دریافت آمار کیف پول
     * 
     * آمار کاملی از فعالیت‌های کیف پول شامل موجودی، مجموع شارژ، برداشت و تعداد تراکنش‌ها
     */
    private void getWalletStatistics(HttpExchange exchange, String path) throws IOException {
        try {
<span class="nc" id="L199">            Long userId = extractPathParameter(path, &quot;/api/wallet/&quot;, &quot;/statistics&quot;);</span>
            
<span class="nc" id="L201">            WalletService.WalletStatistics stats = walletService.getWalletStatistics(userId);</span>
            
<span class="nc" id="L203">            String response = serializeWalletStatistics(stats);</span>
<span class="nc" id="L204">            sendResponse(exchange, 200, response);</span>
            
<span class="nc" id="L206">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L207">            sendResponse(exchange, 400, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L208">        } catch (Exception e) {</span>
<span class="nc" id="L209">            sendResponse(exchange, 404, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L210">        }</span>
<span class="nc" id="L211">    }</span>
    
    /**
     * GET /api/wallet/{userId}/sufficient-balance/{amount} - بررسی کفایت موجودی کیف پول
     * 
     * بررسی می‌کند که آیا کاربر موجودی کافی برای مبلغ مورد نظر دارد یا خیر
     * مسیر: /api/wallet/123/sufficient-balance/100.50
     */
    private void checkSufficientBalance(HttpExchange exchange, String path) throws IOException {
        try {
            // استخراج userId و amount از مسیر مانند /api/wallet/123/sufficient-balance/100.50
<span class="nc" id="L222">            String[] parts = path.split(&quot;/&quot;);</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">            if (parts.length &lt; 6) {</span>
<span class="nc" id="L224">                sendResponse(exchange, 400, &quot;{\&quot;error\&quot;:\&quot;Invalid path format\&quot;}&quot;);</span>
<span class="nc" id="L225">                return;</span>
            }
            
<span class="nc" id="L228">            Long userId = Long.parseLong(parts[3]);</span>
<span class="nc" id="L229">            Double amount = Double.parseDouble(parts[5]);</span>
            
<span class="nc" id="L231">            boolean hasSufficient = walletService.hasSufficientBalance(userId, amount);</span>
<span class="nc" id="L232">            Double currentBalance = walletService.getWalletBalance(userId);</span>
            
<span class="nc" id="L234">            String response = &quot;{&quot;</span>
                + &quot;\&quot;userId\&quot;:&quot; + userId + &quot;,&quot;
                + &quot;\&quot;amount\&quot;:&quot; + amount + &quot;,&quot;
                + &quot;\&quot;currentBalance\&quot;:&quot; + currentBalance + &quot;,&quot;
                + &quot;\&quot;hasSufficientBalance\&quot;:&quot; + hasSufficient
                + &quot;}&quot;;
            
<span class="nc" id="L241">            sendResponse(exchange, 200, response);</span>
            
<span class="nc" id="L243">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L244">            sendResponse(exchange, 400, &quot;{\&quot;error\&quot;:\&quot;Invalid userId or amount format\&quot;}&quot;);</span>
<span class="nc" id="L245">        } catch (Exception e) {</span>
<span class="nc" id="L246">            sendResponse(exchange, 500, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L247">        }</span>
<span class="nc" id="L248">    }</span>
    
    // ==================== POST ENDPOINTS ====================
    
    private void handlePostRequest(HttpExchange exchange, String path) throws IOException {
<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (path.equals(&quot;/api/wallet/charge&quot;)) {</span>
<span class="nc" id="L254">            chargeWallet(exchange);</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">        } else if (path.equals(&quot;/api/wallet/charge/card&quot;)) {</span>
<span class="nc" id="L256">            chargeWalletWithCard(exchange);</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">        } else if (path.equals(&quot;/api/wallet/charge/bank-transfer&quot;)) {</span>
<span class="nc" id="L258">            chargeWalletWithBankTransfer(exchange);</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">        } else if (path.equals(&quot;/api/wallet/withdraw&quot;)) {</span>
<span class="nc" id="L260">            withdrawFromWallet(exchange);</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">        } else if (path.equals(&quot;/api/wallet/admin/credit&quot;)) {</span>
<span class="nc" id="L262">            adminCreditWallet(exchange);</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">        } else if (path.equals(&quot;/api/wallet/admin/debit&quot;)) {</span>
<span class="nc" id="L264">            adminDebitWallet(exchange);</span>
        } else {
<span class="nc" id="L266">            sendResponse(exchange, 404, &quot;{\&quot;error\&quot;:\&quot;Endpoint not found\&quot;}&quot;);</span>
        }
<span class="nc" id="L268">    }</span>
    
    /**
     * POST /api/wallet/charge - شارژ عمومی کیف پول
     * 
     * شارژ کیف پول با روش پرداخت مشخص شده در درخواست
     * پارامترهای ضروری: userId, amount, paymentMethod
     * پارامتر اختیاری: description
     */
    private void chargeWallet(HttpExchange exchange) throws IOException {
        try {
<span class="nc" id="L279">            String requestBody = new String(exchange.getRequestBody().readAllBytes());</span>
<span class="nc" id="L280">            Map&lt;String, Object&gt; request = parseJsonRequest(requestBody);</span>
            
<span class="nc" id="L282">            Long userId = extractLong(request, &quot;userId&quot;);</span>
<span class="nc" id="L283">            Double amount = extractDouble(request, &quot;amount&quot;);</span>
<span class="nc" id="L284">            String paymentMethod = extractString(request, &quot;paymentMethod&quot;);</span>
<span class="nc" id="L285">            String description = extractOptionalString(request, &quot;description&quot;);</span>
            
<span class="nc" id="L287">            Transaction transaction = walletService.chargeWallet(userId, amount, paymentMethod, description);</span>
            
<span class="nc" id="L289">            String response = serializeTransaction(transaction);</span>
<span class="nc" id="L290">            sendResponse(exchange, 201, response);</span>
            
<span class="nc" id="L292">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L293">            sendResponse(exchange, 400, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L294">        } catch (Exception e) {</span>
<span class="nc" id="L295">            sendResponse(exchange, 500, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L296">        }</span>
<span class="nc" id="L297">    }</span>
    
    /**
     * POST /api/wallet/charge/card - شارژ کیف پول با کارت
     * 
     * شارژ کیف پول از طریق کارت بانکی
     * پارامترهای ضروری: userId, amount
     */
    private void chargeWalletWithCard(HttpExchange exchange) throws IOException {
        try {
<span class="nc" id="L307">            String requestBody = new String(exchange.getRequestBody().readAllBytes());</span>
<span class="nc" id="L308">            Map&lt;String, Object&gt; request = parseJsonRequest(requestBody);</span>
            
<span class="nc" id="L310">            Long userId = extractLong(request, &quot;userId&quot;);</span>
<span class="nc" id="L311">            Double amount = extractDouble(request, &quot;amount&quot;);</span>
            
<span class="nc" id="L313">            Transaction transaction = walletService.chargeWalletWithCard(userId, amount);</span>
            
<span class="nc" id="L315">            String response = serializeTransaction(transaction);</span>
<span class="nc" id="L316">            sendResponse(exchange, 201, response);</span>
            
<span class="nc" id="L318">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L319">            sendResponse(exchange, 400, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L320">        } catch (Exception e) {</span>
<span class="nc" id="L321">            sendResponse(exchange, 500, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L322">        }</span>
<span class="nc" id="L323">    }</span>
    
    /**
     * POST /api/wallet/charge/bank-transfer - شارژ کیف پول با انتقال بانکی
     * 
     * شارژ کیف پول از طریق انتقال وجه بانکی
     * پارامترهای ضروری: userId, amount, transferReference
     */
    private void chargeWalletWithBankTransfer(HttpExchange exchange) throws IOException {
        try {
<span class="nc" id="L333">            String requestBody = new String(exchange.getRequestBody().readAllBytes());</span>
<span class="nc" id="L334">            Map&lt;String, Object&gt; request = parseJsonRequest(requestBody);</span>
            
<span class="nc" id="L336">            Long userId = extractLong(request, &quot;userId&quot;);</span>
<span class="nc" id="L337">            Double amount = extractDouble(request, &quot;amount&quot;);</span>
<span class="nc" id="L338">            String transferReference = extractString(request, &quot;transferReference&quot;);</span>
            
<span class="nc" id="L340">            Transaction transaction = walletService.chargeWalletWithBankTransfer(userId, amount, transferReference);</span>
            
<span class="nc" id="L342">            String response = serializeTransaction(transaction);</span>
<span class="nc" id="L343">            sendResponse(exchange, 201, response);</span>
            
<span class="nc" id="L345">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L346">            sendResponse(exchange, 400, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L347">        } catch (Exception e) {</span>
<span class="nc" id="L348">            sendResponse(exchange, 500, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L349">        }</span>
<span class="nc" id="L350">    }</span>
    
    /**
     * POST /api/wallet/withdraw - برداشت از کیف پول
     * 
     * برداشت وجه از کیف پول به حساب بانکی
     * پارامترهای ضروری: userId, amount, bankAccount
     * پارامتر اختیاری: reason
     */
    private void withdrawFromWallet(HttpExchange exchange) throws IOException {
        try {
<span class="nc" id="L361">            String requestBody = new String(exchange.getRequestBody().readAllBytes());</span>
<span class="nc" id="L362">            Map&lt;String, Object&gt; request = parseJsonRequest(requestBody);</span>
            
<span class="nc" id="L364">            Long userId = extractLong(request, &quot;userId&quot;);</span>
<span class="nc" id="L365">            Double amount = extractDouble(request, &quot;amount&quot;);</span>
<span class="nc" id="L366">            String bankAccount = extractString(request, &quot;bankAccount&quot;);</span>
<span class="nc" id="L367">            String reason = extractOptionalString(request, &quot;reason&quot;);</span>
            
<span class="nc" id="L369">            Transaction transaction = walletService.withdrawToBank(userId, amount, bankAccount, reason);</span>
            
<span class="nc" id="L371">            String response = serializeTransaction(transaction);</span>
<span class="nc" id="L372">            sendResponse(exchange, 201, response);</span>
            
<span class="nc" id="L374">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L375">            sendResponse(exchange, 400, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L376">        } catch (Exception e) {</span>
<span class="nc" id="L377">            sendResponse(exchange, 500, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L378">        }</span>
<span class="nc" id="L379">    }</span>
    
    /**
     * POST /api/wallet/admin/credit - شارژ کیف پول توسط ادمین
     * 
     * شارژ کیف پول کاربر توسط ادمین (عملیات مدیریتی)
     * پارامترهای ضروری: userId, amount, adminId
     * پارامتر اختیاری: reason
     */
    private void adminCreditWallet(HttpExchange exchange) throws IOException {
        try {
<span class="nc" id="L390">            String requestBody = new String(exchange.getRequestBody().readAllBytes());</span>
<span class="nc" id="L391">            Map&lt;String, Object&gt; request = parseJsonRequest(requestBody);</span>
            
<span class="nc" id="L393">            Long userId = extractLong(request, &quot;userId&quot;);</span>
<span class="nc" id="L394">            Double amount = extractDouble(request, &quot;amount&quot;);</span>
<span class="nc" id="L395">            String reason = extractOptionalString(request, &quot;reason&quot;);</span>
<span class="nc" id="L396">            Long adminId = extractLong(request, &quot;adminId&quot;);</span>
            
<span class="nc" id="L398">            Transaction transaction = walletService.adminCreditWallet(userId, amount, reason, adminId);</span>
            
<span class="nc" id="L400">            String response = serializeTransaction(transaction);</span>
<span class="nc" id="L401">            sendResponse(exchange, 201, response);</span>
            
<span class="nc" id="L403">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L404">            sendResponse(exchange, 400, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L405">        } catch (Exception e) {</span>
<span class="nc" id="L406">            sendResponse(exchange, 500, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L407">        }</span>
<span class="nc" id="L408">    }</span>
    
    /**
     * POST /api/wallet/admin/debit - برداشت از کیف پول توسط ادمین
     * 
     * برداشت از کیف پول کاربر توسط ادمین (عملیات مدیریتی)
     * پارامترهای ضروری: userId, amount, adminId
     * پارامتر اختیاری: reason
     */
    private void adminDebitWallet(HttpExchange exchange) throws IOException {
        try {
<span class="nc" id="L419">            String requestBody = new String(exchange.getRequestBody().readAllBytes());</span>
<span class="nc" id="L420">            Map&lt;String, Object&gt; request = parseJsonRequest(requestBody);</span>
            
<span class="nc" id="L422">            Long userId = extractLong(request, &quot;userId&quot;);</span>
<span class="nc" id="L423">            Double amount = extractDouble(request, &quot;amount&quot;);</span>
<span class="nc" id="L424">            String reason = extractOptionalString(request, &quot;reason&quot;);</span>
<span class="nc" id="L425">            Long adminId = extractLong(request, &quot;adminId&quot;);</span>
            
<span class="nc" id="L427">            Transaction transaction = walletService.adminDebitWallet(userId, amount, reason, adminId);</span>
            
<span class="nc" id="L429">            String response = serializeTransaction(transaction);</span>
<span class="nc" id="L430">            sendResponse(exchange, 201, response);</span>
            
<span class="nc" id="L432">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L433">            sendResponse(exchange, 400, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L434">        } catch (Exception e) {</span>
<span class="nc" id="L435">            sendResponse(exchange, 500, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="nc" id="L436">        }</span>
<span class="nc" id="L437">    }</span>
    
    // ==================== UTILITY METHODS ====================
    
    private void sendResponse(HttpExchange exchange, int statusCode, String response) throws IOException {
<span class="nc" id="L442">        exchange.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<span class="nc" id="L443">        exchange.getResponseHeaders().set(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);</span>
<span class="nc" id="L444">        exchange.sendResponseHeaders(statusCode, response.length());</span>
<span class="nc" id="L445">        try (OutputStream os = exchange.getResponseBody()) {</span>
<span class="nc" id="L446">            os.write(response.getBytes());</span>
        }
<span class="nc" id="L448">    }</span>
    
    private Long extractPathParameter(String path, String prefix, String suffix) {
<span class="nc" id="L451">        String param = path.substring(prefix.length());</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">        if (!suffix.isEmpty()) {</span>
<span class="nc" id="L453">            param = param.substring(0, param.length() - suffix.length());</span>
        }
<span class="nc" id="L455">        return Long.parseLong(param);</span>
    }
    
    private Map&lt;String, Object&gt; parseJsonRequest(String json) {
        // پارس ساده JSON برای درخواست‌های پایه
<span class="nc" id="L460">        Map&lt;String, Object&gt; result = new java.util.HashMap&lt;&gt;();</span>
        
<span class="nc" id="L462">        json = json.trim();</span>
<span class="nc bnc" id="L463" title="All 4 branches missed.">        if (json.startsWith(&quot;{&quot;) &amp;&amp; json.endsWith(&quot;}&quot;)) {</span>
<span class="nc" id="L464">            json = json.substring(1, json.length() - 1);</span>
<span class="nc" id="L465">            String[] pairs = json.split(&quot;,&quot;);</span>
            
<span class="nc bnc" id="L467" title="All 2 branches missed.">            for (String pair : pairs) {</span>
<span class="nc" id="L468">                String[] keyValue = pair.split(&quot;:&quot;);</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">                if (keyValue.length == 2) {</span>
<span class="nc" id="L470">                    String key = keyValue[0].trim().replaceAll(&quot;\&quot;&quot;, &quot;&quot;);</span>
<span class="nc" id="L471">                    String value = keyValue[1].trim().replaceAll(&quot;\&quot;&quot;, &quot;&quot;);</span>
                    
                    // تلاش برای پارس به عنوان عدد
                    try {
<span class="nc bnc" id="L475" title="All 2 branches missed.">                        if (value.contains(&quot;.&quot;)) {</span>
<span class="nc" id="L476">                            result.put(key, Double.parseDouble(value));</span>
                        } else {
<span class="nc" id="L478">                            result.put(key, Long.parseLong(value));</span>
                        }
<span class="nc" id="L480">                    } catch (NumberFormatException e) {</span>
<span class="nc" id="L481">                        result.put(key, value);</span>
<span class="nc" id="L482">                    }</span>
                }
            }
        }
        
<span class="nc" id="L487">        return result;</span>
    }
    
    private Map&lt;String, String&gt; parseQueryParams(String query) {
<span class="nc" id="L491">        Map&lt;String, String&gt; params = new java.util.HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">        if (query != null) {</span>
<span class="nc" id="L493">            String[] pairs = query.split(&quot;&amp;&quot;);</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">            for (String pair : pairs) {</span>
<span class="nc" id="L495">                String[] keyValue = pair.split(&quot;=&quot;);</span>
<span class="nc bnc" id="L496" title="All 2 branches missed.">                if (keyValue.length == 2) {</span>
<span class="nc" id="L497">                    params.put(keyValue[0], keyValue[1]);</span>
                }
            }
        }
<span class="nc" id="L501">        return params;</span>
    }
    
    private Long extractLong(Map&lt;String, Object&gt; request, String key) {
<span class="nc" id="L505">        Object value = request.get(key);</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">        if (value instanceof Long) {</span>
<span class="nc" id="L507">            return (Long) value;</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">        } else if (value instanceof Integer) {</span>
<span class="nc" id="L509">            return ((Integer) value).longValue();</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">        } else if (value instanceof String) {</span>
<span class="nc" id="L511">            return Long.parseLong((String) value);</span>
        }
<span class="nc" id="L513">        throw new IllegalArgumentException(&quot;Missing or invalid &quot; + key);</span>
    }
    
    private Double extractDouble(Map&lt;String, Object&gt; request, String key) {
<span class="nc" id="L517">        Object value = request.get(key);</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">        if (value instanceof Double) {</span>
<span class="nc" id="L519">            return (Double) value;</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">        } else if (value instanceof Integer) {</span>
<span class="nc" id="L521">            return ((Integer) value).doubleValue();</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">        } else if (value instanceof Long) {</span>
<span class="nc" id="L523">            return ((Long) value).doubleValue();</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">        } else if (value instanceof String) {</span>
<span class="nc" id="L525">            return Double.parseDouble((String) value);</span>
        }
<span class="nc" id="L527">        throw new IllegalArgumentException(&quot;Missing or invalid &quot; + key);</span>
    }
    
    private String extractString(Map&lt;String, Object&gt; request, String key) {
<span class="nc" id="L531">        Object value = request.get(key);</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">        if (value instanceof String) {</span>
<span class="nc" id="L533">            return (String) value;</span>
        }
<span class="nc" id="L535">        throw new IllegalArgumentException(&quot;Missing or invalid &quot; + key);</span>
    }
    
    private String extractOptionalString(Map&lt;String, Object&gt; request, String key) {
<span class="nc" id="L539">        Object value = request.get(key);</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">        return value instanceof String ? (String) value : null;</span>
    }
    
    private String serializeTransaction(Transaction transaction) {
<span class="nc" id="L544">        return &quot;{&quot;</span>
<span class="nc" id="L545">            + &quot;\&quot;id\&quot;:&quot; + transaction.getId() + &quot;,&quot;</span>
<span class="nc" id="L546">            + &quot;\&quot;userId\&quot;:&quot; + transaction.getUserId() + &quot;,&quot;</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">            + &quot;\&quot;orderId\&quot;:&quot; + (transaction.getOrderId() != null ? transaction.getOrderId() : &quot;null&quot;) + &quot;,&quot;</span>
<span class="nc" id="L548">            + &quot;\&quot;amount\&quot;:&quot; + transaction.getAmount() + &quot;,&quot;</span>
<span class="nc" id="L549">            + &quot;\&quot;type\&quot;:\&quot;&quot; + transaction.getType() + &quot;\&quot;,&quot;</span>
<span class="nc" id="L550">            + &quot;\&quot;status\&quot;:\&quot;&quot; + transaction.getStatus() + &quot;\&quot;,&quot;</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">            + &quot;\&quot;paymentMethod\&quot;:\&quot;&quot; + (transaction.getPaymentMethod() != null ? transaction.getPaymentMethod() : &quot;&quot;) + &quot;\&quot;,&quot;</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">            + &quot;\&quot;referenceId\&quot;:\&quot;&quot; + (transaction.getReferenceId() != null ? transaction.getReferenceId() : &quot;&quot;) + &quot;\&quot;,&quot;</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">            + &quot;\&quot;description\&quot;:\&quot;&quot; + (transaction.getDescription() != null ? transaction.getDescription() : &quot;&quot;) + &quot;\&quot;,&quot;</span>
<span class="nc" id="L554">            + &quot;\&quot;createdAt\&quot;:\&quot;&quot; + transaction.getCreatedAt() + &quot;\&quot;,&quot;</span>
<span class="nc bnc" id="L555" title="All 2 branches missed.">            + &quot;\&quot;updatedAt\&quot;:\&quot;&quot; + (transaction.getUpdatedAt() != null ? transaction.getUpdatedAt() : &quot;&quot;) + &quot;\&quot;,&quot;</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">            + &quot;\&quot;processedAt\&quot;:\&quot;&quot; + (transaction.getProcessedAt() != null ? transaction.getProcessedAt() : &quot;&quot;) + &quot;\&quot;&quot;</span>
            + &quot;}&quot;;
    }
    
    private String serializeTransactionList(List&lt;Transaction&gt; transactions) {
<span class="nc" id="L561">        StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L562">        sb.append(&quot;[&quot;);</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">        for (int i = 0; i &lt; transactions.size(); i++) {</span>
<span class="nc bnc" id="L564" title="All 2 branches missed.">            if (i &gt; 0) sb.append(&quot;,&quot;);</span>
<span class="nc" id="L565">            sb.append(serializeTransaction(transactions.get(i)));</span>
        }
<span class="nc" id="L567">        sb.append(&quot;]&quot;);</span>
<span class="nc" id="L568">        return sb.toString();</span>
    }
    
    private String serializeWalletStatistics(WalletService.WalletStatistics stats) {
<span class="nc" id="L572">        return &quot;{&quot;</span>
<span class="nc" id="L573">            + &quot;\&quot;currentBalance\&quot;:&quot; + stats.getCurrentBalance() + &quot;,&quot;</span>
<span class="nc" id="L574">            + &quot;\&quot;totalCharged\&quot;:&quot; + stats.getTotalCharged() + &quot;,&quot;</span>
<span class="nc" id="L575">            + &quot;\&quot;totalWithdrawn\&quot;:&quot; + stats.getTotalWithdrawn() + &quot;,&quot;</span>
<span class="nc" id="L576">            + &quot;\&quot;totalChargeTransactions\&quot;:&quot; + stats.getTotalChargeTransactions() + &quot;,&quot;</span>
<span class="nc" id="L577">            + &quot;\&quot;totalWithdrawalTransactions\&quot;:&quot; + stats.getTotalWithdrawalTransactions() + &quot;,&quot;</span>
<span class="nc" id="L578">            + &quot;\&quot;netFlow\&quot;:&quot; + stats.getNetFlow() + &quot;,&quot;</span>
<span class="nc" id="L579">            + &quot;\&quot;totalTransactions\&quot;:&quot; + stats.getTotalTransactions()</span>
            + &quot;}&quot;;
    }
    
    // ==================== WRAPPER METHODS FOR TESTING ====================
    
    /**
     * اضافه کردن متدهای wrapper مستقیم برای تست‌ها و فراخوانی‌های internal
     * این متدها بدون HTTP layer کار می‌کنند
     */
    
    /**
     * دریافت موجودی کیف پول کاربر
     */
    public java.math.BigDecimal getBalance(Long userId) {
<span class="fc bfc" id="L594" title="All 2 branches covered.">        if (userId == null) {</span>
<span class="fc" id="L595">            throw new IllegalArgumentException(&quot;User ID cannot be null&quot;);</span>
        }
<span class="fc" id="L597">        return walletService.getBalance(userId);</span>
    }
    
    /**
     * شارژ کیف پول کاربر
     */
    public Transaction creditWallet(Long userId, java.math.BigDecimal amount, String description) {
<span class="pc bpc" id="L604" title="1 of 2 branches missed.">        if (userId == null) {</span>
<span class="nc" id="L605">            throw new IllegalArgumentException(&quot;User ID cannot be null&quot;);</span>
        }
<span class="fc" id="L607">        return walletService.creditWallet(userId, amount, description);</span>
    }
    
    /**
     * برداشت از کیف پول کاربر
     */
    public Transaction debitWallet(Long userId, java.math.BigDecimal amount, String description) {
<span class="pc bpc" id="L614" title="1 of 2 branches missed.">        if (userId == null) {</span>
<span class="nc" id="L615">            throw new IllegalArgumentException(&quot;User ID cannot be null&quot;);</span>
        }
<span class="fc" id="L617">        return walletService.debitWallet(userId, amount, description);</span>
    }
    
    /**
     * دریافت تاریخچه تراکنش‌های کیف پول
     */
    public List&lt;Transaction&gt; getTransactionHistory(Long userId) {
<span class="pc bpc" id="L624" title="1 of 2 branches missed.">        if (userId == null) {</span>
<span class="nc" id="L625">            throw new IllegalArgumentException(&quot;User ID cannot be null&quot;);</span>
        }
<span class="fc" id="L627">        return walletService.getTransactionHistory(userId);</span>
    }
    
    /**
     * انتقال وجه بین دو کیف پول
     */
    public Transaction transfer(Long fromUserId, Long toUserId, java.math.BigDecimal amount, String description) {
<span class="pc bpc" id="L634" title="2 of 4 branches missed.">        if (fromUserId == null || toUserId == null) {</span>
<span class="nc" id="L635">            throw new IllegalArgumentException(&quot;User IDs cannot be null&quot;);</span>
        }
<span class="fc" id="L637">        return walletService.transfer(fromUserId, toUserId, amount, description);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>