<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WalletService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.payment</a> &gt; <span class="el_source">WalletService.java</span></div><h1>WalletService.java</h1><pre class="source lang-java linenums">package com.myapp.payment;

/**
 * سرویس مدیریت کیف پول دیجیتال کاربران
 * 
 * این کلاس مسئول پیاده‌سازی منطق کسب‌وکار مربوط به:
 * - مدیریت موجودی کیف پول کاربران
 * - شارژ کیف پول از طریق روش‌های مختلف
 * - برداشت و انتقال وجه از کیف پول
 * - تاریخچه تراکنش‌های کیف پول
 * - آمار و گزارش‌گیری کیف پول
 * - اعتبارسنجی عملیات مالی
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 */

import com.myapp.common.exceptions.NotFoundException;
import com.myapp.common.exceptions.InsufficientFundsException;
import com.myapp.common.models.Transaction;
import com.myapp.common.models.TransactionStatus;
import com.myapp.common.models.TransactionType;
import com.myapp.common.models.User;
import com.myapp.auth.AuthRepository;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;
import java.util.UUID;

/**
 * سرویس مدیریت کیف پول و عملیات مالی
 * 
 * این کلاس تمام عملیات مربوط به کیف پول کاربران را مدیریت می‌کند:
 * - مدیریت موجودی کیف پول
 * - شارژ و برداشت از کیف پول  
 * - انتقال وجه بین کیف پول‌ها
 * - تاریخچه تراکنش‌ها
 * - آمار و گزارش‌گیری
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 */
public class WalletService {
    
    private final PaymentRepository paymentRepository;
    private final AuthRepository authRepository;
    
<span class="nc" id="L52">    public WalletService() {</span>
<span class="nc" id="L53">        this.paymentRepository = new PaymentRepository();</span>
<span class="nc" id="L54">        this.authRepository = new AuthRepository();</span>
<span class="nc" id="L55">    }</span>
    
<span class="fc" id="L57">    public WalletService(PaymentRepository paymentRepository, AuthRepository authRepository) {</span>
<span class="fc" id="L58">        this.paymentRepository = paymentRepository;</span>
<span class="fc" id="L59">        this.authRepository = authRepository;</span>
<span class="fc" id="L60">    }</span>
    
    // ==================== WRAPPER METHODS FOR TEST COMPATIBILITY ====================
    
    /**
     * دریافت موجودی کیف پول - wrapper method برای تست‌ها
     * 
     * @param userId شناسه کاربر
     * @return موجودی کیف پول
     */
    public BigDecimal getBalance(Long userId) {
<span class="nc" id="L71">        Double balance = getWalletBalance(userId);</span>
<span class="nc" id="L72">        return BigDecimal.valueOf(balance);</span>
    }
    
    /**
     * شارژ کیف پول - wrapper method برای تست‌ها
     * 
     * @param userId شناسه کاربر
     * @param amount مبلغ شارژ
     * @param description توضیحات
     * @return تراکنش شارژ
     * @throws InsufficientFundsException در صورت خطا
     */
    public Transaction creditWallet(Long userId, BigDecimal amount, String description) {
<span class="nc bnc" id="L85" title="All 4 branches missed.">        if (amount == null || amount.compareTo(BigDecimal.ZERO) &lt;= 0) {</span>
<span class="nc" id="L86">            throw new IllegalArgumentException(&quot;Credit amount must be positive&quot;);</span>
        }
        
<span class="nc" id="L89">        Transaction transaction = chargeWallet(userId, amount.doubleValue(), &quot;CREDIT&quot;, description);</span>
<span class="nc" id="L90">        transaction.setType(TransactionType.CREDIT);</span>
<span class="nc" id="L91">        return paymentRepository.update(transaction);</span>
    }
    
    /**
     * برداشت از کیف پول - wrapper method برای تست‌ها
     * 
     * @param userId شناسه کاربر
     * @param amount مبلغ برداشت
     * @param description توضیحات
     * @return تراکنش برداشت
     * @throws InsufficientFundsException در صورت کمبود موجودی
     */
    public Transaction debitWallet(Long userId, BigDecimal amount, String description) throws InsufficientFundsException {
<span class="nc bnc" id="L104" title="All 4 branches missed.">        if (amount == null || amount.compareTo(BigDecimal.ZERO) &lt;= 0) {</span>
<span class="nc" id="L105">            throw new IllegalArgumentException(&quot;Debit amount must be positive&quot;);</span>
        }
        
        // بررسی موجودی کافی
<span class="nc" id="L109">        Double currentBalance = getWalletBalance(userId);</span>
<span class="nc" id="L110">        Double debitAmount = amount.doubleValue();</span>
        
<span class="nc bnc" id="L112" title="All 2 branches missed.">        if (currentBalance &lt; debitAmount) {</span>
<span class="nc" id="L113">            throw InsufficientFundsException.forWallet(currentBalance, debitAmount);</span>
        }
        
        // ایجاد تراکنش برداشت
<span class="nc" id="L117">        Transaction transaction = Transaction.forWalletWithdrawal(userId, debitAmount, description);</span>
<span class="nc" id="L118">        transaction.setType(TransactionType.DEBIT);</span>
        
        // تکمیل تراکنش
<span class="nc" id="L121">        String referenceId = &quot;DEBIT_&quot; + UUID.randomUUID().toString().substring(0, 8);</span>
<span class="nc" id="L122">        transaction.markAsCompleted(referenceId);</span>
        
<span class="nc" id="L124">        return paymentRepository.save(transaction);</span>
    }
    
    /**
     * دریافت تاریخچه تراکنش‌ها - wrapper method برای تست‌ها
     * 
     * @param userId شناسه کاربر
     * @return لیست تراکنش‌های کیف پول
     */
    public List&lt;Transaction&gt; getTransactionHistory(Long userId) {
<span class="nc" id="L134">        return getWalletTransactionHistory(userId);</span>
    }
    
    /**
     * انتقال وجه بین کیف پول‌ها
     * 
     * @param fromUserId شناسه کاربر فرستنده
     * @param toUserId شناسه کاربر گیرنده
     * @param amount مبلغ انتقال
     * @param description توضیحات انتقال
     * @return تراکنش انتقال
     * @throws InsufficientFundsException در صورت کمبود موجودی
     */
    public Transaction transfer(Long fromUserId, Long toUserId, BigDecimal amount, String description) throws InsufficientFundsException {
<span class="pc bpc" id="L148" title="2 of 4 branches missed.">        if (fromUserId == null || fromUserId &lt;= 0) {</span>
<span class="nc" id="L149">            throw new IllegalArgumentException(&quot;From user ID must be positive&quot;);</span>
        }
<span class="pc bpc" id="L151" title="2 of 4 branches missed.">        if (toUserId == null || toUserId &lt;= 0) {</span>
<span class="nc" id="L152">            throw new IllegalArgumentException(&quot;To user ID must be positive&quot;);</span>
        }
<span class="fc bfc" id="L154" title="All 2 branches covered.">        if (fromUserId.equals(toUserId)) {</span>
<span class="fc" id="L155">            throw new IllegalArgumentException(&quot;Cannot transfer to the same user&quot;);</span>
        }
<span class="pc bpc" id="L157" title="1 of 4 branches missed.">        if (amount == null || amount.compareTo(BigDecimal.ZERO) &lt;= 0) {</span>
<span class="fc" id="L158">            throw new IllegalArgumentException(&quot;Transfer amount must be positive&quot;);</span>
        }
<span class="fc bfc" id="L160" title="All 2 branches covered.">        if (amount.compareTo(BigDecimal.valueOf(10000)) &gt; 0) {</span>
<span class="fc" id="L161">            throw new IllegalArgumentException(&quot;Maximum transfer amount is 10,000&quot;);</span>
        }
        
        // بررسی وجود کاربران
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">        if (!authRepository.existsById(fromUserId)) {</span>
<span class="nc" id="L166">            throw new NotFoundException(&quot;From user&quot;, fromUserId);</span>
        }
<span class="fc bfc" id="L168" title="All 2 branches covered.">        if (!authRepository.existsById(toUserId)) {</span>
<span class="fc" id="L169">            throw new NotFoundException(&quot;To user&quot;, toUserId);</span>
        }
        
<span class="fc" id="L172">        Double transferAmount = amount.doubleValue();</span>
        
        // بررسی موجودی کافی
<span class="fc" id="L175">        Double fromBalance = getWalletBalance(fromUserId);</span>
<span class="fc bfc" id="L176" title="All 2 branches covered.">        if (fromBalance &lt; transferAmount) {</span>
<span class="fc" id="L177">            throw InsufficientFundsException.forWallet(fromBalance, transferAmount);</span>
        }
        
        // ایجاد تراکنش برداشت از فرستنده
<span class="fc" id="L181">        String debitDesc = &quot;Transfer to user #&quot; + toUserId;</span>
<span class="pc bpc" id="L182" title="2 of 4 branches missed.">        if (description != null &amp;&amp; !description.trim().isEmpty()) {</span>
<span class="fc" id="L183">            debitDesc += &quot;: &quot; + description.trim();</span>
        }
        
<span class="fc" id="L186">        Transaction debitTransaction = Transaction.forWalletWithdrawal(fromUserId, transferAmount, debitDesc);</span>
<span class="fc" id="L187">        debitTransaction.setType(TransactionType.DEBIT);</span>
<span class="fc" id="L188">        String debitRef = &quot;TRANSFER_OUT_&quot; + UUID.randomUUID().toString().substring(0, 8);</span>
<span class="fc" id="L189">        debitTransaction.markAsCompleted(debitRef);</span>
<span class="fc" id="L190">        debitTransaction = paymentRepository.save(debitTransaction);</span>
        
        // ایجاد تراکنش شارژ برای گیرنده
<span class="fc" id="L193">        String creditDesc = &quot;Transfer from user #&quot; + fromUserId;</span>
<span class="pc bpc" id="L194" title="2 of 4 branches missed.">        if (description != null &amp;&amp; !description.trim().isEmpty()) {</span>
<span class="fc" id="L195">            creditDesc += &quot;: &quot; + description.trim();</span>
        }
        
<span class="fc" id="L198">        Transaction creditTransaction = Transaction.forWalletCharge(toUserId, transferAmount, &quot;TRANSFER&quot;);</span>
<span class="fc" id="L199">        creditTransaction.setType(TransactionType.CREDIT);</span>
<span class="fc" id="L200">        creditTransaction.setDescription(creditDesc);</span>
<span class="fc" id="L201">        String creditRef = &quot;TRANSFER_IN_&quot; + UUID.randomUUID().toString().substring(0, 8);</span>
<span class="fc" id="L202">        creditTransaction.markAsCompleted(creditRef);</span>
<span class="fc" id="L203">        creditTransaction = paymentRepository.save(creditTransaction);</span>
        
        // ایجاد تراکنش انتقال اصلی
<span class="fc" id="L206">        Transaction transferTransaction = new Transaction();</span>
<span class="fc" id="L207">        transferTransaction.setUserId(fromUserId);</span>
<span class="fc" id="L208">        transferTransaction.setAmount(transferAmount);</span>
<span class="fc" id="L209">        transferTransaction.setType(TransactionType.TRANSFER);</span>
<span class="fc" id="L210">        transferTransaction.setStatus(TransactionStatus.COMPLETED);</span>
<span class="fc" id="L211">        transferTransaction.setPaymentMethod(&quot;WALLET_TRANSFER&quot;);</span>
<span class="fc" id="L212">        transferTransaction.setReferenceId(&quot;TRANSFER_&quot; + UUID.randomUUID().toString().substring(0, 8));</span>
<span class="fc" id="L213">        transferTransaction.setDescription(&quot;Transfer to user #&quot; + toUserId + &quot;: &quot; + description);</span>
<span class="fc" id="L214">        transferTransaction.setCreatedAt(LocalDateTime.now());</span>
<span class="fc" id="L215">        transferTransaction.setUpdatedAt(LocalDateTime.now());</span>
        
<span class="fc" id="L217">        return paymentRepository.save(transferTransaction);</span>
    }

    // ==================== EXISTING WALLET BALANCE MANAGEMENT ====================
    
    /**
     * دریافت موجودی کیف پول کاربر
     * 
     * @param userId شناسه کاربر
     * @return موجودی کیف پول
     */
    public Double getWalletBalance(Long userId) {
<span class="fc bfc" id="L229" title="All 4 branches covered.">        if (userId == null || userId &lt;= 0) {</span>
<span class="fc" id="L230">            throw new IllegalArgumentException(&quot;User ID must be positive&quot;);</span>
        }
        
        // بررسی وجود کاربر
<span class="fc bfc" id="L234" title="All 2 branches covered.">        if (!authRepository.existsById(userId)) {</span>
<span class="fc" id="L235">            throw new NotFoundException(&quot;User&quot;, userId);</span>
        }
        
<span class="fc" id="L238">        return paymentRepository.calculateWalletBalance(userId);</span>
    }
    
    /**
     * Check if user has sufficient balance
     */
    public boolean hasSufficientBalance(Long userId, Double amount) {
<span class="pc bpc" id="L245" title="1 of 4 branches missed.">        if (userId == null || userId &lt;= 0) {</span>
<span class="fc" id="L246">            return false;</span>
        }
<span class="fc bfc" id="L248" title="All 4 branches covered.">        if (amount == null || amount &lt;= 0) {</span>
<span class="fc" id="L249">            return false;</span>
        }
        
        try {
<span class="fc" id="L253">            Double balance = getWalletBalance(userId);</span>
<span class="fc bfc" id="L254" title="All 2 branches covered.">            return balance &gt;= amount;</span>
<span class="nc" id="L255">        } catch (Exception e) {</span>
<span class="nc" id="L256">            return false;</span>
        }
    }
    
    // ==================== WALLET CHARGING ====================
    
    /**
     * Charge wallet using card payment
     */
    public Transaction chargeWalletWithCard(Long userId, Double amount) {
<span class="fc" id="L266">        return chargeWallet(userId, amount, &quot;CARD&quot;, &quot;Wallet charge via card&quot;);</span>
    }
    
    /**
     * Charge wallet using bank transfer
     */
    public Transaction chargeWalletWithBankTransfer(Long userId, Double amount, String transferReference) {
<span class="fc" id="L273">        String description = &quot;Wallet charge via bank transfer. Reference: &quot; + transferReference;</span>
<span class="fc" id="L274">        return chargeWallet(userId, amount, &quot;BANK_TRANSFER&quot;, description);</span>
    }
    
    /**
     * Charge wallet (generic method)
     */
    public Transaction chargeWallet(Long userId, Double amount, String paymentMethod, String description) {
        // Validate inputs
<span class="pc bpc" id="L282" title="2 of 4 branches missed.">        if (userId == null || userId &lt;= 0) {</span>
<span class="nc" id="L283">            throw new IllegalArgumentException(&quot;User ID must be positive&quot;);</span>
        }
<span class="fc bfc" id="L285" title="All 4 branches covered.">        if (amount == null || amount &lt;= 0) {</span>
<span class="fc" id="L286">            throw new IllegalArgumentException(&quot;Charge amount must be positive&quot;);</span>
        }
<span class="fc bfc" id="L288" title="All 2 branches covered.">        if (amount &gt; 10000.0) {</span>
<span class="fc" id="L289">            throw new IllegalArgumentException(&quot;Maximum charge amount is 10,000 per transaction&quot;);</span>
        }
<span class="pc bpc" id="L291" title="1 of 4 branches missed.">        if (paymentMethod == null || paymentMethod.trim().isEmpty()) {</span>
<span class="fc" id="L292">            throw new IllegalArgumentException(&quot;Payment method cannot be empty&quot;);</span>
        }
        
        // Verify user exists
<span class="fc" id="L296">        Optional&lt;User&gt; userOpt = authRepository.findById(userId);</span>
<span class="pc bpc" id="L297" title="1 of 2 branches missed.">        if (userOpt.isEmpty()) {</span>
<span class="nc" id="L298">            throw new NotFoundException(&quot;User&quot;, userId);</span>
        }
        
        // Check daily charge limit
<span class="fc" id="L302">        validateDailyChargeLimit(userId, amount);</span>
        
        // Create wallet charge transaction
<span class="fc" id="L305">        Transaction chargeTransaction = Transaction.forWalletCharge(userId, amount, paymentMethod);</span>
<span class="pc bpc" id="L306" title="2 of 4 branches missed.">        if (description != null &amp;&amp; !description.trim().isEmpty()) {</span>
<span class="fc" id="L307">            chargeTransaction.setDescription(description.trim());</span>
        }
        
<span class="fc" id="L310">        chargeTransaction = paymentRepository.save(chargeTransaction);</span>
        
        // Process charge based on payment method
        try {
<span class="pc bpc" id="L314" title="1 of 4 branches missed.">            switch (paymentMethod.toUpperCase()) {</span>
                case &quot;CARD&quot;:
<span class="fc" id="L316">                    processCardCharge(chargeTransaction);</span>
<span class="fc" id="L317">                    break;</span>
                case &quot;BANK_TRANSFER&quot;:
<span class="fc" id="L319">                    processBankTransferCharge(chargeTransaction);</span>
<span class="fc" id="L320">                    break;</span>
                case &quot;ADMIN_CREDIT&quot;:
<span class="nc" id="L322">                    processAdminCredit(chargeTransaction);</span>
<span class="nc" id="L323">                    break;</span>
                default:
<span class="fc" id="L325">                    throw new IllegalArgumentException(&quot;Unsupported payment method for wallet charge: &quot; + paymentMethod);</span>
            }
<span class="fc" id="L327">        } catch (Exception e) {</span>
<span class="fc" id="L328">            chargeTransaction.markAsFailed(e.getMessage());</span>
<span class="fc" id="L329">            paymentRepository.update(chargeTransaction);</span>
<span class="fc" id="L330">            throw e;</span>
<span class="fc" id="L331">        }</span>
        
<span class="fc" id="L333">        return chargeTransaction;</span>
    }
    
    /**
     * Process card charge (simulation)
     */
    private void processCardCharge(Transaction transaction) {
        // Simulate card payment processing
<span class="fc" id="L341">        String referenceId = &quot;CARD_CHARGE_&quot; + UUID.randomUUID().toString().substring(0, 8);</span>
        
        // Simulate payment gateway response (95% success rate for wallet charges)
<span class="fc bfc" id="L344" title="All 2 branches covered.">        if (Math.random() &lt; 0.95) {</span>
<span class="fc" id="L345">            transaction.markAsCompleted(referenceId);</span>
        } else {
<span class="fc" id="L347">            transaction.markAsFailed(&quot;Card charge declined by bank&quot;);</span>
        }
        
<span class="fc" id="L350">        paymentRepository.update(transaction);</span>
<span class="fc" id="L351">    }</span>
    
    /**
     * Process bank transfer charge
     */
    private void processBankTransferCharge(Transaction transaction) {
        // Bank transfers need manual verification
<span class="fc" id="L358">        transaction.setDescription(transaction.getDescription() + &quot; - Pending bank verification&quot;);</span>
<span class="fc" id="L359">        paymentRepository.update(transaction);</span>
<span class="fc" id="L360">    }</span>
    
    /**
     * Process admin credit (instant)
     */
    private void processAdminCredit(Transaction transaction) {
<span class="nc" id="L366">        String referenceId = &quot;ADMIN_CREDIT_&quot; + UUID.randomUUID().toString().substring(0, 8);</span>
<span class="nc" id="L367">        transaction.markAsCompleted(referenceId);</span>
<span class="nc" id="L368">        paymentRepository.update(transaction);</span>
<span class="nc" id="L369">    }</span>
    
    /**
     * Validate daily charge limit
     */
    private void validateDailyChargeLimit(Long userId, Double amount) {
<span class="fc" id="L375">        LocalDateTime startOfDay = LocalDateTime.now().withHour(0).withMinute(0).withSecond(0).withNano(0);</span>
<span class="fc" id="L376">        LocalDateTime endOfDay = startOfDay.plusDays(1).minusNanos(1);</span>
        
<span class="fc" id="L378">        List&lt;Transaction&gt; todayCharges = paymentRepository.findByUserIdAndDateRange(userId, startOfDay, endOfDay)</span>
<span class="fc" id="L379">            .stream()</span>
<span class="pc bpc" id="L380" title="2 of 4 branches missed.">            .filter(t -&gt; t.getType() == TransactionType.WALLET_CHARGE &amp;&amp; t.getStatus() == TransactionStatus.COMPLETED)</span>
<span class="fc" id="L381">            .toList();</span>
        
<span class="fc" id="L383">        Double todayTotal = todayCharges.stream()</span>
<span class="fc" id="L384">            .mapToDouble(Transaction::getAmount)</span>
<span class="fc" id="L385">            .sum();</span>
        
<span class="fc" id="L387">        Double dailyLimit = 50000.0; // Daily limit of 50,000</span>
<span class="fc bfc" id="L388" title="All 2 branches covered.">        if (todayTotal + amount &gt; dailyLimit) {</span>
<span class="fc" id="L389">            throw new IllegalArgumentException(&quot;Daily charge limit exceeded. Today: &quot; + todayTotal + &quot;, Limit: &quot; + dailyLimit);</span>
        }
<span class="fc" id="L391">    }</span>
    
    // ==================== WALLET WITHDRAWAL ====================
    
    /**
     * Withdraw from wallet to bank account
     */
    public Transaction withdrawToBank(Long userId, Double amount, String bankAccount, String reason) {
        // Validate inputs
<span class="pc bpc" id="L400" title="2 of 4 branches missed.">        if (userId == null || userId &lt;= 0) {</span>
<span class="nc" id="L401">            throw new IllegalArgumentException(&quot;User ID must be positive&quot;);</span>
        }
<span class="pc bpc" id="L403" title="2 of 4 branches missed.">        if (amount == null || amount &lt;= 0) {</span>
<span class="nc" id="L404">            throw new IllegalArgumentException(&quot;Withdrawal amount must be positive&quot;);</span>
        }
<span class="fc bfc" id="L406" title="All 2 branches covered.">        if (amount &lt; 10.0) {</span>
<span class="fc" id="L407">            throw new IllegalArgumentException(&quot;Minimum withdrawal amount is 10&quot;);</span>
        }
<span class="fc bfc" id="L409" title="All 2 branches covered.">        if (amount &gt; 5000.0) {</span>
<span class="fc" id="L410">            throw new IllegalArgumentException(&quot;Maximum withdrawal amount is 5,000 per transaction&quot;);</span>
        }
<span class="pc bpc" id="L412" title="1 of 4 branches missed.">        if (bankAccount == null || bankAccount.trim().isEmpty()) {</span>
<span class="fc" id="L413">            throw new IllegalArgumentException(&quot;Bank account cannot be empty&quot;);</span>
        }
        
        // Verify user exists and get balance
<span class="pc bpc" id="L417" title="1 of 2 branches missed.">        if (!authRepository.existsById(userId)) {</span>
<span class="nc" id="L418">            throw new NotFoundException(&quot;User&quot;, userId);</span>
        }
        
        // Check wallet balance
<span class="fc" id="L422">        Double currentBalance = paymentRepository.calculateWalletBalance(userId);</span>
<span class="fc bfc" id="L423" title="All 2 branches covered.">        if (currentBalance &lt; amount) {</span>
<span class="fc" id="L424">            throw new IllegalArgumentException(&quot;Insufficient wallet balance. Balance: &quot; + currentBalance + &quot;, Requested: &quot; + amount);</span>
        }
        
        // Check daily withdrawal limit
<span class="fc" id="L428">        validateDailyWithdrawalLimit(userId, amount);</span>
        
        // Create withdrawal transaction
<span class="fc" id="L431">        String description = &quot;Withdrawal to bank account: &quot; + bankAccount;</span>
<span class="pc bpc" id="L432" title="2 of 4 branches missed.">        if (reason != null &amp;&amp; !reason.trim().isEmpty()) {</span>
<span class="fc" id="L433">            description += &quot;. Reason: &quot; + reason.trim();</span>
        }
        
<span class="fc" id="L436">        Transaction withdrawal = Transaction.forWalletWithdrawal(userId, amount, description);</span>
<span class="fc" id="L437">        withdrawal = paymentRepository.save(withdrawal);</span>
        
        // Process withdrawal (mark as pending for manual processing)
<span class="fc" id="L440">        withdrawal.setDescription(withdrawal.getDescription() + &quot; - Pending bank transfer&quot;);</span>
<span class="fc" id="L441">        paymentRepository.update(withdrawal);</span>
        
<span class="fc" id="L443">        return withdrawal;</span>
    }
    
    /**
     * Internal withdrawal for payments (instant)
     */
    public Transaction withdrawForPayment(Long userId, Double amount, String orderReference) {
<span class="pc bpc" id="L450" title="2 of 4 branches missed.">        if (userId == null || userId &lt;= 0) {</span>
<span class="nc" id="L451">            throw new IllegalArgumentException(&quot;User ID must be positive&quot;);</span>
        }
<span class="pc bpc" id="L453" title="2 of 4 branches missed.">        if (amount == null || amount &lt;= 0) {</span>
<span class="nc" id="L454">            throw new IllegalArgumentException(&quot;Withdrawal amount must be positive&quot;);</span>
        }
        
        // Verify user exists and check wallet balance
<span class="pc bpc" id="L458" title="1 of 2 branches missed.">        if (!authRepository.existsById(userId)) {</span>
<span class="nc" id="L459">            throw new NotFoundException(&quot;User&quot;, userId);</span>
        }
        
<span class="fc" id="L462">        Double currentBalance = paymentRepository.calculateWalletBalance(userId);</span>
<span class="pc bpc" id="L463" title="1 of 2 branches missed.">        if (currentBalance &lt; amount) {</span>
<span class="nc" id="L464">            throw new IllegalArgumentException(&quot;Insufficient wallet balance. Balance: &quot; + currentBalance + &quot;, Required: &quot; + amount);</span>
        }
        
        // Create and complete withdrawal transaction
<span class="fc" id="L468">        String description = &quot;Payment withdrawal for order: &quot; + orderReference;</span>
<span class="fc" id="L469">        Transaction withdrawal = Transaction.forWalletWithdrawal(userId, amount, description);</span>
        
<span class="fc" id="L471">        String referenceId = &quot;PAYMENT_WITHDRAWAL_&quot; + UUID.randomUUID().toString().substring(0, 8);</span>
<span class="fc" id="L472">        withdrawal.markAsCompleted(referenceId);</span>
        
<span class="fc" id="L474">        return paymentRepository.save(withdrawal);</span>
    }
    
    /**
     * Validate daily withdrawal limit
     */
    private void validateDailyWithdrawalLimit(Long userId, Double amount) {
<span class="fc" id="L481">        LocalDateTime startOfDay = LocalDateTime.now().withHour(0).withMinute(0).withSecond(0).withNano(0);</span>
<span class="fc" id="L482">        LocalDateTime endOfDay = startOfDay.plusDays(1).minusNanos(1);</span>
        
<span class="fc" id="L484">        List&lt;Transaction&gt; todayWithdrawals = paymentRepository.findByUserIdAndDateRange(userId, startOfDay, endOfDay)</span>
<span class="fc" id="L485">            .stream()</span>
<span class="pc bpc" id="L486" title="2 of 4 branches missed.">            .filter(t -&gt; t.getType() == TransactionType.WALLET_WITHDRAWAL &amp;&amp; t.getStatus() == TransactionStatus.COMPLETED)</span>
<span class="fc" id="L487">            .toList();</span>
        
<span class="fc" id="L489">        Double todayTotal = todayWithdrawals.stream()</span>
<span class="fc" id="L490">            .mapToDouble(Transaction::getAmount)</span>
<span class="fc" id="L491">            .sum();</span>
        
<span class="fc" id="L493">        Double dailyLimit = 20000.0; // Daily withdrawal limit of 20,000</span>
<span class="fc bfc" id="L494" title="All 2 branches covered.">        if (todayTotal + amount &gt; dailyLimit) {</span>
<span class="fc" id="L495">            throw new IllegalArgumentException(&quot;Daily withdrawal limit exceeded. Today: &quot; + todayTotal + &quot;, Limit: &quot; + dailyLimit);</span>
        }
<span class="fc" id="L497">    }</span>
    
    // ==================== WALLET TRANSACTION HISTORY ====================
    
    /**
     * Get wallet transaction history
     */
    public List&lt;Transaction&gt; getWalletTransactionHistory(Long userId) {
<span class="pc bpc" id="L505" title="2 of 4 branches missed.">        if (userId == null || userId &lt;= 0) {</span>
<span class="nc" id="L506">            throw new IllegalArgumentException(&quot;User ID must be positive&quot;);</span>
        }
        
        // Verify user exists
<span class="pc bpc" id="L510" title="1 of 2 branches missed.">        if (!authRepository.existsById(userId)) {</span>
<span class="nc" id="L511">            throw new NotFoundException(&quot;User&quot;, userId);</span>
        }
        
<span class="fc" id="L514">        return paymentRepository.findWalletTransactions(userId);</span>
    }
    
    /**
     * Get wallet transaction history within date range
     */
    public List&lt;Transaction&gt; getWalletTransactionHistory(Long userId, LocalDateTime startDate, LocalDateTime endDate) {
<span class="pc bpc" id="L521" title="2 of 4 branches missed.">        if (userId == null || userId &lt;= 0) {</span>
<span class="nc" id="L522">            throw new IllegalArgumentException(&quot;User ID must be positive&quot;);</span>
        }
<span class="pc bpc" id="L524" title="1 of 2 branches missed.">        if (startDate == null) {</span>
<span class="nc" id="L525">            throw new IllegalArgumentException(&quot;Start date cannot be null&quot;);</span>
        }
<span class="pc bpc" id="L527" title="1 of 2 branches missed.">        if (endDate == null) {</span>
<span class="nc" id="L528">            throw new IllegalArgumentException(&quot;End date cannot be null&quot;);</span>
        }
<span class="fc bfc" id="L530" title="All 2 branches covered.">        if (startDate.isAfter(endDate)) {</span>
<span class="fc" id="L531">            throw new IllegalArgumentException(&quot;Start date cannot be after end date&quot;);</span>
        }
        
        // Verify user exists
<span class="pc bpc" id="L535" title="1 of 2 branches missed.">        if (!authRepository.existsById(userId)) {</span>
<span class="nc" id="L536">            throw new NotFoundException(&quot;User&quot;, userId);</span>
        }
        
<span class="fc" id="L539">        List&lt;Transaction&gt; allTransactions = paymentRepository.findByUserIdAndDateRange(userId, startDate, endDate);</span>
<span class="fc" id="L540">        return allTransactions.stream()</span>
<span class="fc bfc" id="L541" title="All 4 branches covered.">            .filter(t -&gt; t.getType() == TransactionType.WALLET_CHARGE || t.getType() == TransactionType.WALLET_WITHDRAWAL)</span>
<span class="fc" id="L542">            .toList();</span>
    }
    
    /**
     * Get wallet charge history
     */
    public List&lt;Transaction&gt; getWalletChargeHistory(Long userId) {
<span class="pc bpc" id="L549" title="2 of 4 branches missed.">        if (userId == null || userId &lt;= 0) {</span>
<span class="nc" id="L550">            throw new IllegalArgumentException(&quot;User ID must be positive&quot;);</span>
        }
        
        // Verify user exists
<span class="pc bpc" id="L554" title="1 of 2 branches missed.">        if (!authRepository.existsById(userId)) {</span>
<span class="nc" id="L555">            throw new NotFoundException(&quot;User&quot;, userId);</span>
        }
        
<span class="fc" id="L558">        return paymentRepository.findByUserIdAndType(userId, TransactionType.WALLET_CHARGE);</span>
    }
    
    /**
     * Get wallet withdrawal history
     */
    public List&lt;Transaction&gt; getWalletWithdrawalHistory(Long userId) {
<span class="pc bpc" id="L565" title="2 of 4 branches missed.">        if (userId == null || userId &lt;= 0) {</span>
<span class="nc" id="L566">            throw new IllegalArgumentException(&quot;User ID must be positive&quot;);</span>
        }
        
        // Verify user exists
<span class="pc bpc" id="L570" title="1 of 2 branches missed.">        if (!authRepository.existsById(userId)) {</span>
<span class="nc" id="L571">            throw new NotFoundException(&quot;User&quot;, userId);</span>
        }
        
<span class="fc" id="L574">        return paymentRepository.findByUserIdAndType(userId, TransactionType.WALLET_WITHDRAWAL);</span>
    }
    
    // ==================== WALLET STATISTICS ====================
    
    /**
     * Get wallet statistics for a user
     */
    public WalletStatistics getWalletStatistics(Long userId) {
<span class="pc bpc" id="L583" title="2 of 4 branches missed.">        if (userId == null || userId &lt;= 0) {</span>
<span class="nc" id="L584">            throw new IllegalArgumentException(&quot;User ID must be positive&quot;);</span>
        }
        
        // Verify user exists
<span class="pc bpc" id="L588" title="1 of 2 branches missed.">        if (!authRepository.existsById(userId)) {</span>
<span class="nc" id="L589">            throw new NotFoundException(&quot;User&quot;, userId);</span>
        }
        
<span class="fc" id="L592">        List&lt;Transaction&gt; walletTransactions = paymentRepository.findWalletTransactions(userId);</span>
        
<span class="fc" id="L594">        Double totalCharged = walletTransactions.stream()</span>
<span class="fc bfc" id="L595" title="All 4 branches covered.">            .filter(t -&gt; t.getType() == TransactionType.WALLET_CHARGE &amp;&amp; t.getStatus() == TransactionStatus.COMPLETED)</span>
<span class="fc" id="L596">            .mapToDouble(Transaction::getAmount)</span>
<span class="fc" id="L597">            .sum();</span>
        
<span class="fc" id="L599">        Double totalWithdrawn = walletTransactions.stream()</span>
<span class="pc bpc" id="L600" title="1 of 4 branches missed.">            .filter(t -&gt; t.getType() == TransactionType.WALLET_WITHDRAWAL &amp;&amp; t.getStatus() == TransactionStatus.COMPLETED)</span>
<span class="fc" id="L601">            .mapToDouble(Transaction::getAmount)</span>
<span class="fc" id="L602">            .sum();</span>
        
<span class="fc" id="L604">        Long totalChargeTransactions = walletTransactions.stream()</span>
<span class="fc bfc" id="L605" title="All 2 branches covered.">            .filter(t -&gt; t.getType() == TransactionType.WALLET_CHARGE)</span>
<span class="fc" id="L606">            .count();</span>
        
<span class="fc" id="L608">        Long totalWithdrawalTransactions = walletTransactions.stream()</span>
<span class="fc bfc" id="L609" title="All 2 branches covered.">            .filter(t -&gt; t.getType() == TransactionType.WALLET_WITHDRAWAL)</span>
<span class="fc" id="L610">            .count();</span>
        
<span class="fc" id="L612">        Double currentBalance = getWalletBalance(userId);</span>
        
<span class="fc" id="L614">        return new WalletStatistics(</span>
            currentBalance,
            totalCharged,
            totalWithdrawn,
            totalChargeTransactions,
            totalWithdrawalTransactions
        );
    }
    
    // ==================== ADMIN OPERATIONS ====================
    
    /**
     * Admin credit to user wallet
     */
    public Transaction adminCreditWallet(Long userId, Double amount, String reason, Long adminId) {
<span class="pc bpc" id="L629" title="2 of 4 branches missed.">        if (userId == null || userId &lt;= 0) {</span>
<span class="nc" id="L630">            throw new IllegalArgumentException(&quot;User ID must be positive&quot;);</span>
        }
<span class="pc bpc" id="L632" title="2 of 4 branches missed.">        if (amount == null || amount &lt;= 0) {</span>
<span class="nc" id="L633">            throw new IllegalArgumentException(&quot;Credit amount must be positive&quot;);</span>
        }
<span class="pc bpc" id="L635" title="2 of 4 branches missed.">        if (adminId == null || adminId &lt;= 0) {</span>
<span class="nc" id="L636">            throw new IllegalArgumentException(&quot;Admin ID must be positive&quot;);</span>
        }
        
        // Verify user exists
<span class="pc bpc" id="L640" title="1 of 2 branches missed.">        if (!authRepository.existsById(userId)) {</span>
<span class="nc" id="L641">            throw new NotFoundException(&quot;User&quot;, userId);</span>
        }
        
        // Verify admin exists
<span class="fc bfc" id="L645" title="All 2 branches covered.">        if (!authRepository.existsById(adminId)) {</span>
<span class="fc" id="L646">            throw new NotFoundException(&quot;Admin&quot;, adminId);</span>
        }
        
<span class="fc" id="L649">        String description = &quot;Admin credit by admin #&quot; + adminId;</span>
<span class="pc bpc" id="L650" title="2 of 4 branches missed.">        if (reason != null &amp;&amp; !reason.trim().isEmpty()) {</span>
<span class="fc" id="L651">            description += &quot;. Reason: &quot; + reason.trim();</span>
        }
        
        // Create wallet charge transaction with ADMIN_CREDIT payment method
<span class="fc" id="L655">        Transaction chargeTransaction = Transaction.forWalletCharge(userId, amount, &quot;ADMIN_CREDIT&quot;);</span>
<span class="fc" id="L656">        chargeTransaction.setDescription(description);</span>
        
<span class="fc" id="L658">        chargeTransaction = paymentRepository.save(chargeTransaction);</span>
        
        // Admin credits are instant
<span class="fc" id="L661">        String referenceId = &quot;ADMIN_CREDIT_&quot; + UUID.randomUUID().toString().substring(0, 8);</span>
<span class="fc" id="L662">        chargeTransaction.markAsCompleted(referenceId);</span>
<span class="fc" id="L663">        paymentRepository.update(chargeTransaction);</span>
        
<span class="fc" id="L665">        return chargeTransaction;</span>
    }
    
    /**
     * Admin debit from user wallet
     */
    public Transaction adminDebitWallet(Long userId, Double amount, String reason, Long adminId) {
<span class="pc bpc" id="L672" title="2 of 4 branches missed.">        if (userId == null || userId &lt;= 0) {</span>
<span class="nc" id="L673">            throw new IllegalArgumentException(&quot;User ID must be positive&quot;);</span>
        }
<span class="pc bpc" id="L675" title="2 of 4 branches missed.">        if (amount == null || amount &lt;= 0) {</span>
<span class="nc" id="L676">            throw new IllegalArgumentException(&quot;Debit amount must be positive&quot;);</span>
        }
<span class="pc bpc" id="L678" title="2 of 4 branches missed.">        if (adminId == null || adminId &lt;= 0) {</span>
<span class="nc" id="L679">            throw new IllegalArgumentException(&quot;Admin ID must be positive&quot;);</span>
        }
        
        // Verify user exists
<span class="pc bpc" id="L683" title="1 of 2 branches missed.">        if (!authRepository.existsById(userId)) {</span>
<span class="nc" id="L684">            throw new NotFoundException(&quot;User&quot;, userId);</span>
        }
        
        // Verify admin exists
<span class="fc bfc" id="L688" title="All 2 branches covered.">        if (!authRepository.existsById(adminId)) {</span>
<span class="fc" id="L689">            throw new NotFoundException(&quot;Admin&quot;, adminId);</span>
        }
        
        // Check wallet balance
<span class="fc" id="L693">        Double currentBalance = getWalletBalance(userId);</span>
<span class="fc bfc" id="L694" title="All 2 branches covered.">        if (currentBalance &lt; amount) {</span>
<span class="fc" id="L695">            throw new IllegalArgumentException(&quot;Insufficient wallet balance for debit. Balance: &quot; + currentBalance + &quot;, Requested: &quot; + amount);</span>
        }
        
<span class="fc" id="L698">        String description = &quot;Admin debit by admin #&quot; + adminId;</span>
<span class="pc bpc" id="L699" title="2 of 4 branches missed.">        if (reason != null &amp;&amp; !reason.trim().isEmpty()) {</span>
<span class="fc" id="L700">            description += &quot;. Reason: &quot; + reason.trim();</span>
        }
        
<span class="fc" id="L703">        Transaction debit = Transaction.forWalletWithdrawal(userId, amount, description);</span>
<span class="fc" id="L704">        String referenceId = &quot;ADMIN_DEBIT_&quot; + UUID.randomUUID().toString().substring(0, 8);</span>
<span class="fc" id="L705">        debit.markAsCompleted(referenceId);</span>
        
<span class="fc" id="L707">        return paymentRepository.save(debit);</span>
    }
    
    /**
     * Wallet statistics inner class
     */
    public static class WalletStatistics {
        private final Double currentBalance;
        private final Double totalCharged;
        private final Double totalWithdrawn;
        private final Long totalChargeTransactions;
        private final Long totalWithdrawalTransactions;
        
        public WalletStatistics(Double currentBalance, Double totalCharged, Double totalWithdrawn,
<span class="fc" id="L721">                              Long totalChargeTransactions, Long totalWithdrawalTransactions) {</span>
<span class="fc" id="L722">            this.currentBalance = currentBalance;</span>
<span class="fc" id="L723">            this.totalCharged = totalCharged;</span>
<span class="fc" id="L724">            this.totalWithdrawn = totalWithdrawn;</span>
<span class="fc" id="L725">            this.totalChargeTransactions = totalChargeTransactions;</span>
<span class="fc" id="L726">            this.totalWithdrawalTransactions = totalWithdrawalTransactions;</span>
<span class="fc" id="L727">        }</span>
        
        // Getters
<span class="fc" id="L730">        public Double getCurrentBalance() { return currentBalance; }</span>
<span class="fc" id="L731">        public Double getTotalCharged() { return totalCharged; }</span>
<span class="fc" id="L732">        public Double getTotalWithdrawn() { return totalWithdrawn; }</span>
<span class="fc" id="L733">        public Long getTotalChargeTransactions() { return totalChargeTransactions; }</span>
<span class="fc" id="L734">        public Long getTotalWithdrawalTransactions() { return totalWithdrawalTransactions; }</span>
<span class="fc" id="L735">        public Double getNetFlow() { return totalCharged - totalWithdrawn; }</span>
<span class="fc" id="L736">        public Long getTotalTransactions() { return totalChargeTransactions + totalWithdrawalTransactions; }</span>
    }
} 
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>