<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Order.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.common.models</a> &gt; <span class="el_source">Order.java</span></div><h1>Order.java</h1><pre class="source lang-java linenums">package com.myapp.common.models;

import jakarta.persistence.*;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

/**
 * مدل سفارش - نماینده یک سفارش مشتری
 * این کلاس جزئیات سفارش، آیتم‌ها، وضعیت و روابط با کاربر و رستوران را شامل می‌شود
 * یکی از پیچیده‌ترین مدل‌های سیستم با منطق کسب‌وکار قوی
 */
@Entity
@Table(name = &quot;orders&quot;)
public class Order {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = &quot;customer_id&quot;, nullable = false)
    private User customer;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = &quot;restaurant_id&quot;, nullable = false)
    private Restaurant restaurant;
    
<span class="fc" id="L29">    @OneToMany(mappedBy = &quot;order&quot;, cascade = CascadeType.ALL, fetch = FetchType.LAZY)</span>
    private List&lt;OrderItem&gt; orderItems = new ArrayList&lt;&gt;();
    
    @Column(name = &quot;total_amount&quot;, nullable = false)
    private Double totalAmount;
    
    @Enumerated(EnumType.STRING)
    @Column(name = &quot;status&quot;, nullable = false, length = 20)
    private OrderStatus status;
    
    @Column(name = &quot;order_date&quot;, nullable = false)
    private LocalDateTime orderDate;
    
    @Column(name = &quot;delivery_address&quot;, nullable = false, length = 500)
    private String deliveryAddress;
    
    @Column(name = &quot;phone&quot;, nullable = false, length = 15)
    private String phone;
    
    @Column(name = &quot;notes&quot;, length = 500)
    private String notes;
    
    @Column(name = &quot;estimated_delivery_time&quot;)
    private LocalDateTime estimatedDeliveryTime;
    
    @Column(name = &quot;actual_delivery_time&quot;)
    private LocalDateTime actualDeliveryTime;
    
    // Constructors
    /**
     * سازنده پیش‌فرض - برای JPA و فرمورک‌ها
     * JPA نیاز به سازنده بدون پارامتر دارد
     */
<span class="fc" id="L62">    public Order() {}</span>
    
    /**
     * سازنده خصوصی - برای ایجاد سفارش جدید با اعتبارسنجی
     * این سازنده توسط factory method استفاده می‌شود
     * 
     * @param customer مشتری سفارش‌دهنده
     * @param restaurant رستوران
     * @param deliveryAddress آدرس تحویل
     * @param phone شماره تلفن تماس
     */
<span class="fc" id="L73">    private Order(User customer, Restaurant restaurant, String deliveryAddress, String phone) {</span>
        // اعتبارسنجی ورودی‌ها
<span class="fc bfc" id="L75" title="All 4 branches covered.">        if (customer == null || restaurant == null) {</span>
<span class="fc" id="L76">            throw new IllegalArgumentException(&quot;Customer and restaurant are required&quot;);</span>
        }
<span class="pc bpc" id="L78" title="1 of 4 branches missed.">        if (deliveryAddress == null || deliveryAddress.trim().isEmpty()) {</span>
<span class="fc" id="L79">            throw new IllegalArgumentException(&quot;Delivery address is required&quot;);</span>
        }
<span class="pc bpc" id="L81" title="1 of 4 branches missed.">        if (phone == null || phone.trim().isEmpty()) {</span>
<span class="fc" id="L82">            throw new IllegalArgumentException(&quot;Phone number is required&quot;);</span>
        }
        
        // تنظیم مقادیر اولیه
<span class="fc" id="L86">        this.customer = customer;</span>
<span class="fc" id="L87">        this.restaurant = restaurant;</span>
<span class="fc" id="L88">        this.deliveryAddress = deliveryAddress;</span>
<span class="fc" id="L89">        this.phone = phone;</span>
<span class="fc" id="L90">        this.orderDate = LocalDateTime.now();</span>
<span class="fc" id="L91">        this.status = OrderStatus.PENDING;</span>
<span class="fc" id="L92">        this.totalAmount = 0.0;</span>
<span class="fc" id="L93">    }</span>
    
    // Factory methods
    /**
     * متد Factory برای ایجاد سفارش جدید
     * این متد روش امن و کنترل شده‌ای برای ایجاد سفارش ارائه می‌دهد
     * 
     * @param customer مشتری سفارش‌دهنده
     * @param restaurant رستوران
     * @param deliveryAddress آدرس تحویل
     * @param phone شماره تلفن تماس
     * @return سفارش جدید ایجاد شده
     */
    public static Order createNew(User customer, Restaurant restaurant, String deliveryAddress, String phone) {
<span class="fc" id="L107">        return new Order(customer, restaurant, deliveryAddress, phone);</span>
    }
    
    // Business methods
    /**
     * اضافه کردن آیتم به سفارش
     * اگر آیتم قبلاً موجود باشد، تعداد آن افزایش می‌یابد
     * 
     * @param foodItem آیتم غذایی
     * @param quantity تعداد درخواستی
     * @throws IllegalArgumentException در صورت نامعتبر بودن ورودی‌ها یا عدم موجودی کافی
     */
    public void addItem(FoodItem foodItem, Integer quantity) {
        // اعتبارسنجی ورودی‌ها
<span class="fc bfc" id="L121" title="All 4 branches covered.">        if (foodItem == null || quantity &lt;= 0) {</span>
<span class="fc" id="L122">            throw new IllegalArgumentException(&quot;Food item and quantity must be valid&quot;);</span>
        }
        
        // بررسی موجودی
<span class="pc bpc" id="L126" title="2 of 4 branches missed.">        if (!foodItem.isInStock() || foodItem.getQuantity() &lt; quantity) {</span>
<span class="nc" id="L127">            throw new IllegalArgumentException(&quot;Not enough quantity available&quot;);</span>
        }
        
        // بررسی وجود آیتم در سفارش
<span class="fc" id="L131">        OrderItem existingItem = findOrderItemByFoodItem(foodItem);</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">        if (existingItem != null) {</span>
            // به‌روزرسانی تعداد آیتم موجود
<span class="fc" id="L134">            int newQuantity = existingItem.getQuantity() + quantity;</span>
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">            if (foodItem.getQuantity() &lt; newQuantity) {</span>
<span class="nc" id="L136">                throw new IllegalArgumentException(&quot;Not enough quantity available&quot;);</span>
            }
<span class="fc" id="L138">            existingItem.setQuantity(newQuantity);  // افزایش تعداد</span>
<span class="fc" id="L139">        } else {</span>
            // اضافه کردن آیتم جدید
<span class="fc" id="L141">            OrderItem orderItem = new OrderItem(this, foodItem, quantity, foodItem.getPrice());</span>
<span class="fc" id="L142">            orderItems.add(orderItem);</span>
        }
<span class="fc" id="L144">        recalculateTotal(); // محاسبه مجدد مبلغ کل</span>
<span class="fc" id="L145">    }</span>
    
    /**
     * حذف آیتم از سفارش
     * 
     * @param orderItem آیتم سفارش برای حذف
     */
    public void removeItem(OrderItem orderItem) {
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">        if (orderItems.remove(orderItem)) {  // حذف آیتم از لیست</span>
<span class="fc" id="L154">            recalculateTotal(); // محاسبه مجدد مبلغ کل</span>
        }
<span class="fc" id="L156">    }</span>
    
    /**
     * حذف آیتم از سفارش بر اساس آیتم غذایی
     * 
     * @param foodItem آیتم غذایی برای حذف
     */
    public void removeItem(FoodItem foodItem) {
<span class="fc" id="L164">        OrderItem orderItem = findOrderItemByFoodItem(foodItem);</span>
<span class="fc bfc" id="L165" title="All 2 branches covered.">        if (orderItem != null) {</span>
<span class="fc" id="L166">            removeItem(orderItem);  // فراخوانی متد حذف اصلی</span>
        }
<span class="fc" id="L168">    }</span>
    
    /**
     * تنظیم تعداد مشخص برای یک آیتم (بدون اضافه کردن)
     * 
     * @param foodItem آیتم غذایی
     * @param quantity تعداد جدید
     * @throws IllegalArgumentException در صورت نامعتبر بودن ورودی‌ها یا عدم موجودی کافی
     */
    public void setItemQuantity(FoodItem foodItem, Integer quantity) {
        // اعتبارسنجی ورودی‌ها
<span class="pc bpc" id="L179" title="2 of 4 branches missed.">        if (foodItem == null || quantity &lt;= 0) {</span>
<span class="nc" id="L180">            throw new IllegalArgumentException(&quot;Food item and quantity must be valid&quot;);</span>
        }
        
        // بررسی موجودی
<span class="pc bpc" id="L184" title="2 of 4 branches missed.">        if (!foodItem.isInStock() || foodItem.getQuantity() &lt; quantity) {</span>
<span class="nc" id="L185">            throw new IllegalArgumentException(&quot;Not enough quantity available&quot;);</span>
        }
        
<span class="fc" id="L188">        OrderItem existingItem = findOrderItemByFoodItem(foodItem);</span>
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">        if (existingItem != null) {</span>
            // تنظیم تعداد مستقیم (نه اضافه کردن)
<span class="fc" id="L191">            existingItem.setQuantity(quantity);</span>
        } else {
            // اضافه کردن آیتم جدید
<span class="nc" id="L194">            OrderItem orderItem = new OrderItem(this, foodItem, quantity, foodItem.getPrice());</span>
<span class="nc" id="L195">            orderItems.add(orderItem);</span>
        }
<span class="fc" id="L197">        recalculateTotal(); // محاسبه مجدد مبلغ کل</span>
<span class="fc" id="L198">    }</span>
    
    /**
     * پیدا کردن آیتم سفارش بر اساس آیتم غذایی
     * متد کمکی برای جستجو در لیست آیتم‌ها
     * 
     * @param foodItem آیتم غذایی برای جستجو
     * @return آیتم سفارش یافت شده یا null
     */
    private OrderItem findOrderItemByFoodItem(FoodItem foodItem) {
<span class="fc" id="L208">        return orderItems.stream()</span>
<span class="fc" id="L209">                .filter(item -&gt; item.getFoodItem().equals(foodItem))  // فیلتر بر اساس آیتم غذایی</span>
<span class="fc" id="L210">                .findFirst()                                          // یافتن اولین مورد</span>
<span class="fc" id="L211">                .orElse(null);                                        // برگرداندن null در صورت عدم وجود</span>
    }
    
    /**
     * محاسبه مجدد مبلغ کل سفارش
     * این متد بعد از هر تغییر در آیتم‌ها فراخوانی می‌شود
     */
    public void recalculateTotal() {
<span class="fc" id="L219">        this.totalAmount = orderItems.stream()</span>
<span class="fc" id="L220">                .mapToDouble(item -&gt; item.getPrice() * item.getQuantity())  // محاسبه قیمت هر آیتم</span>
<span class="fc" id="L221">                .sum();                                                     // جمع کل</span>
<span class="fc" id="L222">    }</span>
    
    /**
     * تأیید سفارش
     * تغییر وضعیت به تأیید شده و کاهش موجودی آیتم‌ها
     * 
     * @throws IllegalStateException در صورت خالی بودن سفارش
     */
    public void confirm() {
<span class="fc bfc" id="L231" title="All 2 branches covered.">        if (orderItems.isEmpty()) {</span>
<span class="fc" id="L232">            throw new IllegalStateException(&quot;Cannot confirm empty order&quot;);</span>
        }
<span class="fc" id="L234">        this.status = OrderStatus.CONFIRMED;                              // تغییر وضعیت به تأیید شده</span>
<span class="fc" id="L235">        this.estimatedDeliveryTime = LocalDateTime.now().plusMinutes(30); // تنظیم زمان تحویل تخمینی (30 دقیقه)</span>
        
        // کاهش موجودی آیتم‌های غذایی
<span class="fc bfc" id="L238" title="All 2 branches covered.">        for (OrderItem item : orderItems) {</span>
<span class="fc" id="L239">            item.getFoodItem().decreaseQuantity(item.getQuantity());</span>
<span class="fc" id="L240">        }</span>
<span class="fc" id="L241">    }</span>
    
    /**
     * لغو سفارش
     * بازگرداندن موجودی آیتم‌ها در صورت لزوم
     * 
     * @throws IllegalStateException در صورت عدم امکان لغو سفارش
     */
    public void cancel() {
<span class="pc bpc" id="L250" title="2 of 4 branches missed.">        if (status == OrderStatus.DELIVERED || status == OrderStatus.CANCELLED) {</span>
<span class="nc" id="L251">            throw new IllegalStateException(&quot;Cannot cancel order in current status: &quot; + status);</span>
        }
        
        // بازگرداندن موجودی آیتم‌ها اگر سفارش تأیید شده بود
<span class="pc bpc" id="L255" title="1 of 4 branches missed.">        if (status == OrderStatus.CONFIRMED || status == OrderStatus.PREPARING) {</span>
<span class="fc bfc" id="L256" title="All 2 branches covered.">            for (OrderItem item : orderItems) {</span>
<span class="fc" id="L257">                item.getFoodItem().increaseQuantity(item.getQuantity());</span>
<span class="fc" id="L258">            }</span>
        }
        
<span class="fc" id="L261">        this.status = OrderStatus.CANCELLED; // تغییر وضعیت به لغو شده</span>
<span class="fc" id="L262">    }</span>
    
    /**
     * علامت‌گذاری سفارش به عنوان تحویل داده شده
     * 
     * @throws IllegalStateException در صورت عدم امکان تحویل سفارش
     */
    public void markAsDelivered() {
<span class="pc bpc" id="L270" title="1 of 2 branches missed.">        if (status != OrderStatus.OUT_FOR_DELIVERY) {</span>
<span class="nc" id="L271">            throw new IllegalStateException(&quot;Order must be out for delivery to mark as delivered&quot;);</span>
        }
<span class="fc" id="L273">        this.status = OrderStatus.DELIVERED;              // تغییر وضعیت به تحویل داده شده</span>
<span class="fc" id="L274">        this.actualDeliveryTime = LocalDateTime.now();   // ثبت زمان واقعی تحویل</span>
<span class="fc" id="L275">    }</span>
    
    /**
     * بررسی امکان لغو سفارش
     * 
     * @return true اگر سفارش قابل لغو باشد
     */
    public boolean canBeCancelled() {
<span class="fc bfc" id="L283" title="All 6 branches covered.">        return status == OrderStatus.PENDING || </span>
               status == OrderStatus.CONFIRMED || 
               status == OrderStatus.PREPARING;
    }
    
    /**
     * محاسبه تعداد کل آیتم‌های سفارش
     * 
     * @return مجموع تعداد تمام آیتم‌ها
     */
    public int getTotalItems() {
<span class="fc" id="L294">        return orderItems.stream().mapToInt(OrderItem::getQuantity).sum();</span>
    }
    
    // Getters and setters
    /**
     * دریافت و تنظیم شناسه سفارش
     * 
     * @return شناسه یکتای سفارش
     */
<span class="fc" id="L303">    public Long getId() { return id; }</span>
<span class="fc" id="L304">    public void setId(Long id) { this.id = id; }</span>
    
    /**
     * دریافت و تنظیم مشتری سفارش
     * 
     * @return مشتری سفارش‌دهنده
     */
<span class="fc" id="L311">    public User getCustomer() { return customer; }</span>
<span class="fc" id="L312">    public void setCustomer(User customer) { this.customer = customer; }</span>
    
    /**
     * دریافت و تنظیم رستوران سفارش
     * 
     * @return رستوران سفارش
     */
<span class="fc" id="L319">    public Restaurant getRestaurant() { return restaurant; }</span>
<span class="fc" id="L320">    public void setRestaurant(Restaurant restaurant) { this.restaurant = restaurant; }</span>
    
    /**
     * دریافت و تنظیم لیست آیتم‌های سفارش
     * 
     * @return لیست آیتم‌های سفارش
     */
<span class="fc" id="L327">    public List&lt;OrderItem&gt; getOrderItems() { return orderItems; }</span>
<span class="fc" id="L328">    public void setOrderItems(List&lt;OrderItem&gt; orderItems) { this.orderItems = orderItems; }</span>
    
    /**
     * دریافت و تنظیم مبلغ کل سفارش
     * 
     * @return مبلغ کل سفارش
     */
<span class="fc" id="L335">    public Double getTotalAmount() { return totalAmount; }</span>
<span class="fc" id="L336">    public void setTotalAmount(Double totalAmount) { this.totalAmount = totalAmount; }</span>
    
    /**
     * دریافت و تنظیم وضعیت سفارش
     * 
     * @return وضعیت فعلی سفارش
     */
<span class="fc" id="L343">    public OrderStatus getStatus() { return status; }</span>
<span class="fc" id="L344">    public void setStatus(OrderStatus status) { this.status = status; }</span>
    
    /**
     * دریافت و تنظیم تاریخ سفارش
     * 
     * @return تاریخ و زمان ثبت سفارش
     */
<span class="fc" id="L351">    public LocalDateTime getOrderDate() { return orderDate; }</span>
<span class="fc" id="L352">    public void setOrderDate(LocalDateTime orderDate) { this.orderDate = orderDate; }</span>
    
    /**
     * دریافت و تنظیم آدرس تحویل
     * 
     * @return آدرس تحویل سفارش
     */
<span class="fc" id="L359">    public String getDeliveryAddress() { return deliveryAddress; }</span>
<span class="fc" id="L360">    public void setDeliveryAddress(String deliveryAddress) { this.deliveryAddress = deliveryAddress; }</span>
    
    /**
     * دریافت و تنظیم شماره تلفن تماس
     * 
     * @return شماره تلفن تماس
     */
<span class="fc" id="L367">    public String getPhone() { return phone; }</span>
<span class="fc" id="L368">    public void setPhone(String phone) { this.phone = phone; }</span>
    
    /**
     * دریافت و تنظیم یادداشت سفارش
     * 
     * @return یادداشت اضافی مشتری
     */
<span class="fc" id="L375">    public String getNotes() { return notes; }</span>
<span class="fc" id="L376">    public void setNotes(String notes) { this.notes = notes; }</span>
    
    /**
     * دریافت و تنظیم زمان تخمینی تحویل
     * 
     * @return زمان تخمینی تحویل سفارش
     */
<span class="fc" id="L383">    public LocalDateTime getEstimatedDeliveryTime() { return estimatedDeliveryTime; }</span>
    public void setEstimatedDeliveryTime(LocalDateTime estimatedDeliveryTime) { 
<span class="fc" id="L385">        this.estimatedDeliveryTime = estimatedDeliveryTime; </span>
<span class="fc" id="L386">    }</span>
    
    /**
     * دریافت و تنظیم زمان واقعی تحویل
     * 
     * @return زمان واقعی تحویل سفارش
     */
<span class="fc" id="L393">    public LocalDateTime getActualDeliveryTime() { return actualDeliveryTime; }</span>
    public void setActualDeliveryTime(LocalDateTime actualDeliveryTime) { 
<span class="fc" id="L395">        this.actualDeliveryTime = actualDeliveryTime; </span>
<span class="fc" id="L396">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>