<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Rating.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.common.models</a> &gt; <span class="el_source">Rating.java</span></div><h1>Rating.java</h1><pre class="source lang-java linenums">package com.myapp.common.models;

import jakarta.persistence.*;
import java.time.LocalDateTime;
import java.util.Objects;

/**
 * مدل رتبه‌بندی - نماینده نظرات و امتیازات کاربران برای رستوران‌ها
 * 
 * این کلاس سیستم کامل نظرسنجی و رتبه‌بندی رستوران‌ها را مدیریت می‌کند:
 * 
 * === ویژگی‌های کلیدی ===
 * - امتیازدهی از 1 تا 5 ستاره
 * - متن نظر اختیاری تا 1000 کاراکتر
 * - سیستم تأیید نظرات توسط ادمین
 * - شمارنده مفید بودن نظرات
 * - محدودیت یک نظر برای هر کاربر/رستوران
 * - Indexing برای عملکرد بهتر جستجو
 * 
 * === قوانین کسب‌وکار ===
 * - هر کاربر فقط یک نظر برای هر رستوران می‌تواند ثبت کند
 * - امتیاز باید بین 1 تا 5 باشد
 * - متن نظر حداکثر 1000 کاراکتر
 * - تغییر نظر باعث reset شدن تأیید می‌شود
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 */
@Entity
@Table(name = &quot;ratings&quot;, 
       uniqueConstraints = @UniqueConstraint(columnNames = {&quot;user_id&quot;, &quot;restaurant_id&quot;}),
       indexes = {
           @Index(name = &quot;idx_rating_restaurant&quot;, columnList = &quot;restaurant_id&quot;),
           @Index(name = &quot;idx_rating_user&quot;, columnList = &quot;user_id&quot;),
           @Index(name = &quot;idx_rating_score&quot;, columnList = &quot;rating_score&quot;)
       })
public class Rating {
    
    /** شناسه یکتای رتبه‌بندی */
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    /** کاربر ثبت‌کننده نظر (رابطه چند‌به‌یک) */
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = &quot;user_id&quot;, nullable = false)
    private User user;
    
    /** رستوران مورد نظر (رابطه چند‌به‌یک) */
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = &quot;restaurant_id&quot;, nullable = false)
    private Restaurant restaurant;
    
    /** امتیاز رتبه‌بندی (1 تا 5 ستاره) */
    @Column(name = &quot;rating_score&quot;, nullable = false)
    private Integer ratingScore;
    
    /** متن نظر (اختیاری، حداکثر 1000 کاراکتر) */
    @Column(name = &quot;review_text&quot;, length = 1000)
    private String reviewText;
    
    /** زمان ایجاد نظر */
    @Column(name = &quot;created_at&quot;, nullable = false)
    private LocalDateTime createdAt;
    
    /** زمان آخرین به‌روزرسانی */
    @Column(name = &quot;updated_at&quot;)
    private LocalDateTime updatedAt;
    
    /** وضعیت تأیید نظر توسط ادمین */
<span class="fc" id="L72">    @Column(name = &quot;is_verified&quot;, nullable = false)</span>
<span class="fc" id="L73">    private Boolean isVerified = false;</span>
    
    /** تعداد نفراتی که نظر را مفید دانسته‌اند */
<span class="fc" id="L76">    @Column(name = &quot;helpful_count&quot;, nullable = false)</span>
<span class="fc" id="L77">    private Integer helpfulCount = 0;</span>

    // ==================== CONSTRUCTORS ====================
    
    /**
     * سازنده پیش‌فرض
     * مقادیر اولیه پیش‌فرض را تنظیم می‌کند
     */
<span class="fc" id="L85">    public Rating() {</span>
<span class="fc" id="L86">        this.createdAt = LocalDateTime.now();</span>
<span class="fc" id="L87">        this.isVerified = false;</span>
<span class="fc" id="L88">        this.helpfulCount = 0;</span>
<span class="fc" id="L89">    }</span>
    
    /**
     * سازنده با امتیاز ساده
     * 
     * @param user کاربر نظردهنده
     * @param restaurant رستوران مورد نظر
     * @param ratingScore امتیاز (1-5)
     */
    public Rating(User user, Restaurant restaurant, Integer ratingScore) {
<span class="fc" id="L99">        this();</span>
<span class="fc" id="L100">        this.user = user;</span>
<span class="fc" id="L101">        this.restaurant = restaurant;</span>
<span class="fc" id="L102">        setRatingScore(ratingScore);</span>
<span class="fc" id="L103">    }</span>
    
    /**
     * سازنده کامل با امتیاز و متن نظر
     * 
     * @param user کاربر نظردهنده
     * @param restaurant رستوران مورد نظر
     * @param ratingScore امتیاز (1-5)
     * @param reviewText متن نظر
     */
    public Rating(User user, Restaurant restaurant, Integer ratingScore, String reviewText) {
<span class="fc" id="L114">        this(user, restaurant, ratingScore);</span>
<span class="fc" id="L115">        this.reviewText = reviewText;</span>
<span class="fc" id="L116">    }</span>
    
    // ==================== BUSINESS LOGIC METHODS ====================
    
    /**
     * به‌روزرسانی امتیاز و متن نظر
     * 
     * @param newScore امتیاز جدید (1-5)
     * @param newReviewText متن نظر جدید
     */
    public void updateRating(Integer newScore, String newReviewText) {
<span class="fc" id="L127">        setRatingScore(newScore);</span>
<span class="fc" id="L128">        this.reviewText = newReviewText;</span>
<span class="fc" id="L129">        this.updatedAt = LocalDateTime.now();</span>
<span class="fc" id="L130">        this.isVerified = false; // ریست تأیید پس از تغییر</span>
<span class="fc" id="L131">    }</span>
    
    /**
     * اعتبارسنجی و تنظیم امتیاز (1-5 ستاره)
     * 
     * @param ratingScore امتیاز مورد نظر
     * @throws IllegalArgumentException در صورت نامعتبر بودن امتیاز
     */
    public void setRatingScore(Integer ratingScore) {
<span class="pc bpc" id="L140" title="1 of 6 branches missed.">        if (ratingScore == null || ratingScore &lt; 1 || ratingScore &gt; 5) {</span>
<span class="fc" id="L141">            throw new IllegalArgumentException(&quot;امتیاز باید بین 1 تا 5 ستاره باشد&quot;);</span>
        }
<span class="fc" id="L143">        this.ratingScore = ratingScore;</span>
<span class="fc" id="L144">    }</span>
    
    /**
     * اعتبارسنجی و تنظیم متن نظر
     * 
     * @param reviewText متن نظر
     * @throws IllegalArgumentException در صورت طولانی بودن متن
     */
    public void setReviewText(String reviewText) {
<span class="pc bpc" id="L153" title="1 of 4 branches missed.">        if (reviewText != null &amp;&amp; reviewText.trim().length() &gt; 1000) {</span>
<span class="nc" id="L154">            throw new IllegalArgumentException(&quot;متن نظر نمی‌تواند بیشتر از 1000 کاراکتر باشد&quot;);</span>
        }
<span class="fc bfc" id="L156" title="All 2 branches covered.">        this.reviewText = reviewText != null ? reviewText.trim() : null;</span>
<span class="fc" id="L157">    }</span>
    
    /**
     * افزایش شمارنده مفید بودن
     */
    public void incrementHelpfulCount() {
<span class="fc" id="L163">        this.helpfulCount++;</span>
<span class="fc" id="L164">    }</span>
    
    /**
     * کاهش شمارنده مفید بودن (حداقل 0)
     */
    public void decrementHelpfulCount() {
<span class="pc bpc" id="L170" title="1 of 2 branches missed.">        if (this.helpfulCount &gt; 0) {</span>
<span class="nc" id="L171">            this.helpfulCount--;</span>
        }
<span class="fc" id="L173">    }</span>
    
    /**
     * تأیید نظر توسط ادمین
     */
    public void verify() {
<span class="fc" id="L179">        this.isVerified = true;</span>
<span class="fc" id="L180">        this.updatedAt = LocalDateTime.now();</span>
<span class="fc" id="L181">    }</span>
    
    /**
     * لغو تأیید نظر توسط ادمین
     */
    public void unverify() {
<span class="fc" id="L187">        this.isVerified = false;</span>
<span class="fc" id="L188">        this.updatedAt = LocalDateTime.now();</span>
<span class="fc" id="L189">    }</span>
    
    /**
     * بررسی وجود متن نظر
     * 
     * @return true اگر نظر متنی داشته باشد
     */
    public boolean hasReview() {
<span class="nc bnc" id="L197" title="All 4 branches missed.">        return reviewText != null &amp;&amp; !reviewText.trim().isEmpty();</span>
    }
    
    /**
     * بررسی جدید بودن نظر (طی 30 روز گذشته)
     * 
     * @return true اگر نظر جدید باشد
     */
    public boolean isRecent() {
<span class="fc" id="L206">        return createdAt.isAfter(LocalDateTime.now().minusDays(30));</span>
    }
    
    /**
     * تولید نمایش ستاره‌ای امتیاز
     * 
     * @return رشته نمایش ستاره‌ها (★★★☆☆)
     */
    public String getRatingDisplay() {
<span class="fc" id="L215">        return &quot;★&quot;.repeat(ratingScore) + &quot;☆&quot;.repeat(5 - ratingScore);</span>
    }

    // ==================== LIFECYCLE CALLBACKS ====================
    
    /**
     * فراخوانی قبل از ذخیره در دیتابیس
     */
    @PrePersist
    protected void onCreate() {
<span class="pc bpc" id="L225" title="1 of 2 branches missed.">        if (createdAt == null) {</span>
<span class="nc" id="L226">            createdAt = LocalDateTime.now();</span>
        }
<span class="pc bpc" id="L228" title="1 of 2 branches missed.">        if (isVerified == null) {</span>
<span class="nc" id="L229">            isVerified = false;</span>
        }
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">        if (helpfulCount == null) {</span>
<span class="nc" id="L232">            helpfulCount = 0;</span>
        }
<span class="fc" id="L234">    }</span>
    
    /**
     * فراخوانی قبل از به‌روزرسانی در دیتابیس
     */
    @PreUpdate
    protected void onUpdate() {
<span class="fc" id="L241">        updatedAt = LocalDateTime.now();</span>
<span class="fc" id="L242">    }</span>

    // ==================== GETTERS AND SETTERS ====================
    
    /** @return شناسه رتبه‌بندی */
<span class="fc" id="L247">    public Long getId() { return id; }</span>
<span class="fc" id="L248">    public void setId(Long id) { this.id = id; }</span>

    /** @return کاربر نظردهنده */
<span class="fc" id="L251">    public User getUser() { return user; }</span>
<span class="nc" id="L252">    public void setUser(User user) { this.user = user; }</span>

    /** @return رستوران مورد نظر */
<span class="fc" id="L255">    public Restaurant getRestaurant() { return restaurant; }</span>
<span class="nc" id="L256">    public void setRestaurant(Restaurant restaurant) { this.restaurant = restaurant; }</span>

    /** @return امتیاز رتبه‌بندی */
<span class="fc" id="L259">    public Integer getRatingScore() { return ratingScore; }</span>

    /** @return متن نظر */
<span class="fc" id="L262">    public String getReviewText() { return reviewText; }</span>

    /** @return زمان ایجاد */
<span class="fc" id="L265">    public LocalDateTime getCreatedAt() { return createdAt; }</span>
<span class="fc" id="L266">    public void setCreatedAt(LocalDateTime createdAt) { this.createdAt = createdAt; }</span>

    /** @return زمان به‌روزرسانی */
<span class="fc" id="L269">    public LocalDateTime getUpdatedAt() { return updatedAt; }</span>
<span class="nc" id="L270">    public void setUpdatedAt(LocalDateTime updatedAt) { this.updatedAt = updatedAt; }</span>

    /** @return وضعیت تأیید */
<span class="fc" id="L273">    public Boolean getIsVerified() { return isVerified; }</span>
<span class="fc" id="L274">    public void setIsVerified(Boolean isVerified) { this.isVerified = isVerified; }</span>

    /** @return تعداد مفید دانستن */
<span class="fc" id="L277">    public Integer getHelpfulCount() { return helpfulCount; }</span>
    public void setHelpfulCount(Integer helpfulCount) { 
<span class="nc bnc" id="L279" title="All 2 branches missed.">        this.helpfulCount = Math.max(0, helpfulCount != null ? helpfulCount : 0);</span>
<span class="nc" id="L280">    }</span>

    // ==================== OBJECT METHODS ====================
    
    /**
     * بررسی تساوی دو رتبه‌بندی
     */
    @Override
    public boolean equals(Object o) {
<span class="nc bnc" id="L289" title="All 2 branches missed.">        if (this == o) return true;</span>
<span class="nc bnc" id="L290" title="All 4 branches missed.">        if (o == null || getClass() != o.getClass()) return false;</span>
<span class="nc" id="L291">        Rating rating = (Rating) o;</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">        return Objects.equals(id, rating.id) &amp;&amp;</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">               Objects.equals(user, rating.user) &amp;&amp;</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">               Objects.equals(restaurant, rating.restaurant);</span>
    }
    
    /**
     * محاسبه hash code
     */
    @Override
    public int hashCode() {
<span class="nc bnc" id="L302" title="All 2 branches missed.">        return Objects.hash(id, user != null ? user.getId() : null, </span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">                           restaurant != null ? restaurant.getId() : null);</span>
    }
    
    /**
     * نمایش رشته‌ای رتبه‌بندی
     */
    @Override
    public String toString() {
<span class="nc" id="L311">        return &quot;Rating{&quot; +</span>
                &quot;id=&quot; + id +
<span class="nc bnc" id="L313" title="All 2 branches missed.">                &quot;, userId=&quot; + (user != null ? user.getId() : null) +</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">                &quot;, restaurantId=&quot; + (restaurant != null ? restaurant.getId() : null) +</span>
                &quot;, ratingScore=&quot; + ratingScore +
<span class="nc" id="L316">                &quot;, hasReview=&quot; + hasReview() +</span>
                &quot;, isVerified=&quot; + isVerified +
                &quot;, helpfulCount=&quot; + helpfulCount +
                &quot;, createdAt=&quot; + createdAt +
                '}';
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>