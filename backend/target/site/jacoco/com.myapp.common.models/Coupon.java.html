<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Coupon.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.common.models</a> &gt; <span class="el_source">Coupon.java</span></div><h1>Coupon.java</h1><pre class="source lang-java linenums">package com.myapp.common.models;

import jakarta.persistence.*;
import java.time.LocalDateTime;
import java.util.Objects;

/**
 * مدل کوپن تخفیف - نماینده کوپن‌های تخفیف سیستم سفارش غذا
 * 
 * این کلاس سیستم کامل مدیریت کوپن‌های تخفیف را پیاده‌سازی می‌کند:
 * 
 * === انواع تخفیف ===
 * - تخفیف درصدی (PERCENTAGE): درصد از مبلغ سفارش
 * - تخفیف مبلغ ثابت (FIXED_AMOUNT): مبلغ مشخص تخفیف
 * 
 * === ویژگی‌های کلیدی ===
 * - کد یکتای کوپن برای شناسایی
 * - محدودیت حداقل مبلغ سفارش
 * - محدودیت حداکثر تخفیف برای درصدی‌ها
 * - محدودیت تعداد استفاده کلی
 * - محدودیت تعداد استفاده per-user
 * - بازه زمانی اعتبار
 * - امکان اختصاص به رستوران خاص
 * 
 * === قوانین کسب‌وکار ===
 * - کد کوپن باید یکتا باشد
 * - تاریخ شروع و پایان اعتبار اجباری
 * - تخفیف نمی‌تواند از مبلغ سفارش بیشتر باشد
 * - محدودیت‌های استفاده قابل تنظیم
 * 
 * === Factory Methods ===
 * - createPercentageCoupon(): ایجاد کوپن درصدی
 * - createFixedAmountCoupon(): ایجاد کوپن مبلغ ثابت
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 */
@Entity
@Table(name = &quot;coupons&quot;)
public class Coupon {
    
    /** شناسه یکتای کوپن */
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    /** کد یکتای کوپن برای استفاده توسط کاربر */
    @Column(unique = true, nullable = false, length = 50)
    private String code;
    
    /** توضیحات کوپن برای نمایش به کاربر */
    @Column(nullable = false, length = 255)
    private String description;
    
    /** نوع تخفیف (درصدی یا مبلغ ثابت) */
    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private CouponType type;
    
    /** مقدار تخفیف - درصد (0-100) یا مبلغ ثابت */
    @Column(nullable = false)
    private Double value;
    
    /** حداقل مبلغ سفارش برای استفاده از کوپن */
    @Column(name = &quot;min_order_amount&quot;)
    private Double minOrderAmount;
    
    /** حداکثر مبلغ تخفیف برای کوپن‌های درصدی */
    @Column(name = &quot;max_discount_amount&quot;)
    private Double maxDiscountAmount;
    
    /** محدودیت تعداد استفاده کلی (null = نامحدود) */
    @Column(name = &quot;usage_limit&quot;)
    private Integer usageLimit;
    
    /** تعداد استفاده شده از کوپن */
<span class="fc" id="L78">    @Column(name = &quot;used_count&quot;, nullable = false)</span>
<span class="fc" id="L79">    private Integer usedCount = 0;</span>
    
    /** محدودیت استفاده per-user (null = نامحدود) */
    @Column(name = &quot;per_user_limit&quot;)
    private Integer perUserLimit;
    
    /** زمان شروع اعتبار کوپن */
    @Column(name = &quot;valid_from&quot;, nullable = false)
    private LocalDateTime validFrom;
    
    /** زمان پایان اعتبار کوپن */
    @Column(name = &quot;valid_until&quot;, nullable = false)
    private LocalDateTime validUntil;
    
    /** وضعیت فعال بودن کوپن */
<span class="fc" id="L94">    @Column(name = &quot;is_active&quot;, nullable = false)</span>
<span class="fc" id="L95">    private Boolean isActive = true;</span>
    
    /** زمان ایجاد کوپن */
    @Column(name = &quot;created_at&quot;, nullable = false)
    private LocalDateTime createdAt;
    
    /** زمان آخرین به‌روزرسانی */
    @Column(name = &quot;updated_at&quot;)
    private LocalDateTime updatedAt;
    
    /** رستوران مختص این کوپن (null = همه رستوران‌ها) */
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = &quot;restaurant_id&quot;)
    private Restaurant restaurant;
    
    /** شناسه ایجادکننده کوپن (ادمین یا صاحب رستوران) */
    @Column(name = &quot;created_by&quot;)
    private Long createdBy;
    
    // ==================== CONSTRUCTORS ====================
    
    /**
     * سازنده پیش‌فرض
     * زمان ایجاد را به زمان فعلی تنظیم می‌کند
     */
<span class="fc" id="L120">    public Coupon() {</span>
<span class="fc" id="L121">        this.createdAt = LocalDateTime.now();</span>
<span class="fc" id="L122">    }</span>
    
    /**
     * سازنده اصلی برای ایجاد کوپن
     * 
     * @param code کد یکتای کوپن
     * @param description توضیحات
     * @param type نوع تخفیف
     * @param value مقدار تخفیف
     * @param validFrom زمان شروع اعتبار
     * @param validUntil زمان پایان اعتبار
     */
    public Coupon(String code, String description, CouponType type, Double value, 
                  LocalDateTime validFrom, LocalDateTime validUntil) {
<span class="fc" id="L136">        this();</span>
<span class="fc" id="L137">        this.code = code;</span>
<span class="fc" id="L138">        this.description = description;</span>
<span class="fc" id="L139">        this.type = type;</span>
<span class="fc" id="L140">        this.value = value;</span>
<span class="fc" id="L141">        this.validFrom = validFrom;</span>
<span class="fc" id="L142">        this.validUntil = validUntil;</span>
<span class="fc" id="L143">    }</span>
    
    // ==================== FACTORY METHODS ====================
    
    /**
     * ایجاد کوپن تخفیف درصدی
     * 
     * @param code کد کوپن
     * @param description توضیحات
     * @param percentage درصد تخفیف (0-100)
     * @param validFrom زمان شروع
     * @param validUntil زمان پایان
     * @return کوپن درصدی ایجاد شده
     * @throws IllegalArgumentException اگر درصد خارج از محدوده 0-100 باشد
     */
    public static Coupon createPercentageCoupon(String code, String description, Double percentage,
                                               LocalDateTime validFrom, LocalDateTime validUntil) {
<span class="pc bpc" id="L160" title="2 of 4 branches missed.">        if (percentage &lt; 0 || percentage &gt; 100) {</span>
<span class="nc" id="L161">            throw new IllegalArgumentException(&quot;درصد تخفیف باید بین 0 تا 100 باشد&quot;);</span>
        }
<span class="fc" id="L163">        return new Coupon(code, description, CouponType.PERCENTAGE, percentage, validFrom, validUntil);</span>
    }
    
    /**
     * ایجاد کوپن تخفیف مبلغ ثابت
     * 
     * @param code کد کوپن
     * @param description توضیحات
     * @param amount مبلغ تخفیف
     * @param validFrom زمان شروع
     * @param validUntil زمان پایان
     * @return کوپن مبلغ ثابت ایجاد شده
     * @throws IllegalArgumentException اگر مبلغ منفی یا صفر باشد
     */
    public static Coupon createFixedAmountCoupon(String code, String description, Double amount,
                                                LocalDateTime validFrom, LocalDateTime validUntil) {
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">        if (amount &lt;= 0) {</span>
<span class="nc" id="L180">            throw new IllegalArgumentException(&quot;مبلغ تخفیف باید مثبت باشد&quot;);</span>
        }
<span class="fc" id="L182">        return new Coupon(code, description, CouponType.FIXED_AMOUNT, amount, validFrom, validUntil);</span>
    }
    
    // ==================== BUSINESS LOGIC METHODS ====================
    
    /**
     * بررسی اعتبار و قابلیت استفاده کوپن
     * 
     * @return true اگر کوپن معتبر و قابل استفاده باشد
     */
    public boolean isValid() {
<span class="fc" id="L193">        LocalDateTime now = LocalDateTime.now();</span>
<span class="fc bfc" id="L194" title="All 2 branches covered.">        return isActive &amp;&amp; </span>
<span class="fc bfc" id="L195" title="All 2 branches covered.">               now.isAfter(validFrom) &amp;&amp; </span>
<span class="fc bfc" id="L196" title="All 4 branches covered.">               now.isBefore(validUntil) &amp;&amp;</span>
<span class="fc bfc" id="L197" title="All 2 branches covered.">               (usageLimit == null || usedCount &lt; usageLimit);</span>
    }
    
    /**
     * بررسی قابلیت اعمال کوپن روی مبلغ سفارش
     * 
     * @param orderAmount مبلغ سفارش
     * @return true اگر کوپن قابل اعمال باشد
     */
    public boolean canApplyToOrder(Double orderAmount) {
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">        if (!isValid()) {</span>
<span class="nc" id="L208">            return false;</span>
        }
<span class="fc bfc" id="L210" title="All 4 branches covered.">        return minOrderAmount == null || orderAmount &gt;= minOrderAmount;</span>
    }
    
    /**
     * محاسبه مبلغ تخفیف برای سفارش
     * 
     * @param orderAmount مبلغ سفارش
     * @return مبلغ تخفیف قابل اعمال
     */
    public Double calculateDiscount(Double orderAmount) {
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">        if (!canApplyToOrder(orderAmount)) {</span>
<span class="nc" id="L221">            return 0.0;</span>
        }
        
        Double discount;
<span class="fc bfc" id="L225" title="All 2 branches covered.">        if (type == CouponType.PERCENTAGE) {</span>
<span class="fc" id="L226">            discount = orderAmount * (value / 100.0);</span>
            // اعمال محدودیت حداکثر تخفیف
<span class="fc bfc" id="L228" title="All 4 branches covered.">            if (maxDiscountAmount != null &amp;&amp; discount &gt; maxDiscountAmount) {</span>
<span class="fc" id="L229">                discount = maxDiscountAmount;</span>
            }
        } else {
<span class="fc" id="L232">            discount = value;</span>
        }
        
        // اطمینان از عدم تجاوز تخفیف از مبلغ سفارش
<span class="fc" id="L236">        return Math.min(discount, orderAmount);</span>
    }
    
    /**
     * استفاده از کوپن (افزایش شمارنده استفاده)
     * 
     * @throws IllegalStateException اگر کوپن غیرقابل استفاده باشد
     */
    public void use() {
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">        if (!isValid()) {</span>
<span class="nc" id="L246">            throw new IllegalStateException(&quot;امکان استفاده از کوپن غیرمعتبر وجود ندارد&quot;);</span>
        }
<span class="pc bpc" id="L248" title="2 of 4 branches missed.">        if (usageLimit != null &amp;&amp; usedCount &gt;= usageLimit) {</span>
<span class="nc" id="L249">            throw new IllegalStateException(&quot;محدودیت استفاده از کوپن تجاوز شده است&quot;);</span>
        }
        
<span class="fc" id="L252">        usedCount++;</span>
<span class="fc" id="L253">        updatedAt = LocalDateTime.now();</span>
<span class="fc" id="L254">    }</span>
    
    /**
     * بازگشت استفاده از کوپن (کاهش شمارنده)
     * در صورت لغو سفارش استفاده می‌شود
     */
    public void revertUsage() {
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">        if (usedCount &gt; 0) {</span>
<span class="fc" id="L262">            usedCount--;</span>
<span class="fc" id="L263">            updatedAt = LocalDateTime.now();</span>
        }
<span class="fc" id="L265">    }</span>
    
    /**
     * بررسی وجود استفاده باقی‌مانده
     * 
     * @return true اگر هنوز قابل استفاده باشد
     */
    public boolean hasRemainingUses() {
<span class="nc bnc" id="L273" title="All 4 branches missed.">        return usageLimit == null || usedCount &lt; usageLimit;</span>
    }
    
    /**
     * محاسبه تعداد استفاده باقی‌مانده
     * 
     * @return تعداد استفاده باقی‌مانده (null = نامحدود)
     */
    public Integer getRemainingUses() {
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">        if (usageLimit == null) {</span>
<span class="fc" id="L283">            return null; // نامحدود</span>
        }
<span class="nc" id="L285">        return Math.max(0, usageLimit - usedCount);</span>
    }
    
    /**
     * غیرفعال کردن کوپن
     * کوپن قابل استفاده نخواهد بود ولی حذف نمی‌شود
     */
    public void deactivate() {
<span class="fc" id="L293">        this.isActive = false;</span>
<span class="fc" id="L294">        this.updatedAt = LocalDateTime.now();</span>
<span class="fc" id="L295">    }</span>
    
    /**
     * فعال کردن کوپن
     * کوپن مجدداً قابل استفاده خواهد شد
     */
    public void activate() {
<span class="fc" id="L302">        this.isActive = true;</span>
<span class="fc" id="L303">        this.updatedAt = LocalDateTime.now();</span>
<span class="fc" id="L304">    }</span>
    
    /**
     * به‌روزرسانی اطلاعات کوپن
     * 
     * @param description توضیحات جدید
     * @param minOrderAmount حداقل مبلغ سفارش
     * @param maxDiscountAmount حداکثر تخفیف
     * @param usageLimit محدودیت استفاده
     * @param perUserLimit محدودیت per-user
     * @param validUntil تاریخ انقضای جدید
     */
    public void updateInfo(String description, Double minOrderAmount, Double maxDiscountAmount,
                          Integer usageLimit, Integer perUserLimit, LocalDateTime validUntil) {
<span class="pc bpc" id="L318" title="2 of 4 branches missed.">        if (description != null &amp;&amp; !description.trim().isEmpty()) {</span>
<span class="fc" id="L319">            this.description = description.trim();</span>
        }
<span class="fc" id="L321">        this.minOrderAmount = minOrderAmount;</span>
<span class="fc" id="L322">        this.maxDiscountAmount = maxDiscountAmount;</span>
<span class="fc" id="L323">        this.usageLimit = usageLimit;</span>
<span class="fc" id="L324">        this.perUserLimit = perUserLimit;</span>
<span class="pc bpc" id="L325" title="1 of 2 branches missed.">        if (validUntil != null) {</span>
<span class="fc" id="L326">            this.validUntil = validUntil;</span>
        }
<span class="fc" id="L328">        this.updatedAt = LocalDateTime.now();</span>
<span class="fc" id="L329">    }</span>
    
    // ==================== GETTERS AND SETTERS ====================
    
    /** @return شناسه کوپن */
<span class="fc" id="L334">    public Long getId() { return id; }</span>
<span class="fc" id="L335">    public void setId(Long id) { this.id = id; }</span>
    
    /** @return کد کوپن */
<span class="fc" id="L338">    public String getCode() { return code; }</span>
<span class="nc" id="L339">    public void setCode(String code) { this.code = code; }</span>
    
    /** @return توضیحات کوپن */
<span class="fc" id="L342">    public String getDescription() { return description; }</span>
<span class="nc" id="L343">    public void setDescription(String description) { this.description = description; }</span>
    
    /** @return نوع کوپن */
<span class="fc" id="L346">    public CouponType getType() { return type; }</span>
<span class="nc" id="L347">    public void setType(CouponType type) { this.type = type; }</span>
    
    /** @return مقدار تخفیف */
<span class="fc" id="L350">    public Double getValue() { return value; }</span>
<span class="nc" id="L351">    public void setValue(Double value) { this.value = value; }</span>
    
    /** @return حداقل مبلغ سفارش */
<span class="fc" id="L354">    public Double getMinOrderAmount() { return minOrderAmount; }</span>
<span class="fc" id="L355">    public void setMinOrderAmount(Double minOrderAmount) { this.minOrderAmount = minOrderAmount; }</span>
    
    /** @return حداکثر تخفیف */
<span class="fc" id="L358">    public Double getMaxDiscountAmount() { return maxDiscountAmount; }</span>
<span class="fc" id="L359">    public void setMaxDiscountAmount(Double maxDiscountAmount) { this.maxDiscountAmount = maxDiscountAmount; }</span>
    
    /** @return محدودیت استفاده */
<span class="fc" id="L362">    public Integer getUsageLimit() { return usageLimit; }</span>
<span class="fc" id="L363">    public void setUsageLimit(Integer usageLimit) { this.usageLimit = usageLimit; }</span>
    
    /** @return تعداد استفاده شده */
<span class="fc" id="L366">    public Integer getUsedCount() { return usedCount; }</span>
<span class="fc" id="L367">    public void setUsedCount(Integer usedCount) { this.usedCount = usedCount; }</span>
    
    /** @return محدودیت per-user */
<span class="fc" id="L370">    public Integer getPerUserLimit() { return perUserLimit; }</span>
<span class="fc" id="L371">    public void setPerUserLimit(Integer perUserLimit) { this.perUserLimit = perUserLimit; }</span>
    
    /** @return زمان شروع اعتبار */
<span class="fc" id="L374">    public LocalDateTime getValidFrom() { return validFrom; }</span>
<span class="fc" id="L375">    public void setValidFrom(LocalDateTime validFrom) { this.validFrom = validFrom; }</span>
    
    /** @return زمان پایان اعتبار */
<span class="fc" id="L378">    public LocalDateTime getValidUntil() { return validUntil; }</span>
<span class="fc" id="L379">    public void setValidUntil(LocalDateTime validUntil) { this.validUntil = validUntil; }</span>
    
    /** @return وضعیت فعال بودن */
<span class="fc" id="L382">    public Boolean getIsActive() { return isActive; }</span>
<span class="fc" id="L383">    public void setIsActive(Boolean isActive) { this.isActive = isActive; }</span>
    
    /** @return زمان ایجاد */
<span class="fc" id="L386">    public LocalDateTime getCreatedAt() { return createdAt; }</span>
<span class="nc" id="L387">    public void setCreatedAt(LocalDateTime createdAt) { this.createdAt = createdAt; }</span>
    
    /** @return زمان به‌روزرسانی */
<span class="fc" id="L390">    public LocalDateTime getUpdatedAt() { return updatedAt; }</span>
<span class="nc" id="L391">    public void setUpdatedAt(LocalDateTime updatedAt) { this.updatedAt = updatedAt; }</span>
    
    /** @return رستوران مختص */
<span class="fc" id="L394">    public Restaurant getRestaurant() { return restaurant; }</span>
<span class="fc" id="L395">    public void setRestaurant(Restaurant restaurant) { this.restaurant = restaurant; }</span>
    
    /** @return شناسه ایجادکننده */
<span class="fc" id="L398">    public Long getCreatedBy() { return createdBy; }</span>
<span class="fc" id="L399">    public void setCreatedBy(Long createdBy) { this.createdBy = createdBy; }</span>
    
    // ==================== OBJECT METHODS ====================
    
    /**
     * بررسی تساوی دو کوپن
     * 
     * @param o شیء مقایسه
     * @return true در صورت برابری
     */
    @Override
    public boolean equals(Object o) {
<span class="pc bpc" id="L411" title="1 of 2 branches missed.">        if (this == o) return true;</span>
<span class="nc bnc" id="L412" title="All 4 branches missed.">        if (o == null || getClass() != o.getClass()) return false;</span>
<span class="nc" id="L413">        Coupon coupon = (Coupon) o;</span>
<span class="nc bnc" id="L414" title="All 4 branches missed.">        return Objects.equals(id, coupon.id) &amp;&amp; Objects.equals(code, coupon.code);</span>
    }
    
    /**
     * محاسبه hash code
     * 
     * @return hash code بر اساس شناسه و کد
     */
    @Override
    public int hashCode() {
<span class="nc" id="L424">        return Objects.hash(id, code);</span>
    }
    
    /**
     * نمایش رشته‌ای کوپن
     * 
     * @return اطلاعات کلیدی برای debugging
     */
    @Override
    public String toString() {
<span class="nc" id="L434">        return &quot;Coupon{&quot; +</span>
                &quot;id=&quot; + id +
                &quot;, code='&quot; + code + '\'' +
                &quot;, type=&quot; + type +
                &quot;, value=&quot; + value +
                &quot;, isActive=&quot; + isActive +
                &quot;, validFrom=&quot; + validFrom +
                &quot;, validUntil=&quot; + validUntil +
                &quot;, usedCount=&quot; + usedCount +
                &quot;, usageLimit=&quot; + usageLimit +
                '}';
    }
    
    /**
     * تعیین انواع کوپن تخفیف
     */
<span class="fc" id="L450">    public enum CouponType {</span>
        /** تخفیف درصدی (مثلاً 20% تخفیف) */
<span class="fc" id="L452">        PERCENTAGE,</span>
        
        /** تخفیف مبلغ ثابت (مثلاً 10,000 تومان تخفیف) */
<span class="fc" id="L455">        FIXED_AMOUNT</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>