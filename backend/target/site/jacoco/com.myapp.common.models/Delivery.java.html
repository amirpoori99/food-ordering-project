<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Delivery.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.common.models</a> &gt; <span class="el_source">Delivery.java</span></div><h1>Delivery.java</h1><pre class="source lang-java linenums">package com.myapp.common.models;

import jakarta.persistence.*;
import java.time.LocalDateTime;
import java.time.temporal.ChronoUnit;

/**
 * Entity نمایندگی تحویل سفارش در سیستم سفارش غذا
 * 
 * این کلاس مدل کامل فرآیند تحویل سفارش شامل:
 * - اتصال یک‌به‌یک با Order
 * - اختصاص پیک (Courier)
 * - مدیریت وضعیت‌های مختلف تحویل
 * - ردیابی زمان‌های مختلف فرآیند
 * - محاسبه هزینه و مسافت تحویل
 * - validation قوانین کسب‌وکار
 * 
 * ویژگی‌های کلیدی:
 * - State Machine Pattern برای مدیریت وضعیت‌ها
 * - Business Logic Methods برای انتقال وضعیت
 * - Lazy Loading برای بهینه‌سازی performance
 * - Utility Methods برای محاسبات زمان
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 */
@Entity
@Table(name = &quot;deliveries&quot;)
public class Delivery {
    
    /** شناسه یکتای تحویل */
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    /** 
     * سفارش مربوط به این تحویل (رابطه یک‌به‌یک)
     * هر سفارش فقط یک تحویل دارد
     */
    @OneToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = &quot;order_id&quot;, nullable = false, unique = true)
    private Order order;
    
    /** 
     * پیک اختصاص داده شده (رابطه چند‌به‌یک)
     * یک پیک می‌تواند چندین تحویل داشته باشد
     */
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = &quot;courier_id&quot;)
    private User courier;
    
    /** وضعیت فعلی تحویل */
    @Enumerated(EnumType.STRING)
    @Column(name = &quot;status&quot;, nullable = false)
    private DeliveryStatus status;
    
    /** زمان اختصاص پیک */
    @Column(name = &quot;assigned_at&quot;)
    private LocalDateTime assignedAt;
    
    /** زمان تحویل گرفتن از رستوران */
    @Column(name = &quot;picked_up_at&quot;)
    private LocalDateTime pickedUpAt;
    
    /** زمان تحویل به مشتری */
    @Column(name = &quot;delivered_at&quot;)
    private LocalDateTime deliveredAt;
    
    /** زمان تخمینی تحویل گرفتن از رستوران */
    @Column(name = &quot;estimated_pickup_time&quot;)
    private LocalDateTime estimatedPickupTime;
    
    /** زمان تخمینی تحویل به مشتری */
    @Column(name = &quot;estimated_delivery_time&quot;)
    private LocalDateTime estimatedDeliveryTime;
    
    /** یادداشت‌های تحویل (توسط مشتری یا رستوران) */
    @Column(name = &quot;delivery_notes&quot;, length = 1000)
    private String deliveryNotes;
    
    /** یادداشت‌های پیک */
    @Column(name = &quot;courier_notes&quot;, length = 1000)
    private String courierNotes;
    
    /** هزینه تحویل */
    @Column(name = &quot;delivery_fee&quot;, nullable = false)
    private Double deliveryFee;
    
    /** مسافت تحویل به کیلومتر */
    @Column(name = &quot;distance_km&quot;)
    private Double distanceKm;
    
    // ==================== CONSTRUCTORS ====================
    
    /**
     * سازنده پیش‌فرض برای JPA
     */
<span class="fc" id="L99">    public Delivery() {</span>
<span class="fc" id="L100">    }</span>
    
    /**
     * سازنده برای ایجاد تحویل جدید
     * 
     * @param order سفارش مربوطه
     * @param deliveryFee هزینه تحویل
     * @throws IllegalArgumentException در صورت نامعتبر بودن ورودی‌ها
     */
<span class="fc" id="L109">    public Delivery(Order order, Double deliveryFee) {</span>
<span class="fc bfc" id="L110" title="All 2 branches covered.">        if (order == null) {</span>
<span class="fc" id="L111">            throw new IllegalArgumentException(&quot;Order is required&quot;);</span>
        }
<span class="fc bfc" id="L113" title="All 4 branches covered.">        if (deliveryFee == null || deliveryFee &lt; 0) {</span>
<span class="fc" id="L114">            throw new IllegalArgumentException(&quot;Delivery fee must be non-negative&quot;);</span>
        }
        
<span class="fc" id="L117">        this.order = order;</span>
<span class="fc" id="L118">        this.deliveryFee = deliveryFee;</span>
<span class="fc" id="L119">        this.status = DeliveryStatus.PENDING;</span>
        
        // تنظیم زمان‌های تخمینی پیش‌فرض
<span class="fc" id="L122">        this.estimatedPickupTime = LocalDateTime.now().plusMinutes(15); // 15 دقیقه برای آماده‌سازی</span>
<span class="fc" id="L123">        this.estimatedDeliveryTime = LocalDateTime.now().plusMinutes(45); // 45 دقیقه کل</span>
<span class="fc" id="L124">    }</span>
    
    // ==================== FACTORY METHODS ====================
    
    /**
     * ایجاد تحویل جدید
     * 
     * @param order سفارش
     * @param deliveryFee هزینه تحویل
     * @return تحویل ایجاد شده
     */
    public static Delivery createNew(Order order, Double deliveryFee) {
<span class="fc" id="L136">        return new Delivery(order, deliveryFee);</span>
    }
    
    /**
     * ایجاد تحویل جدید با مسافت مشخص
     * زمان‌های تخمینی بر اساس مسافت تنظیم می‌شوند
     * 
     * @param order سفارش
     * @param deliveryFee هزینه تحویل
     * @param distanceKm مسافت به کیلومتر
     * @return تحویل ایجاد شده
     */
    public static Delivery createWithDistance(Order order, Double deliveryFee, Double distanceKm) {
<span class="fc" id="L149">        Delivery delivery = new Delivery(order, deliveryFee);</span>
<span class="fc" id="L150">        delivery.setDistanceKm(distanceKm);</span>
        
        // تنظیم زمان‌های تخمینی بر اساس مسافت
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">        if (distanceKm != null) {</span>
<span class="fc" id="L154">            int extraMinutes = (int) (distanceKm * 3); // 3 دقیقه به ازای هر کیلومتر</span>
<span class="fc" id="L155">            delivery.setEstimatedPickupTime(LocalDateTime.now().plusMinutes(15));</span>
<span class="fc" id="L156">            delivery.setEstimatedDeliveryTime(LocalDateTime.now().plusMinutes(30 + extraMinutes));</span>
        }
<span class="fc" id="L158">        return delivery;</span>
    }
    
    // ==================== BUSINESS METHODS ====================
    
    /**
     * اختصاص پیک به تحویل
     * 
     * این متد state transition از PENDING به ASSIGNED انجام می‌دهد
     * 
     * @param courier پیک مورد نظر
     * @throws IllegalArgumentException اگر پیک null باشد یا نقش COURIER نداشته باشد
     * @throws IllegalStateException اگر تحویل در وضعیت قابل اختصاص نباشد
     */
    public void assignToCourier(User courier) {
<span class="fc bfc" id="L173" title="All 2 branches covered.">        if (courier == null) {</span>
<span class="fc" id="L174">            throw new IllegalArgumentException(&quot;Courier cannot be null&quot;);</span>
        }
<span class="fc bfc" id="L176" title="All 2 branches covered.">        if (!User.Role.COURIER.equals(courier.getRole())) {</span>
<span class="fc" id="L177">            throw new IllegalArgumentException(&quot;User must have COURIER role&quot;);</span>
        }
<span class="fc bfc" id="L179" title="All 2 branches covered.">        if (!canBeAssigned()) {</span>
<span class="fc" id="L180">            throw new IllegalStateException(&quot;Can only assign courier to pending deliveries&quot;);</span>
        }
        
<span class="fc" id="L183">        this.courier = courier;</span>
<span class="fc" id="L184">        this.status = DeliveryStatus.ASSIGNED;</span>
<span class="fc" id="L185">        this.assignedAt = LocalDateTime.now();</span>
        
        // به‌روزرسانی زمان تخمینی تحویل گرفتن
<span class="fc" id="L188">        this.estimatedPickupTime = LocalDateTime.now().plusMinutes(10);</span>
<span class="fc" id="L189">    }</span>
    
    /**
     * علامت‌گذاری تحویل به عنوان &quot;تحویل گرفته شده از رستوران&quot;
     * 
     * State transition از ASSIGNED به PICKED_UP
     * وضعیت سفارش نیز به OUT_FOR_DELIVERY تغییر می‌کند
     * 
     * @throws IllegalStateException اگر شرایط لازم برقرار نباشد
     */
    public void markAsPickedUp() {
<span class="fc bfc" id="L200" title="All 2 branches covered.">        if (!DeliveryStatus.ASSIGNED.equals(this.status)) {</span>
<span class="fc" id="L201">            throw new IllegalStateException(&quot;Delivery must be assigned before pickup&quot;);</span>
        }
<span class="fc bfc" id="L203" title="All 2 branches covered.">        if (this.courier == null) {</span>
<span class="fc" id="L204">            throw new IllegalStateException(&quot;No courier assigned&quot;);</span>
        }
        
<span class="fc" id="L207">        this.status = DeliveryStatus.PICKED_UP;</span>
<span class="fc" id="L208">        this.pickedUpAt = LocalDateTime.now();</span>
        
        // به‌روزرسانی زمان تخمینی تحویل به مشتری
<span class="fc" id="L211">        this.estimatedDeliveryTime = LocalDateTime.now().plusMinutes(20);</span>
        
        // به‌روزرسانی وضعیت سفارش
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">        if (this.order != null) {</span>
<span class="fc" id="L215">            this.order.setStatus(OrderStatus.OUT_FOR_DELIVERY);</span>
        }
<span class="fc" id="L217">    }</span>
    
    /**
     * علامت‌گذاری تحویل به عنوان &quot;تحویل داده شده&quot;
     * 
     * State transition از PICKED_UP به DELIVERED
     * وضعیت سفارش نیز به DELIVERED تغییر می‌کند
     * 
     * @throws IllegalStateException اگر تحویل از رستوران انجام نشده باشد
     */
    public void markAsDelivered() {
<span class="fc bfc" id="L228" title="All 2 branches covered.">        if (!DeliveryStatus.PICKED_UP.equals(this.status)) {</span>
<span class="fc" id="L229">            throw new IllegalStateException(&quot;Delivery must be picked up before marking as delivered&quot;);</span>
        }
        
<span class="fc" id="L232">        this.status = DeliveryStatus.DELIVERED;</span>
<span class="fc" id="L233">        this.deliveredAt = LocalDateTime.now();</span>
        
        // به‌روزرسانی وضعیت سفارش و زمان تحویل واقعی
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">        if (this.order != null) {</span>
<span class="fc" id="L237">            this.order.setStatus(OrderStatus.DELIVERED);</span>
<span class="fc" id="L238">            this.order.setActualDeliveryTime(this.deliveredAt);</span>
        }
<span class="fc" id="L240">    }</span>
    
    /**
     * لغو تحویل
     * 
     * تحویل‌های انجام شده قابل لغو نیستند
     * در صورت لغو، پیک از تحویل حذف می‌شود
     * 
     * @param reason دلیل لغو
     * @throws IllegalStateException اگر تحویل انجام شده باشد
     */
    public void cancel(String reason) {
<span class="fc bfc" id="L252" title="All 2 branches covered.">        if (DeliveryStatus.DELIVERED.equals(this.status)) {</span>
<span class="fc" id="L253">            throw new IllegalStateException(&quot;Cannot cancel delivered order&quot;);</span>
        }
        
<span class="fc" id="L256">        this.status = DeliveryStatus.CANCELLED;</span>
<span class="fc" id="L257">        this.deliveryNotes = reason;</span>
        
        // حذف اختصاص پیک در صورت وجود
<span class="pc bpc" id="L260" title="1 of 2 branches missed.">        if (!DeliveryStatus.PENDING.equals(this.status)) {</span>
<span class="fc" id="L261">            this.courier = null;</span>
<span class="fc" id="L262">            this.assignedAt = null;</span>
        }
<span class="fc" id="L264">    }</span>
    
    // ==================== STATE CHECKING METHODS ====================
    
    /**
     * بررسی قابلیت اختصاص پیک
     * 
     * @return true اگر تحویل در وضعیت PENDING باشد
     */
    public boolean canBeAssigned() {
<span class="fc" id="L274">        return DeliveryStatus.PENDING.equals(this.status);</span>
    }
    
    /**
     * بررسی قابلیت تحویل گرفتن از رستوران
     * 
     * @return true اگر پیک اختصاص داده شده و وضعیت ASSIGNED باشد
     */
    public boolean canBePickedUp() {
<span class="pc bpc" id="L283" title="1 of 4 branches missed.">        return DeliveryStatus.ASSIGNED.equals(this.status) &amp;&amp; this.courier != null;</span>
    }
    
    /**
     * بررسی قابلیت تحویل به مشتری
     * 
     * @return true اگر از رستوران تحویل گرفته شده باشد
     */
    public boolean canBeDelivered() {
<span class="fc" id="L292">        return DeliveryStatus.PICKED_UP.equals(this.status);</span>
    }
    
    /**
     * بررسی فعال بودن تحویل
     * 
     * @return true اگر تحویل در یکی از وضعیت‌های فعال باشد
     */
    public boolean isActive() {
<span class="fc bfc" id="L301" title="All 2 branches covered.">        return DeliveryStatus.PENDING.equals(this.status) ||</span>
<span class="fc bfc" id="L302" title="All 2 branches covered.">               DeliveryStatus.ASSIGNED.equals(this.status) ||</span>
<span class="fc bfc" id="L303" title="All 2 branches covered.">               DeliveryStatus.PICKED_UP.equals(this.status);</span>
    }
    
    // ==================== UTILITY METHODS ====================
    
    /**
     * محاسبه دقایق باقی‌مانده تا زمان تخمینی تحویل گرفتن
     * 
     * @return تعداد دقایق (منفی اگر زمان گذشته باشد)
     */
    public int getEstimatedPickupMinutes() {
<span class="fc bfc" id="L314" title="All 2 branches covered.">        if (estimatedPickupTime == null) {</span>
<span class="fc" id="L315">            return 0;</span>
        }
<span class="fc" id="L317">        return (int) ChronoUnit.MINUTES.between(LocalDateTime.now(), estimatedPickupTime);</span>
    }
    
    /**
     * محاسبه دقایق باقی‌مانده تا زمان تخمینی تحویل
     * 
     * @return تعداد دقایق (منفی اگر زمان گذشته باشد)
     */
    public int getEstimatedDeliveryMinutes() {
<span class="fc bfc" id="L326" title="All 2 branches covered.">        if (estimatedDeliveryTime == null) {</span>
<span class="fc" id="L327">            return 0;</span>
        }
<span class="fc" id="L329">        return (int) ChronoUnit.MINUTES.between(LocalDateTime.now(), estimatedDeliveryTime);</span>
    }
    
    // ==================== GETTERS AND SETTERS ====================
    
    /** @return شناسه تحویل */
    public Long getId() {
<span class="fc" id="L336">        return id;</span>
    }
    
    /** @param id شناسه تحویل */
    public void setId(Long id) {
<span class="fc" id="L341">        this.id = id;</span>
<span class="fc" id="L342">    }</span>
    
    /** @return سفارش مربوطه */
    public Order getOrder() {
<span class="fc" id="L346">        return order;</span>
    }
    
    /** @param order سفارش مربوطه */
    public void setOrder(Order order) {
<span class="fc" id="L351">        this.order = order;</span>
<span class="fc" id="L352">    }</span>
    
    /** @return پیک اختصاص داده شده */
    public User getCourier() {
<span class="fc" id="L356">        return courier;</span>
    }
    
    /** @param courier پیک */
    public void setCourier(User courier) {
<span class="fc" id="L361">        this.courier = courier;</span>
<span class="fc" id="L362">    }</span>
    
    /** @return وضعیت تحویل */
    public DeliveryStatus getStatus() {
<span class="fc" id="L366">        return status;</span>
    }
    
    /** @param status وضعیت تحویل */
    public void setStatus(DeliveryStatus status) {
<span class="fc" id="L371">        this.status = status;</span>
<span class="fc" id="L372">    }</span>
    
    /** @return زمان اختصاص پیک */
    public LocalDateTime getAssignedAt() {
<span class="fc" id="L376">        return assignedAt;</span>
    }
    
    /** @param assignedAt زمان اختصاص پیک */
    public void setAssignedAt(LocalDateTime assignedAt) {
<span class="fc" id="L381">        this.assignedAt = assignedAt;</span>
<span class="fc" id="L382">    }</span>
    
    /** @return زمان تحویل گرفتن از رستوران */
    public LocalDateTime getPickedUpAt() {
<span class="fc" id="L386">        return pickedUpAt;</span>
    }
    
    /** @param pickedUpAt زمان تحویل گرفتن */
    public void setPickedUpAt(LocalDateTime pickedUpAt) {
<span class="fc" id="L391">        this.pickedUpAt = pickedUpAt;</span>
<span class="fc" id="L392">    }</span>
    
    /** @return زمان تحویل به مشتری */
    public LocalDateTime getDeliveredAt() {
<span class="fc" id="L396">        return deliveredAt;</span>
    }
    
    /** @param deliveredAt زمان تحویل */
    public void setDeliveredAt(LocalDateTime deliveredAt) {
<span class="fc" id="L401">        this.deliveredAt = deliveredAt;</span>
<span class="fc" id="L402">    }</span>
    
    /** @return زمان تخمینی تحویل گرفتن */
    public LocalDateTime getEstimatedPickupTime() {
<span class="fc" id="L406">        return estimatedPickupTime;</span>
    }
    
    /** @param estimatedPickupTime زمان تخمینی تحویل گرفتن */
    public void setEstimatedPickupTime(LocalDateTime estimatedPickupTime) {
<span class="fc" id="L411">        this.estimatedPickupTime = estimatedPickupTime;</span>
<span class="fc" id="L412">    }</span>
    
    /** @return زمان تخمینی تحویل */
    public LocalDateTime getEstimatedDeliveryTime() {
<span class="fc" id="L416">        return estimatedDeliveryTime;</span>
    }
    
    /** @param estimatedDeliveryTime زمان تخمینی تحویل */
    public void setEstimatedDeliveryTime(LocalDateTime estimatedDeliveryTime) {
<span class="fc" id="L421">        this.estimatedDeliveryTime = estimatedDeliveryTime;</span>
<span class="fc" id="L422">    }</span>
    
    /** @return یادداشت‌های تحویل */
    public String getDeliveryNotes() {
<span class="fc" id="L426">        return deliveryNotes;</span>
    }
    
    /** @param deliveryNotes یادداشت‌های تحویل */
    public void setDeliveryNotes(String deliveryNotes) {
<span class="fc" id="L431">        this.deliveryNotes = deliveryNotes;</span>
<span class="fc" id="L432">    }</span>
    
    /** @return یادداشت‌های پیک */
    public String getCourierNotes() {
<span class="fc" id="L436">        return courierNotes;</span>
    }
    
    /** @param courierNotes یادداشت‌های پیک */
    public void setCourierNotes(String courierNotes) {
<span class="fc" id="L441">        this.courierNotes = courierNotes;</span>
<span class="fc" id="L442">    }</span>
    
    /** @return هزینه تحویل */
    public Double getDeliveryFee() {
<span class="fc" id="L446">        return deliveryFee;</span>
    }
    
    /** @param deliveryFee هزینه تحویل */
    public void setDeliveryFee(Double deliveryFee) {
<span class="fc" id="L451">        this.deliveryFee = deliveryFee;</span>
<span class="fc" id="L452">    }</span>
    
    /** @return مسافت تحویل */
    public Double getDistanceKm() {
<span class="fc" id="L456">        return distanceKm;</span>
    }
    
    /** @param distanceKm مسافت تحویل */
    public void setDistanceKm(Double distanceKm) {
<span class="fc" id="L461">        this.distanceKm = distanceKm;</span>
<span class="fc" id="L462">    }</span>
    
    /**
     * نمایش رشته‌ای از تحویل برای debugging
     * 
     * @return خلاصه اطلاعات تحویل
     */
    @Override
    public String toString() {
<span class="nc" id="L471">        return &quot;Delivery{&quot; +</span>
                &quot;id=&quot; + id +
<span class="nc bnc" id="L473" title="All 2 branches missed.">                &quot;, orderId=&quot; + (order != null ? order.getId() : null) +</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">                &quot;, courierId=&quot; + (courier != null ? courier.getId() : null) +</span>
                &quot;, status=&quot; + status +
                &quot;, deliveryFee=&quot; + deliveryFee +
                '}';
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>