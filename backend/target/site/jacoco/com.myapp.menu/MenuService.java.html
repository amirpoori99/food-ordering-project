<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MenuService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.menu</a> &gt; <span class="el_source">MenuService.java</span></div><h1>MenuService.java</h1><pre class="source lang-java linenums">package com.myapp.menu;

import com.myapp.common.exceptions.NotFoundException;
import com.myapp.common.models.FoodItem;
import com.myapp.common.models.Restaurant;
import com.myapp.item.ItemRepository;
import com.myapp.restaurant.RestaurantRepository;

import java.util.List;
import java.util.Optional;

/**
 * سرویس مدیریت منوی رستوران‌ها
 * 
 * این کلاس منطق کسب‌وکار مربوط به مدیریت منوی رستوران‌ها را پیاده‌سازی می‌کند:
 * 
 * === عملیات CRUD منو ===
 * - افزودن آیتم جدید به منو
 * - به‌روزرسانی آیتم‌های موجود
 * - حذف آیتم از منو
 * - دریافت منوی کامل یا فیلتر شده
 * 
 * === مدیریت موجودی ===
 * - به‌روزرسانی وضعیت در دسترس بودن
 * - مدیریت موجودی آیتم‌ها
 * - شناسایی آیتم‌های کم موجودی
 * - مدیریت وضعیت out-of-stock
 * 
 * === دسته‌بندی و جستجو ===
 * - مدیریت دسته‌بندی آیتم‌ها
 * - فیلتر بر اساس دسته
 * - جستجوی آیتم‌های منو
 * 
 * === آمار و گزارش ===
 * - آمار کلی منو
 * - گزارش موجودی
 * - تحلیل در دسترس بودن آیتم‌ها
 * 
 * ویژگی‌های کلیدی:
 * - Input Validation: اعتبارسنجی کامل ورودی‌ها
 * - Business Rules: اعمال قوانین کسب‌وکار
 * - Error Handling: مدیریت خطاهای مختلف
 * - Data Integrity: حفظ یکپارچگی داده‌ها
 * - Permission Checking: بررسی مالکیت رستوران
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 */
public class MenuService {
    
    /** Repository مدیریت منو */
    private final MenuRepository menuRepository;
    
    /** Repository آیتم‌های غذایی */
    private final ItemRepository itemRepository;
    
    /** Repository رستوران‌ها */
    private final RestaurantRepository restaurantRepository;
    
    /**
     * سازنده پیش‌فرض
     * Dependencies را به صورت خودکار ایجاد می‌کند
     */
<span class="nc" id="L65">    public MenuService() {</span>
<span class="nc" id="L66">        this.menuRepository = new MenuRepository();</span>
<span class="nc" id="L67">        this.itemRepository = new ItemRepository();</span>
<span class="nc" id="L68">        this.restaurantRepository = new RestaurantRepository();</span>
<span class="nc" id="L69">    }</span>
    
    /**
     * سازنده برای dependency injection (تست)
     * 
     * @param menuRepository repository منو
     * @param itemRepository repository آیتم‌ها
     * @param restaurantRepository repository رستوران‌ها
     */
<span class="fc" id="L78">    public MenuService(MenuRepository menuRepository, ItemRepository itemRepository, RestaurantRepository restaurantRepository) {</span>
<span class="fc" id="L79">        this.menuRepository = menuRepository;</span>
<span class="fc" id="L80">        this.itemRepository = itemRepository;</span>
<span class="fc" id="L81">        this.restaurantRepository = restaurantRepository;</span>
<span class="fc" id="L82">    }</span>
    
    /**
     * دریافت منوی کامل یک رستوران
     * 
     * شامل تمام آیتم‌ها بدون در نظر گیری وضعیت در دسترس بودن
     * 
     * @param restaurantId شناسه رستوران
     * @return لیست کامل آیتم‌های منو
     * @throws IllegalArgumentException اگر ID نامعتبر باشد
     * @throws NotFoundException اگر رستوران وجود نداشته باشد
     */
    public List&lt;FoodItem&gt; getRestaurantMenu(Long restaurantId) {
<span class="fc bfc" id="L95" title="All 4 branches covered.">        if (restaurantId == null || restaurantId &lt;= 0) {</span>
<span class="fc" id="L96">            throw new IllegalArgumentException(&quot;Restaurant ID must be positive&quot;);</span>
        }
        
        // بررسی وجود رستوران
<span class="fc bfc" id="L100" title="All 2 branches covered.">        if (!restaurantRepository.existsById(restaurantId)) {</span>
<span class="fc" id="L101">            throw new NotFoundException(&quot;Restaurant&quot;, restaurantId);</span>
        }
        
<span class="fc" id="L104">        return menuRepository.getMenuByRestaurant(restaurantId);</span>
    }
    
    /**
     * دریافت آیتم‌های در دسترس منوی رستوران
     * 
     * فقط آیتم‌هایی که available=true و quantity&gt;0 هستند
     * 
     * @param restaurantId شناسه رستوران
     * @return لیست آیتم‌های قابل سفارش
     * @throws IllegalArgumentException اگر ID نامعتبر باشد
     * @throws NotFoundException اگر رستوران وجود نداشته باشد
     */
    public List&lt;FoodItem&gt; getAvailableMenu(Long restaurantId) {
<span class="pc bpc" id="L118" title="2 of 4 branches missed.">        if (restaurantId == null || restaurantId &lt;= 0) {</span>
<span class="nc" id="L119">            throw new IllegalArgumentException(&quot;Restaurant ID must be positive&quot;);</span>
        }
        
        // بررسی وجود رستوران
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">        if (!restaurantRepository.existsById(restaurantId)) {</span>
<span class="nc" id="L124">            throw new NotFoundException(&quot;Restaurant&quot;, restaurantId);</span>
        }
        
<span class="fc" id="L127">        return menuRepository.getAvailableMenuByRestaurant(restaurantId);</span>
    }
    
    /**
     * افزودن آیتم جدید به منوی رستوران
     * 
     * آیتم با موجودی اولیه صفر ایجاد می‌شود
     * vendor باید موجودی را به صورت جداگانه تنظیم کند
     * 
     * @param restaurantId شناسه رستوران
     * @param name نام آیتم غذایی
     * @param description توضیحات آیتم
     * @param price قیمت آیتم
     * @param category دسته‌بندی آیتم
     * @return آیتم ایجاد شده
     * @throws IllegalArgumentException اگر ورودی‌ها نامعتبر باشند
     * @throws NotFoundException اگر رستوران وجود نداشته باشد
     */
    public FoodItem addItemToMenu(Long restaurantId, String name, String description, Double price, String category) {
<span class="fc" id="L146">        validateAddItemInput(restaurantId, name, description, price, category);</span>
        
        // بررسی وجود رستوران و دریافت آن
<span class="fc" id="L149">        Optional&lt;Restaurant&gt; restaurantOpt = restaurantRepository.findById(restaurantId);</span>
<span class="fc bfc" id="L150" title="All 2 branches covered.">        if (restaurantOpt.isEmpty()) {</span>
<span class="fc" id="L151">            throw new NotFoundException(&quot;Restaurant&quot;, restaurantId);</span>
        }
        
<span class="fc" id="L154">        Restaurant restaurant = restaurantOpt.get();</span>
        
        // ایجاد آیتم غذایی جدید
<span class="fc" id="L157">        FoodItem foodItem = FoodItem.forMenu(name.trim(), description.trim(), price, category.trim(), restaurant);</span>
        
        // تنظیم موجودی اولیه به صفر - vendor باید به صورت صریح موجودی تنظیم کند
<span class="fc" id="L160">        foodItem.setQuantity(0);</span>
        
<span class="fc" id="L162">        return itemRepository.save(foodItem);</span>
    }
    
    /**
     * افزودن آیتم به منو با استفاده از شیء FoodItem
     * 
     * @param foodItem آیتم غذایی برای افزودن
     * @return آیتم ایجاد شده
     * @throws IllegalArgumentException اگر آیتم یا رستوران نامعتبر باشد
     * @throws NotFoundException اگر رستوران وجود نداشته باشد
     */
    public FoodItem addItemToMenu(FoodItem foodItem) {
<span class="fc bfc" id="L174" title="All 2 branches covered.">        if (foodItem == null) {</span>
<span class="fc" id="L175">            throw new IllegalArgumentException(&quot;Food item cannot be null&quot;);</span>
        }
<span class="pc bpc" id="L177" title="2 of 4 branches missed.">        if (foodItem.getRestaurant() == null || foodItem.getRestaurant().getId() == null) {</span>
<span class="nc" id="L178">            throw new IllegalArgumentException(&quot;Food item must have a valid restaurant&quot;);</span>
        }
        
<span class="fc" id="L181">        validateAddItemInput(foodItem.getRestaurant().getId(), foodItem.getName(), </span>
<span class="fc" id="L182">                           foodItem.getDescription(), foodItem.getPrice(), foodItem.getCategory());</span>
        
        // بررسی وجود رستوران
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">        if (!restaurantRepository.existsById(foodItem.getRestaurant().getId())) {</span>
<span class="nc" id="L186">            throw new NotFoundException(&quot;Restaurant&quot;, foodItem.getRestaurant().getId());</span>
        }
        
<span class="fc" id="L189">        return itemRepository.save(foodItem);</span>
    }
    
    /**
     * به‌روزرسانی آیتم موجود در منو
     * 
     * تنها فیلدهای ارائه شده (غیر null) به‌روزرسانی می‌شوند
     * 
     * @param itemId شناسه آیتم
     * @param name نام جدید (اختیاری)
     * @param description توضیحات جدید (اختیاری)
     * @param price قیمت جدید (اختیاری)
     * @param category دسته‌بندی جدید (اختیاری)
     * @param quantity موجودی جدید (اختیاری)
     * @param available وضعیت در دسترس بودن (اختیاری)
     * @return آیتم به‌روزرسانی شده
     * @throws IllegalArgumentException اگر پارامترها نامعتبر باشند
     * @throws NotFoundException اگر آیتم وجود نداشته باشد
     */
    public FoodItem updateMenuItem(Long itemId, String name, String description, Double price, String category, Integer quantity, Boolean available) {
<span class="pc bpc" id="L209" title="1 of 4 branches missed.">        if (itemId == null || itemId &lt;= 0) {</span>
<span class="fc" id="L210">            throw new IllegalArgumentException(&quot;Item ID must be positive&quot;);</span>
        }
        
        // دریافت آیتم موجود
<span class="fc" id="L214">        Optional&lt;FoodItem&gt; itemOpt = itemRepository.findById(itemId);</span>
<span class="fc bfc" id="L215" title="All 2 branches covered.">        if (itemOpt.isEmpty()) {</span>
<span class="fc" id="L216">            throw new NotFoundException(&quot;Food item&quot;, itemId);</span>
        }
        
<span class="fc" id="L219">        FoodItem existingItem = itemOpt.get();</span>
        
        // به‌روزرسانی فیلدها در صورت ارائه
<span class="pc bpc" id="L222" title="1 of 4 branches missed.">        if (name != null &amp;&amp; !name.trim().isEmpty()) {</span>
<span class="pc bpc" id="L223" title="1 of 2 branches missed.">            if (name.trim().length() &gt; 100) {</span>
<span class="nc" id="L224">                throw new IllegalArgumentException(&quot;Food item name cannot exceed 100 characters&quot;);</span>
            }
<span class="fc" id="L226">            existingItem.setName(name.trim());</span>
        }
        
<span class="pc bpc" id="L229" title="1 of 4 branches missed.">        if (description != null &amp;&amp; !description.trim().isEmpty()) {</span>
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">            if (description.trim().length() &gt; 500) {</span>
<span class="nc" id="L231">                throw new IllegalArgumentException(&quot;Food item description cannot exceed 500 characters&quot;);</span>
            }
<span class="fc" id="L233">            existingItem.setDescription(description.trim());</span>
        }
        
<span class="fc bfc" id="L236" title="All 2 branches covered.">        if (price != null) {</span>
<span class="pc bpc" id="L237" title="2 of 4 branches missed.">            if (price &lt; 0.01 || price &gt; 9999.99) {</span>
<span class="nc" id="L238">                throw new IllegalArgumentException(&quot;Price must be between 0.01 and 9999.99&quot;);</span>
            }
<span class="fc" id="L240">            existingItem.setPrice(price);</span>
        }
        
<span class="pc bpc" id="L243" title="1 of 4 branches missed.">        if (category != null &amp;&amp; !category.trim().isEmpty()) {</span>
<span class="pc bpc" id="L244" title="1 of 2 branches missed.">            if (category.trim().length() &gt; 50) {</span>
<span class="nc" id="L245">                throw new IllegalArgumentException(&quot;Category cannot exceed 50 characters&quot;);</span>
            }
<span class="fc" id="L247">            existingItem.setCategory(category.trim());</span>
        }
        
<span class="fc bfc" id="L250" title="All 2 branches covered.">        if (quantity != null) {</span>
<span class="fc bfc" id="L251" title="All 2 branches covered.">            if (quantity &lt; 0) {</span>
<span class="fc" id="L252">                throw new IllegalArgumentException(&quot;Quantity cannot be negative&quot;);</span>
            }
<span class="fc" id="L254">            existingItem.setQuantity(quantity);</span>
        }
        
<span class="fc bfc" id="L257" title="All 2 branches covered.">        if (available != null) {</span>
<span class="fc" id="L258">            existingItem.setAvailable(available);</span>
        }
        
<span class="fc" id="L261">        return itemRepository.save(existingItem);</span>
    }
    
    /**
     * به‌روزرسانی آیتم منو با استفاده از شیء FoodItem
     * 
     * فقط فیلدهای non-null به‌روزرسانی می‌شوند
     * رستوران آیتم تغییر نمی‌کند
     * 
     * @param foodItem آیتم با اطلاعات جدید
     * @return آیتم به‌روزرسانی شده
     * @throws IllegalArgumentException اگر آیتم یا ID نامعتبر باشد
     * @throws NotFoundException اگر آیتم وجود نداشته باشد
     */
    public FoodItem updateMenuItem(FoodItem foodItem) {
<span class="pc bpc" id="L276" title="1 of 2 branches missed.">        if (foodItem == null) {</span>
<span class="nc" id="L277">            throw new IllegalArgumentException(&quot;Food item cannot be null&quot;);</span>
        }
<span class="pc bpc" id="L279" title="2 of 4 branches missed.">        if (foodItem.getId() == null || foodItem.getId() &lt;= 0) {</span>
<span class="nc" id="L280">            throw new IllegalArgumentException(&quot;Food item ID must be positive&quot;);</span>
        }
        
        // دریافت آیتم موجود برای حفظ تمام فیلدها
<span class="fc" id="L284">        Optional&lt;FoodItem&gt; existingOpt = itemRepository.findById(foodItem.getId());</span>
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">        if (existingOpt.isEmpty()) {</span>
<span class="nc" id="L286">            throw new NotFoundException(&quot;Food item&quot;, foodItem.getId());</span>
        }
        
<span class="fc" id="L289">        FoodItem existingItem = existingOpt.get();</span>
        
        // به‌روزرسانی تنها فیلدهای ارائه شده
<span class="pc bpc" id="L292" title="2 of 4 branches missed.">        if (foodItem.getName() != null &amp;&amp; !foodItem.getName().trim().isEmpty()) {</span>
<span class="pc bpc" id="L293" title="1 of 2 branches missed.">            if (foodItem.getName().trim().length() &gt; 100) {</span>
<span class="nc" id="L294">                throw new IllegalArgumentException(&quot;Food item name cannot exceed 100 characters&quot;);</span>
            }
<span class="fc" id="L296">            existingItem.setName(foodItem.getName().trim());</span>
        }
        
<span class="pc bpc" id="L299" title="3 of 4 branches missed.">        if (foodItem.getDescription() != null &amp;&amp; !foodItem.getDescription().trim().isEmpty()) {</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">            if (foodItem.getDescription().trim().length() &gt; 500) {</span>
<span class="nc" id="L301">                throw new IllegalArgumentException(&quot;Food item description cannot exceed 500 characters&quot;);</span>
            }
<span class="nc" id="L303">            existingItem.setDescription(foodItem.getDescription().trim());</span>
        }
        
<span class="pc bpc" id="L306" title="1 of 2 branches missed.">        if (foodItem.getPrice() != null) {</span>
<span class="pc bpc" id="L307" title="2 of 4 branches missed.">            if (foodItem.getPrice() &lt; 0.01 || foodItem.getPrice() &gt; 9999.99) {</span>
<span class="nc" id="L308">                throw new IllegalArgumentException(&quot;Price must be between 0.01 and 9999.99&quot;);</span>
            }
<span class="fc" id="L310">            existingItem.setPrice(foodItem.getPrice());</span>
        }
        
<span class="pc bpc" id="L313" title="3 of 4 branches missed.">        if (foodItem.getCategory() != null &amp;&amp; !foodItem.getCategory().trim().isEmpty()) {</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">            if (foodItem.getCategory().trim().length() &gt; 50) {</span>
<span class="nc" id="L315">                throw new IllegalArgumentException(&quot;Category cannot exceed 50 characters&quot;);</span>
            }
<span class="nc" id="L317">            existingItem.setCategory(foodItem.getCategory().trim());</span>
        }
        
<span class="pc bpc" id="L320" title="1 of 2 branches missed.">        if (foodItem.getQuantity() != null) {</span>
<span class="pc bpc" id="L321" title="1 of 2 branches missed.">            if (foodItem.getQuantity() &lt; 0) {</span>
<span class="nc" id="L322">                throw new IllegalArgumentException(&quot;Quantity cannot be negative&quot;);</span>
            }
<span class="fc" id="L324">            existingItem.setQuantity(foodItem.getQuantity());</span>
        }
        
<span class="pc bpc" id="L327" title="1 of 2 branches missed.">        if (foodItem.getAvailable() != null) {</span>
<span class="fc" id="L328">            existingItem.setAvailable(foodItem.getAvailable());</span>
        }
        
        // حفظ اتصال رستوران
        // (رستوران نباید از طریق update تغییر کند)
        
<span class="fc" id="L334">        return itemRepository.save(existingItem);</span>
    }
    
    /**
     * حذف آیتم از منو
     * 
     * این عمل آیتم را کاملاً از سیستم حذف می‌کند
     * 
     * @param itemId شناسه آیتم
     * @throws IllegalArgumentException اگر ID نامعتبر باشد
     * @throws NotFoundException اگر آیتم وجود نداشته باشد
     */
    public void removeItemFromMenu(Long itemId) {
<span class="pc bpc" id="L347" title="1 of 4 branches missed.">        if (itemId == null || itemId &lt;= 0) {</span>
<span class="fc" id="L348">            throw new IllegalArgumentException(&quot;Item ID must be positive&quot;);</span>
        }
        
        // بررسی وجود آیتم
<span class="fc bfc" id="L352" title="All 2 branches covered.">        if (!itemRepository.existsById(itemId)) {</span>
<span class="fc" id="L353">            throw new NotFoundException(&quot;Food item&quot;, itemId);</span>
        }
        
<span class="fc" id="L356">        itemRepository.delete(itemId);</span>
<span class="fc" id="L357">    }</span>
    
    /**
     * تنظیم وضعیت در دسترس بودن آیتم
     * 
     * @param itemId شناسه آیتم
     * @param available وضعیت جدید
     * @return آیتم به‌روزرسانی شده
     * @throws IllegalArgumentException اگر ID نامعتبر باشد
     * @throws NotFoundException اگر آیتم وجود نداشته باشد
     */
    public FoodItem setItemAvailability(Long itemId, boolean available) {
<span class="pc bpc" id="L369" title="2 of 4 branches missed.">        if (itemId == null || itemId &lt;= 0) {</span>
<span class="nc" id="L370">            throw new IllegalArgumentException(&quot;Item ID must be positive&quot;);</span>
        }
        
<span class="fc" id="L373">        Optional&lt;FoodItem&gt; itemOpt = itemRepository.findById(itemId);</span>
<span class="pc bpc" id="L374" title="1 of 2 branches missed.">        if (itemOpt.isEmpty()) {</span>
<span class="nc" id="L375">            throw new NotFoundException(&quot;Food item&quot;, itemId);</span>
        }
        
<span class="fc" id="L378">        FoodItem item = itemOpt.get();</span>
<span class="fc" id="L379">        item.setAvailable(available);</span>
        
<span class="fc" id="L381">        return itemRepository.save(item);</span>
    }
    
    /**
     * به‌روزرسانی موجودی آیتم
     * 
     * @param itemId شناسه آیتم
     * @param quantity موجودی جدید
     * @return آیتم به‌روزرسانی شده
     * @throws IllegalArgumentException اگر پارامترها نامعتبر باشند
     * @throws NotFoundException اگر آیتم وجود نداشته باشد
     */
    public FoodItem updateItemQuantity(Long itemId, int quantity) {
<span class="pc bpc" id="L394" title="2 of 4 branches missed.">        if (itemId == null || itemId &lt;= 0) {</span>
<span class="nc" id="L395">            throw new IllegalArgumentException(&quot;Item ID must be positive&quot;);</span>
        }
<span class="fc bfc" id="L397" title="All 2 branches covered.">        if (quantity &lt; 0) {</span>
<span class="fc" id="L398">            throw new IllegalArgumentException(&quot;Quantity cannot be negative&quot;);</span>
        }
        
<span class="fc" id="L401">        Optional&lt;FoodItem&gt; itemOpt = itemRepository.findById(itemId);</span>
<span class="pc bpc" id="L402" title="1 of 2 branches missed.">        if (itemOpt.isEmpty()) {</span>
<span class="nc" id="L403">            throw new NotFoundException(&quot;Food item&quot;, itemId);</span>
        }
        
<span class="fc" id="L406">        FoodItem item = itemOpt.get();</span>
<span class="fc" id="L407">        item.setQuantity(quantity);</span>
        
<span class="fc" id="L409">        return itemRepository.save(item);</span>
    }
    
    /**
     * دریافت آیتم‌های منو بر اساس دسته‌بندی
     * 
     * @param restaurantId شناسه رستوران
     * @param category دسته‌بندی
     * @return لیست آیتم‌های دسته مشخص
     * @throws IllegalArgumentException اگر پارامترها نامعتبر باشند
     * @throws NotFoundException اگر رستوران وجود نداشته باشد
     */
    public List&lt;FoodItem&gt; getMenuByCategory(Long restaurantId, String category) {
<span class="pc bpc" id="L422" title="2 of 4 branches missed.">        if (restaurantId == null || restaurantId &lt;= 0) {</span>
<span class="nc" id="L423">            throw new IllegalArgumentException(&quot;Restaurant ID must be positive&quot;);</span>
        }
<span class="pc bpc" id="L425" title="1 of 4 branches missed.">        if (category == null || category.trim().isEmpty()) {</span>
<span class="fc" id="L426">            throw new IllegalArgumentException(&quot;Category cannot be empty&quot;);</span>
        }
        
        // بررسی وجود رستوران
<span class="pc bpc" id="L430" title="1 of 2 branches missed.">        if (!restaurantRepository.existsById(restaurantId)) {</span>
<span class="nc" id="L431">            throw new NotFoundException(&quot;Restaurant&quot;, restaurantId);</span>
        }
        
<span class="fc" id="L434">        return menuRepository.getMenuByCategory(restaurantId, category.trim());</span>
    }
    
    /**
     * دریافت تمام دسته‌بندی‌های منوی رستوران
     * 
     * @param restaurantId شناسه رستوران
     * @return لیست دسته‌بندی‌های منحصر به فرد
     * @throws IllegalArgumentException اگر ID نامعتبر باشد
     * @throws NotFoundException اگر رستوران وجود نداشته باشد
     */
    public List&lt;String&gt; getMenuCategories(Long restaurantId) {
<span class="pc bpc" id="L446" title="2 of 4 branches missed.">        if (restaurantId == null || restaurantId &lt;= 0) {</span>
<span class="nc" id="L447">            throw new IllegalArgumentException(&quot;Restaurant ID must be positive&quot;);</span>
        }
        
        // بررسی وجود رستوران
<span class="pc bpc" id="L451" title="1 of 2 branches missed.">        if (!restaurantRepository.existsById(restaurantId)) {</span>
<span class="nc" id="L452">            throw new NotFoundException(&quot;Restaurant&quot;, restaurantId);</span>
        }
        
<span class="fc" id="L455">        return menuRepository.getCategories(restaurantId);</span>
    }
    
    /**
     * دریافت آیتم‌های کم موجودی رستوران
     * 
     * @param restaurantId شناسه رستوران
     * @param threshold آستانه کم موجودی
     * @return لیست آیتم‌های با موجودی کمتر از آستانه
     * @throws IllegalArgumentException اگر پارامترها نامعتبر باشند
     * @throws NotFoundException اگر رستوران وجود نداشته باشد
     */
    public List&lt;FoodItem&gt; getLowStockItems(Long restaurantId, int threshold) {
<span class="pc bpc" id="L468" title="2 of 4 branches missed.">        if (restaurantId == null || restaurantId &lt;= 0) {</span>
<span class="nc" id="L469">            throw new IllegalArgumentException(&quot;Restaurant ID must be positive&quot;);</span>
        }
<span class="fc bfc" id="L471" title="All 2 branches covered.">        if (threshold &lt; 0) {</span>
<span class="fc" id="L472">            throw new IllegalArgumentException(&quot;Threshold cannot be negative&quot;);</span>
        }
        
        // بررسی وجود رستوران
<span class="pc bpc" id="L476" title="1 of 2 branches missed.">        if (!restaurantRepository.existsById(restaurantId)) {</span>
<span class="nc" id="L477">            throw new NotFoundException(&quot;Restaurant&quot;, restaurantId);</span>
        }
        
<span class="fc" id="L480">        return menuRepository.getLowStockItems(restaurantId, threshold);</span>
    }
    
    /**
     * دریافت آمار منوی رستوران
     * 
     * شامل تعداد کل آیتم‌ها، آیتم‌های در دسترس، ناموجود، کم موجودی
     * 
     * @param restaurantId شناسه رستوران
     * @return آمار کامل منو
     * @throws IllegalArgumentException اگر ID نامعتبر باشد
     * @throws NotFoundException اگر رستوران وجود نداشته باشد
     */
    public MenuStatistics getMenuStatistics(Long restaurantId) {
<span class="pc bpc" id="L494" title="2 of 4 branches missed.">        if (restaurantId == null || restaurantId &lt;= 0) {</span>
<span class="nc" id="L495">            throw new IllegalArgumentException(&quot;Restaurant ID must be positive&quot;);</span>
        }
        
        // بررسی وجود رستوران
<span class="pc bpc" id="L499" title="1 of 2 branches missed.">        if (!restaurantRepository.existsById(restaurantId)) {</span>
<span class="nc" id="L500">            throw new NotFoundException(&quot;Restaurant&quot;, restaurantId);</span>
        }
        
<span class="fc" id="L503">        List&lt;FoodItem&gt; allItems = menuRepository.getMenuByRestaurant(restaurantId);</span>
        
<span class="fc" id="L505">        int totalItems = allItems.size();</span>
<span class="fc" id="L506">        int availableItems = (int) allItems.stream().filter(FoodItem::getAvailable).count();</span>
<span class="fc" id="L507">        int unavailableItems = totalItems - availableItems;</span>
<span class="fc bfc" id="L508" title="All 2 branches covered.">        int outOfStockItems = (int) allItems.stream().filter(item -&gt; item.getQuantity() == 0).count();</span>
<span class="fc bfc" id="L509" title="All 4 branches covered.">        int lowStockItems = (int) allItems.stream().filter(item -&gt; item.getQuantity() &gt; 0 &amp;&amp; item.getQuantity() &lt;= 5).count();</span>
        
<span class="fc" id="L511">        return new MenuStatistics(totalItems, availableItems, unavailableItems, outOfStockItems, lowStockItems);</span>
    }
    
    /**
     * بررسی مالکیت رستوران برای آیتم منو
     * 
     * @param restaurantId شناسه رستوران
     * @param itemId شناسه آیتم
     * @return true اگر آیتم متعلق به رستوران باشد
     * @throws IllegalArgumentException اگر IDها نامعتبر باشند
     */
    public boolean isRestaurantOwner(Long restaurantId, Long itemId) {
<span class="pc bpc" id="L523" title="2 of 4 branches missed.">        if (restaurantId == null || restaurantId &lt;= 0) {</span>
<span class="nc" id="L524">            throw new IllegalArgumentException(&quot;Restaurant ID must be positive&quot;);</span>
        }
<span class="pc bpc" id="L526" title="2 of 4 branches missed.">        if (itemId == null || itemId &lt;= 0) {</span>
<span class="nc" id="L527">            throw new IllegalArgumentException(&quot;Item ID must be positive&quot;);</span>
        }
        
<span class="fc" id="L530">        Optional&lt;FoodItem&gt; itemOpt = itemRepository.findById(itemId);</span>
<span class="fc bfc" id="L531" title="All 2 branches covered.">        if (itemOpt.isEmpty()) {</span>
<span class="fc" id="L532">            return false;</span>
        }
        
<span class="fc" id="L535">        FoodItem item = itemOpt.get();</span>
<span class="fc" id="L536">        return item.getRestaurant().getId().equals(restaurantId);</span>
    }
    
    /**
     * اعتبارسنجی ورودی‌های افزودن آیتم جدید
     * 
     * @param restaurantId شناسه رستوران
     * @param name نام آیتم
     * @param description توضیحات
     * @param price قیمت
     * @param category دسته‌بندی
     * @throws IllegalArgumentException اگر هر یک از ورودی‌ها نامعتبر باشد
     */
    private void validateAddItemInput(Long restaurantId, String name, String description, Double price, String category) {
<span class="fc bfc" id="L550" title="All 4 branches covered.">        if (restaurantId == null || restaurantId &lt;= 0) {</span>
<span class="fc" id="L551">            throw new IllegalArgumentException(&quot;Restaurant ID must be positive&quot;);</span>
        }
<span class="fc bfc" id="L553" title="All 4 branches covered.">        if (name == null || name.trim().isEmpty()) {</span>
<span class="fc" id="L554">            throw new IllegalArgumentException(&quot;Food item name cannot be empty&quot;);</span>
        }
<span class="fc bfc" id="L556" title="All 2 branches covered.">        if (name.trim().length() &gt; 100) {</span>
<span class="fc" id="L557">            throw new IllegalArgumentException(&quot;Food item name cannot exceed 100 characters&quot;);</span>
        }
<span class="pc bpc" id="L559" title="2 of 4 branches missed.">        if (description == null || description.trim().isEmpty()) {</span>
<span class="nc" id="L560">            throw new IllegalArgumentException(&quot;Food item description cannot be empty&quot;);</span>
        }
<span class="fc bfc" id="L562" title="All 2 branches covered.">        if (description.trim().length() &gt; 500) {</span>
<span class="fc" id="L563">            throw new IllegalArgumentException(&quot;Food item description cannot exceed 500 characters&quot;);</span>
        }
<span class="pc bpc" id="L565" title="1 of 6 branches missed.">        if (price == null || price &lt; 0.01 || price &gt; 9999.99) {</span>
<span class="fc" id="L566">            throw new IllegalArgumentException(&quot;Price must be between 0.01 and 9999.99&quot;);</span>
        }
<span class="pc bpc" id="L568" title="2 of 4 branches missed.">        if (category == null || category.trim().isEmpty()) {</span>
<span class="nc" id="L569">            throw new IllegalArgumentException(&quot;Category cannot be empty&quot;);</span>
        }
<span class="fc bfc" id="L571" title="All 2 branches covered.">        if (category.trim().length() &gt; 50) {</span>
<span class="fc" id="L572">            throw new IllegalArgumentException(&quot;Category cannot exceed 50 characters&quot;);</span>
        }
<span class="fc" id="L574">    }</span>
    
    /**
     * کلاس آمار منو
     * 
     * حاوی اطلاعات آماری مربوط به منوی رستوران
     */
    public static class MenuStatistics {
        /** تعداد کل آیتم‌ها */
        private final int totalItems;
        
        /** تعداد آیتم‌های در دسترس */
        private final int availableItems;
        
        /** تعداد آیتم‌های غیر قابل دسترس */
        private final int unavailableItems;
        
        /** تعداد آیتم‌های تمام شده */
        private final int outOfStockItems;
        
        /** تعداد آیتم‌های کم موجودی */
        private final int lowStockItems;
        
        /**
         * سازنده آمار منو
         */
<span class="fc" id="L600">        public MenuStatistics(int totalItems, int availableItems, int unavailableItems, int outOfStockItems, int lowStockItems) {</span>
<span class="fc" id="L601">            this.totalItems = totalItems;</span>
<span class="fc" id="L602">            this.availableItems = availableItems;</span>
<span class="fc" id="L603">            this.unavailableItems = unavailableItems;</span>
<span class="fc" id="L604">            this.outOfStockItems = outOfStockItems;</span>
<span class="fc" id="L605">            this.lowStockItems = lowStockItems;</span>
<span class="fc" id="L606">        }</span>
        
        /** @return تعداد کل آیتم‌ها */
<span class="fc" id="L609">        public int getTotalItems() { return totalItems; }</span>
        
        /** @return تعداد آیتم‌های در دسترس */
<span class="fc" id="L612">        public int getAvailableItems() { return availableItems; }</span>
        
        /** @return تعداد آیتم‌های غیر قابل دسترس */
<span class="fc" id="L615">        public int getUnavailableItems() { return unavailableItems; }</span>
        
        /** @return تعداد آیتم‌های تمام شده */
<span class="fc" id="L618">        public int getOutOfStockItems() { return outOfStockItems; }</span>
        
        /** @return تعداد آیتم‌های کم موجودی */
<span class="fc" id="L621">        public int getLowStockItems() { return lowStockItems; }</span>
        
        /** @return تعداد آیتم‌های موجود */
<span class="fc" id="L624">        public int getInStockItems() { return totalItems - outOfStockItems; }</span>
        
        /**
         * محاسبه درصد در دسترس بودن
         * 
         * @return درصد آیتم‌های در دسترس (0-100)
         */
        public double getAvailabilityPercentage() { 
<span class="fc bfc" id="L632" title="All 2 branches covered.">            return totalItems &gt; 0 ? (double) availableItems / totalItems * 100 : 0.0; </span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>