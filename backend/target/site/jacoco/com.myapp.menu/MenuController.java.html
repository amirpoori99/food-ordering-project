<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MenuController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.menu</a> &gt; <span class="el_source">MenuController.java</span></div><h1>MenuController.java</h1><pre class="source lang-java linenums">package com.myapp.menu;

import com.myapp.common.exceptions.NotFoundException;
import com.myapp.common.models.FoodItem;
import com.sun.net.httpserver.HttpExchange;
import com.sun.net.httpserver.HttpHandler;

import java.io.IOException;
import java.io.OutputStream;
import java.net.URI;
import java.util.List;
import java.util.Map;
import java.util.HashMap;

/**
 * کنترلر REST API برای مدیریت منوی رستوران‌ها
 * 
 * این کلاس تمام endpoint های مربوط به مدیریت منو را ارائه می‌دهد:
 * 
 * === دریافت منو ===
 * GET    /api/menus/restaurant/{restaurantId}                 - دریافت منوی کامل رستوران
 * GET    /api/menus/restaurant/{restaurantId}/available       - دریافت آیتم‌های در دسترس
 * 
 * === مدیریت آیتم‌ها ===
 * POST   /api/menus/restaurant/{restaurantId}/items           - افزودن آیتم به منو
 * PUT    /api/menus/items/{itemId}                           - به‌روزرسانی آیتم منو
 * DELETE /api/menus/items/{itemId}                           - حذف آیتم از منو
 * 
 * === مدیریت وضعیت ===
 * PUT    /api/menus/items/{itemId}/availability              - تنظیم وضعیت در دسترس بودن
 * PUT    /api/menus/items/{itemId}/quantity                  - به‌روزرسانی موجودی آیتم
 * 
 * === دسته‌بندی و فیلتر ===
 * GET    /api/menus/restaurant/{restaurantId}/categories     - دریافت دسته‌بندی‌های منو
 * GET    /api/menus/restaurant/{restaurantId}/category/{cat} - آیتم‌های یک دسته خاص
 * 
 * === گزارش و مانیتورینگ ===
 * GET    /api/menus/restaurant/{restaurantId}/low-stock      - آیتم‌های کم موجودی
 * GET    /api/menus/restaurant/{restaurantId}/statistics     - آمار کامل منو
 * 
 * ویژگی‌های کلیدی:
 * - Menu-focused API: رویکرد متمرکز بر منو (در مقابل item-focused)
 * - Restaurant Context: تمام عملیات در بافت رستوران
 * - Simple JSON Processing: پردازش JSON ساده و کارآمد
 * - Category Management: مدیریت دسته‌بندی آیتم‌ها
 * - Inventory Monitoring: نظارت بر موجودی و وضعیت
 * - Query Parameters: پشتیبانی از پارامترهای جستجو
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 */
public class MenuController implements HttpHandler {
    
    /** سرویس مدیریت منو */
    private final MenuService menuService;
    
    /**
     * سازنده پیش‌فرض
     * MenuService را به صورت خودکار ایجاد می‌کند
     */
<span class="nc" id="L62">    public MenuController() {</span>
<span class="nc" id="L63">        this.menuService = new MenuService();</span>
<span class="nc" id="L64">    }</span>
    
    /**
     * سازنده برای dependency injection (تست)
     * 
     * @param menuService سرویس منو تزریق شده
     */
<span class="nc" id="L71">    public MenuController(MenuService menuService) {</span>
<span class="nc" id="L72">        this.menuService = menuService;</span>
<span class="nc" id="L73">    }</span>
    
    /**
     * هندلر اصلی HTTP requests
     * 
     * تمام درخواست‌ها را بر اساس HTTP method و path مسیریابی می‌کند
     * Exception handling جامع برای انواع مختلف خطاها
     * 
     * @param exchange شیء HTTP request/response
     */
    @Override
    public void handle(HttpExchange exchange) throws IOException {
<span class="nc" id="L85">        String method = exchange.getRequestMethod();</span>
<span class="nc" id="L86">        String path = exchange.getRequestURI().getPath();</span>
        
        try {
            // مسیریابی بر اساس HTTP method
<span class="nc bnc" id="L90" title="All 5 branches missed.">            switch (method) {</span>
                case &quot;GET&quot;:
<span class="nc" id="L92">                    handleGet(exchange, path);</span>
<span class="nc" id="L93">                    break;</span>
                case &quot;POST&quot;:
<span class="nc" id="L95">                    handlePost(exchange, path);</span>
<span class="nc" id="L96">                    break;</span>
                case &quot;PUT&quot;:
<span class="nc" id="L98">                    handlePut(exchange, path);</span>
<span class="nc" id="L99">                    break;</span>
                case &quot;DELETE&quot;:
<span class="nc" id="L101">                    handleDelete(exchange, path);</span>
<span class="nc" id="L102">                    break;</span>
                default:
<span class="nc" id="L104">                    sendErrorResponse(exchange, 405, &quot;Method not allowed&quot;);</span>
            }
<span class="nc" id="L106">        } catch (IllegalArgumentException e) {</span>
            // خطای پارامتر نامعتبر - 400 Bad Request
<span class="nc" id="L108">            sendErrorResponse(exchange, 400, e.getMessage());</span>
<span class="nc" id="L109">        } catch (NotFoundException e) {</span>
            // خطای یافت نشدن - 404 Not Found
<span class="nc" id="L111">            sendErrorResponse(exchange, 404, e.getMessage());</span>
<span class="nc" id="L112">        } catch (Exception e) {</span>
            // خطای سرور - 500 Internal Server Error
<span class="nc" id="L114">            sendErrorResponse(exchange, 500, &quot;Internal server error: &quot; + e.getMessage());</span>
<span class="nc" id="L115">        }</span>
<span class="nc" id="L116">    }</span>
    
    // ==================== GET ENDPOINTS ====================
    
    /**
     * مدیریت تمام GET requests
     * 
     * بر اساس pattern های مختلف URL، درخواست‌ها را مسیریابی می‌کند
     * از regex pattern matching برای تشخیص endpoint ها استفاده می‌کند
     * 
     * @param exchange HTTP exchange object
     * @param path مسیر درخواست
     */
    private void handleGet(HttpExchange exchange, String path) throws IOException {
<span class="nc bnc" id="L130" title="All 2 branches missed.">        if (path.matches(&quot;/api/menus/restaurant/\\d+&quot;)) {</span>
            // GET /api/menus/restaurant/{restaurantId} - دریافت منوی کامل
<span class="nc" id="L132">            Long restaurantId = extractRestaurantIdFromPath(path);</span>
<span class="nc" id="L133">            getRestaurantMenu(exchange, restaurantId);</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">        } else if (path.matches(&quot;/api/menus/restaurant/\\d+/available&quot;)) {</span>
            // GET /api/menus/restaurant/{restaurantId}/available - منوی در دسترس
<span class="nc" id="L136">            Long restaurantId = extractRestaurantIdFromPath(path, &quot;/available&quot;);</span>
<span class="nc" id="L137">            getAvailableMenu(exchange, restaurantId);</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">        } else if (path.matches(&quot;/api/menus/restaurant/\\d+/categories&quot;)) {</span>
            // GET /api/menus/restaurant/{restaurantId}/categories - دسته‌بندی‌ها
<span class="nc" id="L140">            Long restaurantId = extractRestaurantIdFromPath(path, &quot;/categories&quot;);</span>
<span class="nc" id="L141">            getMenuCategories(exchange, restaurantId);</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        } else if (path.matches(&quot;/api/menus/restaurant/\\d+/category/[^/]+&quot;)) {</span>
            // GET /api/menus/restaurant/{restaurantId}/category/{category} - فیلتر دسته
<span class="nc" id="L144">            Long restaurantId = extractRestaurantIdFromPath(path, &quot;/category/[^/]+&quot;);</span>
<span class="nc" id="L145">            String category = extractCategoryFromPath(path);</span>
<span class="nc" id="L146">            getMenuByCategory(exchange, restaurantId, category);</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        } else if (path.matches(&quot;/api/menus/restaurant/\\d+/low-stock&quot;)) {</span>
            // GET /api/menus/restaurant/{restaurantId}/low-stock - آیتم‌های کم موجودی
<span class="nc" id="L149">            Long restaurantId = extractRestaurantIdFromPath(path, &quot;/low-stock&quot;);</span>
<span class="nc" id="L150">            String thresholdParam = getQueryParameter(exchange, &quot;threshold&quot;);</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">            int threshold = thresholdParam != null ? Integer.parseInt(thresholdParam) : 10;</span>
<span class="nc" id="L152">            getLowStockItems(exchange, restaurantId, threshold);</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">        } else if (path.matches(&quot;/api/menus/restaurant/\\d+/statistics&quot;)) {</span>
            // GET /api/menus/restaurant/{restaurantId}/statistics - آمار منو
<span class="nc" id="L155">            Long restaurantId = extractRestaurantIdFromPath(path, &quot;/statistics&quot;);</span>
<span class="nc" id="L156">            getMenuStatistics(exchange, restaurantId);</span>
<span class="nc" id="L157">        } else {</span>
<span class="nc" id="L158">            sendErrorResponse(exchange, 404, &quot;Endpoint not found&quot;);</span>
        }
<span class="nc" id="L160">    }</span>
    
    /**
     * دریافت منوی کامل رستوران
     * 
     * شامل تمام آیتم‌ها، در دسترس و غیر قابل دسترس
     * 
     * @param exchange HTTP exchange
     * @param restaurantId شناسه رستوران
     */
    private void getRestaurantMenu(HttpExchange exchange, Long restaurantId) throws IOException {
<span class="nc" id="L171">        List&lt;FoodItem&gt; menu = menuService.getRestaurantMenu(restaurantId);</span>
<span class="nc" id="L172">        sendJsonResponse(exchange, 200, menu);</span>
<span class="nc" id="L173">    }</span>
    
    /**
     * دریافت آیتم‌های در دسترس منوی رستوران
     * 
     * فقط آیتم‌هایی که قابل سفارش هستند
     * 
     * @param exchange HTTP exchange
     * @param restaurantId شناسه رستوران
     */
    private void getAvailableMenu(HttpExchange exchange, Long restaurantId) throws IOException {
<span class="nc" id="L184">        List&lt;FoodItem&gt; menu = menuService.getAvailableMenu(restaurantId);</span>
<span class="nc" id="L185">        sendJsonResponse(exchange, 200, menu);</span>
<span class="nc" id="L186">    }</span>
    
    /**
     * دریافت دسته‌بندی‌های منوی رستوران
     * 
     * @param exchange HTTP exchange
     * @param restaurantId شناسه رستوران
     */
    private void getMenuCategories(HttpExchange exchange, Long restaurantId) throws IOException {
<span class="nc" id="L195">        List&lt;String&gt; categories = menuService.getMenuCategories(restaurantId);</span>
<span class="nc" id="L196">        sendJsonResponse(exchange, 200, categories);</span>
<span class="nc" id="L197">    }</span>
    
    /**
     * دریافت آیتم‌های منو بر اساس دسته‌بندی
     * 
     * @param exchange HTTP exchange
     * @param restaurantId شناسه رستوران
     * @param category نام دسته‌بندی
     */
    private void getMenuByCategory(HttpExchange exchange, Long restaurantId, String category) throws IOException {
<span class="nc" id="L207">        List&lt;FoodItem&gt; menu = menuService.getMenuByCategory(restaurantId, category);</span>
<span class="nc" id="L208">        sendJsonResponse(exchange, 200, menu);</span>
<span class="nc" id="L209">    }</span>
    
    /**
     * دریافت آیتم‌های کم موجودی رستوران
     * 
     * Query parameter threshold برای تنظیم آستانه کم موجودی
     * پیش‌فرض: 10 عدد
     * 
     * @param exchange HTTP exchange
     * @param restaurantId شناسه رستوران
     * @param threshold آستانه کم موجودی
     */
    private void getLowStockItems(HttpExchange exchange, Long restaurantId, int threshold) throws IOException {
<span class="nc" id="L222">        List&lt;FoodItem&gt; items = menuService.getLowStockItems(restaurantId, threshold);</span>
<span class="nc" id="L223">        sendJsonResponse(exchange, 200, items);</span>
<span class="nc" id="L224">    }</span>
    
    /**
     * دریافت آمار کامل منوی رستوران
     * 
     * شامل تعداد کل آیتم‌ها، در دسترس، تمام شده، کم موجودی و درصد در دسترس بودن
     * 
     * @param exchange HTTP exchange
     * @param restaurantId شناسه رستوران
     */
    private void getMenuStatistics(HttpExchange exchange, Long restaurantId) throws IOException {
<span class="nc" id="L235">        MenuService.MenuStatistics stats = menuService.getMenuStatistics(restaurantId);</span>
<span class="nc" id="L236">        sendJsonResponse(exchange, 200, stats);</span>
<span class="nc" id="L237">    }</span>
    
    // ==================== POST ENDPOINTS ====================
    
    /**
     * مدیریت تمام POST requests
     * 
     * @param exchange HTTP exchange
     * @param path مسیر درخواست
     */
    private void handlePost(HttpExchange exchange, String path) throws IOException {
<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (path.matches(&quot;/api/menus/restaurant/\\d+/items&quot;)) {</span>
            // POST /api/menus/restaurant/{restaurantId}/items - افزودن آیتم به منو
<span class="nc" id="L250">            Long restaurantId = extractRestaurantIdFromPath(path, &quot;/items&quot;);</span>
<span class="nc" id="L251">            addItemToMenu(exchange, restaurantId);</span>
<span class="nc" id="L252">        } else {</span>
<span class="nc" id="L253">            sendErrorResponse(exchange, 404, &quot;Endpoint not found&quot;);</span>
        }
<span class="nc" id="L255">    }</span>
    
    /**
     * افزودن آیتم جدید به منوی رستوران
     * 
     * JSON Request Body:
     * {
     *   &quot;name&quot;: string,
     *   &quot;description&quot;: string,
     *   &quot;price&quot;: number,
     *   &quot;category&quot;: string
     * }
     * 
     * @param exchange HTTP exchange
     * @param restaurantId شناسه رستوران
     */
    private void addItemToMenu(HttpExchange exchange, Long restaurantId) throws IOException {
<span class="nc" id="L272">        Map&lt;String, Object&gt; requestData = parseJsonRequest(exchange);</span>
        
<span class="nc" id="L274">        String name = getStringFromMap(requestData, &quot;name&quot;);</span>
<span class="nc" id="L275">        String description = getStringFromMap(requestData, &quot;description&quot;);</span>
<span class="nc" id="L276">        Double price = getDoubleFromMap(requestData, &quot;price&quot;);</span>
<span class="nc" id="L277">        String category = getStringFromMap(requestData, &quot;category&quot;);</span>
        
<span class="nc" id="L279">        FoodItem item = menuService.addItemToMenu(restaurantId, name, description, price, category);</span>
<span class="nc" id="L280">        sendJsonResponse(exchange, 201, item);</span>
<span class="nc" id="L281">    }</span>
    
    // ==================== PUT ENDPOINTS ====================
    
    /**
     * مدیریت تمام PUT requests
     * 
     * شامل عملیات‌های به‌روزرسانی آیتم‌ها و تنظیمات
     * 
     * @param exchange HTTP exchange
     * @param path مسیر درخواست
     */
    private void handlePut(HttpExchange exchange, String path) throws IOException {
<span class="nc bnc" id="L294" title="All 2 branches missed.">        if (path.matches(&quot;/api/menus/items/\\d+&quot;)) {</span>
            // PUT /api/menus/items/{itemId} - به‌روزرسانی آیتم منو
<span class="nc" id="L296">            Long itemId = extractItemIdFromPath(path);</span>
<span class="nc" id="L297">            updateMenuItem(exchange, itemId);</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">        } else if (path.matches(&quot;/api/menus/items/\\d+/availability&quot;)) {</span>
            // PUT /api/menus/items/{itemId}/availability - تنظیم وضعیت در دسترس بودن
<span class="nc" id="L300">            Long itemId = extractItemIdFromPath(path, &quot;/availability&quot;);</span>
<span class="nc" id="L301">            setItemAvailability(exchange, itemId);</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">        } else if (path.matches(&quot;/api/menus/items/\\d+/quantity&quot;)) {</span>
            // PUT /api/menus/items/{itemId}/quantity - به‌روزرسانی موجودی
<span class="nc" id="L304">            Long itemId = extractItemIdFromPath(path, &quot;/quantity&quot;);</span>
<span class="nc" id="L305">            updateItemQuantity(exchange, itemId);</span>
<span class="nc" id="L306">        } else {</span>
<span class="nc" id="L307">            sendErrorResponse(exchange, 404, &quot;Endpoint not found&quot;);</span>
        }
<span class="nc" id="L309">    }</span>
    
    /**
     * به‌روزرسانی آیتم منو
     * 
     * تنها فیلدهای ارائه شده در JSON به‌روزرسانی می‌شوند
     * 
     * JSON Request Body:
     * {
     *   &quot;name&quot;: string (اختیاری),
     *   &quot;description&quot;: string (اختیاری),
     *   &quot;price&quot;: number (اختیاری),
     *   &quot;category&quot;: string (اختیاری),
     *   &quot;quantity&quot;: number (اختیاری),
     *   &quot;available&quot;: boolean (اختیاری)
     * }
     * 
     * @param exchange HTTP exchange
     * @param itemId شناسه آیتم
     */
    private void updateMenuItem(HttpExchange exchange, Long itemId) throws IOException {
<span class="nc" id="L330">        Map&lt;String, Object&gt; requestData = parseJsonRequest(exchange);</span>
        
<span class="nc" id="L332">        String name = getStringFromMap(requestData, &quot;name&quot;);</span>
<span class="nc" id="L333">        String description = getStringFromMap(requestData, &quot;description&quot;);</span>
<span class="nc" id="L334">        Double price = getDoubleFromMap(requestData, &quot;price&quot;);</span>
<span class="nc" id="L335">        String category = getStringFromMap(requestData, &quot;category&quot;);</span>
<span class="nc" id="L336">        Integer quantity = getIntegerFromMap(requestData, &quot;quantity&quot;);</span>
<span class="nc" id="L337">        Boolean available = getBooleanFromMap(requestData, &quot;available&quot;);</span>
        
<span class="nc" id="L339">        FoodItem item = menuService.updateMenuItem(itemId, name, description, price, category, quantity, available);</span>
<span class="nc" id="L340">        sendJsonResponse(exchange, 200, item);</span>
<span class="nc" id="L341">    }</span>
    
    /**
     * تنظیم وضعیت در دسترس بودن آیتم
     * 
     * JSON Request Body:
     * {
     *   &quot;available&quot;: boolean
     * }
     * 
     * @param exchange HTTP exchange
     * @param itemId شناسه آیتم
     */
    private void setItemAvailability(HttpExchange exchange, Long itemId) throws IOException {
<span class="nc" id="L355">        Map&lt;String, Object&gt; requestData = parseJsonRequest(exchange);</span>
<span class="nc" id="L356">        Boolean available = getBooleanFromMap(requestData, &quot;available&quot;);</span>
        
<span class="nc bnc" id="L358" title="All 2 branches missed.">        if (available == null) {</span>
<span class="nc" id="L359">            sendErrorResponse(exchange, 400, &quot;Available field is required&quot;);</span>
<span class="nc" id="L360">            return;</span>
        }
        
<span class="nc" id="L363">        FoodItem item = menuService.setItemAvailability(itemId, available);</span>
<span class="nc" id="L364">        sendJsonResponse(exchange, 200, item);</span>
<span class="nc" id="L365">    }</span>
    
    /**
     * به‌روزرسانی موجودی آیتم
     * 
     * JSON Request Body:
     * {
     *   &quot;quantity&quot;: number
     * }
     * 
     * @param exchange HTTP exchange
     * @param itemId شناسه آیتم
     */
    private void updateItemQuantity(HttpExchange exchange, Long itemId) throws IOException {
<span class="nc" id="L379">        Map&lt;String, Object&gt; requestData = parseJsonRequest(exchange);</span>
<span class="nc" id="L380">        Integer quantity = getIntegerFromMap(requestData, &quot;quantity&quot;);</span>
        
<span class="nc bnc" id="L382" title="All 2 branches missed.">        if (quantity == null) {</span>
<span class="nc" id="L383">            sendErrorResponse(exchange, 400, &quot;Quantity field is required&quot;);</span>
<span class="nc" id="L384">            return;</span>
        }
        
<span class="nc" id="L387">        FoodItem item = menuService.updateItemQuantity(itemId, quantity);</span>
<span class="nc" id="L388">        sendJsonResponse(exchange, 200, item);</span>
<span class="nc" id="L389">    }</span>
    
    // ==================== DELETE ENDPOINTS ====================
    
    /**
     * مدیریت تمام DELETE requests
     * 
     * @param exchange HTTP exchange
     * @param path مسیر درخواست
     */
    private void handleDelete(HttpExchange exchange, String path) throws IOException {
<span class="nc bnc" id="L400" title="All 2 branches missed.">        if (path.matches(&quot;/api/menus/items/\\d+&quot;)) {</span>
            // DELETE /api/menus/items/{itemId} - حذف آیتم از منو
<span class="nc" id="L402">            Long itemId = extractItemIdFromPath(path);</span>
<span class="nc" id="L403">            removeItemFromMenu(exchange, itemId);</span>
<span class="nc" id="L404">        } else {</span>
<span class="nc" id="L405">            sendErrorResponse(exchange, 404, &quot;Endpoint not found&quot;);</span>
        }
<span class="nc" id="L407">    }</span>
    
    /**
     * حذف آیتم از منوی رستوران
     * 
     * @param exchange HTTP exchange
     * @param itemId شناسه آیتم
     */
    private void removeItemFromMenu(HttpExchange exchange, Long itemId) throws IOException {
<span class="nc" id="L416">        menuService.removeItemFromMenu(itemId);</span>
<span class="nc" id="L417">        sendJsonResponse(exchange, 200, Map.of(&quot;message&quot;, &quot;Item removed from menu successfully&quot;));</span>
<span class="nc" id="L418">    }</span>
    
    // ==================== UTILITY METHODS ====================
    
    /**
     * استخراج شناسه رستوران از مسیر ساده
     * 
     * Pattern: /api/menus/restaurant/{restaurantId}
     * 
     * @param path مسیر URL
     * @return شناسه رستوران
     */
    private Long extractRestaurantIdFromPath(String path) {
        // استخراج از /api/menus/restaurant/{restaurantId}
<span class="nc" id="L432">        String[] parts = path.split(&quot;/&quot;);</span>
<span class="nc" id="L433">        return Long.parseLong(parts[4]); // /api/menus/restaurant/{restaurantId}</span>
    }
    
    /**
     * استخراج شناسه رستوران از مسیر با suffix
     * 
     * Pattern: /api/menus/restaurant/{restaurantId}/suffix
     * 
     * @param path مسیر URL
     * @param suffix پسوند برای حذف
     * @return شناسه رستوران
     */
    private Long extractRestaurantIdFromPath(String path, String suffix) {
        // استخراج از /api/menus/restaurant/{restaurantId}/suffix
<span class="nc" id="L447">        String pathWithoutSuffix = path.substring(0, path.lastIndexOf(suffix));</span>
<span class="nc" id="L448">        String[] parts = pathWithoutSuffix.split(&quot;/&quot;);</span>
<span class="nc" id="L449">        return Long.parseLong(parts[4]);</span>
    }
    
    /**
     * استخراج شناسه آیتم از مسیر ساده
     * 
     * Pattern: /api/menus/items/{itemId}
     * 
     * @param path مسیر URL
     * @return شناسه آیتم
     */
    private Long extractItemIdFromPath(String path) {
        // استخراج از /api/menus/items/{itemId}
<span class="nc" id="L462">        String[] parts = path.split(&quot;/&quot;);</span>
<span class="nc" id="L463">        return Long.parseLong(parts[4]); // /api/menus/items/{itemId}</span>
    }
    
    /**
     * استخراج شناسه آیتم از مسیر با suffix
     * 
     * Pattern: /api/menus/items/{itemId}/suffix
     * 
     * @param path مسیر URL
     * @param suffix پسوند برای حذف
     * @return شناسه آیتم
     */
    private Long extractItemIdFromPath(String path, String suffix) {
        // استخراج از /api/menus/items/{itemId}/suffix
<span class="nc" id="L477">        String pathWithoutSuffix = path.substring(0, path.lastIndexOf(suffix));</span>
<span class="nc" id="L478">        String[] parts = pathWithoutSuffix.split(&quot;/&quot;);</span>
<span class="nc" id="L479">        return Long.parseLong(parts[4]);</span>
    }
    
    /**
     * استخراج نام دسته‌بندی از مسیر
     * 
     * Pattern: /api/menus/restaurant/{restaurantId}/category/{category}
     * 
     * @param path مسیر URL
     * @return نام دسته‌بندی
     */
    private String extractCategoryFromPath(String path) {
        // استخراج از /api/menus/restaurant/{restaurantId}/category/{category}
<span class="nc" id="L492">        String[] parts = path.split(&quot;/&quot;);</span>
<span class="nc" id="L493">        return parts[6]; // /api/menus/restaurant/{restaurantId}/category/{category}</span>
    }
    
    /**
     * دریافت پارامتر از query string
     * 
     * @param exchange HTTP exchange
     * @param paramName نام پارامتر
     * @return مقدار پارامتر یا null
     */
    private String getQueryParameter(HttpExchange exchange, String paramName) {
<span class="nc" id="L504">        String query = exchange.getRequestURI().getQuery();</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">        if (query == null) return null;</span>
        
<span class="nc" id="L507">        String[] params = query.split(&quot;&amp;&quot;);</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">        for (String param : params) {</span>
<span class="nc" id="L509">            String[] keyValue = param.split(&quot;=&quot;);</span>
<span class="nc bnc" id="L510" title="All 4 branches missed.">            if (keyValue.length == 2 &amp;&amp; keyValue[0].equals(paramName)) {</span>
<span class="nc" id="L511">                return keyValue[1];</span>
            }
        }
<span class="nc" id="L514">        return null;</span>
    }
    
    /**
     * پارس درخواست JSON
     * 
     * پیاده‌سازی ساده JSON parser برای کاهش dependencies
     * در محیط production از Jackson یا Gson استفاده کنید
     * 
     * @param exchange HTTP exchange
     * @return Map حاوی داده‌های JSON پارس شده
     */
    private Map&lt;String, Object&gt; parseJsonRequest(HttpExchange exchange) throws IOException {
        // پارس ساده JSON - در production از Jackson یا Gson استفاده کنید
<span class="nc" id="L528">        String requestBody = new String(exchange.getRequestBody().readAllBytes());</span>
<span class="nc" id="L529">        Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();</span>
        
        // پارس ابتدایی JSON (ساده‌سازی شده برای این پیاده‌سازی)
<span class="nc bnc" id="L532" title="All 2 branches missed.">        if (requestBody.trim().isEmpty()) {</span>
<span class="nc" id="L533">            return result;</span>
        }
        
        // حذف آکولاد و تقسیم بر اساس کاما
<span class="nc" id="L537">        String content = requestBody.trim().replaceAll(&quot;[{}]&quot;, &quot;&quot;);</span>
<span class="nc" id="L538">        String[] pairs = content.split(&quot;,&quot;);</span>
        
<span class="nc bnc" id="L540" title="All 2 branches missed.">        for (String pair : pairs) {</span>
<span class="nc" id="L541">            String[] keyValue = pair.split(&quot;:&quot;);</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">            if (keyValue.length == 2) {</span>
<span class="nc" id="L543">                String key = keyValue[0].trim().replaceAll(&quot;\&quot;&quot;, &quot;&quot;);</span>
<span class="nc" id="L544">                String value = keyValue[1].trim().replaceAll(&quot;\&quot;&quot;, &quot;&quot;);</span>
                
                // تلاش برای پارس به عنوان عدد یا boolean
                try {
<span class="nc bnc" id="L548" title="All 4 branches missed.">                    if (value.equals(&quot;true&quot;) || value.equals(&quot;false&quot;)) {</span>
<span class="nc" id="L549">                        result.put(key, Boolean.parseBoolean(value));</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">                    } else if (value.contains(&quot;.&quot;)) {</span>
<span class="nc" id="L551">                        result.put(key, Double.parseDouble(value));</span>
                    } else {
<span class="nc" id="L553">                        result.put(key, Long.parseLong(value));</span>
                    }
<span class="nc" id="L555">                } catch (NumberFormatException e) {</span>
<span class="nc" id="L556">                    result.put(key, value);</span>
<span class="nc" id="L557">                }</span>
            }
        }
        
<span class="nc" id="L561">        return result;</span>
    }
    
    /**
     * استخراج مقدار String از Map
     * 
     * @param map نقشه داده‌ها
     * @param key کلید
     * @return مقدار رشته یا null
     */
    private String getStringFromMap(Map&lt;String, Object&gt; map, String key) {
<span class="nc" id="L572">        Object value = map.get(key);</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">        return value != null ? value.toString() : null;</span>
    }
    
    /**
     * استخراج مقدار Double از Map
     * 
     * @param map نقشه داده‌ها
     * @param key کلید
     * @return مقدار Double یا null
     */
    private Double getDoubleFromMap(Map&lt;String, Object&gt; map, String key) {
<span class="nc" id="L584">        Object value = map.get(key);</span>
<span class="nc bnc" id="L585" title="All 2 branches missed.">        if (value == null) return null;</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">        if (value instanceof Double) return (Double) value;</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">        if (value instanceof Number) return ((Number) value).doubleValue();</span>
        try {
<span class="nc" id="L589">            return Double.parseDouble(value.toString());</span>
<span class="nc" id="L590">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L591">            throw new IllegalArgumentException(&quot;Invalid number format for &quot; + key + &quot;: &quot; + value);</span>
        }
    }
    
    /**
     * استخراج مقدار Integer از Map
     * 
     * @param map نقشه داده‌ها
     * @param key کلید
     * @return مقدار Integer یا null
     */
    private Integer getIntegerFromMap(Map&lt;String, Object&gt; map, String key) {
<span class="nc" id="L603">        Object value = map.get(key);</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">        if (value == null) return null;</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">        if (value instanceof Integer) return (Integer) value;</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">        if (value instanceof Number) return ((Number) value).intValue();</span>
        try {
<span class="nc" id="L608">            return Integer.parseInt(value.toString());</span>
<span class="nc" id="L609">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L610">            throw new IllegalArgumentException(&quot;Invalid number format for &quot; + key + &quot;: &quot; + value);</span>
        }
    }
    
    /**
     * استخراج مقدار Boolean از Map
     * 
     * @param map نقشه داده‌ها
     * @param key کلید
     * @return مقدار Boolean یا null
     */
    private Boolean getBooleanFromMap(Map&lt;String, Object&gt; map, String key) {
<span class="nc" id="L622">        Object value = map.get(key);</span>
<span class="nc bnc" id="L623" title="All 2 branches missed.">        if (value == null) return null;</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">        if (value instanceof Boolean) return (Boolean) value;</span>
<span class="nc" id="L625">        return Boolean.parseBoolean(value.toString());</span>
    }
    
    /**
     * ارسال پاسخ JSON
     * 
     * @param exchange HTTP exchange
     * @param statusCode کد وضعیت HTTP
     * @param data داده برای serialize
     */
    private void sendJsonResponse(HttpExchange exchange, int statusCode, Object data) throws IOException {
<span class="nc" id="L636">        String jsonResponse = convertToJson(data);</span>
        
<span class="nc" id="L638">        exchange.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<span class="nc" id="L639">        exchange.sendResponseHeaders(statusCode, jsonResponse.getBytes().length);</span>
        
<span class="nc" id="L641">        try (OutputStream os = exchange.getResponseBody()) {</span>
<span class="nc" id="L642">            os.write(jsonResponse.getBytes());</span>
        }
<span class="nc" id="L644">    }</span>
    
    /**
     * ارسال پاسخ خطا
     * 
     * @param exchange HTTP exchange
     * @param statusCode کد خطای HTTP
     * @param message پیام خطا
     */
    private void sendErrorResponse(HttpExchange exchange, int statusCode, String message) throws IOException {
<span class="nc" id="L654">        Map&lt;String, Object&gt; error = Map.of(</span>
<span class="nc" id="L655">            &quot;error&quot;, true,</span>
            &quot;message&quot;, message,
<span class="nc" id="L657">            &quot;status&quot;, statusCode</span>
        );
<span class="nc" id="L659">        sendJsonResponse(exchange, statusCode, error);</span>
<span class="nc" id="L660">    }</span>
    
    /**
     * تبدیل Object به JSON string
     * 
     * سریال‌سازی ساده برای انواع مختلف داده‌ها
     * در محیط production از Jackson یا Gson استفاده کنید
     * 
     * @param data داده برای تبدیل
     * @return رشته JSON
     */
    private String convertToJson(Object data) {
        // سریال‌سازی ساده JSON - در production از Jackson یا Gson استفاده کنید
<span class="nc bnc" id="L673" title="All 2 branches missed.">        if (data == null) {</span>
<span class="nc" id="L674">            return &quot;null&quot;;</span>
        }
        
<span class="nc bnc" id="L677" title="All 2 branches missed.">        if (data instanceof String) {</span>
<span class="nc" id="L678">            return &quot;\&quot;&quot; + data + &quot;\&quot;&quot;;</span>
        }
        
<span class="nc bnc" id="L681" title="All 4 branches missed.">        if (data instanceof Number || data instanceof Boolean) {</span>
<span class="nc" id="L682">            return data.toString();</span>
        }
        
<span class="nc bnc" id="L685" title="All 2 branches missed.">        if (data instanceof Map) {</span>
<span class="nc" id="L686">            Map&lt;?, ?&gt; map = (Map&lt;?, ?&gt;) data;</span>
<span class="nc" id="L687">            StringBuilder sb = new StringBuilder(&quot;{&quot;);</span>
<span class="nc" id="L688">            boolean first = true;</span>
<span class="nc bnc" id="L689" title="All 2 branches missed.">            for (Map.Entry&lt;?, ?&gt; entry : map.entrySet()) {</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">                if (!first) sb.append(&quot;,&quot;);</span>
<span class="nc" id="L691">                sb.append(&quot;\&quot;&quot;).append(entry.getKey()).append(&quot;\&quot;:&quot;);</span>
<span class="nc" id="L692">                sb.append(convertToJson(entry.getValue()));</span>
<span class="nc" id="L693">                first = false;</span>
<span class="nc" id="L694">            }</span>
<span class="nc" id="L695">            sb.append(&quot;}&quot;);</span>
<span class="nc" id="L696">            return sb.toString();</span>
        }
        
<span class="nc bnc" id="L699" title="All 2 branches missed.">        if (data instanceof List) {</span>
<span class="nc" id="L700">            List&lt;?&gt; list = (List&lt;?&gt;) data;</span>
<span class="nc" id="L701">            StringBuilder sb = new StringBuilder(&quot;[&quot;);</span>
<span class="nc" id="L702">            boolean first = true;</span>
<span class="nc bnc" id="L703" title="All 2 branches missed.">            for (Object item : list) {</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">                if (!first) sb.append(&quot;,&quot;);</span>
<span class="nc" id="L705">                sb.append(convertToJson(item));</span>
<span class="nc" id="L706">                first = false;</span>
<span class="nc" id="L707">            }</span>
<span class="nc" id="L708">            sb.append(&quot;]&quot;);</span>
<span class="nc" id="L709">            return sb.toString();</span>
        }
        
        // برای اشیاء پیچیده مثل FoodItem، از reflection استفاده کن
<span class="nc" id="L713">        return serializeObject(data);</span>
    }
    
    /**
     * سریال‌سازی اشیاء پیچیده
     * 
     * سریال‌سازی ساده برای FoodItem و دیگر entity ها
     * 
     * @param obj شیء برای سریال‌سازی
     * @return رشته JSON
     */
    private String serializeObject(Object obj) {
        // سریال‌سازی ساده اشیاء برای FoodItem و entity های دیگر
<span class="nc bnc" id="L726" title="All 2 branches missed.">        if (obj instanceof FoodItem) {</span>
<span class="nc" id="L727">            FoodItem item = (FoodItem) obj;</span>
<span class="nc" id="L728">            return String.format(</span>
                &quot;{\&quot;id\&quot;:%d,\&quot;name\&quot;:\&quot;%s\&quot;,\&quot;description\&quot;:\&quot;%s\&quot;,\&quot;price\&quot;:%.2f,\&quot;category\&quot;:\&quot;%s\&quot;,\&quot;quantity\&quot;:%d,\&quot;available\&quot;:%b,\&quot;restaurantId\&quot;:%d}&quot;,
<span class="nc" id="L730">                item.getId(), item.getName(), item.getDescription(), item.getPrice(), </span>
<span class="nc" id="L731">                item.getCategory(), item.getQuantity(), item.getAvailable(), </span>
<span class="nc" id="L732">                item.getRestaurant().getId()</span>
            );
        }
        
<span class="nc bnc" id="L736" title="All 2 branches missed.">        if (obj instanceof MenuService.MenuStatistics) {</span>
<span class="nc" id="L737">            MenuService.MenuStatistics stats = (MenuService.MenuStatistics) obj;</span>
<span class="nc" id="L738">            return String.format(</span>
                &quot;{\&quot;totalItems\&quot;:%d,\&quot;availableItems\&quot;:%d,\&quot;unavailableItems\&quot;:%d,\&quot;outOfStockItems\&quot;:%d,\&quot;lowStockItems\&quot;:%d,\&quot;inStockItems\&quot;:%d,\&quot;availabilityPercentage\&quot;:%.2f}&quot;,
<span class="nc" id="L740">                stats.getTotalItems(), stats.getAvailableItems(), stats.getUnavailableItems(),</span>
<span class="nc" id="L741">                stats.getOutOfStockItems(), stats.getLowStockItems(), stats.getInStockItems(),</span>
<span class="nc" id="L742">                stats.getAvailabilityPercentage()</span>
            );
        }
        
        // Fallback به toString
<span class="nc" id="L747">        return &quot;\&quot;&quot; + obj.toString() + &quot;\&quot;&quot;;</span>
    }
} 
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>