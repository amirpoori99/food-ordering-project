<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>VendorService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.vendor</a> &gt; <span class="el_source">VendorService.java</span></div><h1>VendorService.java</h1><pre class="source lang-java linenums">package com.myapp.vendor;

import com.myapp.common.exceptions.NotFoundException;
import com.myapp.common.models.FoodItem;
import com.myapp.common.models.Restaurant;
import com.myapp.common.models.RestaurantStatus;
import com.myapp.restaurant.RestaurantRepository;
import com.myapp.item.ItemRepository;

import java.util.List;
import java.util.Map;
import java.util.HashMap;
import java.util.stream.Collectors;

/**
 * Service لایه منطق کسب‌وکار برای عملیات فروشندگان از دیدگاه مشتری
 * 
 * این کلاس تمام منطق کسب‌وکار مربوط به فروشندگان (رستوران‌ها) از دیدگاه مشتری را پیاده‌سازی می‌کند:
 * 
 * === مرور و جستجوی فروشندگان ===
 * - getAllVendors(): دریافت تمام فروشندگان فعال
 * - searchVendors(): جستجوی فروشندگان بر اساس نام یا موقعیت
 * - getVendor(): دریافت جزئیات کامل یک فروشنده
 * - getVendorsByLocation(): فروشندگان بر اساس موقعیت
 * - getFeaturedVendors(): فروشندگان برجسته
 * - getVendorsByCategory(): فروشندگان بر اساس دسته غذا
 * 
 * === مدیریت منوی فروشندگان ===
 * - getVendorMenu(): دریافت منوی کامل فروشنده با دسته‌بندی
 * - getVendorStats(): آمار فروشنده (تعداد آیتم‌ها، دسته‌ها)
 * - isVendorAcceptingOrders(): بررسی پذیرش سفارش
 * 
 * === ویژگی‌های کلیدی ===
 * - Customer-Perspective Logic: منطق مختص دیدگاه مشتری
 * - Status Filtering: فیلتر وضعیت (فقط تایید شده‌ها)
 * - Menu Organization: سازماندهی منو بر اساس دسته‌ها
 * - Availability Checking: بررسی در دسترس بودن
 * - Statistics Generation: تولید آمار فروشندگان
 * - Error Handling: مدیریت خطاها
 * - Data Validation: اعتبارسنجی ورودی‌ها
 * - Business Rules: اجرای قوانین کسب‌وکار
 * 
 * === Inner Classes ===
 * - VendorStats: کلاس آمار فروشندگان
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 */
public class VendorService {
    
    /** Repository عملیات فروشندگان */
    private final VendorRepository vendorRepository;
    /** Repository رستوران‌ها */
    private final RestaurantRepository restaurantRepository;
    /** Repository آیتم‌های غذایی */
    private final ItemRepository itemRepository;
    
    /**
     * سازنده پیش‌فرض با ایجاد repositories
     */
<span class="fc" id="L62">    public VendorService() {</span>
<span class="fc" id="L63">        this.vendorRepository = new VendorRepository();</span>
<span class="fc" id="L64">        this.restaurantRepository = new RestaurantRepository();</span>
<span class="fc" id="L65">        this.itemRepository = new ItemRepository();</span>
<span class="fc" id="L66">    }</span>
    
    /**
     * سازنده با تزریق وابستگی‌ها (برای تست)
     * 
     * @param vendorRepository repository فروشندگان
     * @param restaurantRepository repository رستوران‌ها
     * @param itemRepository repository آیتم‌ها
     */
<span class="fc" id="L75">    public VendorService(VendorRepository vendorRepository, RestaurantRepository restaurantRepository, ItemRepository itemRepository) {</span>
<span class="fc" id="L76">        this.vendorRepository = vendorRepository;</span>
<span class="fc" id="L77">        this.restaurantRepository = restaurantRepository;</span>
<span class="fc" id="L78">        this.itemRepository = itemRepository;</span>
<span class="fc" id="L79">    }</span>
    
    /**
     * دریافت تمام فروشندگان فعال (رستوران‌های تایید شده)
     * 
     * فقط رستوران‌هایی که وضعیت APPROVED دارند را برمی‌گرداند
     * 
     * @return لیست فروشندگان فعال
     */
    public List&lt;Restaurant&gt; getAllVendors() {
<span class="fc" id="L89">        return restaurantRepository.findByStatus(RestaurantStatus.APPROVED);</span>
    }
    
    /**
     * جستجوی فروشندگان بر اساس نام یا موقعیت
     * 
     * اگر عبارت جستجو خالی باشد، تمام فروشندگان را برمی‌گرداند
     * 
     * @param searchTerm عبارت جستجو
     * @return لیست فروشندگان یافت شده
     */
    public List&lt;Restaurant&gt; searchVendors(String searchTerm) {
<span class="fc bfc" id="L101" title="All 4 branches covered.">        if (searchTerm == null || searchTerm.trim().isEmpty()) {</span>
<span class="fc" id="L102">            return getAllVendors();</span>
        }
        
<span class="fc" id="L105">        return vendorRepository.searchVendors(searchTerm.trim());</span>
    }
    
    /**
     * دریافت فروشنده با شناسه به همراه جزئیات کامل
     * 
     * فقط فروشندگان تایید شده در دسترس مشتریان هستند
     * 
     * @param vendorId شناسه فروشنده
     * @return اطلاعات کامل فروشنده
     * @throws IllegalArgumentException در صورت شناسه نامعتبر
     * @throws NotFoundException در صورت عدم وجود یا عدم تایید فروشنده
     */
    public Restaurant getVendor(Long vendorId) {
<span class="fc bfc" id="L119" title="All 4 branches covered.">        if (vendorId == null || vendorId &lt;= 0) {</span>
<span class="fc" id="L120">            throw new IllegalArgumentException(&quot;Vendor ID must be positive&quot;);</span>
        }
        
<span class="fc" id="L123">        Restaurant vendor = restaurantRepository.findById(vendorId)</span>
<span class="fc" id="L124">            .orElseThrow(() -&gt; new NotFoundException(&quot;Vendor&quot;, vendorId));</span>
        
        // فقط فروشندگان تایید شده را به مشتریان نشان می‌دهیم
<span class="fc bfc" id="L127" title="All 2 branches covered.">        if (vendor.getStatus() != RestaurantStatus.APPROVED) {</span>
<span class="fc" id="L128">            throw new NotFoundException(&quot;Vendor&quot;, vendorId);</span>
        }
        
<span class="fc" id="L131">        return vendor;</span>
    }
    
    /**
     * دریافت منوی فروشنده سازماندهی شده بر اساس دسته‌ها
     * 
     * منو را بر اساس دسته‌های غذایی گروه‌بندی می‌کند و
     * ساختار پاسخ را مطابق OpenAPI spec می‌سازد
     * 
     * @param vendorId شناسه فروشنده
     * @return Map حاوی اطلاعات فروشنده و منوی دسته‌بندی شده
     * @throws NotFoundException در صورت عدم وجود فروشنده
     */
    public Map&lt;String, Object&gt; getVendorMenu(Long vendorId) {
<span class="fc" id="L145">        Restaurant vendor = getVendor(vendorId);</span>
        
        // دریافت آیتم‌های منوی موجود
<span class="fc" id="L148">        List&lt;FoodItem&gt; menuItems = itemRepository.findAvailableByRestaurant(vendorId);</span>
        
        // گروه‌بندی آیتم‌ها بر اساس دسته
<span class="fc" id="L151">        Map&lt;String, List&lt;FoodItem&gt;&gt; itemsByCategory = menuItems.stream()</span>
<span class="fc" id="L152">            .collect(Collectors.groupingBy(FoodItem::getCategory));</span>
        
        // ساخت ساختار پاسخ مطابق OpenAPI spec
<span class="fc" id="L155">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="fc" id="L156">        response.put(&quot;vendor&quot;, vendor);</span>
<span class="fc" id="L157">        response.put(&quot;menu_titles&quot;, itemsByCategory.keySet().stream().collect(Collectors.toList()));</span>
        
        // اضافه کردن آیتم‌های هر دسته
<span class="fc bfc" id="L160" title="All 2 branches covered.">        for (Map.Entry&lt;String, List&lt;FoodItem&gt;&gt; entry : itemsByCategory.entrySet()) {</span>
<span class="fc" id="L161">            response.put(entry.getKey(), entry.getValue());</span>
<span class="fc" id="L162">        }</span>
        
<span class="fc" id="L164">        return response;</span>
    }
    
    /**
     * دریافت فروشندگان بر اساس موقعیت/منطقه
     * 
     * @param location نام منطقه یا موقعیت
     * @return لیست فروشندگان در آن منطقه
     * @throws IllegalArgumentException در صورت موقعیت خالی
     */
    public List&lt;Restaurant&gt; getVendorsByLocation(String location) {
<span class="fc bfc" id="L175" title="All 4 branches covered.">        if (location == null || location.trim().isEmpty()) {</span>
<span class="fc" id="L176">            throw new IllegalArgumentException(&quot;Location cannot be empty&quot;);</span>
        }
        
<span class="fc" id="L179">        return vendorRepository.findByLocation(location.trim());</span>
    }
    
    /**
     * دریافت فروشندگان برجسته/محبوب
     * 
     * @return لیست فروشندگان برجسته
     */
    public List&lt;Restaurant&gt; getFeaturedVendors() {
<span class="fc" id="L188">        return vendorRepository.getFeaturedVendors();</span>
    }
    
    /**
     * دریافت فروشندگان بر اساس دسته غذایی خاص
     * 
     * @param category نام دسته غذایی
     * @return لیست فروشندگان ارائه‌دهنده آن دسته
     * @throws IllegalArgumentException در صورت دسته خالی
     */
    public List&lt;Restaurant&gt; getVendorsByCategory(String category) {
<span class="fc bfc" id="L199" title="All 4 branches covered.">        if (category == null || category.trim().isEmpty()) {</span>
<span class="fc" id="L200">            throw new IllegalArgumentException(&quot;Category cannot be empty&quot;);</span>
        }
        
<span class="fc" id="L203">        return vendorRepository.findByFoodCategory(category.trim());</span>
    }
    
    /**
     * دریافت آمار فروشنده برای نمایش
     * 
     * شامل تعداد آیتم‌ها، دسته‌ها و سایر آمار مفید
     * 
     * @param vendorId شناسه فروشنده
     * @return آمار کامل فروشنده
     * @throws NotFoundException در صورت عدم وجود فروشنده
     */
    public VendorStats getVendorStats(Long vendorId) {
<span class="fc" id="L216">        Restaurant vendor = getVendor(vendorId);</span>
        
        // محاسبه آمار
<span class="fc" id="L219">        int totalItems = itemRepository.countByRestaurant(vendorId);</span>
<span class="fc" id="L220">        int availableItems = itemRepository.countAvailableByRestaurant(vendorId);</span>
<span class="fc" id="L221">        List&lt;String&gt; categories = itemRepository.getCategoriesByRestaurant(vendorId);</span>
        
<span class="fc" id="L223">        return new VendorStats(</span>
            vendorId,
<span class="fc" id="L225">            vendor.getName(),</span>
            totalItems,
            availableItems,
<span class="fc" id="L228">            categories.size(),</span>
            categories
        );
    }
    
    /**
     * بررسی اینکه آیا فروشنده در حال حاضر سفارش می‌پذیرد یا خیر
     * 
     * فروشنده در صورتی سفارش می‌پذیرد که:
     * - وجود داشته باشد
     * - وضعیت APPROVED داشته باشد  
     * - حداقل یک آیتم موجود داشته باشد
     * 
     * @param vendorId شناسه فروشنده
     * @return true اگر سفارش می‌پذیرد، false در غیر این صورت
     * @throws IllegalArgumentException در صورت شناسه نامعتبر
     */
    public boolean isVendorAcceptingOrders(Long vendorId) {
<span class="fc bfc" id="L246" title="All 4 branches covered.">        if (vendorId == null || vendorId &lt;= 0) {</span>
<span class="fc" id="L247">            throw new IllegalArgumentException(&quot;Vendor ID must be positive&quot;);</span>
        }

<span class="fc" id="L250">        Restaurant vendor = restaurantRepository.findById(vendorId).orElse(null);</span>
        
        // false برگردان اگر فروشنده وجود ندارد یا تایید نشده
<span class="fc bfc" id="L253" title="All 4 branches covered.">        if (vendor == null || vendor.getStatus() != RestaurantStatus.APPROVED) {</span>
<span class="fc" id="L254">            return false;</span>
        }
        
        // بررسی وجود حداقل یک آیتم موجود
<span class="fc bfc" id="L258" title="All 2 branches covered.">        return itemRepository.countAvailableByRestaurant(vendorId) &gt; 0;</span>
    }
    
    /**
     * کلاس داده آمار فروشندگان
     * 
     * این کلاس اطلاعات آماری مفید در مورد فروشنده را نگه می‌دارد
     * شامل تعداد آیتم‌ها، دسته‌ها و سایر معیارهای عملکرد
     */
    public static class VendorStats {
        /** شناسه فروشنده */
        private final Long vendorId;
        /** نام فروشنده */
        private final String vendorName;
        /** تعداد کل آیتم‌های منو */
        private final int totalItems;
        /** تعداد آیتم‌های موجود */
        private final int availableItems;
        /** تعداد کل دسته‌های غذایی */
        private final int totalCategories;
        /** لیست نام دسته‌های غذایی */
        private final List&lt;String&gt; categories;
        
        /**
         * سازنده کلاس VendorStats
         * 
         * @param vendorId شناسه فروشنده
         * @param vendorName نام فروشنده
         * @param totalItems تعداد کل آیتم‌ها
         * @param availableItems تعداد آیتم‌های موجود
         * @param totalCategories تعداد دسته‌ها
         * @param categories لیست دسته‌ها
         */
<span class="fc" id="L291">        public VendorStats(Long vendorId, String vendorName, int totalItems, int availableItems, int totalCategories, List&lt;String&gt; categories) {</span>
<span class="fc" id="L292">            this.vendorId = vendorId;</span>
<span class="fc" id="L293">            this.vendorName = vendorName;</span>
<span class="fc" id="L294">            this.totalItems = totalItems;</span>
<span class="fc" id="L295">            this.availableItems = availableItems;</span>
<span class="fc" id="L296">            this.totalCategories = totalCategories;</span>
<span class="fc" id="L297">            this.categories = categories;</span>
<span class="fc" id="L298">        }</span>
        
        // Getters با کامنت فارسی
        /** @return شناسه فروشنده */
<span class="fc" id="L302">        public Long getVendorId() { return vendorId; }</span>
        /** @return نام فروشنده */
<span class="fc" id="L304">        public String getVendorName() { return vendorName; }</span>
        /** @return تعداد کل آیتم‌ها */
<span class="fc" id="L306">        public int getTotalItems() { return totalItems; }</span>
        /** @return تعداد آیتم‌های موجود */
<span class="fc" id="L308">        public int getAvailableItems() { return availableItems; }</span>
        /** @return تعداد دسته‌های غذایی */
<span class="fc" id="L310">        public int getTotalCategories() { return totalCategories; }</span>
        /** @return لیست دسته‌های غذایی */
<span class="fc" id="L312">        public List&lt;String&gt; getCategories() { return categories; }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>