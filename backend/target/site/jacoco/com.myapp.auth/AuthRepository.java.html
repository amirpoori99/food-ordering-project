<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuthRepository.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.auth</a> &gt; <span class="el_source">AuthRepository.java</span></div><h1>AuthRepository.java</h1><pre class="source lang-java linenums">package com.myapp.auth;

import com.myapp.common.exceptions.DuplicatePhoneException;
import com.myapp.common.models.User;
import com.myapp.common.utils.DatabaseUtil;
import org.hibernate.Session;
import org.hibernate.Transaction;
import org.hibernate.query.Query;

import java.util.List;
import java.util.Optional;

/**
 * مخزن داده‌های احراز هویت - لایه دسترسی به داده برای عملیات کاربران
 * این کلاس تمام عملیات CRUD مربوط به کاربران را مدیریت می‌کند
 * از الگوی Repository Pattern استفاده می‌کند
 */
<span class="fc" id="L18">public class AuthRepository {</span>

    /**
     * ذخیره کاربر جدید در دیتابیس
     * بررسی تکراری نبودن شماره تلفن قبل از ذخیره
     * 
     * @param user کاربر جدید برای ذخیره
     * @return کاربر ذخیره شده همراه با ID تولید شده
     * @throws DuplicatePhoneException در صورت تکراری بودن شماره تلفن
     */
    public User saveNew(User user) {
<span class="fc" id="L29">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
            // بررسی تکراری بودن شماره تلفن
<span class="fc" id="L31">            Query&lt;User&gt; q = session.createQuery(&quot;from User where phone = :p&quot;, User.class);</span>
<span class="fc" id="L32">            q.setParameter(&quot;p&quot;, user.getPhone());</span>
<span class="fc bfc" id="L33" title="All 2 branches covered.">            if (!q.getResultList().isEmpty()) {</span>
<span class="fc" id="L34">                throw new DuplicatePhoneException(user.getPhone());</span>
            }
            
            // ذخیره کاربر جدید
<span class="fc" id="L38">            Transaction tx = session.beginTransaction();</span>
<span class="fc" id="L39">            session.persist(user);           // ذخیره در دیتابیس</span>
<span class="fc" id="L40">            tx.commit();                     // تأیید تراکنش</span>
<span class="fc" id="L41">            return user;                     // بازگشت کاربر با ID تولید شده</span>
        }
    }

    /**
     * یافتن کاربر بر اساس شناسه
     * 
     * @param id شناسه کاربر
     * @return Optional حاوی کاربر یا empty در صورت عدم وجود
     */
    public Optional&lt;User&gt; findById(long id) {
<span class="fc" id="L52">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L53">            return Optional.ofNullable(session.get(User.class, id));</span>
        }
    }

    /**
     * یافتن کاربر بر اساس شماره تلفن
     * این متد برای فرآیند ورود استفاده می‌شود
     * 
     * @param phone شماره تلفن کاربر
     * @return Optional حاوی کاربر یا empty در صورت عدم وجود
     */
    public Optional&lt;User&gt; findByPhone(String phone) {
<span class="fc" id="L65">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L66">            Query&lt;User&gt; q = session.createQuery(&quot;from User where phone = :p&quot;, User.class);</span>
<span class="fc" id="L67">            q.setParameter(&quot;p&quot;, phone);</span>
<span class="fc" id="L68">            return q.uniqueResultOptional();  // برگرداندن یک نتیجه یکتا یا empty</span>
        }
    }

    /**
     * به‌روزرسانی اطلاعات کاربر
     * مدیریت تعارض‌های ممکن در شماره تلفن
     * 
     * @param updated کاربر با اطلاعات به‌روز شده
     * @return کاربر به‌روز شده
     * @throws DuplicatePhoneException در صورت تعارض شماره تلفن
     */
    public User update(User updated) {
<span class="fc" id="L81">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L82">            Transaction tx = session.beginTransaction();</span>
<span class="fc" id="L83">            session.merge(updated);          // به‌روزرسانی در دیتابیس</span>
<span class="fc" id="L84">            tx.commit();                     // تأیید تراکنش</span>
<span class="fc" id="L85">            return updated;</span>
<span class="nc" id="L86">        } catch (org.hibernate.exception.ConstraintViolationException e) {</span>
            // تبدیل خطای constraint violation به استثنای سفارشی
<span class="nc bnc" id="L88" title="All 4 branches missed.">            if (e.getConstraintName() != null &amp;&amp; e.getConstraintName().toLowerCase().contains(&quot;phone&quot;)) {</span>
<span class="nc" id="L89">                throw new DuplicatePhoneException(updated.getPhone());</span>
            }
<span class="nc" id="L91">            throw e;  // در غیر اینصورت، خطای اصلی را پرتاب کن</span>
<span class="fc" id="L92">        } catch (org.hibernate.exception.GenericJDBCException e) {</span>
            // مدیریت خطاهای unique constraint در SQLite
<span class="pc bpc" id="L94" title="2 of 4 branches missed.">            if (e.getMessage() != null &amp;&amp; e.getMessage().toLowerCase().contains(&quot;unique constraint failed: users.phone&quot;)) {</span>
<span class="fc" id="L95">                throw new DuplicatePhoneException(updated.getPhone());</span>
            }
<span class="nc" id="L97">            throw e;  // در غیر اینصورت، خطای اصلی را پرتاب کن</span>
        }
    }

    /**
     * حذف کاربر بر اساس شناسه
     * 
     * @param id شناسه کاربر برای حذف
     */
    public void delete(long id) {
<span class="fc" id="L107">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L108">            Transaction tx = session.beginTransaction();</span>
<span class="fc" id="L109">            User u = session.get(User.class, id);  // یافتن کاربر</span>
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">            if (u != null) session.remove(u);      // حذف در صورت وجود</span>
<span class="fc" id="L111">            tx.commit();                            // تأیید تراکنش</span>
        }
<span class="fc" id="L113">    }</span>

    /**
     * بررسی وجود کاربر بر اساس شناسه
     * این متد برای validation استفاده می‌شود
     * 
     * @param id شناسه کاربر
     * @return true اگر کاربر وجود داشته باشد، در غیر اینصورت false
     */
    public boolean existsById(Long id) {
<span class="pc bpc" id="L123" title="2 of 4 branches missed.">        if (id == null || id &lt;= 0) {</span>
<span class="nc" id="L124">            return false;  // شناسه نامعتبر</span>
        }
<span class="fc" id="L126">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L127">            Query&lt;Long&gt; query = session.createQuery(&quot;SELECT COUNT(u) FROM User u WHERE u.id = :id&quot;, Long.class);</span>
<span class="fc" id="L128">            query.setParameter(&quot;id&quot;, id);</span>
<span class="fc" id="L129">            Long count = query.uniqueResult();</span>
<span class="pc bpc" id="L130" title="1 of 4 branches missed.">            return count != null &amp;&amp; count &gt; 0;  // بررسی وجود کاربر</span>
        }
    }

    /**
     * یافتن شناسه تمام کاربران فعال
     * این متد برای عملیات bulk استفاده می‌شود
     * 
     * @return لیست شناسه‌های تمام کاربران فعال
     */
    public List&lt;Long&gt; findAllActiveUserIds() {
<span class="nc" id="L141">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="nc" id="L142">            Query&lt;Long&gt; query = session.createQuery(&quot;SELECT u.id FROM User u&quot;, Long.class);</span>
<span class="nc" id="L143">            return query.getResultList();</span>
        }
    }

    /**
     * حذف تمام کاربران - متد کمکی برای تست‌ها
     * ⚠️ هشدار: این متد فقط برای محیط تست استفاده شود
     */
    public void deleteAll() {
<span class="fc" id="L152">        try (Session session = DatabaseUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L153">            Transaction tx = session.beginTransaction();</span>
<span class="fc" id="L154">            session.createQuery(&quot;delete from User&quot;).executeUpdate();  // حذف تمام کاربران</span>
<span class="fc" id="L155">            tx.commit();                                               // تأیید تراکنش</span>
        }
<span class="fc" id="L157">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>