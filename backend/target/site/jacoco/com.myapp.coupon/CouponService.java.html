<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CouponService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.coupon</a> &gt; <span class="el_source">CouponService.java</span></div><h1>CouponService.java</h1><pre class="source lang-java linenums">package com.myapp.coupon;

import com.myapp.auth.AuthRepository;
import com.myapp.common.exceptions.NotFoundException;
import com.myapp.common.models.Coupon;
import com.myapp.common.models.CouponUsage;
import com.myapp.common.models.Restaurant;
import com.myapp.common.models.User;
import com.myapp.restaurant.RestaurantRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;

/**
 * Service لایه منطق کسب‌وکار برای مدیریت کوپن‌های تخفیف
 * 
 * این کلاس تمام عملیات مربوط به منطق کسب‌وکار کوپن‌ها را پیاده‌سازی می‌کند:
 * 
 * === ایجاد کوپن ===
 * - createPercentageCoupon(): ایجاد کوپن درصدی
 * - createFixedAmountCoupon(): ایجاد کوپن مبلغ ثابت
 * - createCouponWithSettings(): ایجاد کوپن با تنظیمات پیشرفته
 * 
 * === اعتبارسنجی و اعمال کوپن ===
 * - applyCoupon(): اعمال کوپن به سفارش
 * - validateCouponForOrder(): اعتبارسنجی بدون اعمال
 * - useCoupon(): استفاده از کوپن (افزایش شمارنده)
 * - useCouponWithTracking(): استفاده با ردیابی کامل
 * - revertCouponUsage(): برگشت استفاده (برای لغو سفارش)
 * 
 * === مدیریت کوپن ===
 * - getCoupon(): دریافت کوپن با ID
 * - getCouponByCode(): دریافت کوپن با کد
 * - getValidCoupons(): کوپن‌های معتبر
 * - getApplicableCoupons(): کوپن‌های قابل اعمال
 * - getRestaurantCoupons(): کوپن‌های رستوران
 * - getGlobalCoupons(): کوپن‌های سراسری
 * - getCouponsByCreator(): کوپن‌های ایجاد شده توسط کاربر
 * - getCouponsExpiringSoon(): کوپن‌های نزدیک به انقضا
 * 
 * === مدیریت وضعیت ===
 * - updateCoupon(): به‌روزرسانی اطلاعات
 * - activateCoupon(): فعال‌سازی کوپن
 * - deactivateCoupon(): غیرفعال‌سازی کوپن
 * - deleteCoupon(): حذف کوپن
 * - getCouponStatistics(): آمار کوپن‌ها
 * 
 * === ویژگی‌های پیشرفته ===
 * - Complex Validation Logic: منطق اعتبارسنجی پیچیده
 * - Permission Management: مدیریت مجوزهای دسترسی
 * - Usage Tracking: ردیابی دقیق استفاده
 * - Business Rule Enforcement: اجرای قوانین کسب‌وکار
 * - Error Handling: مدیریت خطاها و validation
 * - Dependency Injection: پشتیبانی از تزریق وابستگی‌ها
 * 
 * === Inner Classes ===
 * - CouponApplicationResult: نتیجه اعمال کوپن
 * - CouponValidationResult: نتیجه اعتبارسنجی
 * - CouponStatistics: آمار کوپن‌ها
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 */
public class CouponService {
    
    /** Logger برای ثبت عملیات و خطاها */
<span class="fc" id="L71">    private static final Logger logger = LoggerFactory.getLogger(CouponService.class);</span>
    
    /** Repository لایه دسترسی داده کوپن‌ها */
    private final CouponRepository couponRepository;
    /** Repository لایه دسترسی داده کاربران برای اعتبارسنجی مجوزها */
    private final AuthRepository authRepository;
    /** Repository لایه دسترسی داده رستوران‌ها */
    private final RestaurantRepository restaurantRepository;
    /** Repository لایه دسترسی داده استفاده از کوپن‌ها */
    private final CouponUsageRepository couponUsageRepository;
    
    /**
     * سازنده پیش‌فرض - Repository های مورد نیاز را ایجاد می‌کند
     */
<span class="nc" id="L85">    public CouponService() {</span>
<span class="nc" id="L86">        this.couponRepository = new CouponRepository();</span>
<span class="nc" id="L87">        this.authRepository = new AuthRepository();</span>
<span class="nc" id="L88">        this.restaurantRepository = new RestaurantRepository();</span>
<span class="nc" id="L89">        this.couponUsageRepository = new CouponUsageRepository();</span>
<span class="nc" id="L90">    }</span>
    
    /**
     * سازنده برای تزریق وابستگی‌ها (برای تست‌ها)
     * 
     * @param couponRepository repository کوپن‌ها
     * @param authRepository repository احراز هویت
     * @param restaurantRepository repository رستوران‌ها
     * @param couponUsageRepository repository استفاده از کوپن‌ها
     */
    public CouponService(CouponRepository couponRepository, AuthRepository authRepository, 
<span class="fc" id="L101">                        RestaurantRepository restaurantRepository, CouponUsageRepository couponUsageRepository) {</span>
<span class="fc" id="L102">        this.couponRepository = couponRepository;</span>
<span class="fc" id="L103">        this.authRepository = authRepository;</span>
<span class="fc" id="L104">        this.restaurantRepository = restaurantRepository;</span>
<span class="fc" id="L105">        this.couponUsageRepository = couponUsageRepository;</span>
<span class="fc" id="L106">    }</span>
    
    // ==================== COUPON CREATION ====================
    
    /**
     * ایجاد کوپن درصدی جدید
     * 
     * این متد کوپنی ایجاد می‌کند که درصد مشخصی از مبلغ سفارش را تخفیف می‌دهد
     * 
     * @param code کد یکتای کوپن (حداکثر 50 کاراکتر)
     * @param description توضیحات کوپن (حداکثر 255 کاراکتر)
     * @param percentage درصد تخفیف (0 تا 100)
     * @param validFrom تاریخ شروع اعتبار
     * @param validUntil تاریخ پایان اعتبار
     * @param createdBy شناسه کاربر ایجادکننده
     * @param restaurantId شناسه رستوران (null برای کوپن سراسری)
     * @return کوپن ایجاد شده
     * @throws IllegalArgumentException در صورت ورودی‌های نامعتبر
     * @throws NotFoundException در صورت عدم وجود رستوران یا کاربر
     */
    public Coupon createPercentageCoupon(String code, String description, Double percentage,
                                        LocalDateTime validFrom, LocalDateTime validUntil,
                                        Long createdBy, Long restaurantId) {
<span class="fc" id="L129">        logger.info(&quot;Creating percentage coupon: code={}, percentage={}&quot;, code, percentage);</span>
        
        // اعتبارسنجی ورودی‌ها
<span class="fc" id="L132">        validateCouponCreationInputs(code, description, validFrom, validUntil, createdBy);</span>
<span class="fc" id="L133">        validatePercentage(percentage);</span>
        
        // بررسی یکتا بودن کد
<span class="fc bfc" id="L136" title="All 2 branches covered.">        if (couponRepository.existsByCode(code)) {</span>
<span class="fc" id="L137">            throw new IllegalArgumentException(&quot;Coupon code already exists: &quot; + code);</span>
        }
        
        // اعتبارسنجی مجوزهای ایجادکننده
<span class="fc" id="L141">        validateCreatorPermissions(createdBy, restaurantId);</span>
        
        // ایجاد کوپن درصدی
<span class="fc" id="L144">        Coupon coupon = Coupon.createPercentageCoupon(code, description, percentage, validFrom, validUntil);</span>
<span class="fc" id="L145">        coupon.setCreatedBy(createdBy);</span>
        
        // تنظیم رستوران در صورت مشخص بودن
<span class="fc bfc" id="L148" title="All 2 branches covered.">        if (restaurantId != null) {</span>
<span class="fc" id="L149">            Restaurant restaurant = restaurantRepository.findById(restaurantId)</span>
<span class="pc" id="L150">                .orElseThrow(() -&gt; new NotFoundException(&quot;Restaurant&quot;, restaurantId));</span>
<span class="fc" id="L151">            coupon.setRestaurant(restaurant);</span>
        }
        
<span class="fc" id="L154">        Coupon savedCoupon = couponRepository.save(coupon);</span>
<span class="fc" id="L155">        logger.info(&quot;Created percentage coupon with ID: {}&quot;, savedCoupon.getId());</span>
<span class="fc" id="L156">        return savedCoupon;</span>
    }
    
    /**
     * ایجاد کوپن مبلغ ثابت جدید
     * 
     * این متد کوپنی ایجاد می‌کند که مبلغ ثابتی از سفارش کم می‌کند
     * 
     * @param code کد یکتای کوپن
     * @param description توضیحات کوپن
     * @param amount مبلغ تخفیف ثابت (مثبت و حداکثر 10,000)
     * @param validFrom تاریخ شروع اعتبار
     * @param validUntil تاریخ پایان اعتبار
     * @param createdBy شناسه کاربر ایجادکننده
     * @param restaurantId شناسه رستوران (null برای کوپن سراسری)
     * @return کوپن ایجاد شده
     * @throws IllegalArgumentException در صورت ورودی‌های نامعتبر
     * @throws NotFoundException در صورت عدم وجود رستوران یا کاربر
     */
    public Coupon createFixedAmountCoupon(String code, String description, Double amount,
                                         LocalDateTime validFrom, LocalDateTime validUntil,
                                         Long createdBy, Long restaurantId) {
<span class="fc" id="L178">        logger.info(&quot;Creating fixed amount coupon: code={}, amount={}&quot;, code, amount);</span>
        
        // اعتبارسنجی ورودی‌ها
<span class="fc" id="L181">        validateCouponCreationInputs(code, description, validFrom, validUntil, createdBy);</span>
<span class="fc" id="L182">        validateFixedAmount(amount);</span>
        
        // بررسی یکتا بودن کد
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">        if (couponRepository.existsByCode(code)) {</span>
<span class="nc" id="L186">            throw new IllegalArgumentException(&quot;Coupon code already exists: &quot; + code);</span>
        }
        
        // اعتبارسنجی مجوزهای ایجادکننده
<span class="fc" id="L190">        validateCreatorPermissions(createdBy, restaurantId);</span>
        
        // ایجاد کوپن مبلغ ثابت
<span class="fc" id="L193">        Coupon coupon = Coupon.createFixedAmountCoupon(code, description, amount, validFrom, validUntil);</span>
<span class="fc" id="L194">        coupon.setCreatedBy(createdBy);</span>
        
        // تنظیم رستوران در صورت مشخص بودن
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">        if (restaurantId != null) {</span>
<span class="nc" id="L198">            Restaurant restaurant = restaurantRepository.findById(restaurantId)</span>
<span class="nc" id="L199">                .orElseThrow(() -&gt; new NotFoundException(&quot;Restaurant&quot;, restaurantId));</span>
<span class="nc" id="L200">            coupon.setRestaurant(restaurant);</span>
        }
        
<span class="fc" id="L203">        Coupon savedCoupon = couponRepository.save(coupon);</span>
<span class="fc" id="L204">        logger.info(&quot;Created fixed amount coupon with ID: {}&quot;, savedCoupon.getId());</span>
<span class="fc" id="L205">        return savedCoupon;</span>
    }
    
    /**
     * ایجاد کوپن با تنظیمات پیشرفته
     * 
     * این متد کوپنی با قابلیت‌های پیشرفته مانند:
     * - حداقل مبلغ سفارش
     * - حداکثر مبلغ تخفیف
     * - محدودیت کل استفاده
     * - محدودیت استفاده به ازای کاربر
     * 
     * @param code کد کوپن
     * @param description توضیحات
     * @param type نوع کوپن (درصدی یا مبلغ ثابت)
     * @param value مقدار تخفیف
     * @param validFrom تاریخ شروع
     * @param validUntil تاریخ پایان
     * @param minOrderAmount حداقل مبلغ سفارش (اختیاری)
     * @param maxDiscountAmount حداکثر مبلغ تخفیف (اختیاری)
     * @param usageLimit محدودیت کل استفاده (اختیاری)
     * @param perUserLimit محدودیت استفاده هر کاربر (اختیاری)
     * @param createdBy ایجادکننده
     * @param restaurantId رستوران (اختیاری)
     * @return کوپن ایجاد شده با تنظیمات
     */
    public Coupon createCouponWithSettings(String code, String description, Coupon.CouponType type, Double value,
                                          LocalDateTime validFrom, LocalDateTime validUntil,
                                          Double minOrderAmount, Double maxDiscountAmount,
                                          Integer usageLimit, Integer perUserLimit,
                                          Long createdBy, Long restaurantId) {
<span class="fc" id="L236">        logger.info(&quot;Creating coupon with settings: code={}, type={}&quot;, code, type);</span>
        
        // ایجاد کوپن پایه بر اساس نوع
        Coupon coupon;
<span class="fc bfc" id="L240" title="All 2 branches covered.">        if (type == Coupon.CouponType.PERCENTAGE) {</span>
<span class="fc" id="L241">            coupon = createPercentageCoupon(code, description, value, validFrom, validUntil, createdBy, restaurantId);</span>
        } else {
<span class="fc" id="L243">            coupon = createFixedAmountCoupon(code, description, value, validFrom, validUntil, createdBy, restaurantId);</span>
        }
        
        // اعمال تنظیمات پیشرفته
<span class="fc" id="L247">        coupon.updateInfo(description, minOrderAmount, maxDiscountAmount, usageLimit, perUserLimit, validUntil);</span>
        
<span class="fc" id="L249">        return couponRepository.update(coupon);</span>
    }
    
    // ==================== COUPON VALIDATION AND APPLICATION ====================
    
    /**
     * اعتبارسنجی و اعمال کوپن به سفارش
     * 
     * این متد کامل‌ترین فرآیند استفاده از کوپن است که شامل:
     * - پیدا کردن کوپن با کد
     * - اعتبارسنجی کامل کوپن
     * - محاسبه مبلغ تخفیف
     * - بازگشت نتیجه اعمال
     * 
     * @param couponCode کد کوپن
     * @param orderAmount مبلغ سفارش
     * @param restaurantId شناسه رستوران
     * @param userId شناسه کاربر
     * @return نتیجه اعمال کوپن (موفق یا ناموفق با دلیل)
     * @throws IllegalArgumentException در صورت ورودی‌های نامعتبر
     */
    public CouponApplicationResult applyCoupon(String couponCode, Double orderAmount, Long restaurantId, Long userId) {
<span class="fc" id="L271">        logger.info(&quot;Applying coupon: code={}, orderAmount={}, restaurantId={}, userId={}&quot;, </span>
                   couponCode, orderAmount, restaurantId, userId);
        
        // اعتبارسنجی ورودی‌ها
<span class="fc bfc" id="L275" title="All 4 branches covered.">        if (couponCode == null || couponCode.trim().isEmpty()) {</span>
<span class="fc" id="L276">            throw new IllegalArgumentException(&quot;Coupon code cannot be empty&quot;);</span>
        }
<span class="fc bfc" id="L278" title="All 4 branches covered.">        if (orderAmount == null || orderAmount &lt;= 0) {</span>
<span class="fc" id="L279">            throw new IllegalArgumentException(&quot;Order amount must be positive&quot;);</span>
        }
<span class="fc bfc" id="L281" title="All 2 branches covered.">        if (userId == null) {</span>
<span class="fc" id="L282">            throw new IllegalArgumentException(&quot;User ID cannot be null&quot;);</span>
        }
        
        // جستجوی کوپن با کد (تبدیل به حروف بزرگ)
<span class="fc" id="L286">        Optional&lt;Coupon&gt; couponOpt = couponRepository.findByCode(couponCode.trim().toUpperCase());</span>
<span class="fc bfc" id="L287" title="All 2 branches covered.">        if (couponOpt.isEmpty()) {</span>
<span class="fc" id="L288">            return CouponApplicationResult.failed(&quot;Coupon code not found&quot;);</span>
        }
        
<span class="fc" id="L291">        Coupon coupon = couponOpt.get();</span>
        
        // اعتبارسنجی کوپن برای سفارش
<span class="fc" id="L294">        CouponValidationResult validation = validateCouponForOrder(coupon, orderAmount, restaurantId, userId);</span>
<span class="fc bfc" id="L295" title="All 2 branches covered.">        if (!validation.isValid()) {</span>
<span class="fc" id="L296">            return CouponApplicationResult.failed(validation.getErrorMessage());</span>
        }
        
        // محاسبه مبلغ تخفیف
<span class="fc" id="L300">        Double discountAmount = coupon.calculateDiscount(orderAmount);</span>
        
<span class="fc" id="L302">        return CouponApplicationResult.success(coupon, discountAmount);</span>
    }
    
    /**
     * اعتبارسنجی کوپن برای سفارش خاص بدون اعمال آن
     * 
     * این متد برای بررسی صحت کوپن قبل از اعمال استفاده می‌شود
     * 
     * @param coupon شیء کوپن
     * @param orderAmount مبلغ سفارش
     * @param restaurantId شناسه رستوران
     * @param userId شناسه کاربر
     * @return نتیجه اعتبارسنجی
     */
    public CouponValidationResult validateCouponForOrder(Coupon coupon, Double orderAmount, Long restaurantId, Long userId) {
        // اعتبارسنجی پایه کوپن
<span class="fc bfc" id="L318" title="All 2 branches covered.">        if (!coupon.isValid()) {</span>
<span class="fc bfc" id="L319" title="All 2 branches covered.">            if (!coupon.getIsActive()) {</span>
<span class="fc" id="L320">                return CouponValidationResult.invalid(&quot;Coupon is not active&quot;);</span>
            }
<span class="fc" id="L322">            LocalDateTime now = LocalDateTime.now();</span>
<span class="fc bfc" id="L323" title="All 2 branches covered.">            if (now.isBefore(coupon.getValidFrom())) {</span>
<span class="fc" id="L324">                return CouponValidationResult.invalid(&quot;Coupon is not yet valid&quot;);</span>
            }
<span class="fc bfc" id="L326" title="All 2 branches covered.">            if (now.isAfter(coupon.getValidUntil())) {</span>
<span class="fc" id="L327">                return CouponValidationResult.invalid(&quot;Coupon has expired&quot;);</span>
            }
<span class="pc bpc" id="L329" title="2 of 4 branches missed.">            if (coupon.getUsageLimit() != null &amp;&amp; coupon.getUsedCount() &gt;= coupon.getUsageLimit()) {</span>
<span class="fc" id="L330">                return CouponValidationResult.invalid(&quot;Coupon usage limit exceeded&quot;);</span>
            }
        }
        
        // اعتبارسنجی مبلغ سفارش
<span class="fc bfc" id="L335" title="All 2 branches covered.">        if (!coupon.canApplyToOrder(orderAmount)) {</span>
<span class="pc bpc" id="L336" title="2 of 4 branches missed.">            if (coupon.getMinOrderAmount() != null &amp;&amp; orderAmount &lt; coupon.getMinOrderAmount()) {</span>
<span class="fc" id="L337">                return CouponValidationResult.invalid(&quot;Minimum order amount not met. Required: &quot; + coupon.getMinOrderAmount());</span>
            }
        }
        
        // اعتبارسنجی رستوران - کوپن باید برای این رستوران معتبر باشد
<span class="fc bfc" id="L342" title="All 4 branches covered.">        if (coupon.getRestaurant() != null &amp;&amp; !coupon.getRestaurant().getId().equals(restaurantId)) {</span>
<span class="fc" id="L343">            return CouponValidationResult.invalid(&quot;Coupon is not valid for this restaurant&quot;);</span>
        }
        
        // اعتبارسنجی محدودیت هر کاربر
<span class="fc bfc" id="L347" title="All 2 branches covered.">        if (coupon.getPerUserLimit() != null) {</span>
<span class="fc" id="L348">            Long userUsageCount = couponUsageRepository.countActiveByCouponIdAndUserId(coupon.getId(), userId);</span>
<span class="fc bfc" id="L349" title="All 2 branches covered.">            if (userUsageCount &gt;= coupon.getPerUserLimit()) {</span>
<span class="fc" id="L350">                return CouponValidationResult.invalid(&quot;User has exceeded the per-user limit for this coupon&quot;);</span>
            }
        }
        
<span class="fc" id="L354">        return CouponValidationResult.valid();</span>
    }
    
    /**
     * استفاده از کوپن (افزایش شمارنده استفاده)
     * 
     * این متد زمانی فراخوانی می‌شود که کوپن در سفارش اعمال شده است
     * 
     * @param couponId شناسه کوپن
     * @throws NotFoundException در صورت عدم وجود کوپن
     */
    public void useCoupon(Long couponId) {
<span class="fc" id="L366">        logger.info(&quot;Using coupon with ID: {}&quot;, couponId);</span>
        
<span class="fc" id="L368">        Optional&lt;Coupon&gt; couponOpt = couponRepository.findById(couponId);</span>
<span class="fc bfc" id="L369" title="All 2 branches covered.">        if (couponOpt.isEmpty()) {</span>
<span class="fc" id="L370">            throw new NotFoundException(&quot;Coupon&quot;, couponId);</span>
        }
        
<span class="fc" id="L373">        Coupon coupon = couponOpt.get();</span>
<span class="fc" id="L374">        coupon.use(); // افزایش شمارنده استفاده</span>
<span class="fc" id="L375">        couponRepository.update(coupon);</span>
        
<span class="fc" id="L377">        logger.info(&quot;Used coupon {}, new usage count: {}&quot;, couponId, coupon.getUsedCount());</span>
<span class="fc" id="L378">    }</span>
    
    /**
     * استفاده از کوپن با ردیابی کامل (روش توصیه شده)
     * 
     * این متد علاوه بر افزایش شمارنده، رکورد کاملی از استفاده ایجاد می‌کند
     * 
     * @param couponId شناسه کوپن
     * @param userId شناسه کاربر
     * @param orderId شناسه سفارش
     * @param discountAmount مبلغ تخفیف اعمال شده
     * @param orderAmount مبلغ کل سفارش
     * @return رکورد استفاده از کوپن
     */
    public CouponUsage useCouponWithTracking(Long couponId, Long userId, Long orderId, Double discountAmount, Double orderAmount) {
<span class="fc" id="L393">        logger.info(&quot;Using coupon with tracking: couponId={}, userId={}, orderId={}&quot;, couponId, userId, orderId);</span>
        
        // استفاده از کوپن
<span class="fc" id="L396">        useCoupon(couponId);</span>
        
        // ایجاد رکورد استفاده
<span class="fc" id="L399">        Coupon coupon = getCoupon(couponId);</span>
<span class="fc" id="L400">        CouponUsage usage = new CouponUsage(coupon, userId, orderId, discountAmount, orderAmount);</span>
        
<span class="fc" id="L402">        return couponUsageRepository.save(usage);</span>
    }
    
    /**
     * برگشت استفاده از کوپن (برای لغو سفارش یا بازگردانی)
     * 
     * @param couponId شناسه کوپن
     * @throws NotFoundException در صورت عدم وجود کوپن
     */
    public void revertCouponUsage(Long couponId) {
<span class="fc" id="L412">        logger.info(&quot;Reverting coupon usage for ID: {}&quot;, couponId);</span>
        
<span class="fc" id="L414">        Optional&lt;Coupon&gt; couponOpt = couponRepository.findById(couponId);</span>
<span class="fc bfc" id="L415" title="All 2 branches covered.">        if (couponOpt.isEmpty()) {</span>
<span class="fc" id="L416">            throw new NotFoundException(&quot;Coupon&quot;, couponId);</span>
        }
        
<span class="fc" id="L419">        Coupon coupon = couponOpt.get();</span>
<span class="fc" id="L420">        coupon.revertUsage(); // کاهش شمارنده استفاده</span>
<span class="fc" id="L421">        couponRepository.update(coupon);</span>
        
<span class="fc" id="L423">        logger.info(&quot;Reverted coupon usage {}, new usage count: {}&quot;, couponId, coupon.getUsedCount());</span>
<span class="fc" id="L424">    }</span>
    
    // ==================== COUPON MANAGEMENT ====================
    
    /**
     * دریافت کوپن بر اساس شناسه
     * 
     * @param couponId شناسه کوپن
     * @return کوپن یافت شده
     * @throws IllegalArgumentException در صورت null بودن ID
     * @throws NotFoundException در صورت عدم وجود کوپن
     */
    public Coupon getCoupon(Long couponId) {
<span class="fc bfc" id="L437" title="All 2 branches covered.">        if (couponId == null) {</span>
<span class="fc" id="L438">            throw new IllegalArgumentException(&quot;Coupon ID cannot be null&quot;);</span>
        }
        
<span class="fc" id="L441">        return couponRepository.findById(couponId)</span>
<span class="fc" id="L442">            .orElseThrow(() -&gt; new NotFoundException(&quot;Coupon&quot;, couponId));</span>
    }
    
    /**
     * دریافت کوپن بر اساس کد
     * 
     * کد به حروف بزرگ تبدیل می‌شود برای یکنواختی
     * 
     * @param code کد کوپن
     * @return کوپن یافت شده
     * @throws IllegalArgumentException در صورت خالی بودن کد
     * @throws NotFoundException در صورت عدم وجود کوپن
     */
    public Coupon getCouponByCode(String code) {
<span class="pc bpc" id="L456" title="1 of 4 branches missed.">        if (code == null || code.trim().isEmpty()) {</span>
<span class="fc" id="L457">            throw new IllegalArgumentException(&quot;Coupon code cannot be empty&quot;);</span>
        }
        
<span class="fc" id="L460">        return couponRepository.findByCode(code.trim().toUpperCase())</span>
<span class="pc" id="L461">            .orElseThrow(() -&gt; new NotFoundException(&quot;Coupon with code&quot;, code));</span>
    }
    
    /**
     * دریافت تمام کوپن‌های معتبر
     * 
     * @return لیست کوپن‌های معتبر
     */
    public List&lt;Coupon&gt; getValidCoupons() {
<span class="nc" id="L470">        return couponRepository.findValidCoupons();</span>
    }
    
    /**
     * دریافت کوپن‌های قابل اعمال برای سفارش خاص
     * 
     * @param orderAmount مبلغ سفارش
     * @param restaurantId شناسه رستوران
     * @return لیست کوپن‌های قابل اعمال
     * @throws IllegalArgumentException در صورت مبلغ منفی یا صفر
     */
    public List&lt;Coupon&gt; getApplicableCoupons(Double orderAmount, Long restaurantId) {
<span class="pc bpc" id="L482" title="1 of 4 branches missed.">        if (orderAmount == null || orderAmount &lt;= 0) {</span>
<span class="fc" id="L483">            throw new IllegalArgumentException(&quot;Order amount must be positive&quot;);</span>
        }
        
<span class="fc" id="L486">        return couponRepository.findApplicableCoupons(orderAmount, restaurantId);</span>
    }
    
    /**
     * دریافت کوپن‌های رستوران خاص
     * 
     * @param restaurantId شناسه رستوران (null برای کوپن‌های سراسری)
     * @return لیست کوپن‌های رستوران یا سراسری
     */
    public List&lt;Coupon&gt; getRestaurantCoupons(Long restaurantId) {
<span class="nc" id="L496">        return couponRepository.findByRestaurantId(restaurantId);</span>
    }
    
    /**
     * دریافت کوپن‌های سراسری
     * 
     * @return لیست کوپن‌های قابل استفاده در تمام رستوران‌ها
     */
    public List&lt;Coupon&gt; getGlobalCoupons() {
<span class="nc" id="L505">        return couponRepository.findGlobalCoupons();</span>
    }
    
    /**
     * دریافت کوپن‌های ایجاد شده توسط کاربر
     * 
     * @param createdBy شناسه کاربر ایجادکننده
     * @return لیست کوپن‌های ایجاد شده توسط کاربر
     * @throws IllegalArgumentException در صورت null بودن شناسه
     */
    public List&lt;Coupon&gt; getCouponsByCreator(Long createdBy) {
<span class="pc bpc" id="L516" title="1 of 2 branches missed.">        if (createdBy == null) {</span>
<span class="fc" id="L517">            throw new IllegalArgumentException(&quot;Creator ID cannot be null&quot;);</span>
        }
        
<span class="nc" id="L520">        return couponRepository.findByCreatedBy(createdBy);</span>
    }
    
    /**
     * دریافت کوپن‌های نزدیک به انقضا
     * 
     * @param days تعداد روزهای آینده
     * @return لیست کوپن‌های نزدیک به انقضا
     * @throws IllegalArgumentException در صورت تعداد روز منفی
     */
    public List&lt;Coupon&gt; getCouponsExpiringSoon(int days) {
<span class="nc bnc" id="L531" title="All 2 branches missed.">        if (days &lt; 1) {</span>
<span class="nc" id="L532">            throw new IllegalArgumentException(&quot;Days must be positive&quot;);</span>
        }
        
<span class="nc" id="L535">        return couponRepository.findCouponsExpiringSoon(days);</span>
    }
    
    /**
     * به‌روزرسانی اطلاعات کوپن
     * 
     * @param couponId شناسه کوپن
     * @param description توضیحات جدید
     * @param minOrderAmount حداقل مبلغ سفارش
     * @param maxDiscountAmount حداکثر مبلغ تخفیف
     * @param usageLimit محدودیت کل استفاده
     * @param perUserLimit محدودیت هر کاربر
     * @param validUntil تاریخ انقضا
     * @param updatedBy شناسه به‌روزرسانی کننده
     * @return کوپن به‌روزرسانی شده
     */
    public Coupon updateCoupon(Long couponId, String description, Double minOrderAmount, 
                              Double maxDiscountAmount, Integer usageLimit, Integer perUserLimit, 
                              LocalDateTime validUntil, Long updatedBy) {
<span class="nc" id="L554">        logger.info(&quot;Updating coupon with ID: {}&quot;, couponId);</span>
        
<span class="nc" id="L556">        Coupon coupon = getCoupon(couponId);</span>
        
        // اعتبارسنجی مجوزهای به‌روزرسانی
<span class="nc" id="L559">        validateUpdatePermissions(coupon, updatedBy);</span>
        
        // به‌روزرسانی اطلاعات
<span class="nc" id="L562">        coupon.updateInfo(description, minOrderAmount, maxDiscountAmount, usageLimit, perUserLimit, validUntil);</span>
        
<span class="nc" id="L564">        return couponRepository.update(coupon);</span>
    }
    
    /**
     * فعال‌سازی کوپن
     * 
     * @param couponId شناسه کوپن
     * @param activatedBy شناسه فعال‌کننده
     */
    public void activateCoupon(Long couponId, Long activatedBy) {
<span class="fc" id="L574">        logger.info(&quot;Activating coupon with ID: {}&quot;, couponId);</span>
        
<span class="fc" id="L576">        Coupon coupon = getCoupon(couponId);</span>
<span class="fc" id="L577">        validateUpdatePermissions(coupon, activatedBy);</span>
        
<span class="fc" id="L579">        coupon.activate();</span>
<span class="fc" id="L580">        couponRepository.update(coupon);</span>
<span class="fc" id="L581">    }</span>
    
    /**
     * غیرفعال‌سازی کوپن
     * 
     * @param couponId شناسه کوپن
     * @param deactivatedBy شناسه غیرفعال‌کننده
     */
    public void deactivateCoupon(Long couponId, Long deactivatedBy) {
<span class="fc" id="L590">        logger.info(&quot;Deactivating coupon with ID: {}&quot;, couponId);</span>
        
<span class="fc" id="L592">        Coupon coupon = getCoupon(couponId);</span>
<span class="fc" id="L593">        validateUpdatePermissions(coupon, deactivatedBy);</span>
        
<span class="fc" id="L595">        coupon.deactivate();</span>
<span class="fc" id="L596">        couponRepository.update(coupon);</span>
<span class="fc" id="L597">    }</span>
    
    /**
     * حذف کوپن
     * 
     * کوپن‌هایی که استفاده شده‌اند قابل حذف نیستند
     * 
     * @param couponId شناسه کوپن
     * @param deletedBy شناسه حذف‌کننده
     * @throws IllegalStateException در صورت استفاده شدن کوپن
     */
    public void deleteCoupon(Long couponId, Long deletedBy) {
<span class="fc" id="L609">        logger.info(&quot;Deleting coupon with ID: {}&quot;, couponId);</span>
        
<span class="fc" id="L611">        Coupon coupon = getCoupon(couponId);</span>
<span class="fc" id="L612">        validateUpdatePermissions(coupon, deletedBy);</span>
        
        // بررسی استفاده نشدن کوپن
<span class="fc bfc" id="L615" title="All 2 branches covered.">        if (coupon.getUsedCount() &gt; 0) {</span>
<span class="fc" id="L616">            throw new IllegalStateException(&quot;Cannot delete coupon that has been used&quot;);</span>
        }
        
<span class="fc" id="L619">        couponRepository.delete(couponId);</span>
<span class="fc" id="L620">    }</span>
    
    /**
     * دریافت آمار کوپن‌ها
     * 
     * @return آمار شامل کل، فعال، نزدیک به انقضا و منقضی
     */
    public CouponStatistics getCouponStatistics() {
<span class="fc" id="L628">        Long totalCoupons = couponRepository.countAll();</span>
<span class="fc" id="L629">        Long activeCoupons = couponRepository.countActive();</span>
<span class="fc" id="L630">        List&lt;Coupon&gt; expiringSoon = couponRepository.findCouponsExpiringSoon(7);</span>
<span class="fc" id="L631">        List&lt;Coupon&gt; expired = couponRepository.findExpiredCoupons();</span>
        
<span class="fc" id="L633">        return new CouponStatistics(totalCoupons, activeCoupons, (long)expiringSoon.size(), (long)expired.size());</span>
    }
    
    // ==================== PRIVATE HELPER METHODS ====================
    
    /**
     * اعتبارسنجی ورودی‌های ایجاد کوپن
     * 
     * بررسی تمام قوانین validation برای ایجاد کوپن
     */
    private void validateCouponCreationInputs(String code, String description, LocalDateTime validFrom, 
                                            LocalDateTime validUntil, Long createdBy) {
<span class="pc bpc" id="L645" title="2 of 4 branches missed.">        if (code == null || code.trim().isEmpty()) {</span>
<span class="nc" id="L646">            throw new IllegalArgumentException(&quot;Coupon code cannot be empty&quot;);</span>
        }
<span class="pc bpc" id="L648" title="1 of 2 branches missed.">        if (code.trim().length() &gt; 50) {</span>
<span class="nc" id="L649">            throw new IllegalArgumentException(&quot;Coupon code cannot exceed 50 characters&quot;);</span>
        }
<span class="pc bpc" id="L651" title="2 of 4 branches missed.">        if (description == null || description.trim().isEmpty()) {</span>
<span class="nc" id="L652">            throw new IllegalArgumentException(&quot;Coupon description cannot be empty&quot;);</span>
        }
<span class="pc bpc" id="L654" title="1 of 2 branches missed.">        if (description.trim().length() &gt; 255) {</span>
<span class="nc" id="L655">            throw new IllegalArgumentException(&quot;Coupon description cannot exceed 255 characters&quot;);</span>
        }
<span class="pc bpc" id="L657" title="1 of 2 branches missed.">        if (validFrom == null) {</span>
<span class="nc" id="L658">            throw new IllegalArgumentException(&quot;Valid from date cannot be null&quot;);</span>
        }
<span class="pc bpc" id="L660" title="1 of 2 branches missed.">        if (validUntil == null) {</span>
<span class="nc" id="L661">            throw new IllegalArgumentException(&quot;Valid until date cannot be null&quot;);</span>
        }
<span class="fc bfc" id="L663" title="All 2 branches covered.">        if (validUntil.isBefore(validFrom)) {</span>
<span class="fc" id="L664">            throw new IllegalArgumentException(&quot;Valid until date must be after valid from date&quot;);</span>
        }
<span class="pc bpc" id="L666" title="1 of 2 branches missed.">        if (validUntil.isBefore(LocalDateTime.now())) {</span>
<span class="nc" id="L667">            throw new IllegalArgumentException(&quot;Valid until date must be in the future&quot;);</span>
        }
<span class="pc bpc" id="L669" title="1 of 2 branches missed.">        if (createdBy == null) {</span>
<span class="nc" id="L670">            throw new IllegalArgumentException(&quot;Creator ID cannot be null&quot;);</span>
        }
<span class="fc" id="L672">    }</span>
    
    /**
     * اعتبارسنجی درصد تخفیف
     * 
     * درصد باید بین 0 تا 100 باشد
     */
    private void validatePercentage(Double percentage) {
<span class="pc bpc" id="L680" title="2 of 6 branches missed.">        if (percentage == null || percentage &lt; 0 || percentage &gt; 100) {</span>
<span class="fc" id="L681">            throw new IllegalArgumentException(&quot;Percentage must be between 0 and 100&quot;);</span>
        }
<span class="fc" id="L683">    }</span>
    
    /**
     * اعتبارسنجی مبلغ ثابت تخفیف
     * 
     * مبلغ باید مثبت و کمتر از 10,000 باشد
     */
    private void validateFixedAmount(Double amount) {
<span class="pc bpc" id="L691" title="1 of 4 branches missed.">        if (amount == null || amount &lt;= 0) {</span>
<span class="fc" id="L692">            throw new IllegalArgumentException(&quot;Fixed amount must be positive&quot;);</span>
        }
<span class="pc bpc" id="L694" title="1 of 2 branches missed.">        if (amount &gt; 10000) {</span>
<span class="nc" id="L695">            throw new IllegalArgumentException(&quot;Fixed amount cannot exceed 10,000&quot;);</span>
        }
<span class="fc" id="L697">    }</span>
    
    /**
     * اعتبارسنجی مجوزهای ایجاد کوپن
     * 
     * قوانین:
     * - ادمین‌ها می‌توانند هر نوع کوپنی ایجاد کنند
     * - مالکان رستوران فقط برای رستوران خودشان
     * - سایر کاربران اجازه ایجاد ندارند
     */
    private void validateCreatorPermissions(Long createdBy, Long restaurantId) {
<span class="fc" id="L708">        User creator = authRepository.findById(createdBy)</span>
<span class="pc" id="L709">            .orElseThrow(() -&gt; new NotFoundException(&quot;User&quot;, createdBy));</span>
        
        // ادمین‌ها می‌توانند هر کوپنی ایجاد کنند
<span class="fc bfc" id="L712" title="All 2 branches covered.">        if (creator.getRole() == User.Role.ADMIN) {</span>
<span class="fc" id="L713">            return;</span>
        }
        
        // مالکان رستوران (نقش SELLER) فقط برای رستوران خودشان
<span class="fc bfc" id="L717" title="All 2 branches covered.">        if (creator.getRole() == User.Role.SELLER) {</span>
<span class="fc bfc" id="L718" title="All 2 branches covered.">            if (restaurantId == null) {</span>
<span class="fc" id="L719">                throw new IllegalArgumentException(&quot;Restaurant owners cannot create global coupons&quot;);</span>
            }
            
<span class="fc" id="L722">            Restaurant restaurant = restaurantRepository.findById(restaurantId)</span>
<span class="pc" id="L723">                .orElseThrow(() -&gt; new NotFoundException(&quot;Restaurant&quot;, restaurantId));</span>
            
<span class="fc bfc" id="L725" title="All 2 branches covered.">            if (!restaurant.getOwnerId().equals(createdBy)) {</span>
<span class="fc" id="L726">                throw new IllegalArgumentException(&quot;Restaurant owners can only create coupons for their own restaurants&quot;);</span>
            }
<span class="fc" id="L728">            return;</span>
        }
        
<span class="fc" id="L731">        throw new IllegalArgumentException(&quot;Only admins and restaurant owners can create coupons&quot;);</span>
    }
    
    /**
     * اعتبارسنجی مجوزهای به‌روزرسانی کوپن
     * 
     * قوانین:
     * - ادمین‌ها می‌توانند همه کوپن‌ها را به‌روزرسانی کنند
     * - کاربران فقط کوپن‌های خودشان را
     * - مالکان رستوران فقط کوپن‌های رستوران خودشان را
     */
    private void validateUpdatePermissions(Coupon coupon, Long updatedBy) {
<span class="fc" id="L743">        User updater = authRepository.findById(updatedBy)</span>
<span class="pc" id="L744">            .orElseThrow(() -&gt; new NotFoundException(&quot;User&quot;, updatedBy));</span>
        
        // ادمین‌ها می‌توانند هر کوپنی را به‌روزرسانی کنند
<span class="fc bfc" id="L747" title="All 2 branches covered.">        if (updater.getRole() == User.Role.ADMIN) {</span>
<span class="fc" id="L748">            return;</span>
        }
        
        // کاربران فقط کوپن‌های خودشان را
<span class="pc bpc" id="L752" title="1 of 2 branches missed.">        if (!coupon.getCreatedBy().equals(updatedBy)) {</span>
<span class="fc" id="L753">            throw new IllegalArgumentException(&quot;Users can only update their own coupons&quot;);</span>
        }
        
        // مالکان رستوران فقط کوپن‌های رستوران خودشان را
<span class="nc bnc" id="L757" title="All 4 branches missed.">        if (updater.getRole() == User.Role.SELLER &amp;&amp; coupon.getRestaurant() != null) {</span>
<span class="nc bnc" id="L758" title="All 2 branches missed.">            if (!coupon.getRestaurant().getOwnerId().equals(updatedBy)) {</span>
<span class="nc" id="L759">                throw new IllegalArgumentException(&quot;Restaurant owners can only update their own restaurant coupons&quot;);</span>
            }
        }
<span class="nc" id="L762">    }</span>
    
    // ==================== RESULT CLASSES ====================
    
    /**
     * کلاس نتیجه اعمال کوپن
     * 
     * این کلاس نتیجه فرآیند اعمال کوپن را در بر می‌گیرد:
     * - موفقیت/ناموفقی بودن
     * - پیام خطا در صورت ناموفقی بودن
     * - شیء کوپن در صورت موفقیت
     * - مبلغ تخفیف محاسبه شده
     */
    public static class CouponApplicationResult {
        /** آیا اعمال کوپن موفق بوده است */
        private final boolean success;
        /** پیام خطا در صورت ناموفقی بودن */
        private final String errorMessage;
        /** شیء کوپن در صورت موفقیت */
        private final Coupon coupon;
        /** مبلغ تخفیف محاسبه شده */
        private final Double discountAmount;
        
<span class="fc" id="L785">        private CouponApplicationResult(boolean success, String errorMessage, Coupon coupon, Double discountAmount) {</span>
<span class="fc" id="L786">            this.success = success;</span>
<span class="fc" id="L787">            this.errorMessage = errorMessage;</span>
<span class="fc" id="L788">            this.coupon = coupon;</span>
<span class="fc" id="L789">            this.discountAmount = discountAmount;</span>
<span class="fc" id="L790">        }</span>
        
        /**
         * ایجاد نتیجه موفق
         */
        public static CouponApplicationResult success(Coupon coupon, Double discountAmount) {
<span class="fc" id="L796">            return new CouponApplicationResult(true, null, coupon, discountAmount);</span>
        }
        
        /**
         * ایجاد نتیجه ناموفق با پیام خطا
         */
        public static CouponApplicationResult failed(String errorMessage) {
<span class="fc" id="L803">            return new CouponApplicationResult(false, errorMessage, null, null);</span>
        }
        
        // Getters
<span class="fc" id="L807">        public boolean isSuccess() { return success; }</span>
<span class="fc" id="L808">        public String getErrorMessage() { return errorMessage; }</span>
<span class="fc" id="L809">        public Coupon getCoupon() { return coupon; }</span>
<span class="fc" id="L810">        public Double getDiscountAmount() { return discountAmount; }</span>
    }
    
    /**
     * کلاس نتیجه اعتبارسنجی کوپن
     * 
     * برای بررسی معتبر بودن کوپن بدون اعمال آن
     */
    public static class CouponValidationResult {
        /** آیا کوپن معتبر است */
        private final boolean valid;
        /** پیام خطا در صورت نامعتبر بودن */
        private final String errorMessage;
        
<span class="fc" id="L824">        private CouponValidationResult(boolean valid, String errorMessage) {</span>
<span class="fc" id="L825">            this.valid = valid;</span>
<span class="fc" id="L826">            this.errorMessage = errorMessage;</span>
<span class="fc" id="L827">        }</span>
        
        /**
         * ایجاد نتیجه معتبر
         */
        public static CouponValidationResult valid() {
<span class="fc" id="L833">            return new CouponValidationResult(true, null);</span>
        }
        
        /**
         * ایجاد نتیجه نامعتبر با پیام خطا
         */
        public static CouponValidationResult invalid(String errorMessage) {
<span class="fc" id="L840">            return new CouponValidationResult(false, errorMessage);</span>
        }
        
        // Getters
<span class="fc" id="L844">        public boolean isValid() { return valid; }</span>
<span class="fc" id="L845">        public String getErrorMessage() { return errorMessage; }</span>
    }
    
    /**
     * کلاس آمار کوپن‌ها
     * 
     * شامل آمارهای کلی سیستم کوپن‌ها برای dashboard
     */
    public static class CouponStatistics {
        /** تعداد کل کوپن‌ها */
        private final Long totalCoupons;
        /** تعداد کوپن‌های فعال */
        private final Long activeCoupons;
        /** تعداد کوپن‌های نزدیک به انقضا */
        private final Long expiringSoon;
        /** تعداد کوپن‌های منقضی */
        private final Long expired;
        
<span class="fc" id="L863">        public CouponStatistics(Long totalCoupons, Long activeCoupons, Long expiringSoon, Long expired) {</span>
<span class="fc" id="L864">            this.totalCoupons = totalCoupons;</span>
<span class="fc" id="L865">            this.activeCoupons = activeCoupons;</span>
<span class="fc" id="L866">            this.expiringSoon = expiringSoon;</span>
<span class="fc" id="L867">            this.expired = expired;</span>
<span class="fc" id="L868">        }</span>
        
        // Getters
<span class="fc" id="L871">        public Long getTotalCoupons() { return totalCoupons; }</span>
<span class="fc" id="L872">        public Long getActiveCoupons() { return activeCoupons; }</span>
<span class="fc" id="L873">        public Long getExpiringSoon() { return expiringSoon; }</span>
<span class="fc" id="L874">        public Long getExpired() { return expired; }</span>
        /** محاسبه تعداد کوپن‌های غیرفعال */
<span class="fc" id="L876">        public Long getInactiveCoupons() { return totalCoupons - activeCoupons; }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>