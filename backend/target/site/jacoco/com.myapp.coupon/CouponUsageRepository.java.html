<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CouponUsageRepository.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.coupon</a> &gt; <span class="el_source">CouponUsageRepository.java</span></div><h1>CouponUsageRepository.java</h1><pre class="source lang-java linenums">package com.myapp.coupon;

import com.myapp.common.models.CouponUsage;
import com.myapp.common.utils.DatabaseUtil;
import org.hibernate.Session;
import org.hibernate.SessionFactory;
import org.hibernate.query.Query;

import java.util.List;
import java.util.Optional;

/**
 * Repository لایه دسترسی داده برای entity های CouponUsage
 * 
 * این کلاس تمام عملیات پایگاه داده مربوط به ردیابی استفاده از کوپن‌ها را ارائه می‌دهد:
 * 
 * === عملیات CRUD پایه ===
 * - save(): ذخیره استفاده جدید از کوپن
 * - update(): به‌روزرسانی استفاده موجود
 * - findById(): جستجو بر اساس شناسه
 * - delete(): حذف رکورد استفاده
 * - deleteAll(): پاکسازی کامل (تست)
 * 
 * === جستجوهای تخصصی ===
 * - findByCouponIdAndUserId(): تمام استفاده‌های کاربر از کوپن خاص
 * - findActiveByCouponIdAndUserId(): استفاده‌های فعال کاربر از کوپن
 * - countActiveByCouponIdAndUserId(): شمارش استفاده‌های فعال
 * - findByCouponId(): تمام استفاده‌ها از کوپن خاص
 * - findByUserId(): تمام استفاده‌های کاربر
 * - findByOrderId(): استفاده کوپن در سفارش خاص
 * 
 * === عملیات آماری ===
 * - countTotalUsage(): تعداد کل استفاده‌ها
 * - countActiveUsage(): تعداد استفاده‌های فعال
 * - getTotalDiscountAmount(): مجموع مبلغ تخفیف‌های اعمال شده
 * 
 * === ویژگی‌های کلیدی ===
 * - Usage Tracking: ردیابی دقیق استفاده از کوپن‌ها
 * - Per-User Limitations: محدودیت‌های per-user
 * - Active Status Management: مدیریت وضعیت فعال/غیرفعال
 * - Order Linking: اتصال با سفارشات
 * - Revert Support: پشتیبانی از بازگشت استفاده
 * - Statistical Queries: queries آماری پیچیده
 * - Transaction Management: مدیریت تراکنش‌ها
 * - SessionFactory Injection: تزریق وابستگی برای تست
 * - HQL Queries: استفاده از Hibernate Query Language
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 */
public class CouponUsageRepository {
    
    /** SessionFactory برای مدیریت ارتباط با دیتابیس */
    private final SessionFactory sessionFactory;
    
    /**
     * سازنده پیش‌فرض - دریافت SessionFactory از DatabaseUtil
     */
<span class="nc" id="L60">    public CouponUsageRepository() {</span>
<span class="nc" id="L61">        this.sessionFactory = DatabaseUtil.getSessionFactory();</span>
<span class="nc" id="L62">    }</span>
    
    /**
     * سازنده برای تزریق وابستگی (Dependency Injection)
     * برای تست‌ها و configuration سفارشی استفاده می‌شود
     * 
     * @param sessionFactory SessionFactory سفارشی
     */
<span class="nc" id="L70">    public CouponUsageRepository(SessionFactory sessionFactory) {</span>
<span class="nc" id="L71">        this.sessionFactory = sessionFactory;</span>
<span class="nc" id="L72">    }</span>
    
    // ==================== BASIC CRUD OPERATIONS ====================
    
    /**
     * ذخیره استفاده جدید از کوپن در دیتابیس
     * 
     * @param couponUsage استفاده از کوپن برای ذخیره
     * @return استفاده ذخیره شده با ID تولید شده
     */
    public CouponUsage save(CouponUsage couponUsage) {
<span class="nc" id="L83">        try (Session session = sessionFactory.openSession()) {</span>
<span class="nc" id="L84">            session.beginTransaction();</span>
<span class="nc" id="L85">            session.persist(couponUsage);</span>
<span class="nc" id="L86">            session.getTransaction().commit();</span>
<span class="nc" id="L87">            return couponUsage;</span>
        }
    }
    
    /**
     * به‌روزرسانی استفاده موجود از کوپن
     * 
     * @param couponUsage استفاده از کوپن برای به‌روزرسانی
     * @return استفاده به‌روزرسانی شده
     */
    public CouponUsage update(CouponUsage couponUsage) {
<span class="nc" id="L98">        try (Session session = sessionFactory.openSession()) {</span>
<span class="nc" id="L99">            session.beginTransaction();</span>
<span class="nc" id="L100">            CouponUsage updated = session.merge(couponUsage);</span>
<span class="nc" id="L101">            session.getTransaction().commit();</span>
<span class="nc" id="L102">            return updated;</span>
        }
    }
    
    /**
     * جستجوی استفاده از کوپن بر اساس شناسه
     * 
     * @param id شناسه استفاده از کوپن
     * @return Optional حاوی استفاده یا empty در صورت عدم وجود
     */
    public Optional&lt;CouponUsage&gt; findById(Long id) {
<span class="nc" id="L113">        try (Session session = sessionFactory.openSession()) {</span>
<span class="nc" id="L114">            CouponUsage usage = session.get(CouponUsage.class, id);</span>
<span class="nc" id="L115">            return Optional.ofNullable(usage);</span>
        }
    }
    
    // ==================== SPECIALIZED QUERIES ====================
    
    /**
     * یافتن تمام استفاده‌های کاربر از کوپن خاص
     * 
     * مرتب شده بر اساس تاریخ استفاده (جدیدترین اول)
     * 
     * @param couponId شناسه کوپن
     * @param userId شناسه کاربر
     * @return لیست استفاده‌های کاربر از کوپن
     */
    public List&lt;CouponUsage&gt; findByCouponIdAndUserId(Long couponId, Long userId) {
<span class="nc" id="L131">        try (Session session = sessionFactory.openSession()) {</span>
<span class="nc" id="L132">            Query&lt;CouponUsage&gt; query = session.createQuery(</span>
                &quot;FROM CouponUsage cu WHERE cu.coupon.id = :couponId AND cu.userId = :userId ORDER BY cu.usedAt DESC&quot;, 
                CouponUsage.class);
<span class="nc" id="L135">            query.setParameter(&quot;couponId&quot;, couponId);</span>
<span class="nc" id="L136">            query.setParameter(&quot;userId&quot;, userId);</span>
<span class="nc" id="L137">            return query.getResultList();</span>
        }
    }
    
    /**
     * یافتن استفاده‌های فعال کاربر از کوپن خاص
     * 
     * فقط استفاده‌هایی که هنوز بازگشت داده نشده‌اند (isActive = true)
     * 
     * @param couponId شناسه کوپن
     * @param userId شناسه کاربر
     * @return لیست استفاده‌های فعال کاربر
     */
    public List&lt;CouponUsage&gt; findActiveByCouponIdAndUserId(Long couponId, Long userId) {
<span class="nc" id="L151">        try (Session session = sessionFactory.openSession()) {</span>
<span class="nc" id="L152">            Query&lt;CouponUsage&gt; query = session.createQuery(</span>
                &quot;FROM CouponUsage cu WHERE cu.coupon.id = :couponId AND cu.userId = :userId AND cu.isActive = true ORDER BY cu.usedAt DESC&quot;, 
                CouponUsage.class);
<span class="nc" id="L155">            query.setParameter(&quot;couponId&quot;, couponId);</span>
<span class="nc" id="L156">            query.setParameter(&quot;userId&quot;, userId);</span>
<span class="nc" id="L157">            return query.getResultList();</span>
        }
    }
    
    /**
     * شمارش استفاده‌های فعال کاربر از کوپن خاص
     * 
     * برای بررسی محدودیت per-user استفاده می‌شود
     * 
     * @param couponId شناسه کوپن
     * @param userId شناسه کاربر
     * @return تعداد استفاده‌های فعال
     */
    public Long countActiveByCouponIdAndUserId(Long couponId, Long userId) {
<span class="nc" id="L171">        try (Session session = sessionFactory.openSession()) {</span>
<span class="nc" id="L172">            Query&lt;Long&gt; query = session.createQuery(</span>
                &quot;SELECT COUNT(cu) FROM CouponUsage cu WHERE cu.coupon.id = :couponId AND cu.userId = :userId AND cu.isActive = true&quot;, 
                Long.class);
<span class="nc" id="L175">            query.setParameter(&quot;couponId&quot;, couponId);</span>
<span class="nc" id="L176">            query.setParameter(&quot;userId&quot;, userId);</span>
<span class="nc" id="L177">            return query.getSingleResult();</span>
        }
    }
    
    /**
     * یافتن تمام استفاده‌ها از کوپن خاص
     * 
     * مرتب شده بر اساس تاریخ استفاده (جدیدترین اول)
     * برای آمارگیری و گزارش‌گیری استفاده می‌شود
     * 
     * @param couponId شناسه کوپن
     * @return لیست تمام استفاده‌ها از کوپن
     */
    public List&lt;CouponUsage&gt; findByCouponId(Long couponId) {
<span class="nc" id="L191">        try (Session session = sessionFactory.openSession()) {</span>
<span class="nc" id="L192">            Query&lt;CouponUsage&gt; query = session.createQuery(</span>
                &quot;FROM CouponUsage cu WHERE cu.coupon.id = :couponId ORDER BY cu.usedAt DESC&quot;, 
                CouponUsage.class);
<span class="nc" id="L195">            query.setParameter(&quot;couponId&quot;, couponId);</span>
<span class="nc" id="L196">            return query.getResultList();</span>
        }
    }
    
    /**
     * یافتن تمام استفاده‌های کاربر از کوپن‌ها
     * 
     * مرتب شده بر اساس تاریخ استفاده (جدیدترین اول)
     * برای نمایش تاریخچه استفاده کاربر استفاده می‌شود
     * 
     * @param userId شناسه کاربر
     * @return لیست تمام استفاده‌های کاربر
     */
    public List&lt;CouponUsage&gt; findByUserId(Long userId) {
<span class="nc" id="L210">        try (Session session = sessionFactory.openSession()) {</span>
<span class="nc" id="L211">            Query&lt;CouponUsage&gt; query = session.createQuery(</span>
                &quot;FROM CouponUsage cu WHERE cu.userId = :userId ORDER BY cu.usedAt DESC&quot;, 
                CouponUsage.class);
<span class="nc" id="L214">            query.setParameter(&quot;userId&quot;, userId);</span>
<span class="nc" id="L215">            return query.getResultList();</span>
        }
    }
    
    /**
     * یافتن استفاده از کوپن در سفارش خاص
     * 
     * هر سفارش حداکثر یک کوپن می‌تواند داشته باشد
     * 
     * @param orderId شناسه سفارش
     * @return Optional حاوی استفاده از کوپن یا empty
     */
    public Optional&lt;CouponUsage&gt; findByOrderId(Long orderId) {
<span class="nc" id="L228">        try (Session session = sessionFactory.openSession()) {</span>
<span class="nc" id="L229">            Query&lt;CouponUsage&gt; query = session.createQuery(</span>
                &quot;FROM CouponUsage cu WHERE cu.orderId = :orderId&quot;, 
                CouponUsage.class);
<span class="nc" id="L232">            query.setParameter(&quot;orderId&quot;, orderId);</span>
<span class="nc" id="L233">            return query.getResultStream().findFirst();</span>
        }
    }
    
    // ==================== DELETE OPERATIONS ====================
    
    /**
     * حذف استفاده از کوپن با شناسه
     * 
     * @param id شناسه استفاده برای حذف
     */
    public void delete(Long id) {
<span class="nc" id="L245">        try (Session session = sessionFactory.openSession()) {</span>
<span class="nc" id="L246">            session.beginTransaction();</span>
<span class="nc" id="L247">            CouponUsage usage = session.get(CouponUsage.class, id);</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">            if (usage != null) {</span>
<span class="nc" id="L249">                session.remove(usage);</span>
            }
<span class="nc" id="L251">            session.getTransaction().commit();</span>
        }
<span class="nc" id="L253">    }</span>
    
    /**
     * حذف تمام استفاده‌ها از کوپن‌ها (متد کمکی برای تست‌ها)
     * ⚠️ هشدار: این متد فقط برای محیط تست استفاده شود
     */
    public void deleteAll() {
<span class="nc" id="L260">        try (Session session = sessionFactory.openSession()) {</span>
<span class="nc" id="L261">            session.beginTransaction();</span>
<span class="nc" id="L262">            session.createQuery(&quot;DELETE FROM CouponUsage&quot;).executeUpdate();</span>
<span class="nc" id="L263">            session.getTransaction().commit();</span>
        }
<span class="nc" id="L265">    }</span>
    
    // ==================== STATISTICAL OPERATIONS ====================
    
    /**
     * شمارش تعداد کل استفاده‌ها از کوپن‌ها
     * 
     * شامل استفاده‌های فعال و غیرفعال
     * 
     * @return تعداد کل استفاده‌ها
     */
    public Long countTotalUsage() {
<span class="nc" id="L277">        try (Session session = sessionFactory.openSession()) {</span>
<span class="nc" id="L278">            Query&lt;Long&gt; query = session.createQuery(&quot;SELECT COUNT(cu) FROM CouponUsage cu&quot;, Long.class);</span>
<span class="nc" id="L279">            return query.getSingleResult();</span>
        }
    }
    
    /**
     * شمارش تعداد استفاده‌های فعال از کوپن‌ها
     * 
     * فقط استفاده‌هایی که بازگشت داده نشده‌اند
     * 
     * @return تعداد استفاده‌های فعال
     */
    public Long countActiveUsage() {
<span class="nc" id="L291">        try (Session session = sessionFactory.openSession()) {</span>
<span class="nc" id="L292">            Query&lt;Long&gt; query = session.createQuery(&quot;SELECT COUNT(cu) FROM CouponUsage cu WHERE cu.isActive = true&quot;, Long.class);</span>
<span class="nc" id="L293">            return query.getSingleResult();</span>
        }
    }
    
    /**
     * محاسبه مجموع مبلغ تخفیف‌های اعمال شده
     * 
     * فقط تخفیف‌های فعال (بازگشت داده نشده) محاسبه می‌شوند
     * 
     * @return مجموع مبلغ تخفیف‌ها
     */
    public Double getTotalDiscountAmount() {
<span class="nc" id="L305">        try (Session session = sessionFactory.openSession()) {</span>
<span class="nc" id="L306">            Query&lt;Double&gt; query = session.createQuery(</span>
                &quot;SELECT COALESCE(SUM(cu.discountAmount), 0.0) FROM CouponUsage cu WHERE cu.isActive = true&quot;, 
                Double.class);
<span class="nc" id="L309">            return query.getSingleResult();</span>
        }
    }
} 
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>