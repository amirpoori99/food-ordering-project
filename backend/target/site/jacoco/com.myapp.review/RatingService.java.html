<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RatingService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.review</a> &gt; <span class="el_source">RatingService.java</span></div><h1>RatingService.java</h1><pre class="source lang-java linenums">package com.myapp.review;

import com.myapp.auth.AuthRepository;
import com.myapp.common.exceptions.NotFoundException;
import com.myapp.common.models.Rating;
import com.myapp.common.models.Restaurant;
import com.myapp.common.models.User;
import com.myapp.restaurant.RestaurantRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.List;
import java.util.Map;
import java.util.Optional;

/**
 * Service لایه منطق کسب‌وکار برای مدیریت نظرات و امتیازدهی
 * 
 * این کلاس تمام عملیات مربوط به منطق کسب‌وکار نظرات و امتیازات را پیاده‌سازی می‌کند:
 * 
 * === عملیات اصلی CRUD ===
 * - createRating(): ایجاد نظر و امتیاز جدید
 * - updateRating(): به‌روزرسانی نظر موجود
 * - getRating(): دریافت نظر بر اساس شناسه
 * - deleteRating(): حذف نظر (فقط توسط صاحب نظر)
 * 
 * === جستجو و دریافت اطلاعات ===
 * - getRestaurantRatings(): تمام نظرات رستوران
 * - getUserRatings(): تمام نظرات کاربر
 * - getRestaurantRatingStats(): آمار کامل امتیازات رستوران
 * - hasUserRatedRestaurant(): بررسی نظردهی کاربر به رستوران
 * - getUserRatingForRestaurant(): نظر کاربر برای رستوران خاص
 * 
 * === عملیات تعامل کاربران ===
 * - markAsHelpful(): علامت‌گذاری نظر به عنوان مفید
 * - removeHelpfulMark(): حذف علامت مفید از نظر
 * 
 * === عملیات مدیریتی ===
 * - verifyRating(): تایید نظر (توسط ادمین)
 * - unverifyRating(): لغو تایید نظر (توسط ادمین)
 * - getAllRatings(): دریافت تمام نظرات (ادمین)
 * 
 * === فیلترها و جستجوهای پیشرفته ===
 * - getRatingsByScore(): نظرات در بازه امتیاز
 * - getVerifiedRatings(): نظرات تایید شده
 * - getRatingsWithReviews(): نظرات دارای متن
 * - getRecentRatings(): نظرات اخیر
 * 
 * === صفحه‌بندی و آمار ===
 * - getRatingsWithPagination(): دریافت با صفحه‌بندی
 * - getTotalRatingCount(): تعداد کل نظرات
 * 
 * === ویژگی‌های کلیدی ===
 * - Business Rules Enforcement: اجرای قوانین کسب‌وکار
 * - Data Validation: اعتبارسنجی کامل داده‌ها
 * - User Permission Checks: بررسی مجوزهای کاربران
 * - Duplicate Prevention: جلوگیری از نظر تکراری هر کاربر
 * - Owner Restriction: منع نظردهی مالک به رستوران خود
 * - Statistical Analysis: تحلیل آماری امتیازات
 * - Error Handling: مدیریت خطاها و validation
 * - Dependency Injection: پشتیبانی از تزریق وابستگی‌ها
 * 
 * === Inner Classes ===
 * - RatingStats: کلاس آمار امتیازات رستوران
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 */
public class RatingService {
    
    /** Logger برای ثبت عملیات و خطاها */
<span class="fc" id="L73">    private static final Logger logger = LoggerFactory.getLogger(RatingService.class);</span>
    
    /** Repository لایه دسترسی داده نظرات */
    private final RatingRepository ratingRepository;
    /** Repository لایه دسترسی داده کاربران */
    private final AuthRepository authRepository;
    /** Repository لایه دسترسی داده رستوران‌ها */
    private final RestaurantRepository restaurantRepository;
    
    /**
     * سازنده پیش‌فرض - Repository های مورد نیاز را ایجاد می‌کند
     */
<span class="fc" id="L85">    public RatingService() {</span>
<span class="fc" id="L86">        this.ratingRepository = new RatingRepository();</span>
<span class="fc" id="L87">        this.authRepository = new AuthRepository();</span>
<span class="fc" id="L88">        this.restaurantRepository = new RestaurantRepository();</span>
<span class="fc" id="L89">    }</span>
    
    /**
     * سازنده برای تزریق وابستگی‌ها (برای تست‌ها)
     * 
     * @param ratingRepository repository نظرات
     * @param authRepository repository کاربران
     * @param restaurantRepository repository رستوران‌ها
     */
<span class="fc" id="L98">    public RatingService(RatingRepository ratingRepository, AuthRepository authRepository, RestaurantRepository restaurantRepository) {</span>
<span class="fc" id="L99">        this.ratingRepository = ratingRepository;</span>
<span class="fc" id="L100">        this.authRepository = authRepository;</span>
<span class="fc" id="L101">        this.restaurantRepository = restaurantRepository;</span>
<span class="fc" id="L102">    }</span>
    
    /**
     * ایجاد نظر و امتیاز جدید برای رستوران
     * 
     * قوانین کسب‌وکار:
     * - هر کاربر فقط یک نظر برای هر رستوران
     * - مالک رستوران نمی‌تواند به رستوران خودش نظر دهد
     * - امتیاز باید بین 1 تا 5 باشد
     * 
     * @param userId شناسه کاربر نظردهنده
     * @param restaurantId شناسه رستوران
     * @param score امتیاز (1-5)
     * @param reviewText متن نظر (اختیاری)
     * @return نظر ایجاد شده
     * @throws IllegalArgumentException در صورت ورودی‌های نامعتبر یا تکراری بودن
     * @throws NotFoundException در صورت عدم وجود کاربر یا رستوران
     */
    public Rating createRating(Long userId, Long restaurantId, Integer score, String reviewText) {
<span class="fc" id="L121">        logger.info(&quot;Creating rating: userId={}, restaurantId={}, score={}&quot;, userId, restaurantId, score);</span>
        
        // اعتبارسنجی ورودی‌ها
<span class="fc" id="L124">        validateRatingInputs(userId, restaurantId, score);</span>
        
        // دریافت کاربر و رستوران
<span class="fc" id="L127">        User user = authRepository.findById(userId)</span>
<span class="fc" id="L128">            .orElseThrow(() -&gt; new NotFoundException(&quot;User&quot;, userId));</span>
<span class="fc" id="L129">        Restaurant restaurant = restaurantRepository.findById(restaurantId)</span>
<span class="fc" id="L130">            .orElseThrow(() -&gt; new NotFoundException(&quot;Restaurant&quot;, restaurantId));</span>
        
        // بررسی عدم وجود نظر قبلی از همین کاربر
<span class="fc" id="L133">        Optional&lt;Rating&gt; existingRating = ratingRepository.findByUserAndRestaurant(user, restaurant);</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">        if (existingRating.isPresent()) {</span>
<span class="fc" id="L135">            throw new IllegalArgumentException(&quot;User has already rated this restaurant. Use update instead.&quot;);</span>
        }
        
        // بررسی عدم نظردهی مالک به رستوران خودش
<span class="fc bfc" id="L139" title="All 2 branches covered.">        if (restaurant.getOwnerId().equals(userId)) {</span>
<span class="fc" id="L140">            throw new IllegalArgumentException(&quot;Restaurant owners cannot rate their own restaurants&quot;);</span>
        }
        
        // ایجاد و ذخیره نظر
<span class="fc" id="L144">        Rating rating = new Rating(user, restaurant, score, reviewText);</span>
<span class="fc" id="L145">        Rating savedRating = ratingRepository.save(rating);</span>
        
<span class="fc" id="L147">        logger.info(&quot;Created rating with ID: {}&quot;, savedRating.getId());</span>
<span class="fc" id="L148">        return savedRating;</span>
    }
    
    /**
     * به‌روزرسانی نظر موجود
     * 
     * کاربران می‌توانند امتیاز و/یا متن نظر خود را ویرایش کنند
     * 
     * @param ratingId شناسه نظر
     * @param newScore امتیاز جدید (اختیاری)
     * @param newReviewText متن نظر جدید (اختیاری)
     * @return نظر به‌روزرسانی شده
     * @throws IllegalArgumentException در صورت ورودی‌های نامعتبر
     * @throws NotFoundException در صورت عدم وجود نظر
     */
    public Rating updateRating(Long ratingId, Integer newScore, String newReviewText) {
<span class="fc" id="L164">        logger.info(&quot;Updating rating: ratingId={}, newScore={}&quot;, ratingId, newScore);</span>
        
        // اعتبارسنجی ورودی‌ها
<span class="fc bfc" id="L167" title="All 2 branches covered.">        if (ratingId == null) {</span>
<span class="fc" id="L168">            throw new IllegalArgumentException(&quot;Rating ID cannot be null&quot;);</span>
        }
<span class="fc bfc" id="L170" title="All 6 branches covered.">        if (newScore != null &amp;&amp; (newScore &lt; 1 || newScore &gt; 5)) {</span>
<span class="fc" id="L171">            throw new IllegalArgumentException(&quot;Rating score must be between 1 and 5&quot;);</span>
        }
        
        // دریافت نظر موجود
<span class="fc" id="L175">        Rating rating = ratingRepository.findById(ratingId)</span>
<span class="fc" id="L176">            .orElseThrow(() -&gt; new NotFoundException(&quot;Rating&quot;, ratingId));</span>
        
        // به‌روزرسانی نظر
<span class="fc bfc" id="L179" title="All 2 branches covered.">        if (newScore != null) {</span>
<span class="fc" id="L180">            rating.updateRating(newScore, newReviewText);</span>
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">        } else if (newReviewText != null) {</span>
<span class="fc" id="L182">            rating.setReviewText(newReviewText);</span>
        }
        
<span class="fc" id="L185">        Rating updatedRating = ratingRepository.save(rating);</span>
<span class="fc" id="L186">        logger.info(&quot;Updated rating with ID: {}&quot;, updatedRating.getId());</span>
<span class="fc" id="L187">        return updatedRating;</span>
    }
    
    /**
     * دریافت نظر بر اساس شناسه
     * 
     * @param ratingId شناسه نظر
     * @return نظر یافت شده
     * @throws IllegalArgumentException در صورت null بودن ID
     * @throws NotFoundException در صورت عدم وجود نظر
     */
    public Rating getRating(Long ratingId) {
<span class="fc bfc" id="L199" title="All 2 branches covered.">        if (ratingId == null) {</span>
<span class="fc" id="L200">            throw new IllegalArgumentException(&quot;Rating ID cannot be null&quot;);</span>
        }
        
<span class="fc" id="L203">        return ratingRepository.findById(ratingId)</span>
<span class="fc" id="L204">            .orElseThrow(() -&gt; new NotFoundException(&quot;Rating&quot;, ratingId));</span>
    }
    
    /**
     * دریافت تمام نظرات رستوران خاص
     * 
     * @param restaurantId شناسه رستوران
     * @return لیست نظرات رستوران
     * @throws IllegalArgumentException در صورت null بودن ID
     * @throws NotFoundException در صورت عدم وجود رستوران
     */
    public List&lt;Rating&gt; getRestaurantRatings(Long restaurantId) {
<span class="fc bfc" id="L216" title="All 2 branches covered.">        if (restaurantId == null) {</span>
<span class="fc" id="L217">            throw new IllegalArgumentException(&quot;Restaurant ID cannot be null&quot;);</span>
        }
        
<span class="fc" id="L220">        Restaurant restaurant = restaurantRepository.findById(restaurantId)</span>
<span class="fc" id="L221">            .orElseThrow(() -&gt; new NotFoundException(&quot;Restaurant&quot;, restaurantId));</span>
        
<span class="fc" id="L223">        return ratingRepository.findByRestaurant(restaurant);</span>
    }
    
    /**
     * دریافت تمام نظرات ثبت شده توسط کاربر
     * 
     * @param userId شناسه کاربر
     * @return لیست نظرات کاربر
     * @throws IllegalArgumentException در صورت null بودن ID
     * @throws NotFoundException در صورت عدم وجود کاربر
     */
    public List&lt;Rating&gt; getUserRatings(Long userId) {
<span class="fc bfc" id="L235" title="All 2 branches covered.">        if (userId == null) {</span>
<span class="fc" id="L236">            throw new IllegalArgumentException(&quot;User ID cannot be null&quot;);</span>
        }
        
<span class="fc" id="L239">        User user = authRepository.findById(userId)</span>
<span class="fc" id="L240">            .orElseThrow(() -&gt; new NotFoundException(&quot;User&quot;, userId));</span>
        
<span class="fc" id="L242">        return ratingRepository.findByUser(user);</span>
    }
    
    /**
     * دریافت آمار کامل امتیازات رستوران
     * 
     * شامل میانگین امتیاز، تعداد کل نظرات و توزیع امتیازات
     * 
     * @param restaurantId شناسه رستوران
     * @return آمار امتیازات رستوران
     * @throws IllegalArgumentException در صورت null بودن ID
     * @throws NotFoundException در صورت عدم وجود رستوران
     */
    public RatingStats getRestaurantRatingStats(Long restaurantId) {
<span class="fc bfc" id="L256" title="All 2 branches covered.">        if (restaurantId == null) {</span>
<span class="fc" id="L257">            throw new IllegalArgumentException(&quot;Restaurant ID cannot be null&quot;);</span>
        }
        
<span class="fc" id="L260">        Restaurant restaurant = restaurantRepository.findById(restaurantId)</span>
<span class="fc" id="L261">            .orElseThrow(() -&gt; new NotFoundException(&quot;Restaurant&quot;, restaurantId));</span>
        
<span class="fc" id="L263">        Double averageRating = ratingRepository.getAverageRating(restaurant);</span>
<span class="fc" id="L264">        Long totalRatings = ratingRepository.getRatingCount(restaurant);</span>
<span class="fc" id="L265">        Map&lt;Integer, Long&gt; distribution = ratingRepository.getRatingDistribution(restaurant);</span>
        
<span class="fc" id="L267">        return new RatingStats(averageRating, totalRatings, distribution);</span>
    }
    
    /**
     * بررسی اینکه آیا کاربر به رستوران نظر داده است
     * 
     * @param userId شناسه کاربر
     * @param restaurantId شناسه رستوران
     * @return true اگر کاربر نظر داده باشد، false در غیر این صورت
     */
    public boolean hasUserRatedRestaurant(Long userId, Long restaurantId) {
<span class="fc bfc" id="L278" title="All 4 branches covered.">        if (userId == null || restaurantId == null) {</span>
<span class="fc" id="L279">            return false;</span>
        }
        
        try {
<span class="fc" id="L283">            User user = authRepository.findById(userId).orElse(null);</span>
<span class="fc" id="L284">            Restaurant restaurant = restaurantRepository.findById(restaurantId).orElse(null);</span>
            
<span class="fc bfc" id="L286" title="All 4 branches covered.">            if (user == null || restaurant == null) {</span>
<span class="fc" id="L287">                return false;</span>
            }
            
<span class="fc" id="L290">            return ratingRepository.findByUserAndRestaurant(user, restaurant).isPresent();</span>
<span class="nc" id="L291">        } catch (Exception e) {</span>
<span class="nc" id="L292">            logger.error(&quot;Error checking if user {} rated restaurant {}: {}&quot;, userId, restaurantId, e.getMessage());</span>
<span class="nc" id="L293">            return false;</span>
        }
    }
    
    /**
     * دریافت نظر کاربر برای رستوران خاص
     * 
     * @param userId شناسه کاربر
     * @param restaurantId شناسه رستوران
     * @return Optional حاوی نظر کاربر یا empty
     */
    public Optional&lt;Rating&gt; getUserRatingForRestaurant(Long userId, Long restaurantId) {
<span class="fc bfc" id="L305" title="All 4 branches covered.">        if (userId == null || restaurantId == null) {</span>
<span class="fc" id="L306">            return Optional.empty();</span>
        }
        
        try {
<span class="fc" id="L310">            User user = authRepository.findById(userId).orElse(null);</span>
<span class="fc" id="L311">            Restaurant restaurant = restaurantRepository.findById(restaurantId).orElse(null);</span>
            
<span class="pc bpc" id="L313" title="2 of 4 branches missed.">            if (user == null || restaurant == null) {</span>
<span class="nc" id="L314">                return Optional.empty();</span>
            }
            
<span class="fc" id="L317">            return ratingRepository.findByUserAndRestaurant(user, restaurant);</span>
<span class="nc" id="L318">        } catch (Exception e) {</span>
<span class="nc" id="L319">            logger.error(&quot;Error getting user {} rating for restaurant {}: {}&quot;, userId, restaurantId, e.getMessage());</span>
<span class="nc" id="L320">            return Optional.empty();</span>
        }
    }
    
    /**
     * حذف نظر (فقط توسط صاحب نظر)
     * 
     * کاربران فقط می‌توانند نظرات خودشان را حذف کنند
     * 
     * @param ratingId شناسه نظر
     * @param userId شناسه کاربر درخواست‌کننده حذف
     * @return true در صورت حذف موفق، false در غیر این صورت
     * @throws IllegalArgumentException در صورت null بودن IDs یا عدم مجوز
     * @throws NotFoundException در صورت عدم وجود نظر
     */
    public boolean deleteRating(Long ratingId, Long userId) {
<span class="fc" id="L336">        logger.info(&quot;Deleting rating: ratingId={}, userId={}&quot;, ratingId, userId);</span>
        
<span class="fc bfc" id="L338" title="All 4 branches covered.">        if (ratingId == null || userId == null) {</span>
<span class="fc" id="L339">            throw new IllegalArgumentException(&quot;Rating ID and User ID cannot be null&quot;);</span>
        }
        
<span class="fc" id="L342">        Rating rating = ratingRepository.findById(ratingId)</span>
<span class="fc" id="L343">            .orElseThrow(() -&gt; new NotFoundException(&quot;Rating&quot;, ratingId));</span>
        
        // بررسی مالکیت نظر
<span class="fc bfc" id="L346" title="All 2 branches covered.">        if (!rating.getUser().getId().equals(userId)) {</span>
<span class="fc" id="L347">            throw new IllegalArgumentException(&quot;Users can only delete their own ratings&quot;);</span>
        }
        
<span class="fc" id="L350">        boolean deleted = ratingRepository.delete(ratingId);</span>
<span class="pc bpc" id="L351" title="1 of 2 branches missed.">        if (deleted) {</span>
<span class="fc" id="L352">            logger.info(&quot;Deleted rating with ID: {}&quot;, ratingId);</span>
        }
<span class="fc" id="L354">        return deleted;</span>
    }
    
    /**
     * علامت‌گذاری نظر به عنوان مفید
     * 
     * افزایش شمارنده &quot;مفید بودن&quot; نظر توسط سایر کاربران
     * 
     * @param ratingId شناسه نظر
     * @return نظر به‌روزرسانی شده
     * @throws IllegalArgumentException در صورت null بودن ID
     * @throws NotFoundException در صورت عدم وجود نظر
     */
    public Rating markAsHelpful(Long ratingId) {
<span class="fc bfc" id="L368" title="All 2 branches covered.">        if (ratingId == null) {</span>
<span class="fc" id="L369">            throw new IllegalArgumentException(&quot;Rating ID cannot be null&quot;);</span>
        }
        
<span class="fc" id="L372">        Rating rating = ratingRepository.findById(ratingId)</span>
<span class="pc" id="L373">            .orElseThrow(() -&gt; new NotFoundException(&quot;Rating&quot;, ratingId));</span>
        
<span class="fc" id="L375">        rating.incrementHelpfulCount();</span>
<span class="fc" id="L376">        return ratingRepository.save(rating);</span>
    }
    
    /**
     * حذف علامت مفید از نظر
     * 
     * کاهش شمارنده &quot;مفید بودن&quot; نظر
     * 
     * @param ratingId شناسه نظر
     * @return نظر به‌روزرسانی شده
     * @throws IllegalArgumentException در صورت null بودن ID
     * @throws NotFoundException در صورت عدم وجود نظر
     */
    public Rating removeHelpfulMark(Long ratingId) {
<span class="fc bfc" id="L390" title="All 2 branches covered.">        if (ratingId == null) {</span>
<span class="fc" id="L391">            throw new IllegalArgumentException(&quot;Rating ID cannot be null&quot;);</span>
        }
        
<span class="fc" id="L394">        Rating rating = ratingRepository.findById(ratingId)</span>
<span class="pc" id="L395">            .orElseThrow(() -&gt; new NotFoundException(&quot;Rating&quot;, ratingId));</span>
        
<span class="fc" id="L397">        rating.decrementHelpfulCount();</span>
<span class="fc" id="L398">        return ratingRepository.save(rating);</span>
    }
    
    /**
     * تایید نظر (فقط توسط ادمین)
     * 
     * نظرات تایید شده اعتبار بیشتری دارند
     * 
     * @param ratingId شناسه نظر
     * @return نظر تایید شده
     * @throws IllegalArgumentException در صورت null بودن ID
     * @throws NotFoundException در صورت عدم وجود نظر
     */
    public Rating verifyRating(Long ratingId) {
<span class="pc bpc" id="L412" title="1 of 2 branches missed.">        if (ratingId == null) {</span>
<span class="nc" id="L413">            throw new IllegalArgumentException(&quot;Rating ID cannot be null&quot;);</span>
        }
        
<span class="fc" id="L416">        Rating rating = ratingRepository.findById(ratingId)</span>
<span class="pc" id="L417">            .orElseThrow(() -&gt; new NotFoundException(&quot;Rating&quot;, ratingId));</span>
        
<span class="fc" id="L419">        rating.verify();</span>
<span class="fc" id="L420">        Rating verifiedRating = ratingRepository.save(rating);</span>
<span class="fc" id="L421">        logger.info(&quot;Verified rating with ID: {}&quot;, ratingId);</span>
<span class="fc" id="L422">        return verifiedRating;</span>
    }
    
    /**
     * لغو تایید نظر (فقط توسط ادمین)
     * 
     * @param ratingId شناسه نظر
     * @return نظر با تایید لغو شده
     * @throws IllegalArgumentException در صورت null بودن ID
     * @throws NotFoundException در صورت عدم وجود نظر
     */
    public Rating unverifyRating(Long ratingId) {
<span class="pc bpc" id="L434" title="1 of 2 branches missed.">        if (ratingId == null) {</span>
<span class="nc" id="L435">            throw new IllegalArgumentException(&quot;Rating ID cannot be null&quot;);</span>
        }
        
<span class="fc" id="L438">        Rating rating = ratingRepository.findById(ratingId)</span>
<span class="pc" id="L439">            .orElseThrow(() -&gt; new NotFoundException(&quot;Rating&quot;, ratingId));</span>
        
<span class="fc" id="L441">        rating.unverify();</span>
<span class="fc" id="L442">        Rating unverifiedRating = ratingRepository.save(rating);</span>
<span class="fc" id="L443">        logger.info(&quot;Unverified rating with ID: {}&quot;, ratingId);</span>
<span class="fc" id="L444">        return unverifiedRating;</span>
    }
    
    /**
     * دریافت نظرات در بازه امتیاز مشخص
     * 
     * @param minScore حداقل امتیاز (1-5)
     * @param maxScore حداکثر امتیاز (1-5)
     * @return لیست نظرات در بازه امتیاز
     * @throws IllegalArgumentException در صورت بازه نامعتبر
     */
    public List&lt;Rating&gt; getRatingsByScore(int minScore, int maxScore) {
<span class="fc bfc" id="L456" title="All 6 branches covered.">        if (minScore &lt; 1 || maxScore &gt; 5 || minScore &gt; maxScore) {</span>
<span class="fc" id="L457">            throw new IllegalArgumentException(&quot;Invalid score range. Must be between 1-5 and minScore &lt;= maxScore&quot;);</span>
        }
        
<span class="fc" id="L460">        return ratingRepository.findByScoreRange(minScore, maxScore);</span>
    }
    
    /**
     * دریافت نظرات تایید شده
     * 
     * @return لیست نظرات تایید شده توسط ادمین
     */
    public List&lt;Rating&gt; getVerifiedRatings() {
<span class="fc" id="L469">        return ratingRepository.findVerifiedRatings();</span>
    }
    
    /**
     * دریافت نظراتی که متن نظر دارند
     * 
     * نظراتی که علاوه بر امتیاز، توضیحات متنی نیز ارائه داده‌اند
     * 
     * @return لیست نظرات دارای متن
     */
    public List&lt;Rating&gt; getRatingsWithReviews() {
<span class="fc" id="L480">        return ratingRepository.findRatingsWithReviews();</span>
    }
    
    /**
     * دریافت نظرات اخیر (در چند روز گذشته)
     * 
     * @param days تعداد روزهای گذشته
     * @return لیست نظرات اخیر
     * @throws IllegalArgumentException در صورت تعداد روز منفی یا صفر
     */
    public List&lt;Rating&gt; getRecentRatings(int days) {
<span class="fc bfc" id="L491" title="All 2 branches covered.">        if (days &lt; 1) {</span>
<span class="fc" id="L492">            throw new IllegalArgumentException(&quot;Days must be positive&quot;);</span>
        }
        
<span class="fc" id="L495">        return ratingRepository.findRecentRatings(days);</span>
    }
    
    /**
     * دریافت تمام نظرات (فقط برای ادمین)
     * 
     * @return لیست تمام نظرات سیستم
     */
    public List&lt;Rating&gt; getAllRatings() {
<span class="fc" id="L504">        return ratingRepository.findAll();</span>
    }
    
    /**
     * دریافت نظرات با صفحه‌بندی
     * 
     * برای بهبود عملکرد در صفحات مدیریت
     * 
     * @param page شماره صفحه (شروع از 0)
     * @param size تعداد رکورد در هر صفحه
     * @return لیست نظرات با صفحه‌بندی
     * @throws IllegalArgumentException در صورت پارامترهای نامعتبر
     */
    public List&lt;Rating&gt; getRatingsWithPagination(int page, int size) {
<span class="fc bfc" id="L518" title="All 4 branches covered.">        if (page &lt; 0 || size &lt; 1) {</span>
<span class="fc" id="L519">            throw new IllegalArgumentException(&quot;Page must be non-negative and size must be positive&quot;);</span>
        }
        
<span class="fc" id="L522">        int offset = page * size;</span>
<span class="fc" id="L523">        return ratingRepository.findWithPagination(offset, size);</span>
    }
    
    /**
     * دریافت تعداد کل نظرات سیستم
     * 
     * @return تعداد کل نظرات
     */
    public Long getTotalRatingCount() {
<span class="fc" id="L532">        return ratingRepository.countAll();</span>
    }
    
    // Private helper methods
    
    /**
     * اعتبارسنجی ورودی‌های ایجاد نظر
     * 
     * @param userId شناسه کاربر
     * @param restaurantId شناسه رستوران
     * @param score امتیاز
     * @throws IllegalArgumentException در صورت ورودی‌های نامعتبر
     */
    private void validateRatingInputs(Long userId, Long restaurantId, Integer score) {
<span class="fc bfc" id="L546" title="All 2 branches covered.">        if (userId == null) {</span>
<span class="fc" id="L547">            throw new IllegalArgumentException(&quot;User ID cannot be null&quot;);</span>
        }
<span class="fc bfc" id="L549" title="All 2 branches covered.">        if (restaurantId == null) {</span>
<span class="fc" id="L550">            throw new IllegalArgumentException(&quot;Restaurant ID cannot be null&quot;);</span>
        }
<span class="fc bfc" id="L552" title="All 6 branches covered.">        if (score == null || score &lt; 1 || score &gt; 5) {</span>
<span class="fc" id="L553">            throw new IllegalArgumentException(&quot;Rating score must be between 1 and 5&quot;);</span>
        }
<span class="fc" id="L555">    }</span>
    
    /**
     * کلاس آمار امتیازات رستوران
     * 
     * این کلاس اطلاعات آماری کاملی از امتیازات رستوران ارائه می‌دهد:
     * - میانگین امتیاز
     * - تعداد کل نظرات
     * - توزیع امتیازات (تعداد هر امتیاز از 1 تا 5)
     * - متدهای کمکی برای نمایش و بررسی
     */
    public static class RatingStats {
        /** میانگین امتیاز رستوران */
        private final Double averageRating;
        /** تعداد کل نظرات */
        private final Long totalRatings;
        /** توزیع امتیازات (امتیاز -&gt; تعداد) */
        private final Map&lt;Integer, Long&gt; distribution;
        
        /**
         * سازنده کلاس آمار
         * 
         * @param averageRating میانگین امتیاز
         * @param totalRatings تعداد کل نظرات
         * @param distribution توزیع امتیازات
         */
<span class="fc" id="L581">        public RatingStats(Double averageRating, Long totalRatings, Map&lt;Integer, Long&gt; distribution) {</span>
<span class="fc bfc" id="L582" title="All 2 branches covered.">            this.averageRating = averageRating != null ? averageRating : 0.0;</span>
<span class="fc bfc" id="L583" title="All 2 branches covered.">            this.totalRatings = totalRatings != null ? totalRatings : 0L;</span>
<span class="fc bfc" id="L584" title="All 2 branches covered.">            this.distribution = distribution != null ? distribution : Map.of();</span>
<span class="fc" id="L585">        }</span>
        
        /** دریافت میانگین امتیاز */
        public Double getAverageRating() {
<span class="fc" id="L589">            return averageRating;</span>
        }
        
        /** دریافت تعداد کل نظرات */
        public Long getTotalRatings() {
<span class="fc" id="L594">            return totalRatings;</span>
        }
        
        /** دریافت توزیع امتیازات */
        public Map&lt;Integer, Long&gt; getDistribution() {
<span class="fc" id="L599">            return distribution;</span>
        }
        
        /** دریافت میانگین امتیاز با فرمت یک رقم اعشار */
        public String getAverageRatingFormatted() {
<span class="fc" id="L604">            return String.format(&quot;%.1f&quot;, averageRating);</span>
        }
        
        /** بررسی وجود نظر برای رستوران */
        public boolean hasRatings() {
<span class="fc bfc" id="L609" title="All 2 branches covered.">            return totalRatings &gt; 0;</span>
        }
        
        @Override
        public String toString() {
<span class="fc" id="L614">            return &quot;RatingStats{&quot; +</span>
                    &quot;averageRating=&quot; + averageRating +
                    &quot;, totalRatings=&quot; + totalRatings +
                    &quot;, distribution=&quot; + distribution +
                    '}';
        }
    }
} 
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>