<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RatingController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.review</a> &gt; <span class="el_source">RatingController.java</span></div><h1>RatingController.java</h1><pre class="source lang-java linenums">package com.myapp.review;

import com.myapp.common.exceptions.NotFoundException;
import com.myapp.common.models.Rating;
import com.myapp.common.utils.JsonUtil;
import com.sun.net.httpserver.HttpExchange;
import com.sun.net.httpserver.HttpHandler;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.io.OutputStream;
import java.net.URLDecoder;
import java.nio.charset.StandardCharsets;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * Controller REST API برای مدیریت نظرات و امتیازدهی
 * 
 * این کلاس تمام endpoints مربوط به عملیات نظرات و امتیازات را ارائه می‌دهد:
 * 
 * === GET Endpoints (دریافت اطلاعات) ===
 * GET    /api/ratings                      - دریافت تمام نظرات
 * GET    /api/ratings/{id}                 - دریافت نظر بر اساس شناسه
 * GET    /api/ratings/restaurant?restaurantId={id} - دریافت نظرات رستوران خاص
 * GET    /api/ratings/stats?restaurantId={id}      - دریافت آمار امتیازات رستوران
 * 
 * === POST Endpoints (ایجاد) ===
 * POST   /api/ratings                      - ایجاد نظر و امتیاز جدید
 * 
 * === PUT Endpoints (به‌روزرسانی) ===
 * PUT    /api/ratings/{id}                 - به‌روزرسانی نظر موجود
 * 
 * === ویژگی‌های کلیدی ===
 * - JSON Request/Response Processing: پردازش JSON برای همه endpoints
 * - Query Parameter Support: پشتیبانی از query parameters
 * - Path Parameter Extraction: استخراج پارامترها از URL path
 * - Error Handling: مدیریت خطاها با HTTP status codes مناسب
 * - URL Decoding: رمزگشایی URL برای query parameters
 * - Request Validation: اعتبارسنجی درخواست‌ها
 * - Business Logic Delegation: تفویض منطق کسب‌وکار به Service
 * - RESTful Design: طراحی مطابق اصول REST
 * 
 * === Request/Response Examples ===
 * 
 * **POST /api/ratings** - ایجاد نظر:
 * ```json
 * {
 *   &quot;userId&quot;: 1,
 *   &quot;restaurantId&quot;: 5,
 *   &quot;score&quot;: 4,
 *   &quot;reviewText&quot;: &quot;غذای خوبی بود&quot;
 * }
 * ```
 * 
 * **PUT /api/ratings/123** - به‌روزرسانی نظر:
 * ```json
 * {
 *   &quot;score&quot;: 5,
 *   &quot;reviewText&quot;: &quot;غذای عالی بود&quot;
 * }
 * ```
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 */
public class RatingController implements HttpHandler {
    
    /** Logger برای ثبت عملیات و خطاها */
<span class="fc" id="L73">    private static final Logger logger = LoggerFactory.getLogger(RatingController.class);</span>
    /** سرویس منطق کسب‌وکار نظرات */
    private final RatingService ratingService;
    
    /**
     * سازنده پیش‌فرض - RatingService را ایجاد می‌کند
     */
<span class="fc" id="L80">    public RatingController() {</span>
<span class="fc" id="L81">        this.ratingService = new RatingService();</span>
<span class="fc" id="L82">    }</span>
    
    /**
     * سازنده برای تزریق وابستگی (برای تست‌ها)
     * 
     * @param ratingService سرویس نظرات
     */
<span class="fc" id="L89">    public RatingController(RatingService ratingService) {</span>
<span class="fc" id="L90">        this.ratingService = ratingService;</span>
<span class="fc" id="L91">    }</span>
    
    /**
     * متد اصلی پردازش HTTP requests
     * 
     * این متد requests را بر اساس HTTP method به متدهای مناسب هدایت می‌کند
     * 
     * @param exchange شیء HttpExchange حاوی اطلاعات request و response
     * @throws IOException در صورت خطا در ورودی/خروجی
     */
    @Override
    public void handle(HttpExchange exchange) throws IOException {
<span class="fc" id="L103">        String method = exchange.getRequestMethod();</span>
<span class="fc" id="L104">        String path = exchange.getRequestURI().getPath();</span>
        
<span class="fc" id="L106">        logger.info(&quot;Handling {} request to {}&quot;, method, path);</span>
        
        try {
<span class="fc bfc" id="L109" title="All 4 branches covered.">            switch (method) {</span>
<span class="fc" id="L110">                case &quot;GET&quot; -&gt; handleGet(exchange, path);</span>
<span class="fc" id="L111">                case &quot;POST&quot; -&gt; handlePost(exchange, path);</span>
<span class="fc" id="L112">                case &quot;PUT&quot; -&gt; handlePut(exchange, path);</span>
<span class="fc" id="L113">                default -&gt; sendResponse(exchange, 405, Map.of(&quot;error&quot;, &quot;Method not allowed&quot;));</span>
            }
<span class="fc" id="L115">        } catch (Exception e) {</span>
<span class="fc" id="L116">            logger.error(&quot;Error handling request: {}&quot;, e.getMessage(), e);</span>
<span class="fc" id="L117">            sendResponse(exchange, 500, Map.of(&quot;error&quot;, &quot;Internal server error&quot;));</span>
<span class="fc" id="L118">        }</span>
<span class="fc" id="L119">    }</span>
    
    /**
     * پردازش تمام GET requests
     * 
     * این متد path و query parameters را بررسی کرده و درخواست را به handler مناسب ارسال می‌کند
     * 
     * @param exchange شیء HttpExchange
     * @param path مسیر درخواست
     * @throws IOException در صورت خطا در ورودی/خروجی
     */
    private void handleGet(HttpExchange exchange, String path) throws IOException {
<span class="fc" id="L131">        String query = exchange.getRequestURI().getQuery();</span>
<span class="fc" id="L132">        Map&lt;String, String&gt; params = parseQueryParams(query);</span>
        
        try {
<span class="fc bfc" id="L135" title="All 2 branches covered.">            if (path.equals(&quot;/api/ratings&quot;)) {</span>
                // GET /api/ratings - دریافت تمام نظرات
<span class="fc" id="L137">                handleGetAllRatings(exchange, params);</span>
<span class="fc bfc" id="L138" title="All 2 branches covered.">            } else if (path.matches(&quot;/api/ratings/\\d+&quot;)) {</span>
                // GET /api/ratings/{id} - دریافت نظر بر اساس شناسه
<span class="fc" id="L140">                Long ratingId = extractIdFromPath(path);</span>
<span class="fc" id="L141">                handleGetRating(exchange, ratingId);</span>
<span class="fc bfc" id="L142" title="All 2 branches covered.">            } else if (path.equals(&quot;/api/ratings/restaurant&quot;)) {</span>
                // GET /api/ratings/restaurant?restaurantId={id} - دریافت نظرات رستوران
<span class="fc" id="L144">                String restaurantIdStr = params.get(&quot;restaurantId&quot;);</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">                if (restaurantIdStr == null) {</span>
<span class="fc" id="L146">                    sendResponse(exchange, 400, Map.of(&quot;error&quot;, &quot;Restaurant ID is required&quot;));</span>
<span class="fc" id="L147">                    return;</span>
                }
<span class="fc" id="L149">                Long restaurantId = Long.parseLong(restaurantIdStr);</span>
<span class="fc" id="L150">                handleGetRestaurantRatings(exchange, restaurantId);</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">            } else if (path.equals(&quot;/api/ratings/stats&quot;)) {</span>
                // GET /api/ratings/stats?restaurantId={id} - دریافت آمار امتیازات
<span class="fc" id="L153">                String restaurantIdStr = params.get(&quot;restaurantId&quot;);</span>
<span class="fc bfc" id="L154" title="All 2 branches covered.">                if (restaurantIdStr == null) {</span>
<span class="fc" id="L155">                    sendResponse(exchange, 400, Map.of(&quot;error&quot;, &quot;Restaurant ID is required&quot;));</span>
<span class="fc" id="L156">                    return;</span>
                }
<span class="fc" id="L158">                Long restaurantId = Long.parseLong(restaurantIdStr);</span>
<span class="fc" id="L159">                handleGetRatingStats(exchange, restaurantId);</span>
<span class="fc" id="L160">            } else {</span>
<span class="fc" id="L161">                sendResponse(exchange, 404, Map.of(&quot;error&quot;, &quot;Endpoint not found&quot;));</span>
            }
<span class="fc" id="L163">        } catch (NumberFormatException e) {</span>
            // خطای فرمت عددی
<span class="fc" id="L165">            sendResponse(exchange, 400, Map.of(&quot;error&quot;, &quot;Invalid number format&quot;));</span>
<span class="nc" id="L166">        } catch (IllegalArgumentException e) {</span>
            // خطای ورودی نامعتبر
<span class="nc" id="L168">            sendResponse(exchange, 400, Map.of(&quot;error&quot;, &quot;Bad request&quot;));</span>
<span class="fc" id="L169">        } catch (NotFoundException e) {</span>
            // خطای عدم وجود resource
<span class="fc" id="L171">            sendResponse(exchange, 404, Map.of(&quot;error&quot;, &quot;Not found&quot;));</span>
<span class="pc" id="L172">        }</span>
<span class="fc" id="L173">    }</span>
    
    /**
     * پردازش تمام POST requests
     * 
     * @param exchange شیء HttpExchange
     * @param path مسیر درخواست
     * @throws IOException در صورت خطا در ورودی/خروجی
     */
    private void handlePost(HttpExchange exchange, String path) throws IOException {
        try {
<span class="fc bfc" id="L184" title="All 2 branches covered.">            if (path.equals(&quot;/api/ratings&quot;)) {</span>
                // POST /api/ratings - ایجاد نظر جدید
<span class="fc" id="L186">                handleCreateRating(exchange);</span>
            } else {
<span class="fc" id="L188">                sendResponse(exchange, 404, Map.of(&quot;error&quot;, &quot;Endpoint not found&quot;));</span>
            }
<span class="fc" id="L190">        } catch (Exception e) {</span>
<span class="fc" id="L191">            sendResponse(exchange, 400, Map.of(&quot;error&quot;, &quot;Bad request&quot;));</span>
<span class="fc" id="L192">        }</span>
<span class="fc" id="L193">    }</span>
    
    /**
     * پردازش تمام PUT requests
     * 
     * @param exchange شیء HttpExchange
     * @param path مسیر درخواست
     * @throws IOException در صورت خطا در ورودی/خروجی
     */
    private void handlePut(HttpExchange exchange, String path) throws IOException {
        try {
<span class="fc bfc" id="L204" title="All 2 branches covered.">            if (path.matches(&quot;/api/ratings/\\d+&quot;)) {</span>
                // PUT /api/ratings/{id} - به‌روزرسانی نظر
<span class="fc" id="L206">                Long ratingId = extractIdFromPath(path);</span>
<span class="fc" id="L207">                handleUpdateRating(exchange, ratingId);</span>
<span class="fc" id="L208">            } else {</span>
<span class="fc" id="L209">                sendResponse(exchange, 404, Map.of(&quot;error&quot;, &quot;Endpoint not found&quot;));</span>
            }
<span class="fc" id="L211">        } catch (Exception e) {</span>
<span class="fc" id="L212">            sendResponse(exchange, 400, Map.of(&quot;error&quot;, &quot;Bad request&quot;));</span>
<span class="fc" id="L213">        }</span>
<span class="fc" id="L214">    }</span>
    
    /**
     * پردازش ایجاد نظر جدید
     * 
     * Request Body JSON Fields:
     * - userId (required): شناسه کاربر نظردهنده
     * - restaurantId (required): شناسه رستوران
     * - score (required): امتیاز (1-5)
     * - reviewText (optional): متن نظر
     * 
     * @param exchange شیء HttpExchange
     * @throws IOException در صورت خطا در ورودی/خروجی
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    private void handleCreateRating(HttpExchange exchange) throws IOException {
<span class="fc" id="L230">        String requestBody = new String(exchange.getRequestBody().readAllBytes(), StandardCharsets.UTF_8);</span>
<span class="fc" id="L231">        Map&lt;String, Object&gt; request = JsonUtil.fromJson(requestBody, Map.class);</span>
        
<span class="fc" id="L233">        Long userId = ((Number) request.get(&quot;userId&quot;)).longValue();</span>
<span class="fc" id="L234">        Long restaurantId = ((Number) request.get(&quot;restaurantId&quot;)).longValue();</span>
<span class="fc" id="L235">        Integer score = ((Number) request.get(&quot;score&quot;)).intValue();</span>
<span class="fc" id="L236">        String reviewText = (String) request.get(&quot;reviewText&quot;);</span>
        
<span class="fc" id="L238">        Rating rating = ratingService.createRating(userId, restaurantId, score, reviewText);</span>
<span class="fc" id="L239">        sendResponse(exchange, 201, rating);</span>
<span class="fc" id="L240">    }</span>
    
    /**
     * پردازش به‌روزرسانی نظر موجود
     * 
     * Request Body JSON Fields (همه اختیاری):
     * - score: امتیاز جدید (1-5)
     * - reviewText: متن نظر جدید
     * 
     * @param exchange شیء HttpExchange
     * @param ratingId شناسه نظر
     * @throws IOException در صورت خطا در ورودی/خروجی
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    private void handleUpdateRating(HttpExchange exchange, Long ratingId) throws IOException {
<span class="fc" id="L255">        String requestBody = new String(exchange.getRequestBody().readAllBytes(), StandardCharsets.UTF_8);</span>
<span class="fc" id="L256">        Map&lt;String, Object&gt; request = JsonUtil.fromJson(requestBody, Map.class);</span>
        
<span class="fc bfc" id="L258" title="All 2 branches covered.">        Integer newScore = request.get(&quot;score&quot;) != null ? ((Number) request.get(&quot;score&quot;)).intValue() : null;</span>
<span class="fc" id="L259">        String newReviewText = (String) request.get(&quot;reviewText&quot;);</span>
        
<span class="fc" id="L261">        Rating rating = ratingService.updateRating(ratingId, newScore, newReviewText);</span>
<span class="fc" id="L262">        sendResponse(exchange, 200, rating);</span>
<span class="fc" id="L263">    }</span>
    
    /**
     * دریافت نظر بر اساس شناسه
     * 
     * @param exchange شیء HttpExchange
     * @param ratingId شناسه نظر
     * @throws IOException در صورت خطا در ورودی/خروجی
     */
    private void handleGetRating(HttpExchange exchange, Long ratingId) throws IOException {
<span class="fc" id="L273">        Rating rating = ratingService.getRating(ratingId);</span>
<span class="fc" id="L274">        sendResponse(exchange, 200, rating);</span>
<span class="fc" id="L275">    }</span>
    
    /**
     * دریافت تمام نظرات (برای مدیریت)
     * 
     * @param exchange شیء HttpExchange
     * @param params پارامترهای query (آینده: pagination)
     * @throws IOException در صورت خطا در ورودی/خروجی
     */
    private void handleGetAllRatings(HttpExchange exchange, Map&lt;String, String&gt; params) throws IOException {
<span class="fc" id="L285">        List&lt;Rating&gt; ratings = ratingService.getAllRatings();</span>
<span class="fc" id="L286">        sendResponse(exchange, 200, ratings);</span>
<span class="fc" id="L287">    }</span>
    
    /**
     * دریافت تمام نظرات رستوران خاص
     * 
     * @param exchange شیء HttpExchange
     * @param restaurantId شناسه رستوران
     * @throws IOException در صورت خطا در ورودی/خروجی
     */
    private void handleGetRestaurantRatings(HttpExchange exchange, Long restaurantId) throws IOException {
<span class="fc" id="L297">        List&lt;Rating&gt; ratings = ratingService.getRestaurantRatings(restaurantId);</span>
<span class="fc" id="L298">        sendResponse(exchange, 200, ratings);</span>
<span class="fc" id="L299">    }</span>
    
    /**
     * دریافت آمار امتیازات رستوران
     * 
     * Response شامل:
     * - averageRating: میانگین امتیاز
     * - totalRatings: تعداد کل نظرات
     * - distribution: توزیع امتیازات (1-5)
     * 
     * @param exchange شیء HttpExchange
     * @param restaurantId شناسه رستوران
     * @throws IOException در صورت خطا در ورودی/خروجی
     */
    private void handleGetRatingStats(HttpExchange exchange, Long restaurantId) throws IOException {
<span class="fc" id="L314">        RatingService.RatingStats stats = ratingService.getRestaurantRatingStats(restaurantId);</span>
<span class="fc" id="L315">        sendResponse(exchange, 200, stats);</span>
<span class="fc" id="L316">    }</span>
    
    /**
     * استخراج شناسه از انتهای path
     * 
     * مثال: &quot;/api/ratings/123&quot; -&gt; 123
     * 
     * @param path مسیر URL
     * @return شناسه استخراج شده
     */
    private Long extractIdFromPath(String path) {
<span class="fc" id="L327">        String[] parts = path.split(&quot;/&quot;);</span>
<span class="fc" id="L328">        return Long.parseLong(parts[parts.length - 1]);</span>
    }
    
    /**
     * پارس کردن query parameters از URL
     * 
     * این متد query string را پارس کرده و پارامترها را URL decode می‌کند
     * 
     * @param query رشته query parameters
     * @return Map حاوی پارامترهای پارس شده
     */
    private Map&lt;String, String&gt; parseQueryParams(String query) {
<span class="fc" id="L340">        Map&lt;String, String&gt; params = new HashMap&lt;&gt;();</span>
<span class="pc bpc" id="L341" title="1 of 4 branches missed.">        if (query != null &amp;&amp; !query.isEmpty()) {</span>
<span class="fc" id="L342">            String[] pairs = query.split(&quot;&amp;&quot;);</span>
<span class="fc bfc" id="L343" title="All 2 branches covered.">            for (String pair : pairs) {</span>
<span class="fc" id="L344">                String[] keyValue = pair.split(&quot;=&quot;, 2);</span>
<span class="fc bfc" id="L345" title="All 2 branches covered.">                if (keyValue.length == 2) {</span>
                    try {
                        // URL decode برای پشتیبانی از کاراکترهای خاص
<span class="fc" id="L348">                        String key = URLDecoder.decode(keyValue[0], StandardCharsets.UTF_8);</span>
<span class="fc" id="L349">                        String value = URLDecoder.decode(keyValue[1], StandardCharsets.UTF_8);</span>
<span class="fc" id="L350">                        params.put(key, value);</span>
<span class="nc" id="L351">                    } catch (Exception e) {</span>
<span class="nc" id="L352">                        logger.warn(&quot;Failed to decode query parameter: {}&quot;, pair);</span>
<span class="fc" id="L353">                    }</span>
                }
            }
        }
<span class="fc" id="L357">        return params;</span>
    }
    
    /**
     * ارسال پاسخ JSON با status code مشخص
     * 
     * @param exchange شیء HttpExchange
     * @param statusCode کد وضعیت HTTP
     * @param data داده برای serialize کردن به JSON
     * @throws IOException در صورت خطا در ورودی/خروجی
     */
    private void sendResponse(HttpExchange exchange, int statusCode, Object data) throws IOException {
<span class="fc" id="L369">        String response = JsonUtil.toJson(data);</span>
<span class="fc" id="L370">        exchange.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<span class="fc" id="L371">        exchange.sendResponseHeaders(statusCode, response.getBytes(StandardCharsets.UTF_8).length);</span>
        
<span class="fc" id="L373">        try (OutputStream os = exchange.getResponseBody()) {</span>
<span class="fc" id="L374">            os.write(response.getBytes(StandardCharsets.UTF_8));</span>
        }
<span class="fc" id="L376">    }</span>
} 
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>