<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AdminController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.admin</a> &gt; <span class="el_source">AdminController.java</span></div><h1>AdminController.java</h1><pre class="source lang-java linenums">package com.myapp.admin;

import com.myapp.common.exceptions.NotFoundException;
import com.myapp.common.models.*;
import com.myapp.common.utils.JsonUtil;
import com.sun.net.httpserver.HttpExchange;
import com.sun.net.httpserver.HttpHandler;

import java.io.IOException;
import java.io.OutputStream;
import java.net.URI;
import java.util.List;
import java.util.Map;
import java.util.HashMap;

/**
 * REST API Controller لپنل مدیریت (Admin Dashboard)
 * 
 * این کلاس تمام endpoints API مربوط به عملیات مدیریتی سیستم سفارش غذا را پیاده‌سازی می‌کند:
 * 
 * === Dashboard و آمار کلی ===
 * GET    /api/admin/dashboard                         - دریافت آمار dashboard
 * GET    /api/admin/statistics/daily                  - آمار روزانه
 * GET    /api/admin/statistics/users                  - آمار کاربران بر اساس نقش
 * GET    /api/admin/statistics/restaurants            - آمار رستوران‌ها بر اساس وضعیت
 * GET    /api/admin/statistics/orders                 - آمار سفارشات بر اساس وضعیت
 * 
 * === مدیریت کاربران (User Management) ===
 * GET    /api/admin/users                             - دریافت تمام کاربران با فیلتر
 * GET    /api/admin/users/{userId}                    - دریافت کاربر با شناسه
 * PUT    /api/admin/users/{userId}/status             - تغییر وضعیت کاربر
 * 
 * === مدیریت رستوران‌ها (Restaurant Management) ===
 * GET    /api/admin/restaurants                       - دریافت تمام رستوران‌ها با فیلتر
 * GET    /api/admin/restaurants/{restaurantId}        - دریافت رستوران با شناسه
 * PUT    /api/admin/restaurants/{restaurantId}/status - تغییر وضعیت رستوران
 * 
 * === مدیریت سفارشات (Order Management) ===
 * GET    /api/admin/orders                            - دریافت تمام سفارشات با فیلتر
 * GET    /api/admin/orders/{orderId}                  - دریافت سفارش با شناسه
 * PUT    /api/admin/orders/{orderId}/status           - تغییر وضعیت سفارش
 * 
 * === مدیریت تراکنش‌ها (Transaction Management) ===
 * GET    /api/admin/transactions                      - دریافت تمام تراکنش‌ها با فیلتر
 * GET    /api/admin/transactions/{transactionId}      - دریافت تراکنش با شناسه
 * 
 * === مدیریت تحویل (Delivery Management) ===
 * GET    /api/admin/deliveries                        - دریافت تمام تحویل‌ها با فیلتر
 * GET    /api/admin/deliveries/{deliveryId}           - دریافت تحویل با شناسه
 * 
 * === ویژگی‌های کلیدی ===
 * - RESTful API Design: طراحی API مبتنی بر استانداردهای REST
 * - Comprehensive Filtering: فیلترهای جامع برای همه endpoints
 * - Pagination Support: پشتیبانی از صفحه‌بندی
 * - Security Filtering: فیلتر کردن فیلدهای حساس
 * - Error Handling: مدیریت جامع خطاها
 * - CORS Support: پشتیبانی از Cross-Origin Resource Sharing
 * - JSON Response Format: فرمت پاسخ JSON استاندارد
 * - Query Parameter Parsing: پردازش پارامترهای query
 * - Path Parameter Extraction: استخراج پارامترهای path
 * - HTTP Status Codes: کدهای وضعیت HTTP مناسب
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 */
public class AdminController implements HttpHandler {
    
    /** سرویس لایه منطق کسب‌وکار مدیریت */
    private final AdminService adminService;
    
    /**
     * سازنده با تزریق AdminService
     * 
     * @param adminService سرویس عملیات مدیریتی
     */
<span class="fc" id="L77">    public AdminController(AdminService adminService) {</span>
<span class="fc" id="L78">        this.adminService = adminService;</span>
<span class="fc" id="L79">    }</span>
    
    @Override
    public void handle(HttpExchange exchange) throws IOException {
<span class="fc" id="L83">        String method = exchange.getRequestMethod();</span>
<span class="fc" id="L84">        String path = exchange.getRequestURI().getPath();</span>
        
        try {
            // مسیریابی درخواست‌ها بر اساس path و method
<span class="pc bpc" id="L88" title="1 of 4 branches missed.">            if (path.equals(&quot;/api/admin/dashboard&quot;) &amp;&amp; &quot;GET&quot;.equals(method)) {</span>
<span class="fc" id="L89">                getDashboardStatistics(exchange);</span>
<span class="pc bpc" id="L90" title="1 of 4 branches missed.">            } else if (path.equals(&quot;/api/admin/users&quot;) &amp;&amp; &quot;GET&quot;.equals(method)) {</span>
<span class="fc" id="L91">                getAllUsers(exchange);</span>
<span class="pc bpc" id="L92" title="1 of 4 branches missed.">            } else if (path.matches(&quot;/api/admin/users/\\d+&quot;) &amp;&amp; &quot;GET&quot;.equals(method)) {</span>
<span class="fc" id="L93">                getUserById(exchange);</span>
<span class="pc bpc" id="L94" title="1 of 4 branches missed.">            } else if (path.matches(&quot;/api/admin/users/\\d+/status&quot;) &amp;&amp; &quot;PUT&quot;.equals(method)) {</span>
<span class="fc" id="L95">                updateUserStatus(exchange);</span>
<span class="pc bpc" id="L96" title="1 of 4 branches missed.">            } else if (path.equals(&quot;/api/admin/restaurants&quot;) &amp;&amp; &quot;GET&quot;.equals(method)) {</span>
<span class="fc" id="L97">                getAllRestaurants(exchange);</span>
<span class="pc bpc" id="L98" title="3 of 4 branches missed.">            } else if (path.matches(&quot;/api/admin/restaurants/\\d+&quot;) &amp;&amp; &quot;GET&quot;.equals(method)) {</span>
<span class="nc" id="L99">                getRestaurantById(exchange);</span>
<span class="pc bpc" id="L100" title="1 of 4 branches missed.">            } else if (path.matches(&quot;/api/admin/restaurants/\\d+/status&quot;) &amp;&amp; &quot;PUT&quot;.equals(method)) {</span>
<span class="fc" id="L101">                updateRestaurantStatus(exchange);</span>
<span class="pc bpc" id="L102" title="1 of 4 branches missed.">            } else if (path.equals(&quot;/api/admin/orders&quot;) &amp;&amp; &quot;GET&quot;.equals(method)) {</span>
<span class="fc" id="L103">                getAllOrders(exchange);</span>
<span class="pc bpc" id="L104" title="3 of 4 branches missed.">            } else if (path.matches(&quot;/api/admin/orders/\\d+&quot;) &amp;&amp; &quot;GET&quot;.equals(method)) {</span>
<span class="nc" id="L105">                getOrderById(exchange);</span>
<span class="pc bpc" id="L106" title="1 of 4 branches missed.">            } else if (path.matches(&quot;/api/admin/orders/\\d+/status&quot;) &amp;&amp; &quot;PUT&quot;.equals(method)) {</span>
<span class="fc" id="L107">                updateOrderStatus(exchange);</span>
<span class="pc bpc" id="L108" title="1 of 4 branches missed.">            } else if (path.equals(&quot;/api/admin/transactions&quot;) &amp;&amp; &quot;GET&quot;.equals(method)) {</span>
<span class="fc" id="L109">                getAllTransactions(exchange);</span>
<span class="pc bpc" id="L110" title="1 of 4 branches missed.">            } else if (path.matches(&quot;/api/admin/transactions/\\d+&quot;) &amp;&amp; &quot;GET&quot;.equals(method)) {</span>
<span class="fc" id="L111">                getTransactionById(exchange);</span>
<span class="pc bpc" id="L112" title="1 of 4 branches missed.">            } else if (path.equals(&quot;/api/admin/deliveries&quot;) &amp;&amp; &quot;GET&quot;.equals(method)) {</span>
<span class="fc" id="L113">                getAllDeliveries(exchange);</span>
<span class="pc bpc" id="L114" title="1 of 4 branches missed.">            } else if (path.matches(&quot;/api/admin/deliveries/\\d+&quot;) &amp;&amp; &quot;GET&quot;.equals(method)) {</span>
<span class="fc" id="L115">                getDeliveryById(exchange);</span>
<span class="pc bpc" id="L116" title="1 of 4 branches missed.">            } else if (path.equals(&quot;/api/admin/statistics/daily&quot;) &amp;&amp; &quot;GET&quot;.equals(method)) {</span>
<span class="fc" id="L117">                getDailyStatistics(exchange);</span>
<span class="pc bpc" id="L118" title="1 of 4 branches missed.">            } else if (path.equals(&quot;/api/admin/statistics/users&quot;) &amp;&amp; &quot;GET&quot;.equals(method)) {</span>
<span class="fc" id="L119">                getUserStatistics(exchange);</span>
<span class="pc bpc" id="L120" title="1 of 4 branches missed.">            } else if (path.equals(&quot;/api/admin/statistics/restaurants&quot;) &amp;&amp; &quot;GET&quot;.equals(method)) {</span>
<span class="fc" id="L121">                getRestaurantStatistics(exchange);</span>
<span class="pc bpc" id="L122" title="1 of 4 branches missed.">            } else if (path.equals(&quot;/api/admin/statistics/orders&quot;) &amp;&amp; &quot;GET&quot;.equals(method)) {</span>
<span class="fc" id="L123">                getOrderStatistics(exchange);</span>
            } else {
<span class="fc" id="L125">                sendResponse(exchange, 404, &quot;{\&quot;error\&quot;:\&quot;Endpoint not found\&quot;}&quot;);</span>
            }
<span class="fc" id="L127">        } catch (NotFoundException e) {</span>
<span class="fc" id="L128">            sendResponse(exchange, 404, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="fc" id="L129">        } catch (IllegalArgumentException e) {</span>
<span class="fc" id="L130">            sendResponse(exchange, 400, &quot;{\&quot;error\&quot;:\&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="fc" id="L131">        } catch (Exception e) {</span>
<span class="fc" id="L132">            e.printStackTrace();</span>
<span class="fc" id="L133">            sendResponse(exchange, 500, &quot;{\&quot;error\&quot;:\&quot;Internal server error: &quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="fc" id="L134">        }</span>
<span class="fc" id="L135">    }</span>

    // ==================== Dashboard و آمار کلی (DASHBOARD) ====================
    
    /**
     * GET /api/admin/dashboard - دریافت آمار dashboard
     * 
     * این endpoint آمار کلی سیستم را برای نمایش در صفحه اصلی پنل مدیریت برمی‌گرداند
     * شامل: تعداد کاربران، رستوران‌ها، سفارشات، درآمد کل، سفارشات امروز و ...
     * 
     * @param exchange شیء HttpExchange
     * @throws IOException در صورت خطا در I/O
     */
    private void getDashboardStatistics(HttpExchange exchange) throws IOException {
<span class="fc" id="L149">        AdminRepository.SystemStatistics stats = adminService.getSystemStatistics();</span>
        
        // ساخت پاسخ JSON
<span class="fc" id="L152">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="fc" id="L153">        response.put(&quot;totalUsers&quot;, stats.getTotalUsers());</span>
<span class="fc" id="L154">        response.put(&quot;totalRestaurants&quot;, stats.getTotalRestaurants());</span>
<span class="fc" id="L155">        response.put(&quot;totalOrders&quot;, stats.getTotalOrders());</span>
<span class="fc" id="L156">        response.put(&quot;totalDeliveries&quot;, stats.getTotalDeliveries());</span>
<span class="fc" id="L157">        response.put(&quot;totalRevenue&quot;, stats.getTotalRevenue());</span>
<span class="fc" id="L158">        response.put(&quot;totalRefunds&quot;, stats.getTotalRefunds());</span>
<span class="fc" id="L159">        response.put(&quot;todayOrders&quot;, stats.getTodayOrders());</span>
<span class="fc" id="L160">        response.put(&quot;todayRevenue&quot;, stats.getTodayRevenue());</span>
<span class="fc" id="L161">        response.put(&quot;activeRestaurants&quot;, stats.getActiveRestaurants());</span>
<span class="fc" id="L162">        response.put(&quot;pendingOrders&quot;, stats.getPendingOrders());</span>
<span class="fc" id="L163">        response.put(&quot;activeDeliveries&quot;, stats.getActiveDeliveries());</span>
        
<span class="fc" id="L165">        String responseBody = JsonUtil.toJson(response);</span>
<span class="fc" id="L166">        sendResponse(exchange, 200, responseBody);</span>
<span class="fc" id="L167">    }</span>

    // ==================== مدیریت کاربران (USER MANAGEMENT) ====================
    
    /**
     * GET /api/admin/users - دریافت تمام کاربران با فیلتر
     * 
     * پارامترهای query قابل قبول:
     * - search: عبارت جستجو در نام، ایمیل و تلفن
     * - role: فیلتر بر اساس نقش (CUSTOMER, ADMIN, VENDOR, COURIER)
     * - page: شماره صفحه (پیش‌فرض 0)
     * - size: تعداد رکورد در صفحه (پیش‌فرض 20)
     * 
     * @param exchange شیء HttpExchange
     * @throws IOException در صورت خطا در I/O
     */
    private void getAllUsers(HttpExchange exchange) throws IOException {
<span class="fc" id="L184">        URI uri = exchange.getRequestURI();</span>
<span class="fc" id="L185">        Map&lt;String, String&gt; params = parseQueryParameters(uri.getQuery());</span>
        
        // استخراج پارامترها
<span class="fc" id="L188">        String searchTerm = params.get(&quot;search&quot;);</span>
<span class="fc" id="L189">        String role = params.get(&quot;role&quot;);</span>
<span class="fc" id="L190">        int page = parseIntParam(params.get(&quot;page&quot;), 0);</span>
<span class="fc" id="L191">        int size = parseIntParam(params.get(&quot;size&quot;), 20);</span>
        
        // دریافت کاربران و تعداد کل
<span class="fc" id="L194">        List&lt;User&gt; users = adminService.getAllUsers(searchTerm, role, page, size);</span>
<span class="fc" id="L195">        Long totalCount = adminService.countUsers(searchTerm, role);</span>
        
        // فیلتر کردن فیلدهای حساس برای امنیت
<span class="fc" id="L198">        List&lt;Map&lt;String, Object&gt;&gt; safeUsers = users.stream().map(user -&gt; {</span>
<span class="fc" id="L199">            Map&lt;String, Object&gt; safeUser = new HashMap&lt;&gt;();</span>
<span class="fc" id="L200">            safeUser.put(&quot;id&quot;, user.getId());</span>
<span class="fc" id="L201">            safeUser.put(&quot;fullName&quot;, user.getFullName());</span>
<span class="fc" id="L202">            safeUser.put(&quot;phone&quot;, user.getPhone());</span>
<span class="fc" id="L203">            safeUser.put(&quot;email&quot;, user.getEmail());</span>
<span class="fc" id="L204">            safeUser.put(&quot;role&quot;, user.getRole());</span>
<span class="fc" id="L205">            safeUser.put(&quot;address&quot;, user.getAddress());</span>
<span class="fc" id="L206">            safeUser.put(&quot;isActive&quot;, user.getIsActive());</span>
            // عمداً رمز عبور هش شده را برای امنیت حذف می‌کنیم
<span class="fc" id="L208">            return safeUser;</span>
<span class="fc" id="L209">        }).toList();</span>
        
        // ساخت پاسخ با pagination metadata
<span class="fc" id="L212">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="fc" id="L213">        response.put(&quot;users&quot;, safeUsers);</span>
<span class="fc" id="L214">        response.put(&quot;totalCount&quot;, totalCount);</span>
<span class="fc" id="L215">        response.put(&quot;page&quot;, page);</span>
<span class="fc" id="L216">        response.put(&quot;size&quot;, size);</span>
<span class="fc" id="L217">        response.put(&quot;totalPages&quot;, (int) Math.ceil((double) totalCount / size));</span>
        
<span class="fc" id="L219">        String responseBody = JsonUtil.toJson(response);</span>
<span class="fc" id="L220">        sendResponse(exchange, 200, responseBody);</span>
<span class="fc" id="L221">    }</span>
    
    /**
     * GET /api/admin/users/{userId} - دریافت کاربر با شناسه
     * 
     * @param exchange شیء HttpExchange
     * @throws IOException در صورت خطا در I/O
     */
    private void getUserById(HttpExchange exchange) throws IOException {
<span class="fc" id="L230">        Long userId = extractIdFromPath(exchange.getRequestURI().getPath(), &quot;/api/admin/users/&quot;);</span>
<span class="fc" id="L231">        User user = adminService.getUserById(userId);</span>
        
        // فیلتر کردن فیلدهای حساس برای امنیت
<span class="fc" id="L234">        Map&lt;String, Object&gt; safeUser = new HashMap&lt;&gt;();</span>
<span class="fc" id="L235">        safeUser.put(&quot;id&quot;, user.getId());</span>
<span class="fc" id="L236">        safeUser.put(&quot;fullName&quot;, user.getFullName());</span>
<span class="fc" id="L237">        safeUser.put(&quot;phone&quot;, user.getPhone());</span>
<span class="fc" id="L238">        safeUser.put(&quot;email&quot;, user.getEmail());</span>
<span class="fc" id="L239">        safeUser.put(&quot;role&quot;, user.getRole());</span>
<span class="fc" id="L240">        safeUser.put(&quot;address&quot;, user.getAddress());</span>
<span class="fc" id="L241">        safeUser.put(&quot;isActive&quot;, user.getIsActive());</span>
        // عمداً رمز عبور هش شده را برای امنیت حذف می‌کنیم
        
<span class="fc" id="L244">        String responseBody = JsonUtil.toJson(safeUser);</span>
<span class="fc" id="L245">        sendResponse(exchange, 200, responseBody);</span>
<span class="fc" id="L246">    }</span>
    
    /**
     * PUT /api/admin/users/{userId}/status - تغییر وضعیت کاربر
     * 
     * Body JSON مورد نیاز:
     * {
     *   &quot;isActive&quot;: true/false,
     *   &quot;adminId&quot;: شناسه ادمین درخواست‌کننده
     * }
     * 
     * @param exchange شیء HttpExchange
     * @throws IOException در صورت خطا در I/O
     */
    private void updateUserStatus(HttpExchange exchange) throws IOException {
<span class="fc" id="L261">        Long userId = extractIdFromPath(exchange.getRequestURI().getPath(), &quot;/api/admin/users/&quot;, &quot;/status&quot;);</span>
        
        // خواندن و پردازش JSON body
<span class="fc" id="L264">        String requestBody = new String(exchange.getRequestBody().readAllBytes());</span>
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L266">        Map&lt;String, Object&gt; request = JsonUtil.fromJson(requestBody, Map.class);</span>
        
<span class="fc" id="L268">        Boolean isActive = (Boolean) request.get(&quot;isActive&quot;);</span>
<span class="fc" id="L269">        Long adminId = extractLong(request, &quot;adminId&quot;);</span>
        
<span class="pc bpc" id="L271" title="1 of 2 branches missed.">        if (isActive == null) {</span>
<span class="nc" id="L272">            throw new IllegalArgumentException(&quot;isActive field is required&quot;);</span>
        }
        
<span class="fc" id="L275">        adminService.updateUserStatus(userId, isActive, adminId);</span>
        
<span class="fc" id="L277">        sendResponse(exchange, 200, &quot;{\&quot;message\&quot;:\&quot;User status updated successfully\&quot;}&quot;);</span>
<span class="fc" id="L278">    }</span>

    // ==================== مدیریت رستوران‌ها (RESTAURANT MANAGEMENT) ====================
    
    /**
     * GET /api/admin/restaurants - دریافت تمام رستوران‌ها با فیلتر
     * 
     * پارامترهای query قابل قبول:
     * - search: عبارت جستجو در نام و آدرس رستوران
     * - status: فیلتر بر اساس وضعیت (ACTIVE, INACTIVE, PENDING_APPROVAL)
     * - page: شماره صفحه
     * - size: تعداد رکورد در صفحه
     * 
     * @param exchange شیء HttpExchange
     * @throws IOException در صورت خطا در I/O
     */
    private void getAllRestaurants(HttpExchange exchange) throws IOException {
<span class="fc" id="L295">        URI uri = exchange.getRequestURI();</span>
<span class="fc" id="L296">        Map&lt;String, String&gt; params = parseQueryParameters(uri.getQuery());</span>
        
<span class="fc" id="L298">        String searchTerm = params.get(&quot;search&quot;);</span>
<span class="fc" id="L299">        String status = params.get(&quot;status&quot;);</span>
<span class="fc" id="L300">        int page = parseIntParam(params.get(&quot;page&quot;), 0);</span>
<span class="fc" id="L301">        int size = parseIntParam(params.get(&quot;size&quot;), 20);</span>
        
<span class="fc" id="L303">        List&lt;Restaurant&gt; restaurants = adminService.getAllRestaurants(searchTerm, status, page, size);</span>
<span class="fc" id="L304">        Long totalCount = adminService.countRestaurants(searchTerm, status);</span>
        
<span class="fc" id="L306">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="fc" id="L307">        response.put(&quot;restaurants&quot;, restaurants);</span>
<span class="fc" id="L308">        response.put(&quot;totalCount&quot;, totalCount);</span>
<span class="fc" id="L309">        response.put(&quot;page&quot;, page);</span>
<span class="fc" id="L310">        response.put(&quot;size&quot;, size);</span>
<span class="fc" id="L311">        response.put(&quot;totalPages&quot;, (int) Math.ceil((double) totalCount / size));</span>
        
<span class="fc" id="L313">        String responseBody = JsonUtil.toJson(response);</span>
<span class="fc" id="L314">        sendResponse(exchange, 200, responseBody);</span>
<span class="fc" id="L315">    }</span>
    
    /**
     * GET /api/admin/restaurants/{restaurantId} - دریافت رستوران با شناسه
     * 
     * @param exchange شیء HttpExchange
     * @throws IOException در صورت خطا در I/O
     */
    private void getRestaurantById(HttpExchange exchange) throws IOException {
<span class="nc" id="L324">        Long restaurantId = extractIdFromPath(exchange.getRequestURI().getPath(), &quot;/api/admin/restaurants/&quot;);</span>
<span class="nc" id="L325">        Restaurant restaurant = adminService.getRestaurantById(restaurantId);</span>
        
<span class="nc" id="L327">        String responseBody = JsonUtil.toJson(restaurant);</span>
<span class="nc" id="L328">        sendResponse(exchange, 200, responseBody);</span>
<span class="nc" id="L329">    }</span>
    
    /**
     * PUT /api/admin/restaurants/{restaurantId}/status - تغییر وضعیت رستوران
     * 
     * Body JSON مورد نیاز:
     * {
     *   &quot;status&quot;: &quot;ACTIVE&quot; | &quot;INACTIVE&quot; | &quot;PENDING_APPROVAL&quot;,
     *   &quot;adminId&quot;: شناسه ادمین درخواست‌کننده
     * }
     * 
     * @param exchange شیء HttpExchange
     * @throws IOException در صورت خطا در I/O
     */
    private void updateRestaurantStatus(HttpExchange exchange) throws IOException {
<span class="fc" id="L344">        Long restaurantId = extractIdFromPath(exchange.getRequestURI().getPath(), &quot;/api/admin/restaurants/&quot;, &quot;/status&quot;);</span>
        
<span class="fc" id="L346">        String requestBody = new String(exchange.getRequestBody().readAllBytes());</span>
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L348">        Map&lt;String, Object&gt; request = JsonUtil.fromJson(requestBody, Map.class);</span>
        
<span class="fc" id="L350">        String status = (String) request.get(&quot;status&quot;);</span>
<span class="fc" id="L351">        Long adminId = extractLong(request, &quot;adminId&quot;);</span>
        
<span class="pc bpc" id="L353" title="2 of 4 branches missed.">        if (status == null || status.trim().isEmpty()) {</span>
<span class="nc" id="L354">            throw new IllegalArgumentException(&quot;status field is required&quot;);</span>
        }
        
        // تبدیل string به enum
        RestaurantStatus statusEnum;
        try {
<span class="fc" id="L360">            statusEnum = RestaurantStatus.valueOf(status.toUpperCase());</span>
<span class="nc" id="L361">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L362">            throw new IllegalArgumentException(&quot;Invalid restaurant status: &quot; + status);</span>
<span class="fc" id="L363">        }</span>
        
<span class="fc" id="L365">        adminService.updateRestaurantStatus(restaurantId, statusEnum, adminId);</span>
        
<span class="fc" id="L367">        sendResponse(exchange, 200, &quot;{\&quot;message\&quot;:\&quot;Restaurant status updated successfully\&quot;}&quot;);</span>
<span class="fc" id="L368">    }</span>

    // ==================== مدیریت سفارشات (ORDER MANAGEMENT) ====================
    
    /**
     * GET /api/admin/orders - دریافت تمام سفارشات با فیلتر
     * 
     * پارامترهای query قابل قبول:
     * - search: عبارت جستجو در آدرس تحویل و شماره تلفن
     * - status: فیلتر بر اساس وضعیت سفارش
     * - customerId: شناسه مشتری
     * - restaurantId: شناسه رستوران
     * - page: شماره صفحه
     * - size: تعداد رکورد در صفحه
     * 
     * @param exchange شیء HttpExchange
     * @throws IOException در صورت خطا در I/O
     */
    private void getAllOrders(HttpExchange exchange) throws IOException {
<span class="fc" id="L387">        URI uri = exchange.getRequestURI();</span>
<span class="fc" id="L388">        Map&lt;String, String&gt; params = parseQueryParameters(uri.getQuery());</span>
        
<span class="fc" id="L390">        String searchTerm = params.get(&quot;search&quot;);</span>
<span class="fc" id="L391">        String status = params.get(&quot;status&quot;);</span>
<span class="fc" id="L392">        Long customerId = parseLongParam(params.get(&quot;customerId&quot;));</span>
<span class="fc" id="L393">        Long restaurantId = parseLongParam(params.get(&quot;restaurantId&quot;));</span>
<span class="fc" id="L394">        int page = parseIntParam(params.get(&quot;page&quot;), 0);</span>
<span class="fc" id="L395">        int size = parseIntParam(params.get(&quot;size&quot;), 20);</span>
        
<span class="fc" id="L397">        List&lt;Order&gt; orders = adminService.getAllOrders(searchTerm, status, customerId, restaurantId, page, size);</span>
<span class="fc" id="L398">        Long totalCount = adminService.countOrders(searchTerm, status, customerId, restaurantId);</span>
        
<span class="fc" id="L400">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="fc" id="L401">        response.put(&quot;orders&quot;, orders);</span>
<span class="fc" id="L402">        response.put(&quot;totalCount&quot;, totalCount);</span>
<span class="fc" id="L403">        response.put(&quot;page&quot;, page);</span>
<span class="fc" id="L404">        response.put(&quot;size&quot;, size);</span>
<span class="fc" id="L405">        response.put(&quot;totalPages&quot;, (int) Math.ceil((double) totalCount / size));</span>
        
<span class="fc" id="L407">        String responseBody = JsonUtil.toJson(response);</span>
<span class="fc" id="L408">        sendResponse(exchange, 200, responseBody);</span>
<span class="fc" id="L409">    }</span>
    
    /**
     * GET /api/admin/orders/{orderId} - دریافت سفارش با شناسه
     * 
     * @param exchange شیء HttpExchange
     * @throws IOException در صورت خطا در I/O
     */
    private void getOrderById(HttpExchange exchange) throws IOException {
<span class="nc" id="L418">        Long orderId = extractIdFromPath(exchange.getRequestURI().getPath(), &quot;/api/admin/orders/&quot;);</span>
<span class="nc" id="L419">        Order order = adminService.getOrderById(orderId);</span>
        
<span class="nc" id="L421">        String responseBody = JsonUtil.toJson(order);</span>
<span class="nc" id="L422">        sendResponse(exchange, 200, responseBody);</span>
<span class="nc" id="L423">    }</span>
    
    /**
     * PUT /api/admin/orders/{orderId}/status - تغییر وضعیت سفارش
     * 
     * این endpoint به ادمین اجازه تغییر دستی وضعیت سفارش را می‌دهد
     * 
     * Body JSON مورد نیاز:
     * {
     *   &quot;status&quot;: &quot;PENDING&quot; | &quot;CONFIRMED&quot; | &quot;PREPARING&quot; | &quot;READY&quot; | &quot;DELIVERED&quot; | &quot;CANCELLED&quot;,
     *   &quot;adminId&quot;: شناسه ادمین درخواست‌کننده
     * }
     * 
     * @param exchange شیء HttpExchange
     * @throws IOException در صورت خطا در I/O
     */
    private void updateOrderStatus(HttpExchange exchange) throws IOException {
<span class="fc" id="L440">        Long orderId = extractIdFromPath(exchange.getRequestURI().getPath(), &quot;/api/admin/orders/&quot;, &quot;/status&quot;);</span>
        
<span class="fc" id="L442">        String requestBody = new String(exchange.getRequestBody().readAllBytes());</span>
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L444">        Map&lt;String, Object&gt; request = JsonUtil.fromJson(requestBody, Map.class);</span>
        
<span class="fc" id="L446">        String status = (String) request.get(&quot;status&quot;);</span>
<span class="fc" id="L447">        Long adminId = extractLong(request, &quot;adminId&quot;);</span>
        
<span class="pc bpc" id="L449" title="2 of 4 branches missed.">        if (status == null || status.trim().isEmpty()) {</span>
<span class="nc" id="L450">            throw new IllegalArgumentException(&quot;status field is required&quot;);</span>
        }
        
        OrderStatus statusEnum;
        try {
<span class="fc" id="L455">            statusEnum = OrderStatus.valueOf(status.toUpperCase());</span>
<span class="nc" id="L456">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L457">            throw new IllegalArgumentException(&quot;Invalid order status: &quot; + status);</span>
<span class="fc" id="L458">        }</span>
        
<span class="fc" id="L460">        adminService.updateOrderStatus(orderId, statusEnum, adminId);</span>
        
<span class="fc" id="L462">        sendResponse(exchange, 200, &quot;{\&quot;message\&quot;:\&quot;Order status updated successfully\&quot;}&quot;);</span>
<span class="fc" id="L463">    }</span>

    // ==================== مدیریت تراکنش‌ها (TRANSACTION MANAGEMENT) ====================
    
    /**
     * GET /api/admin/transactions - دریافت تمام تراکنش‌ها با فیلتر
     * 
     * پارامترهای query قابل قبول:
     * - search: عبارت جستجو در شناسه مرجع، توضیحات و روش پرداخت
     * - status: فیلتر بر اساس وضعیت تراکنش
     * - type: فیلتر بر اساس نوع تراکنش (PAYMENT, REFUND, WALLET_CHARGE)
     * - userId: شناسه کاربر
     * - page: شماره صفحه
     * - size: تعداد رکورد در صفحه
     * 
     * @param exchange شیء HttpExchange
     * @throws IOException در صورت خطا در I/O
     */
    private void getAllTransactions(HttpExchange exchange) throws IOException {
<span class="fc" id="L482">        URI uri = exchange.getRequestURI();</span>
<span class="fc" id="L483">        Map&lt;String, String&gt; params = parseQueryParameters(uri.getQuery());</span>
        
<span class="fc" id="L485">        String searchTerm = params.get(&quot;search&quot;);</span>
<span class="fc" id="L486">        String status = params.get(&quot;status&quot;);</span>
<span class="fc" id="L487">        String type = params.get(&quot;type&quot;);</span>
<span class="fc" id="L488">        Long userId = parseLongParam(params.get(&quot;userId&quot;));</span>
<span class="fc" id="L489">        int page = parseIntParam(params.get(&quot;page&quot;), 0);</span>
<span class="fc" id="L490">        int size = parseIntParam(params.get(&quot;size&quot;), 20);</span>
        
<span class="fc" id="L492">        List&lt;Transaction&gt; transactions = adminService.getAllTransactions(searchTerm, status, type, userId, page, size);</span>
<span class="fc" id="L493">        Long totalCount = adminService.countTransactions(searchTerm, status, type, userId);</span>
        
<span class="fc" id="L495">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="fc" id="L496">        response.put(&quot;transactions&quot;, transactions);</span>
<span class="fc" id="L497">        response.put(&quot;totalCount&quot;, totalCount);</span>
<span class="fc" id="L498">        response.put(&quot;page&quot;, page);</span>
<span class="fc" id="L499">        response.put(&quot;size&quot;, size);</span>
<span class="fc" id="L500">        response.put(&quot;totalPages&quot;, (int) Math.ceil((double) totalCount / size));</span>
        
<span class="fc" id="L502">        String responseBody = JsonUtil.toJson(response);</span>
<span class="fc" id="L503">        sendResponse(exchange, 200, responseBody);</span>
<span class="fc" id="L504">    }</span>
    
    /**
     * GET /api/admin/transactions/{transactionId} - دریافت تراکنش با شناسه
     * 
     * @param exchange شیء HttpExchange
     * @throws IOException در صورت خطا در I/O
     */
    private void getTransactionById(HttpExchange exchange) throws IOException {
<span class="fc" id="L513">        Long transactionId = extractIdFromPath(exchange.getRequestURI().getPath(), &quot;/api/admin/transactions/&quot;);</span>
<span class="fc" id="L514">        Transaction transaction = adminService.getTransactionById(transactionId);</span>
        
<span class="fc" id="L516">        String responseBody = JsonUtil.toJson(transaction);</span>
<span class="fc" id="L517">        sendResponse(exchange, 200, responseBody);</span>
<span class="fc" id="L518">    }</span>

    // ==================== مدیریت تحویل (DELIVERY MANAGEMENT) ====================
    
    /**
     * GET /api/admin/deliveries - دریافت تمام تحویل‌ها با فیلتر
     * 
     * پارامترهای query قابل قبول:
     * - search: عبارت جستجو در یادداشت‌های تحویل
     * - status: فیلتر بر اساس وضعیت تحویل
     * - courierId: شناسه پیک
     * - page: شماره صفحه
     * - size: تعداد رکورد در صفحه
     * 
     * @param exchange شیء HttpExchange
     * @throws IOException در صورت خطا در I/O
     */
    private void getAllDeliveries(HttpExchange exchange) throws IOException {
<span class="fc" id="L536">        URI uri = exchange.getRequestURI();</span>
<span class="fc" id="L537">        Map&lt;String, String&gt; params = parseQueryParameters(uri.getQuery());</span>
        
<span class="fc" id="L539">        String searchTerm = params.get(&quot;search&quot;);</span>
<span class="fc" id="L540">        String status = params.get(&quot;status&quot;);</span>
<span class="fc" id="L541">        Long courierId = parseLongParam(params.get(&quot;courierId&quot;));</span>
<span class="fc" id="L542">        int page = parseIntParam(params.get(&quot;page&quot;), 0);</span>
<span class="fc" id="L543">        int size = parseIntParam(params.get(&quot;size&quot;), 20);</span>
        
<span class="fc" id="L545">        List&lt;Delivery&gt; deliveries = adminService.getAllDeliveries(searchTerm, status, courierId, page, size);</span>
<span class="fc" id="L546">        Long totalCount = adminService.countDeliveries(searchTerm, status, courierId);</span>
        
<span class="fc" id="L548">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="fc" id="L549">        response.put(&quot;deliveries&quot;, deliveries);</span>
<span class="fc" id="L550">        response.put(&quot;totalCount&quot;, totalCount);</span>
<span class="fc" id="L551">        response.put(&quot;page&quot;, page);</span>
<span class="fc" id="L552">        response.put(&quot;size&quot;, size);</span>
<span class="fc" id="L553">        response.put(&quot;totalPages&quot;, (int) Math.ceil((double) totalCount / size));</span>
        
<span class="fc" id="L555">        String responseBody = JsonUtil.toJson(response);</span>
<span class="fc" id="L556">        sendResponse(exchange, 200, responseBody);</span>
<span class="fc" id="L557">    }</span>
    
    /**
     * GET /api/admin/deliveries/{deliveryId} - دریافت تحویل با شناسه
     * 
     * @param exchange شیء HttpExchange
     * @throws IOException در صورت خطا در I/O
     */
    private void getDeliveryById(HttpExchange exchange) throws IOException {
<span class="fc" id="L566">        Long deliveryId = extractIdFromPath(exchange.getRequestURI().getPath(), &quot;/api/admin/deliveries/&quot;);</span>
<span class="fc" id="L567">        Delivery delivery = adminService.getDeliveryById(deliveryId);</span>
        
<span class="fc" id="L569">        String responseBody = JsonUtil.toJson(delivery);</span>
<span class="fc" id="L570">        sendResponse(exchange, 200, responseBody);</span>
<span class="fc" id="L571">    }</span>

    // ==================== آمار و گزارشات (STATISTICS) ====================
    
    /**
     * GET /api/admin/statistics/daily - دریافت آمار روزانه
     * 
     * پارامترهای query قابل قبول:
     * - days: تعداد روزهای گذشته (پیش‌فرض 7)
     * 
     * @param exchange شیء HttpExchange
     * @throws IOException در صورت خطا در I/O
     */
    private void getDailyStatistics(HttpExchange exchange) throws IOException {
<span class="fc" id="L585">        URI uri = exchange.getRequestURI();</span>
<span class="fc" id="L586">        Map&lt;String, String&gt; params = parseQueryParameters(uri.getQuery());</span>
        
<span class="fc" id="L588">        int days = parseIntParam(params.get(&quot;days&quot;), 7);</span>
        
<span class="fc" id="L590">        List&lt;AdminRepository.DailyStatistics&gt; stats = adminService.getDailyStatistics(days);</span>
        
<span class="fc" id="L592">        String responseBody = JsonUtil.toJson(stats);</span>
<span class="fc" id="L593">        sendResponse(exchange, 200, responseBody);</span>
<span class="fc" id="L594">    }</span>
    
    /**
     * GET /api/admin/statistics/users - دریافت آمار کاربران بر اساس نقش
     * 
     * برای نمایش نمودار توزیع نقش‌های کاربران
     * 
     * @param exchange شیء HttpExchange
     * @throws IOException در صورت خطا در I/O
     */
    private void getUserStatistics(HttpExchange exchange) throws IOException {
<span class="fc" id="L605">        Map&lt;User.Role, Long&gt; stats = adminService.getUserStatsByRole();</span>
        
<span class="fc" id="L607">        String responseBody = JsonUtil.toJson(stats);</span>
<span class="fc" id="L608">        sendResponse(exchange, 200, responseBody);</span>
<span class="fc" id="L609">    }</span>
    
    /**
     * GET /api/admin/statistics/restaurants - دریافت آمار رستوران‌ها بر اساس وضعیت
     * 
     * برای نمایش نمودار توزیع وضعیت رستوران‌ها
     * 
     * @param exchange شیء HttpExchange
     * @throws IOException در صورت خطا در I/O
     */
    private void getRestaurantStatistics(HttpExchange exchange) throws IOException {
<span class="fc" id="L620">        Map&lt;RestaurantStatus, Long&gt; stats = adminService.getRestaurantStatsByStatus();</span>
        
<span class="fc" id="L622">        String responseBody = JsonUtil.toJson(stats);</span>
<span class="fc" id="L623">        sendResponse(exchange, 200, responseBody);</span>
<span class="fc" id="L624">    }</span>
    
    /**
     * GET /api/admin/statistics/orders - دریافت آمار سفارشات بر اساس وضعیت
     * 
     * برای نمایش نمودار توزیع وضعیت سفارشات
     * 
     * @param exchange شیء HttpExchange
     * @throws IOException در صورت خطا در I/O
     */
    private void getOrderStatistics(HttpExchange exchange) throws IOException {
<span class="fc" id="L635">        Map&lt;OrderStatus, Long&gt; stats = adminService.getOrderStatsByStatus();</span>
        
<span class="fc" id="L637">        String responseBody = JsonUtil.toJson(stats);</span>
<span class="fc" id="L638">        sendResponse(exchange, 200, responseBody);</span>
<span class="fc" id="L639">    }</span>

    // ==================== متدهای کمکی (HELPER METHODS) ====================
    
    /**
     * پردازش پارامترهای query از رشته query
     * 
     * @param query رشته query از URL
     * @return Map حاوی پارامترها
     */
    private Map&lt;String, String&gt; parseQueryParameters(String query) {
<span class="fc" id="L650">        Map&lt;String, String&gt; params = new HashMap&lt;&gt;();</span>
<span class="pc bpc" id="L651" title="1 of 4 branches missed.">        if (query != null &amp;&amp; !query.isEmpty()) {</span>
<span class="fc" id="L652">            String[] pairs = query.split(&quot;&amp;&quot;);</span>
<span class="fc bfc" id="L653" title="All 2 branches covered.">            for (String pair : pairs) {</span>
<span class="fc" id="L654">                String[] keyValue = pair.split(&quot;=&quot;);</span>
<span class="pc bpc" id="L655" title="1 of 2 branches missed.">                if (keyValue.length == 2) {</span>
<span class="fc" id="L656">                    params.put(keyValue[0], keyValue[1]);</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">                } else if (keyValue.length == 1) {</span>
<span class="nc" id="L658">                    params.put(keyValue[0], &quot;&quot;);</span>
                }
            }
        }
<span class="fc" id="L662">        return params;</span>
    }
    
    /**
     * استخراج شناسه از path
     * 
     * @param path مسیر درخواست
     * @param prefix پیشوند path
     * @return شناسه استخراج شده
     */
    private Long extractIdFromPath(String path, String prefix) {
<span class="fc" id="L673">        String idStr = path.substring(prefix.length());</span>
<span class="fc" id="L674">        return Long.parseLong(idStr);</span>
    }
    
    /**
     * استخراج شناسه از path با پسوند
     * 
     * @param path مسیر درخواست
     * @param prefix پیشوند path
     * @param suffix پسوند path
     * @return شناسه استخراج شده
     */
    private Long extractIdFromPath(String path, String prefix, String suffix) {
<span class="fc" id="L686">        String pathWithoutPrefix = path.substring(prefix.length());</span>
<span class="fc" id="L687">        String idStr = pathWithoutPrefix.substring(0, pathWithoutPrefix.length() - suffix.length());</span>
<span class="fc" id="L688">        return Long.parseLong(idStr);</span>
    }
    
    /**
     * پردازش پارامتر integer با مقدار پیش‌فرض
     * 
     * @param param رشته پارامتر
     * @param defaultValue مقدار پیش‌فرض
     * @return مقدار integer پردازش شده
     */
    private int parseIntParam(String param, int defaultValue) {
<span class="pc bpc" id="L699" title="1 of 4 branches missed.">        if (param == null || param.trim().isEmpty()) {</span>
<span class="fc" id="L700">            return defaultValue;</span>
        }
        try {
<span class="fc" id="L703">            return Integer.parseInt(param);</span>
<span class="nc" id="L704">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L705">            return defaultValue;</span>
        }
    }
    
    /**
     * پردازش پارامتر Long اختیاری
     * 
     * @param param رشته پارامتر
     * @return مقدار Long یا null
     */
    private Long parseLongParam(String param) {
<span class="pc bpc" id="L716" title="3 of 4 branches missed.">        if (param == null || param.trim().isEmpty()) {</span>
<span class="fc" id="L717">            return null;</span>
        }
        try {
<span class="nc" id="L720">            return Long.parseLong(param);</span>
<span class="nc" id="L721">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L722">            return null;</span>
        }
    }
    
    /**
     * استخراج مقدار Long از Map درخواست
     * 
     * @param request Map حاوی داده‌های درخواست
     * @param key کلید مورد نظر
     * @return مقدار Long استخراج شده
     * @throws IllegalArgumentException در صورت عدم وجود یا نامعتبر بودن مقدار
     */
    private Long extractLong(Map&lt;String, Object&gt; request, String key) {
<span class="fc" id="L735">        Object value = request.get(key);</span>
<span class="pc bpc" id="L736" title="1 of 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L737">            throw new IllegalArgumentException(key + &quot; is required&quot;);</span>
        }
<span class="pc bpc" id="L739" title="1 of 2 branches missed.">        if (value instanceof Number) {</span>
<span class="fc" id="L740">            return ((Number) value).longValue();</span>
        }
<span class="nc bnc" id="L742" title="All 2 branches missed.">        if (value instanceof String) {</span>
            try {
<span class="nc" id="L744">                return Long.parseLong((String) value);</span>
<span class="nc" id="L745">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L746">                throw new IllegalArgumentException(&quot;Invalid &quot; + key + &quot; format&quot;);</span>
            }
        }
<span class="nc" id="L749">        throw new IllegalArgumentException(&quot;Invalid &quot; + key + &quot; type&quot;);</span>
    }
    
    /**
     * ارسال پاسخ HTTP
     * 
     * @param exchange شیء HttpExchange
     * @param statusCode کد وضعیت HTTP
     * @param response محتوای پاسخ JSON
     * @throws IOException در صورت خطا در I/O
     */
    private void sendResponse(HttpExchange exchange, int statusCode, String response) throws IOException {
        // تنظیم headers
<span class="fc" id="L762">        exchange.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<span class="fc" id="L763">        exchange.getResponseHeaders().set(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);</span>
<span class="fc" id="L764">        exchange.getResponseHeaders().set(&quot;Access-Control-Allow-Methods&quot;, &quot;GET, POST, PUT, DELETE, OPTIONS&quot;);</span>
<span class="fc" id="L765">        exchange.getResponseHeaders().set(&quot;Access-Control-Allow-Headers&quot;, &quot;Content-Type, Authorization&quot;);</span>
        
        // ارسال پاسخ
<span class="fc" id="L768">        byte[] responseBytes = response.getBytes();</span>
<span class="fc" id="L769">        exchange.sendResponseHeaders(statusCode, responseBytes.length);</span>
        
<span class="fc" id="L771">        try (OutputStream os = exchange.getResponseBody()) {</span>
<span class="fc" id="L772">            os.write(responseBytes);</span>
        }
<span class="fc" id="L774">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>