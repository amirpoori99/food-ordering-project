<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DeliveryService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.courier</a> &gt; <span class="el_source">DeliveryService.java</span></div><h1>DeliveryService.java</h1><pre class="source lang-java linenums">package com.myapp.courier;

import com.myapp.common.exceptions.NotFoundException;
import com.myapp.common.models.*;
import com.myapp.auth.AuthRepository;
import com.myapp.order.OrderRepository;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;

/**
 * سرویس مدیریت عملیات تحویل سفارشات
 * 
 * این کلاس مسئول پیاده‌سازی منطق کسب‌وکار مربوط به تحویل شامل:
 * - ایجاد درخواست تحویل برای سفارشات
 * - اختصاص پیک به تحویل‌ها
 * - مدیریت مراحل مختلف تحویل (pickup, delivery)
 * - لغو و به‌روزرسانی تحویل‌ها
 * - محاسبه آمار و گزارش‌های پیک‌ها
 * - validation قوانین کسب‌وکار
 * 
 * ویژگی‌های کلیدی:
 * - State Management: مدیریت انتقال وضعیت‌ها
 * - Courier Availability: بررسی در دسترس بودن پیک‌ها
 * - Business Validation: اعتبارسنجی قوانین کسب‌وکار
 * - Statistics Calculation: محاسبه آمار عملکرد
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 */
public class DeliveryService {

    private final DeliveryRepository deliveryRepository;
    private final AuthRepository authRepository;
    private final OrderRepository orderRepository;

    public DeliveryService(DeliveryRepository deliveryRepository, 
                          AuthRepository authRepository,
<span class="fc" id="L41">                          OrderRepository orderRepository) {</span>
<span class="fc" id="L42">        this.deliveryRepository = deliveryRepository;</span>
<span class="fc" id="L43">        this.authRepository = authRepository;</span>
<span class="fc" id="L44">        this.orderRepository = orderRepository;</span>
<span class="fc" id="L45">    }</span>

    /**
     * Creates a new delivery request for an order
     */
    public Delivery createDelivery(Long orderId, Double estimatedFee) {
<span class="fc bfc" id="L51" title="All 2 branches covered.">        if (orderId == null) {</span>
<span class="fc" id="L52">            throw new IllegalArgumentException(&quot;Order ID cannot be null&quot;);</span>
        }
<span class="pc bpc" id="L54" title="1 of 4 branches missed.">        if (estimatedFee == null || estimatedFee &lt; 0) {</span>
<span class="fc" id="L55">            throw new IllegalArgumentException(&quot;Estimated fee cannot be null or negative&quot;);</span>
        }

        // Verify order exists
<span class="fc" id="L59">        Order order = orderRepository.findById(orderId)</span>
<span class="fc" id="L60">            .orElseThrow(() -&gt; new NotFoundException(&quot;Order&quot;, orderId));</span>

        // Check if delivery already exists for this order
<span class="fc" id="L63">        Optional&lt;Delivery&gt; existingDelivery = deliveryRepository.findByOrderId(orderId);</span>
<span class="fc bfc" id="L64" title="All 2 branches covered.">        if (existingDelivery.isPresent()) {</span>
<span class="fc" id="L65">            throw new IllegalStateException(&quot;Delivery already exists for order: &quot; + orderId);</span>
        }

        // Create new delivery
<span class="fc" id="L69">        Delivery delivery = new Delivery(order, estimatedFee);</span>
<span class="fc" id="L70">        return deliveryRepository.save(delivery);</span>
    }

    /**
     * Assigns a courier to a pending delivery
     */
    public Delivery assignCourier(Long deliveryId, Long courierId) {
<span class="fc bfc" id="L77" title="All 2 branches covered.">        if (deliveryId == null) {</span>
<span class="fc" id="L78">            throw new IllegalArgumentException(&quot;Delivery ID cannot be null&quot;);</span>
        }
<span class="fc bfc" id="L80" title="All 2 branches covered.">        if (courierId == null) {</span>
<span class="fc" id="L81">            throw new IllegalArgumentException(&quot;Courier ID cannot be null&quot;);</span>
        }

<span class="fc" id="L84">        Delivery delivery = deliveryRepository.findById(deliveryId)</span>
<span class="fc" id="L85">            .orElseThrow(() -&gt; new NotFoundException(&quot;Delivery&quot;, deliveryId));</span>

<span class="fc" id="L87">        User courier = authRepository.findById(courierId)</span>
<span class="fc" id="L88">            .orElseThrow(() -&gt; new NotFoundException(&quot;Courier&quot;, courierId));</span>

        // Verify courier role
<span class="fc bfc" id="L91" title="All 2 branches covered.">        if (courier.getRole() != User.Role.COURIER) {</span>
<span class="fc" id="L92">            throw new IllegalArgumentException(&quot;User is not a courier&quot;);</span>
        }

        // Check if courier is available (not assigned to other active deliveries)
<span class="fc" id="L96">        List&lt;Delivery&gt; activeCourierDeliveries = deliveryRepository.findActiveByCourier(courierId);</span>
<span class="fc bfc" id="L97" title="All 2 branches covered.">        if (!activeCourierDeliveries.isEmpty()) {</span>
<span class="fc" id="L98">            throw new IllegalStateException(&quot;Courier is already assigned to active deliveries&quot;);</span>
        }

        // Assign courier using entity method
<span class="fc" id="L102">        delivery.assignToCourier(courier);</span>
<span class="fc" id="L103">        return deliveryRepository.update(delivery);</span>
    }

    /**
     * Marks delivery as picked up by courier
     */
    public Delivery markPickedUp(Long deliveryId, Long courierId) {
<span class="fc bfc" id="L110" title="All 2 branches covered.">        if (deliveryId == null) {</span>
<span class="fc" id="L111">            throw new IllegalArgumentException(&quot;Delivery ID cannot be null&quot;);</span>
        }
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">        if (courierId == null) {</span>
<span class="nc" id="L114">            throw new IllegalArgumentException(&quot;Courier ID cannot be null&quot;);</span>
        }

<span class="fc" id="L117">        Delivery delivery = deliveryRepository.findById(deliveryId)</span>
<span class="pc" id="L118">            .orElseThrow(() -&gt; new NotFoundException(&quot;Delivery&quot;, deliveryId));</span>

        // Verify courier is assigned to this delivery
<span class="fc bfc" id="L121" title="All 4 branches covered.">        if (delivery.getCourier() == null || !delivery.getCourier().getId().equals(courierId)) {</span>
<span class="fc" id="L122">            throw new IllegalArgumentException(&quot;Courier is not assigned to this delivery&quot;);</span>
        }

<span class="fc" id="L125">        delivery.markAsPickedUp();</span>
<span class="fc" id="L126">        return deliveryRepository.update(delivery);</span>
    }

    /**
     * Marks delivery as completed
     */
    public Delivery markDelivered(Long deliveryId, Long courierId) {
<span class="fc bfc" id="L133" title="All 2 branches covered.">        if (deliveryId == null) {</span>
<span class="fc" id="L134">            throw new IllegalArgumentException(&quot;Delivery ID cannot be null&quot;);</span>
        }
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">        if (courierId == null) {</span>
<span class="nc" id="L137">            throw new IllegalArgumentException(&quot;Courier ID cannot be null&quot;);</span>
        }

<span class="fc" id="L140">        Delivery delivery = deliveryRepository.findById(deliveryId)</span>
<span class="pc" id="L141">            .orElseThrow(() -&gt; new NotFoundException(&quot;Delivery&quot;, deliveryId));</span>

        // Verify courier is assigned to this delivery
<span class="pc bpc" id="L144" title="1 of 4 branches missed.">        if (delivery.getCourier() == null || !delivery.getCourier().getId().equals(courierId)) {</span>
<span class="fc" id="L145">            throw new IllegalArgumentException(&quot;Courier is not assigned to this delivery&quot;);</span>
        }

<span class="fc" id="L148">        delivery.markAsDelivered();</span>
        
        // The order status is updated automatically in the entity method
<span class="fc" id="L151">        return deliveryRepository.update(delivery);</span>
    }

    /**
     * Cancels a delivery
     */
    public Delivery cancelDelivery(Long deliveryId, String reason) {
<span class="fc bfc" id="L158" title="All 2 branches covered.">        if (deliveryId == null) {</span>
<span class="fc" id="L159">            throw new IllegalArgumentException(&quot;Delivery ID cannot be null&quot;);</span>
        }

<span class="fc" id="L162">        Delivery delivery = deliveryRepository.findById(deliveryId)</span>
<span class="fc" id="L163">            .orElseThrow(() -&gt; new NotFoundException(&quot;Delivery&quot;, deliveryId));</span>

<span class="fc bfc" id="L165" title="All 2 branches covered.">        delivery.cancel(reason != null ? reason : &quot;No reason provided&quot;);</span>
<span class="fc" id="L166">        return deliveryRepository.update(delivery);</span>
    }

    /**
     * Gets delivery by ID
     */
    public Delivery getDelivery(Long deliveryId) {
<span class="pc bpc" id="L173" title="1 of 2 branches missed.">        if (deliveryId == null) {</span>
<span class="nc" id="L174">            throw new IllegalArgumentException(&quot;Delivery ID cannot be null&quot;);</span>
        }

<span class="fc" id="L177">        return deliveryRepository.findById(deliveryId)</span>
<span class="fc" id="L178">            .orElseThrow(() -&gt; new NotFoundException(&quot;Delivery&quot;, deliveryId));</span>
    }

    /**
     * Gets delivery by order ID
     */
    public Delivery getDeliveryByOrderId(Long orderId) {
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">        if (orderId == null) {</span>
<span class="nc" id="L186">            throw new IllegalArgumentException(&quot;Order ID cannot be null&quot;);</span>
        }

<span class="fc" id="L189">        return deliveryRepository.findByOrderId(orderId)</span>
<span class="fc" id="L190">            .orElseThrow(() -&gt; new NotFoundException(&quot;Delivery for order&quot;, orderId));</span>
    }

    /**
     * Gets all pending deliveries available for assignment
     */
    public List&lt;Delivery&gt; getPendingDeliveries() {
<span class="fc" id="L197">        return deliveryRepository.findPendingDeliveries();</span>
    }

    /**
     * Gets all active deliveries for a courier
     */
    public List&lt;Delivery&gt; getCourierActiveDeliveries(Long courierId) {
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">        if (courierId == null) {</span>
<span class="nc" id="L205">            throw new IllegalArgumentException(&quot;Courier ID cannot be null&quot;);</span>
        }

        // Verify courier exists
<span class="fc" id="L209">        User courier = authRepository.findById(courierId)</span>
<span class="pc" id="L210">            .orElseThrow(() -&gt; new NotFoundException(&quot;Courier&quot;, courierId));</span>

<span class="fc bfc" id="L212" title="All 2 branches covered.">        if (courier.getRole() != User.Role.COURIER) {</span>
<span class="fc" id="L213">            throw new IllegalArgumentException(&quot;User is not a courier&quot;);</span>
        }

<span class="fc" id="L216">        return deliveryRepository.findActiveByCourier(courierId);</span>
    }

    /**
     * Gets delivery history for a courier
     */
    public List&lt;Delivery&gt; getCourierDeliveryHistory(Long courierId) {
<span class="pc bpc" id="L223" title="1 of 2 branches missed.">        if (courierId == null) {</span>
<span class="nc" id="L224">            throw new IllegalArgumentException(&quot;Courier ID cannot be null&quot;);</span>
        }

        // Verify courier exists
<span class="fc" id="L228">        User courier = authRepository.findById(courierId)</span>
<span class="pc" id="L229">            .orElseThrow(() -&gt; new NotFoundException(&quot;Courier&quot;, courierId));</span>

<span class="pc bpc" id="L231" title="1 of 2 branches missed.">        if (courier.getRole() != User.Role.COURIER) {</span>
<span class="nc" id="L232">            throw new IllegalArgumentException(&quot;User is not a courier&quot;);</span>
        }

<span class="fc" id="L235">        return deliveryRepository.findByCourierId(courierId);</span>
    }

    /**
     * Gets deliveries by status
     */
    public List&lt;Delivery&gt; getDeliveriesByStatus(DeliveryStatus status) {
<span class="fc bfc" id="L242" title="All 2 branches covered.">        if (status == null) {</span>
<span class="fc" id="L243">            throw new IllegalArgumentException(&quot;Status cannot be null&quot;);</span>
        }

<span class="fc" id="L246">        return deliveryRepository.findByStatus(status);</span>
    }

    /**
     * Gets courier statistics
     */
    public DeliveryRepository.CourierStatistics getCourierStatistics(Long courierId) {
<span class="fc bfc" id="L253" title="All 2 branches covered.">        if (courierId == null) {</span>
<span class="fc" id="L254">            throw new IllegalArgumentException(&quot;Courier ID cannot be null&quot;);</span>
        }

        // Verify courier exists
<span class="fc" id="L258">        User courier = authRepository.findById(courierId)</span>
<span class="pc" id="L259">            .orElseThrow(() -&gt; new NotFoundException(&quot;Courier&quot;, courierId));</span>

<span class="fc bfc" id="L261" title="All 2 branches covered.">        if (courier.getRole() != User.Role.COURIER) {</span>
<span class="fc" id="L262">            throw new IllegalArgumentException(&quot;User is not a courier&quot;);</span>
        }

<span class="fc" id="L265">        return deliveryRepository.getCourierStatistics(courierId);</span>
    }

    /**
     * Checks if a courier is available for assignment
     */
    public boolean isCourierAvailable(Long courierId) {
<span class="fc bfc" id="L272" title="All 2 branches covered.">        if (courierId == null) {</span>
<span class="fc" id="L273">            return false;</span>
        }

<span class="fc" id="L276">        List&lt;Delivery&gt; activeDeliveries = deliveryRepository.findActiveByCourier(courierId);</span>
<span class="fc" id="L277">        return activeDeliveries.isEmpty();</span>
    }

    /**
     * Gets all deliveries (admin function)
     */
    public List&lt;Delivery&gt; getAllDeliveries() {
<span class="fc" id="L284">        return deliveryRepository.findAll();</span>
    }

    /**
     * Gets active deliveries
     */
    public List&lt;Delivery&gt; getActiveDeliveries() {
<span class="fc" id="L291">        return deliveryRepository.findActiveDeliveries();</span>
    }

    /**
     * Deletes a delivery (admin function - use with caution)
     */
    public void deleteDelivery(Long deliveryId) {
<span class="pc bpc" id="L298" title="1 of 2 branches missed.">        if (deliveryId == null) {</span>
<span class="nc" id="L299">            throw new IllegalArgumentException(&quot;Delivery ID cannot be null&quot;);</span>
        }

<span class="fc" id="L302">        Delivery delivery = deliveryRepository.findById(deliveryId)</span>
<span class="pc" id="L303">            .orElseThrow(() -&gt; new NotFoundException(&quot;Delivery&quot;, deliveryId));</span>

        // Only allow deletion of cancelled deliveries
<span class="fc bfc" id="L306" title="All 2 branches covered.">        if (delivery.getStatus() != DeliveryStatus.CANCELLED) {</span>
<span class="fc" id="L307">            throw new IllegalStateException(&quot;Can only delete cancelled deliveries&quot;);</span>
        }

<span class="fc" id="L310">        deliveryRepository.delete(deliveryId);</span>
<span class="fc" id="L311">    }</span>

    /**
     * Updates delivery status (admin function)
     */
    public Delivery updateDeliveryStatus(Long deliveryId, DeliveryStatus newStatus) {
<span class="pc bpc" id="L317" title="1 of 2 branches missed.">        if (deliveryId == null) {</span>
<span class="nc" id="L318">            throw new IllegalArgumentException(&quot;Delivery ID cannot be null&quot;);</span>
        }
<span class="pc bpc" id="L320" title="1 of 2 branches missed.">        if (newStatus == null) {</span>
<span class="nc" id="L321">            throw new IllegalArgumentException(&quot;Status cannot be null&quot;);</span>
        }

<span class="fc" id="L324">        Delivery delivery = deliveryRepository.findById(deliveryId)</span>
<span class="pc" id="L325">            .orElseThrow(() -&gt; new NotFoundException(&quot;Delivery&quot;, deliveryId));</span>

        // Update status based on business rules
<span class="pc bpc" id="L328" title="5 of 6 branches missed.">        switch (newStatus) {</span>
            case PENDING:
<span class="nc" id="L330">                delivery.setStatus(DeliveryStatus.PENDING);</span>
<span class="nc" id="L331">                break;</span>
            case ASSIGNED:
<span class="fc bfc" id="L333" title="All 2 branches covered.">                if (delivery.getStatus() != DeliveryStatus.PENDING) {</span>
<span class="fc" id="L334">                    throw new IllegalStateException(&quot;Can only assign pending deliveries&quot;);</span>
                }
<span class="fc" id="L336">                delivery.setStatus(DeliveryStatus.ASSIGNED);</span>
<span class="fc" id="L337">                break;</span>
            case PICKED_UP:
<span class="nc bnc" id="L339" title="All 2 branches missed.">                if (delivery.getStatus() != DeliveryStatus.ASSIGNED) {</span>
<span class="nc" id="L340">                    throw new IllegalStateException(&quot;Can only pick up assigned deliveries&quot;);</span>
                }
<span class="nc" id="L342">                delivery.markAsPickedUp();</span>
<span class="nc" id="L343">                break;</span>
            case DELIVERED:
<span class="nc bnc" id="L345" title="All 2 branches missed.">                if (delivery.getStatus() != DeliveryStatus.PICKED_UP) {</span>
<span class="nc" id="L346">                    throw new IllegalStateException(&quot;Can only deliver picked up deliveries&quot;);</span>
                }
<span class="nc" id="L348">                delivery.markAsDelivered();</span>
<span class="nc" id="L349">                break;</span>
            case CANCELLED:
<span class="nc" id="L351">                delivery.cancel(&quot;Admin cancelled&quot;);</span>
<span class="nc" id="L352">                break;</span>
            default:
<span class="nc" id="L354">                throw new IllegalArgumentException(&quot;Invalid status: &quot; + newStatus);</span>
        }

<span class="fc" id="L357">        return deliveryRepository.update(delivery);</span>
    }

    /**
     * Count deliveries by courier and status
     */
    public Long countDeliveriesByCourierAndStatus(Long courierId, DeliveryStatus status) {
<span class="fc bfc" id="L364" title="All 2 branches covered.">        if (courierId == null) {</span>
<span class="fc" id="L365">            throw new IllegalArgumentException(&quot;Courier ID cannot be null&quot;);</span>
        }
<span class="fc bfc" id="L367" title="All 2 branches covered.">        if (status == null) {</span>
<span class="fc" id="L368">            throw new IllegalArgumentException(&quot;Status cannot be null&quot;);</span>
        }

<span class="fc" id="L371">        return deliveryRepository.countByCourierAndStatus(courierId, status);</span>
    }

    /**
     * Get deliveries by courier and status
     */
    public List&lt;Delivery&gt; getDeliveriesByCourierAndStatus(Long courierId, DeliveryStatus status) {
<span class="fc bfc" id="L378" title="All 2 branches covered.">        if (courierId == null) {</span>
<span class="fc" id="L379">            throw new IllegalArgumentException(&quot;Courier ID cannot be null&quot;);</span>
        }
<span class="fc bfc" id="L381" title="All 2 branches covered.">        if (status == null) {</span>
<span class="fc" id="L382">            throw new IllegalArgumentException(&quot;Status cannot be null&quot;);</span>
        }

<span class="fc" id="L385">        return deliveryRepository.findByCourierAndStatus(courierId, status);</span>
    }

    /**
     * Get deliveries by date range
     */
    public List&lt;Delivery&gt; getDeliveriesByDateRange(LocalDateTime startDate, LocalDateTime endDate) {
<span class="pc bpc" id="L392" title="2 of 4 branches missed.">        if (startDate == null || endDate == null) {</span>
<span class="nc" id="L393">            throw new IllegalArgumentException(&quot;Start date and end date cannot be null&quot;);</span>
        }
<span class="pc bpc" id="L395" title="1 of 2 branches missed.">        if (startDate.isAfter(endDate)) {</span>
<span class="nc" id="L396">            throw new IllegalArgumentException(&quot;Start date cannot be after end date&quot;);</span>
        }

<span class="fc" id="L399">        return deliveryRepository.findByDateRange(startDate, endDate);</span>
    }

    /**
     * Check if delivery exists by order ID
     */
    public boolean deliveryExistsForOrder(Long orderId) {
<span class="pc bpc" id="L406" title="1 of 2 branches missed.">        if (orderId == null) {</span>
<span class="nc" id="L407">            return false;</span>
        }
<span class="fc" id="L409">        return deliveryRepository.existsByOrderId(orderId);</span>
    }
} 
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>