<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DeliveryController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Backend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.courier</a> &gt; <span class="el_source">DeliveryController.java</span></div><h1>DeliveryController.java</h1><pre class="source lang-java linenums">package com.myapp.courier;

import com.myapp.common.exceptions.NotFoundException;
import com.myapp.common.models.Delivery;
import com.myapp.common.models.DeliveryStatus;
import com.myapp.common.models.User;
import com.myapp.auth.AuthRepository;
import com.sun.net.httpserver.HttpExchange;
import com.sun.net.httpserver.HttpHandler;

import java.io.IOException;
import java.io.OutputStream;
import java.net.URI;
import java.util.List;
import java.util.Map;
import java.util.HashMap;

/**
 * کنترلر REST API برای مدیریت تحویل سفارشات
 * 
 * این کلاس تمام endpoint های مربوط به سیستم تحویل را مدیریت می‌کند:
 * 
 * === CRUD عملیات اصلی ===
 * POST   /api/deliveries                               - ایجاد تحویل جدید
 * GET    /api/deliveries/{deliveryId}                  - دریافت جزئیات تحویل
 * DELETE /api/deliveries/{deliveryId}                  - حذف تحویل (مدیر)
 * 
 * === مدیریت فرآیند تحویل ===
 * PUT    /api/deliveries/{deliveryId}/assign           - اختصاص پیک به تحویل
 * PUT    /api/deliveries/{deliveryId}/pickup           - علامت‌گذاری تحویل گرفته شده
 * PUT    /api/deliveries/{deliveryId}/deliver          - علامت‌گذاری تحویل داده شده
 * PUT    /api/deliveries/{deliveryId}/cancel           - لغو تحویل
 * PUT    /api/deliveries/{deliveryId}/status           - به‌روزرسانی وضعیت (مدیر)
 * 
 * === جستجو و فیلتر ===
 * GET    /api/deliveries/order/{orderId}               - تحویل بر اساس سفارش
 * GET    /api/deliveries/courier/{courierId}           - تحویل‌های پیک
 * GET    /api/deliveries/courier/{courierId}/active    - تحویل‌های فعال پیک
 * GET    /api/deliveries/status/{status}               - تحویل‌ها بر اساس وضعیت
 * GET    /api/deliveries/active                        - تمام تحویل‌های فعال
 * GET    /api/deliveries/pending                       - تحویل‌های در انتظار
 * 
 * === مدیریت پیک‌ها ===
 * GET    /api/deliveries/courier/{courierId}/available - بررسی در دسترس بودن پیک
 * GET    /api/deliveries/courier/{courierId}/statistics - آمار عملکرد پیک
 * 
 * ویژگی‌های کلیدی:
 * - RESTful API Design: طراحی مطابق استانداردهای REST
 * - JSON Request/Response: پردازش و تولید JSON
 * - Error Handling: مدیریت خطاها با کدهای HTTP مناسب
 * - Path Parameter Extraction: استخراج پارامترها از URL
 * - Input Validation: اعتبارسنجی داده‌های ورودی
 * - Custom JSON Parser: پارسر JSON سفارشی برای dependency کمتر
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 */
public class DeliveryController implements HttpHandler {
    
    /** سرویس منطق کسب‌وکار تحویل */
    private final DeliveryService deliveryService;
    
    /**
     * سازنده پیش‌فرض
     * Dependencies را به صورت خودکار ایجاد می‌کند
     */
<span class="nc" id="L68">    public DeliveryController() {</span>
<span class="nc" id="L69">        this.deliveryService = new DeliveryService(</span>
            new DeliveryRepository(),
            new AuthRepository(),
            new com.myapp.order.OrderRepository()
        );
<span class="nc" id="L74">    }</span>
    
    /**
     * سازنده برای dependency injection (تست)
     * 
     * @param deliveryService سرویس تحویل از خارج تزریق شده
     */
<span class="fc" id="L81">    public DeliveryController(DeliveryService deliveryService) {</span>
<span class="fc" id="L82">        this.deliveryService = deliveryService;</span>
<span class="fc" id="L83">    }</span>
    
    /**
     * هندلر اصلی HTTP requests
     * 
     * تمام درخواست‌ها را بر اساس HTTP method و path مسیریابی می‌کند
     * Error handling کامل برای انواع مختلف exceptions
     * 
     * @param exchange شیء HTTP request/response
     */
    @Override
    public void handle(HttpExchange exchange) throws IOException {
<span class="fc" id="L95">        String method = exchange.getRequestMethod();</span>
<span class="fc" id="L96">        String path = exchange.getRequestURI().getPath();</span>
        
        try {
            // مسیریابی بر اساس HTTP method
<span class="fc bfc" id="L100" title="All 5 branches covered.">            switch (method) {</span>
                case &quot;GET&quot;:
<span class="fc" id="L102">                    handleGet(exchange, path);</span>
<span class="fc" id="L103">                    break;</span>
                case &quot;POST&quot;:
<span class="fc" id="L105">                    handlePost(exchange, path);</span>
<span class="fc" id="L106">                    break;</span>
                case &quot;PUT&quot;:
<span class="fc" id="L108">                    handlePut(exchange, path);</span>
<span class="fc" id="L109">                    break;</span>
                case &quot;DELETE&quot;:
<span class="fc" id="L111">                    handleDelete(exchange, path);</span>
<span class="fc" id="L112">                    break;</span>
                default:
<span class="fc" id="L114">                    sendErrorResponse(exchange, 405, &quot;Method not allowed&quot;);</span>
            }
<span class="fc" id="L116">        } catch (IllegalArgumentException e) {</span>
            // خطای پارامتر نامعتبر - 400 Bad Request
<span class="fc" id="L118">            sendErrorResponse(exchange, 400, e.getMessage());</span>
<span class="fc" id="L119">        } catch (IllegalStateException e) {</span>
            // خطای وضعیت نامعتبر - 409 Conflict
<span class="fc" id="L121">            sendErrorResponse(exchange, 409, e.getMessage());</span>
<span class="fc" id="L122">        } catch (NotFoundException e) {</span>
            // خطای یافت نشدن - 404 Not Found
<span class="fc" id="L124">            sendErrorResponse(exchange, 404, e.getMessage());</span>
<span class="fc" id="L125">        } catch (Exception e) {</span>
            // خطای سرور - 500 Internal Server Error
<span class="fc" id="L127">            sendErrorResponse(exchange, 500, &quot;Internal server error: &quot; + e.getMessage());</span>
<span class="fc" id="L128">        }</span>
<span class="fc" id="L129">    }</span>
    
    // ==================== GET ENDPOINTS ====================
    
    /**
     * مدیریت تمام GET requests
     * 
     * بر اساس pattern های مختلف URL، درخواست‌ها را مسیریابی می‌کند
     * از regex pattern matching برای انعطاف‌پذیری استفاده می‌کند
     * 
     * @param exchange HTTP exchange object
     * @param path مسیر درخواست
     */
    private void handleGet(HttpExchange exchange, String path) throws IOException {
<span class="fc bfc" id="L143" title="All 2 branches covered.">        if (path.matches(&quot;/api/deliveries/\\d+&quot;)) {</span>
            // GET /api/deliveries/{deliveryId} - دریافت جزئیات تحویل
<span class="fc" id="L145">            Long deliveryId = extractDeliveryIdFromPath(path);</span>
<span class="fc" id="L146">            getDeliveryDetails(exchange, deliveryId);</span>
<span class="fc bfc" id="L147" title="All 2 branches covered.">        } else if (path.matches(&quot;/api/deliveries/order/\\d+&quot;)) {</span>
            // GET /api/deliveries/order/{orderId} - تحویل بر اساس سفارش
<span class="fc" id="L149">            Long orderId = extractIdFromPath(path, &quot;/api/deliveries/order/&quot;);</span>
<span class="fc" id="L150">            getDeliveryByOrder(exchange, orderId);</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">        } else if (path.matches(&quot;/api/deliveries/courier/\\d+/active&quot;)) {</span>
            // GET /api/deliveries/courier/{courierId}/active - تحویل‌های فعال پیک
<span class="fc" id="L153">            Long courierId = extractIdFromPath(path, &quot;/api/deliveries/courier/&quot;, &quot;/active&quot;);</span>
<span class="fc" id="L154">            getCourierActiveDeliveries(exchange, courierId);</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">        } else if (path.matches(&quot;/api/deliveries/courier/\\d+/available&quot;)) {</span>
            // GET /api/deliveries/courier/{courierId}/available - بررسی در دسترس بودن پیک
<span class="fc" id="L157">            Long courierId = extractIdFromPath(path, &quot;/api/deliveries/courier/&quot;, &quot;/available&quot;);</span>
<span class="fc" id="L158">            checkCourierAvailability(exchange, courierId);</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">        } else if (path.matches(&quot;/api/deliveries/courier/\\d+/statistics&quot;)) {</span>
            // GET /api/deliveries/courier/{courierId}/statistics - آمار پیک
<span class="fc" id="L161">            Long courierId = extractIdFromPath(path, &quot;/api/deliveries/courier/&quot;, &quot;/statistics&quot;);</span>
<span class="fc" id="L162">            getCourierStatistics(exchange, courierId);</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">        } else if (path.matches(&quot;/api/deliveries/courier/\\d+&quot;)) {</span>
            // GET /api/deliveries/courier/{courierId} - تاریخچه تحویل‌های پیک
<span class="fc" id="L165">            Long courierId = extractIdFromPath(path, &quot;/api/deliveries/courier/&quot;);</span>
<span class="fc" id="L166">            getCourierDeliveries(exchange, courierId);</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">        } else if (path.matches(&quot;/api/deliveries/status/\\w+&quot;)) {</span>
            // GET /api/deliveries/status/{status} - تحویل‌ها بر اساس وضعیت
<span class="fc" id="L169">            String statusStr = extractStatusFromPath(path);</span>
<span class="fc" id="L170">            getDeliveriesByStatus(exchange, statusStr);</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">        } else if (path.equals(&quot;/api/deliveries/active&quot;)) {</span>
            // GET /api/deliveries/active - تمام تحویل‌های فعال
<span class="fc" id="L173">            getActiveDeliveries(exchange);</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">        } else if (path.equals(&quot;/api/deliveries/pending&quot;)) {</span>
            // GET /api/deliveries/pending - تحویل‌های در انتظار اختصاص پیک
<span class="fc" id="L176">            getPendingDeliveries(exchange);</span>
        } else {
<span class="fc" id="L178">            sendErrorResponse(exchange, 404, &quot;Endpoint not found&quot;);</span>
        }
<span class="fc" id="L180">    }</span>
    
    /**
     * دریافت جزئیات کامل یک تحویل
     * 
     * @param exchange HTTP exchange
     * @param deliveryId شناسه تحویل
     */
    private void getDeliveryDetails(HttpExchange exchange, Long deliveryId) throws IOException {
<span class="fc" id="L189">        Delivery delivery = deliveryService.getDelivery(deliveryId);</span>
<span class="fc" id="L190">        sendJsonResponse(exchange, 200, delivery);</span>
<span class="fc" id="L191">    }</span>
    
    /**
     * دریافت تحویل مربوط به یک سفارش خاص
     * 
     * @param exchange HTTP exchange
     * @param orderId شناسه سفارش
     */
    private void getDeliveryByOrder(HttpExchange exchange, Long orderId) throws IOException {
<span class="fc" id="L200">        Delivery delivery = deliveryService.getDeliveryByOrderId(orderId);</span>
<span class="fc" id="L201">        sendJsonResponse(exchange, 200, delivery);</span>
<span class="fc" id="L202">    }</span>
    
    /**
     * دریافت تاریخچه کامل تحویل‌های یک پیک
     * 
     * @param exchange HTTP exchange
     * @param courierId شناسه پیک
     */
    private void getCourierDeliveries(HttpExchange exchange, Long courierId) throws IOException {
<span class="fc" id="L211">        List&lt;Delivery&gt; deliveries = deliveryService.getCourierDeliveryHistory(courierId);</span>
<span class="fc" id="L212">        sendJsonResponse(exchange, 200, deliveries);</span>
<span class="fc" id="L213">    }</span>
    
    /**
     * دریافت تحویل‌های فعال (در حال انجام) یک پیک
     * 
     * @param exchange HTTP exchange
     * @param courierId شناسه پیک
     */
    private void getCourierActiveDeliveries(HttpExchange exchange, Long courierId) throws IOException {
<span class="fc" id="L222">        List&lt;Delivery&gt; deliveries = deliveryService.getCourierActiveDeliveries(courierId);</span>
<span class="fc" id="L223">        sendJsonResponse(exchange, 200, deliveries);</span>
<span class="fc" id="L224">    }</span>
    
    /**
     * دریافت تحویل‌ها بر اساس وضعیت مشخص
     * 
     * @param exchange HTTP exchange
     * @param statusStr وضعیت تحویل (رشته)
     */
    private void getDeliveriesByStatus(HttpExchange exchange, String statusStr) throws IOException {
        try {
<span class="fc" id="L234">            DeliveryStatus status = DeliveryStatus.valueOf(statusStr.toUpperCase());</span>
<span class="fc" id="L235">            List&lt;Delivery&gt; deliveries = deliveryService.getDeliveriesByStatus(status);</span>
<span class="fc" id="L236">            sendJsonResponse(exchange, 200, deliveries);</span>
<span class="fc" id="L237">        } catch (IllegalArgumentException e) {</span>
<span class="fc" id="L238">            sendErrorResponse(exchange, 400, &quot;Invalid status: &quot; + statusStr);</span>
<span class="fc" id="L239">        }</span>
<span class="fc" id="L240">    }</span>
    
    /**
     * دریافت تمام تحویل‌های فعال سیستم
     * 
     * @param exchange HTTP exchange
     */
    private void getActiveDeliveries(HttpExchange exchange) throws IOException {
<span class="fc" id="L248">        List&lt;Delivery&gt; deliveries = deliveryService.getActiveDeliveries();</span>
<span class="fc" id="L249">        sendJsonResponse(exchange, 200, deliveries);</span>
<span class="fc" id="L250">    }</span>
    
    /**
     * دریافت تحویل‌های در انتظار اختصاص پیک
     * 
     * @param exchange HTTP exchange
     */
    private void getPendingDeliveries(HttpExchange exchange) throws IOException {
<span class="fc" id="L258">        List&lt;Delivery&gt; deliveries = deliveryService.getDeliveriesByStatus(DeliveryStatus.PENDING);</span>
<span class="fc" id="L259">        sendJsonResponse(exchange, 200, deliveries);</span>
<span class="fc" id="L260">    }</span>
    
    /**
     * بررسی در دسترس بودن پیک برای تحویل جدید
     * 
     * @param exchange HTTP exchange
     * @param courierId شناسه پیک
     */
    private void checkCourierAvailability(HttpExchange exchange, Long courierId) throws IOException {
<span class="fc" id="L269">        boolean isAvailable = deliveryService.isCourierAvailable(courierId);</span>
<span class="fc" id="L270">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="fc" id="L271">        response.put(&quot;courierId&quot;, courierId);</span>
<span class="fc" id="L272">        response.put(&quot;available&quot;, isAvailable);</span>
<span class="fc" id="L273">        sendJsonResponse(exchange, 200, response);</span>
<span class="fc" id="L274">    }</span>
    
    /**
     * دریافت آمار عملکرد پیک
     * 
     * شامل تعداد تحویل‌ها، نرخ موفقیت، درآمد و میانگین زمان تحویل
     * 
     * @param exchange HTTP exchange
     * @param courierId شناسه پیک
     */
    private void getCourierStatistics(HttpExchange exchange, Long courierId) throws IOException {
<span class="fc" id="L285">        DeliveryRepository.CourierStatistics stats = deliveryService.getCourierStatistics(courierId);</span>
<span class="fc" id="L286">        sendJsonResponse(exchange, 200, stats);</span>
<span class="fc" id="L287">    }</span>
    
    // ==================== POST ENDPOINTS ====================
    
    /**
     * مدیریت تمام POST requests
     * 
     * @param exchange HTTP exchange
     * @param path مسیر درخواست
     */
    private void handlePost(HttpExchange exchange, String path) throws IOException {
<span class="fc bfc" id="L298" title="All 2 branches covered.">        if (path.equals(&quot;/api/deliveries&quot;)) {</span>
            // POST /api/deliveries - ایجاد تحویل جدید
<span class="fc" id="L300">            createDelivery(exchange);</span>
        } else {
<span class="fc" id="L302">            sendErrorResponse(exchange, 404, &quot;Endpoint not found&quot;);</span>
        }
<span class="fc" id="L304">    }</span>
    
    /**
     * ایجاد درخواست تحویل جدید برای سفارش
     * 
     * JSON Request Body:
     * {
     *   &quot;orderId&quot;: number,
     *   &quot;estimatedFee&quot;: number
     * }
     * 
     * @param exchange HTTP exchange
     */
    private void createDelivery(HttpExchange exchange) throws IOException {
<span class="fc" id="L318">        Map&lt;String, Object&gt; requestData = parseJsonRequest(exchange);</span>
        
<span class="fc" id="L320">        Long orderId = getLongFromMap(requestData, &quot;orderId&quot;);</span>
<span class="fc" id="L321">        Double estimatedFee = getDoubleFromMap(requestData, &quot;estimatedFee&quot;);</span>
        
        // اعتبارسنجی ورودی‌ها
<span class="fc bfc" id="L324" title="All 2 branches covered.">        if (orderId == null) {</span>
<span class="fc" id="L325">            sendErrorResponse(exchange, 400, &quot;Order ID is required&quot;);</span>
<span class="fc" id="L326">            return;</span>
        }
        
<span class="fc bfc" id="L329" title="All 2 branches covered.">        if (estimatedFee == null) {</span>
<span class="fc" id="L330">            sendErrorResponse(exchange, 400, &quot;Estimated fee is required&quot;);</span>
<span class="fc" id="L331">            return;</span>
        }
        
<span class="fc" id="L334">        Delivery delivery = deliveryService.createDelivery(orderId, estimatedFee);</span>
<span class="fc" id="L335">        sendJsonResponse(exchange, 201, delivery);</span>
<span class="fc" id="L336">    }</span>
    
    // ==================== PUT ENDPOINTS ====================
    
    /**
     * مدیریت تمام PUT requests
     * 
     * شامل عملیات‌های به‌روزرسانی وضعیت تحویل
     * 
     * @param exchange HTTP exchange
     * @param path مسیر درخواست
     */
    private void handlePut(HttpExchange exchange, String path) throws IOException {
<span class="fc bfc" id="L349" title="All 2 branches covered.">        if (path.matches(&quot;/api/deliveries/\\d+/assign&quot;)) {</span>
            // PUT /api/deliveries/{deliveryId}/assign - اختصاص پیک
<span class="fc" id="L351">            Long deliveryId = extractDeliveryIdFromPath(path, &quot;/assign&quot;);</span>
<span class="fc" id="L352">            assignCourier(exchange, deliveryId);</span>
<span class="fc bfc" id="L353" title="All 2 branches covered.">        } else if (path.matches(&quot;/api/deliveries/\\d+/pickup&quot;)) {</span>
            // PUT /api/deliveries/{deliveryId}/pickup - تحویل گرفتن از رستوران
<span class="fc" id="L355">            Long deliveryId = extractDeliveryIdFromPath(path, &quot;/pickup&quot;);</span>
<span class="fc" id="L356">            markPickedUp(exchange, deliveryId);</span>
<span class="fc bfc" id="L357" title="All 2 branches covered.">        } else if (path.matches(&quot;/api/deliveries/\\d+/deliver&quot;)) {</span>
            // PUT /api/deliveries/{deliveryId}/deliver - تحویل به مشتری
<span class="fc" id="L359">            Long deliveryId = extractDeliveryIdFromPath(path, &quot;/deliver&quot;);</span>
<span class="fc" id="L360">            markDelivered(exchange, deliveryId);</span>
<span class="fc bfc" id="L361" title="All 2 branches covered.">        } else if (path.matches(&quot;/api/deliveries/\\d+/cancel&quot;)) {</span>
            // PUT /api/deliveries/{deliveryId}/cancel - لغو تحویل
<span class="fc" id="L363">            Long deliveryId = extractDeliveryIdFromPath(path, &quot;/cancel&quot;);</span>
<span class="fc" id="L364">            cancelDelivery(exchange, deliveryId);</span>
<span class="fc bfc" id="L365" title="All 2 branches covered.">        } else if (path.matches(&quot;/api/deliveries/\\d+/status&quot;)) {</span>
            // PUT /api/deliveries/{deliveryId}/status - به‌روزرسانی وضعیت (مدیر)
<span class="fc" id="L367">            Long deliveryId = extractDeliveryIdFromPath(path, &quot;/status&quot;);</span>
<span class="fc" id="L368">            updateDeliveryStatus(exchange, deliveryId);</span>
<span class="fc" id="L369">        } else {</span>
<span class="fc" id="L370">            sendErrorResponse(exchange, 404, &quot;Endpoint not found&quot;);</span>
        }
<span class="fc" id="L372">    }</span>
    
    /**
     * اختصاص پیک به تحویل
     * 
     * JSON Request Body:
     * {
     *   &quot;courierId&quot;: number
     * }
     * 
     * @param exchange HTTP exchange
     * @param deliveryId شناسه تحویل
     */
    private void assignCourier(HttpExchange exchange, Long deliveryId) throws IOException {
<span class="fc" id="L386">        Map&lt;String, Object&gt; requestData = parseJsonRequest(exchange);</span>
        
<span class="fc" id="L388">        Long courierId = getLongFromMap(requestData, &quot;courierId&quot;);</span>
        
<span class="fc bfc" id="L390" title="All 2 branches covered.">        if (courierId == null) {</span>
<span class="fc" id="L391">            sendErrorResponse(exchange, 400, &quot;Courier ID is required&quot;);</span>
<span class="fc" id="L392">            return;</span>
        }
        
<span class="fc" id="L395">        Delivery delivery = deliveryService.assignCourier(deliveryId, courierId);</span>
<span class="fc" id="L396">        sendJsonResponse(exchange, 200, delivery);</span>
<span class="fc" id="L397">    }</span>
    
    /**
     * علامت‌گذاری تحویل به عنوان &quot;تحویل گرفته شده از رستوران&quot;
     * 
     * JSON Request Body:
     * {
     *   &quot;courierId&quot;: number
     * }
     * 
     * @param exchange HTTP exchange
     * @param deliveryId شناسه تحویل
     */
    private void markPickedUp(HttpExchange exchange, Long deliveryId) throws IOException {
<span class="fc" id="L411">        Map&lt;String, Object&gt; requestData = parseJsonRequest(exchange);</span>
        
<span class="fc" id="L413">        Long courierId = getLongFromMap(requestData, &quot;courierId&quot;);</span>
        
<span class="fc bfc" id="L415" title="All 2 branches covered.">        if (courierId == null) {</span>
<span class="fc" id="L416">            sendErrorResponse(exchange, 400, &quot;Courier ID is required&quot;);</span>
<span class="fc" id="L417">            return;</span>
        }
        
<span class="fc" id="L420">        Delivery delivery = deliveryService.markPickedUp(deliveryId, courierId);</span>
<span class="fc" id="L421">        sendJsonResponse(exchange, 200, delivery);</span>
<span class="fc" id="L422">    }</span>
    
    /**
     * علامت‌گذاری تحویل به عنوان &quot;تحویل داده شده به مشتری&quot;
     * 
     * JSON Request Body:
     * {
     *   &quot;courierId&quot;: number
     * }
     * 
     * @param exchange HTTP exchange
     * @param deliveryId شناسه تحویل
     */
    private void markDelivered(HttpExchange exchange, Long deliveryId) throws IOException {
<span class="fc" id="L436">        Map&lt;String, Object&gt; requestData = parseJsonRequest(exchange);</span>
        
<span class="fc" id="L438">        Long courierId = getLongFromMap(requestData, &quot;courierId&quot;);</span>
        
<span class="fc bfc" id="L440" title="All 2 branches covered.">        if (courierId == null) {</span>
<span class="fc" id="L441">            sendErrorResponse(exchange, 400, &quot;Courier ID is required&quot;);</span>
<span class="fc" id="L442">            return;</span>
        }
        
<span class="fc" id="L445">        Delivery delivery = deliveryService.markDelivered(deliveryId, courierId);</span>
<span class="fc" id="L446">        sendJsonResponse(exchange, 200, delivery);</span>
<span class="fc" id="L447">    }</span>
    
    /**
     * لغو تحویل
     * 
     * JSON Request Body:
     * {
     *   &quot;reason&quot;: string (اختیاری)
     * }
     * 
     * @param exchange HTTP exchange
     * @param deliveryId شناسه تحویل
     */
    private void cancelDelivery(HttpExchange exchange, Long deliveryId) throws IOException {
<span class="fc" id="L461">        Map&lt;String, Object&gt; requestData = parseJsonRequest(exchange);</span>
        
<span class="fc" id="L463">        String reason = getStringFromMap(requestData, &quot;reason&quot;);</span>
        
<span class="fc" id="L465">        Delivery delivery = deliveryService.cancelDelivery(deliveryId, reason);</span>
<span class="fc" id="L466">        sendJsonResponse(exchange, 200, delivery);</span>
<span class="fc" id="L467">    }</span>
    
    /**
     * به‌روزرسانی مستقیم وضعیت تحویل (عملکرد مدیر)
     * 
     * JSON Request Body:
     * {
     *   &quot;status&quot;: string
     * }
     * 
     * @param exchange HTTP exchange
     * @param deliveryId شناسه تحویل
     */
    private void updateDeliveryStatus(HttpExchange exchange, Long deliveryId) throws IOException {
<span class="fc" id="L481">        Map&lt;String, Object&gt; requestData = parseJsonRequest(exchange);</span>
        
<span class="fc" id="L483">        String statusStr = getStringFromMap(requestData, &quot;status&quot;);</span>
        
<span class="fc bfc" id="L485" title="All 2 branches covered.">        if (statusStr == null) {</span>
<span class="fc" id="L486">            sendErrorResponse(exchange, 400, &quot;Status is required&quot;);</span>
<span class="fc" id="L487">            return;</span>
        }
        
        try {
<span class="fc" id="L491">            DeliveryStatus status = DeliveryStatus.valueOf(statusStr.toUpperCase());</span>
<span class="fc" id="L492">            Delivery delivery = deliveryService.updateDeliveryStatus(deliveryId, status);</span>
<span class="fc" id="L493">            sendJsonResponse(exchange, 200, delivery);</span>
<span class="fc" id="L494">        } catch (IllegalArgumentException e) {</span>
<span class="fc" id="L495">            sendErrorResponse(exchange, 400, &quot;Invalid status: &quot; + statusStr);</span>
<span class="fc" id="L496">        }</span>
<span class="fc" id="L497">    }</span>
    
    // ==================== DELETE ENDPOINTS ====================
    
    /**
     * مدیریت تمام DELETE requests
     * 
     * @param exchange HTTP exchange
     * @param path مسیر درخواست
     */
    private void handleDelete(HttpExchange exchange, String path) throws IOException {
<span class="fc bfc" id="L508" title="All 2 branches covered.">        if (path.matches(&quot;/api/deliveries/\\d+&quot;)) {</span>
            // DELETE /api/deliveries/{deliveryId} - حذف تحویل (مدیر)
<span class="fc" id="L510">            Long deliveryId = extractDeliveryIdFromPath(path);</span>
<span class="fc" id="L511">            deleteDelivery(exchange, deliveryId);</span>
<span class="fc" id="L512">        } else {</span>
<span class="fc" id="L513">            sendErrorResponse(exchange, 404, &quot;Endpoint not found&quot;);</span>
        }
<span class="fc" id="L515">    }</span>
    
    /**
     * حذف تحویل (فقط برای مدیر و تحویل‌های لغو شده)
     * 
     * @param exchange HTTP exchange
     * @param deliveryId شناسه تحویل
     */
    private void deleteDelivery(HttpExchange exchange, Long deliveryId) throws IOException {
<span class="fc" id="L524">        deliveryService.deleteDelivery(deliveryId);</span>
        
<span class="fc" id="L526">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="fc" id="L527">        response.put(&quot;message&quot;, &quot;Delivery deleted successfully&quot;);</span>
<span class="fc" id="L528">        response.put(&quot;deliveryId&quot;, deliveryId);</span>
<span class="fc" id="L529">        sendJsonResponse(exchange, 200, response);</span>
<span class="fc" id="L530">    }</span>
    
    // ==================== UTILITY METHODS ====================
    
    /**
     * استخراج شناسه تحویل از path ساده
     * 
     * Pattern: /api/deliveries/{id}
     * 
     * @param path مسیر URL
     * @return شناسه تحویل
     */
    private Long extractDeliveryIdFromPath(String path) {
<span class="fc" id="L543">        String[] parts = path.split(&quot;/&quot;);</span>
<span class="pc bpc" id="L544" title="1 of 2 branches missed.">        if (parts.length &lt;= 3) {</span>
<span class="nc" id="L545">            throw new IllegalArgumentException(&quot;Invalid path format: &quot; + path);</span>
        }
<span class="fc" id="L547">        return Long.parseLong(parts[3]); // /api/deliveries/{id}</span>
    }
    
    /**
     * استخراج شناسه تحویل از path با suffix
     * 
     * Pattern: /api/deliveries/{id}/action
     * 
     * @param path مسیر URL
     * @param suffix پسوند برای حذف
     * @return شناسه تحویل
     */
    private Long extractDeliveryIdFromPath(String path, String suffix) {
        // حذف suffix فقط از انتهای path
<span class="pc bpc" id="L561" title="1 of 2 branches missed.">        if (path.endsWith(suffix)) {</span>
<span class="fc" id="L562">            String pathWithoutSuffix = path.substring(0, path.length() - suffix.length());</span>
<span class="fc" id="L563">            return extractDeliveryIdFromPath(pathWithoutSuffix);</span>
        } else {
<span class="nc" id="L565">            throw new IllegalArgumentException(&quot;Path does not end with expected suffix: &quot; + suffix);</span>
        }
    }
    
    /**
     * استخراج ID از path با prefix
     * 
     * @param path مسیر URL
     * @param prefix پیشوند برای حذف
     * @return شناسه استخراج شده
     */
    private Long extractIdFromPath(String path, String prefix) {
<span class="fc" id="L577">        String idPart = path.substring(prefix.length());</span>
<span class="fc" id="L578">        return Long.parseLong(idPart);</span>
    }
    
    /**
     * استخراج ID از path با prefix و suffix
     * 
     * @param path مسیر URL
     * @param prefix پیشوند برای حذف
     * @param suffix پسوند برای حذف
     * @return شناسه استخراج شده
     */
    private Long extractIdFromPath(String path, String prefix, String suffix) {
<span class="fc" id="L590">        String idPart = path.substring(prefix.length());</span>
<span class="fc" id="L591">        idPart = idPart.replace(suffix, &quot;&quot;);</span>
<span class="fc" id="L592">        return Long.parseLong(idPart);</span>
    }
    
    /**
     * استخراج وضعیت از path
     * 
     * Pattern: /api/deliveries/status/{status}
     * 
     * @param path مسیر URL
     * @return رشته وضعیت
     */
    private String extractStatusFromPath(String path) {
<span class="fc" id="L604">        String[] parts = path.split(&quot;/&quot;);</span>
<span class="fc" id="L605">        return parts[4]; // /api/deliveries/status/{status}</span>
    }
    
    /**
     * پارس درخواست JSON از HTTP request body
     * 
     * @param exchange HTTP exchange
     * @return Map حاوی داده‌های JSON
     */
    private Map&lt;String, Object&gt; parseJsonRequest(HttpExchange exchange) throws IOException {
<span class="fc" id="L615">        StringBuilder requestBody = new StringBuilder();</span>
<span class="fc" id="L616">        try (java.io.BufferedReader reader = new java.io.BufferedReader(</span>
<span class="fc" id="L617">                new java.io.InputStreamReader(exchange.getRequestBody()))) {</span>
            String line;
<span class="fc bfc" id="L619" title="All 2 branches covered.">            while ((line = reader.readLine()) != null) {</span>
<span class="fc" id="L620">                requestBody.append(line);</span>
            }
        }
        
<span class="fc" id="L624">        String json = requestBody.toString().trim();</span>
<span class="fc bfc" id="L625" title="All 2 branches covered.">        if (json.isEmpty()) {</span>
<span class="fc" id="L626">            return new HashMap&lt;&gt;();</span>
        }
        
<span class="fc" id="L629">        return parseJson(json);</span>
    }
    
    /**
     * پارسر JSON ساده
     * 
     * در محیط production از Jackson یا Gson استفاده کنید
     * این پیاده‌سازی برای کاهش dependencies است
     * 
     * @param json رشته JSON
     * @return Map حاوی داده‌های پارس شده
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    private Map&lt;String, Object&gt; parseJson(String json) {
        try {
<span class="fc" id="L644">            json = json.trim();</span>
<span class="pc bpc" id="L645" title="1 of 4 branches missed.">            if (!json.startsWith(&quot;{&quot;) || !json.endsWith(&quot;}&quot;)) {</span>
<span class="fc" id="L646">                throw new IllegalArgumentException(&quot;Invalid JSON format&quot;);</span>
            }
            
<span class="fc" id="L649">            Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();</span>
<span class="fc" id="L650">            json = json.substring(1, json.length() - 1); // حذف { }</span>
            
<span class="fc bfc" id="L652" title="All 2 branches covered.">            if (json.trim().isEmpty()) {</span>
<span class="fc" id="L653">                return result;</span>
            }
            
<span class="fc" id="L656">            String[] pairs = json.split(&quot;,&quot;);</span>
<span class="fc bfc" id="L657" title="All 2 branches covered.">            for (String pair : pairs) {</span>
<span class="fc" id="L658">                String[] keyValue = pair.split(&quot;:&quot;, 2);</span>
<span class="pc bpc" id="L659" title="1 of 2 branches missed.">                if (keyValue.length != 2) continue;</span>
                
<span class="fc" id="L661">                String key = keyValue[0].trim().replaceAll(&quot;\&quot;&quot;, &quot;&quot;);</span>
<span class="fc" id="L662">                String value = keyValue[1].trim();</span>
                
                // پارس انواع مختلف مقادیر
<span class="pc bpc" id="L665" title="1 of 2 branches missed.">                if (value.equals(&quot;null&quot;)) {</span>
<span class="nc" id="L666">                    result.put(key, null);</span>
<span class="pc bpc" id="L667" title="1 of 2 branches missed.">                } else if (value.equals(&quot;true&quot;)) {</span>
<span class="nc" id="L668">                    result.put(key, true);</span>
<span class="pc bpc" id="L669" title="1 of 2 branches missed.">                } else if (value.equals(&quot;false&quot;)) {</span>
<span class="nc" id="L670">                    result.put(key, false);</span>
<span class="pc bpc" id="L671" title="1 of 4 branches missed.">                } else if (value.startsWith(&quot;\&quot;&quot;) &amp;&amp; value.endsWith(&quot;\&quot;&quot;)) {</span>
<span class="fc" id="L672">                    result.put(key, value.substring(1, value.length() - 1));</span>
<span class="fc bfc" id="L673" title="All 2 branches covered.">                } else if (value.contains(&quot;.&quot;)) {</span>
<span class="fc" id="L674">                    result.put(key, Double.parseDouble(value));</span>
                } else {
<span class="fc" id="L676">                    result.put(key, Long.parseLong(value));</span>
                }
            }
            
<span class="fc" id="L680">            return result;</span>
<span class="fc" id="L681">        } catch (Exception e) {</span>
<span class="fc" id="L682">            throw new IllegalArgumentException(&quot;Invalid JSON: &quot; + e.getMessage());</span>
        }
    }
    
    /**
     * استخراج مقدار String از Map
     * 
     * @param map نقشه داده‌ها
     * @param key کلید
     * @return مقدار رشته یا null
     */
    private String getStringFromMap(Map&lt;String, Object&gt; map, String key) {
<span class="fc" id="L694">        Object value = map.get(key);</span>
<span class="fc bfc" id="L695" title="All 2 branches covered.">        return value != null ? value.toString() : null;</span>
    }
    
    /**
     * استخراج مقدار Long از Map
     * 
     * انواع مختلف عددی را پشتیبانی می‌کند
     * 
     * @param map نقشه داده‌ها
     * @param key کلید
     * @return مقدار Long یا null
     */
    private Long getLongFromMap(Map&lt;String, Object&gt; map, String key) {
<span class="fc" id="L708">        Object value = map.get(key);</span>
<span class="fc bfc" id="L709" title="All 2 branches covered.">        if (value == null) return null;</span>
        
<span class="pc bpc" id="L711" title="1 of 2 branches missed.">        if (value instanceof Long) {</span>
<span class="fc" id="L712">            return (Long) value;</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">        } else if (value instanceof Integer) {</span>
<span class="nc" id="L714">            return ((Integer) value).longValue();</span>
<span class="nc bnc" id="L715" title="All 2 branches missed.">        } else if (value instanceof String) {</span>
            try {
<span class="nc" id="L717">                return Long.parseLong((String) value);</span>
<span class="nc" id="L718">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L719">                return null;</span>
            }
        }
<span class="nc" id="L722">        return null;</span>
    }
    
    /**
     * استخراج مقدار Double از Map
     * 
     * انواع مختلف عددی را پشتیبانی می‌کند
     * 
     * @param map نقشه داده‌ها
     * @param key کلید
     * @return مقدار Double یا null
     */
    private Double getDoubleFromMap(Map&lt;String, Object&gt; map, String key) {
<span class="fc" id="L735">        Object value = map.get(key);</span>
<span class="fc bfc" id="L736" title="All 2 branches covered.">        if (value == null) return null;</span>
        
<span class="pc bpc" id="L738" title="1 of 2 branches missed.">        if (value instanceof Double) {</span>
<span class="fc" id="L739">            return (Double) value;</span>
<span class="nc bnc" id="L740" title="All 2 branches missed.">        } else if (value instanceof Float) {</span>
<span class="nc" id="L741">            return ((Float) value).doubleValue();</span>
<span class="nc bnc" id="L742" title="All 2 branches missed.">        } else if (value instanceof Integer) {</span>
<span class="nc" id="L743">            return ((Integer) value).doubleValue();</span>
<span class="nc bnc" id="L744" title="All 2 branches missed.">        } else if (value instanceof Long) {</span>
<span class="nc" id="L745">            return ((Long) value).doubleValue();</span>
<span class="nc bnc" id="L746" title="All 2 branches missed.">        } else if (value instanceof String) {</span>
            try {
<span class="nc" id="L748">                return Double.parseDouble((String) value);</span>
<span class="nc" id="L749">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L750">                return null;</span>
            }
        }
<span class="nc" id="L753">        return null;</span>
    }
    
    /**
     * ارسال پاسخ JSON
     * 
     * @param exchange HTTP exchange
     * @param statusCode کد وضعیت HTTP
     * @param data داده برای serialize
     */
    private void sendJsonResponse(HttpExchange exchange, int statusCode, Object data) throws IOException {
<span class="fc" id="L764">        String jsonResponse = convertToJson(data);</span>
        
<span class="fc" id="L766">        exchange.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<span class="fc" id="L767">        exchange.sendResponseHeaders(statusCode, jsonResponse.getBytes().length);</span>
        
<span class="fc" id="L769">        try (OutputStream os = exchange.getResponseBody()) {</span>
<span class="fc" id="L770">            os.write(jsonResponse.getBytes());</span>
        }
<span class="fc" id="L772">    }</span>
    
    /**
     * ارسال پاسخ خطا
     * 
     * @param exchange HTTP exchange
     * @param statusCode کد خطای HTTP
     * @param message پیام خطا
     */
    private void sendErrorResponse(HttpExchange exchange, int statusCode, String message) throws IOException {
<span class="fc" id="L782">        Map&lt;String, Object&gt; errorResponse = new HashMap&lt;&gt;();</span>
<span class="fc" id="L783">        errorResponse.put(&quot;error&quot;, message);</span>
<span class="fc" id="L784">        errorResponse.put(&quot;status&quot;, statusCode);</span>
        
<span class="fc" id="L786">        sendJsonResponse(exchange, statusCode, errorResponse);</span>
<span class="fc" id="L787">    }</span>
    
    /**
     * تبدیل Object به JSON string
     * 
     * Serializer ساده برای انواع مختلف داده‌ها
     * 
     * @param data داده برای تبدیل
     * @return رشته JSON
     */
    private String convertToJson(Object data) {
<span class="fc bfc" id="L798" title="All 2 branches covered.">        if (data == null) {</span>
<span class="fc" id="L799">            return &quot;null&quot;;</span>
        }
        
<span class="fc bfc" id="L802" title="All 2 branches covered.">        if (data instanceof String) {</span>
<span class="fc" id="L803">            return &quot;\&quot;&quot; + escapeJson((String) data) + &quot;\&quot;&quot;;</span>
        }
        
<span class="fc bfc" id="L806" title="All 4 branches covered.">        if (data instanceof Number || data instanceof Boolean) {</span>
<span class="fc" id="L807">            return data.toString();</span>
        }
        
<span class="fc bfc" id="L810" title="All 2 branches covered.">        if (data instanceof Map) {</span>
<span class="fc" id="L811">            return convertMapToJson((Map&lt;?, ?&gt;) data);</span>
        }
        
<span class="fc bfc" id="L814" title="All 2 branches covered.">        if (data instanceof List) {</span>
<span class="fc" id="L815">            return convertListToJson((List&lt;?&gt;) data);</span>
        }
        
        // برای اشیاء پیچیده، از reflection استفاده کن
<span class="fc" id="L819">        return serializeObject(data);</span>
    }
    
    /**
     * تبدیل Map به JSON
     * 
     * @param map نقشه برای تبدیل
     * @return رشته JSON
     */
    private String convertMapToJson(Map&lt;?, ?&gt; map) {
<span class="fc" id="L829">        StringBuilder json = new StringBuilder(&quot;{&quot;);</span>
<span class="fc" id="L830">        boolean first = true;</span>
        
<span class="fc bfc" id="L832" title="All 2 branches covered.">        for (Map.Entry&lt;?, ?&gt; entry : map.entrySet()) {</span>
<span class="fc bfc" id="L833" title="All 2 branches covered.">            if (!first) json.append(&quot;,&quot;);</span>
<span class="fc" id="L834">            json.append(&quot;\&quot;&quot;).append(entry.getKey()).append(&quot;\&quot;:&quot;);</span>
<span class="fc" id="L835">            json.append(convertToJson(entry.getValue()));</span>
<span class="fc" id="L836">            first = false;</span>
<span class="fc" id="L837">        }</span>
        
<span class="fc" id="L839">        json.append(&quot;}&quot;);</span>
<span class="fc" id="L840">        return json.toString();</span>
    }
    
    /**
     * تبدیل List به JSON
     * 
     * @param list لیست برای تبدیل
     * @return رشته JSON
     */
    private String convertListToJson(List&lt;?&gt; list) {
<span class="fc" id="L850">        StringBuilder json = new StringBuilder(&quot;[&quot;);</span>
<span class="fc" id="L851">        boolean first = true;</span>
        
<span class="fc bfc" id="L853" title="All 2 branches covered.">        for (Object item : list) {</span>
<span class="fc bfc" id="L854" title="All 2 branches covered.">            if (!first) json.append(&quot;,&quot;);</span>
<span class="fc" id="L855">            json.append(convertToJson(item));</span>
<span class="fc" id="L856">            first = false;</span>
<span class="fc" id="L857">        }</span>
        
<span class="fc" id="L859">        json.append(&quot;]&quot;);</span>
<span class="fc" id="L860">        return json.toString();</span>
    }
    
    /**
     * Serialize اشیاء پیچیده با reflection
     * 
     * @param obj شیء برای serialize
     * @return رشته JSON
     */
    private String serializeObject(Object obj) {
        // سریال‌سازی ساده با reflection
<span class="fc" id="L871">        StringBuilder json = new StringBuilder(&quot;{&quot;);</span>
<span class="fc" id="L872">        boolean first = true;</span>
        
        try {
<span class="fc" id="L875">            Class&lt;?&gt; clazz = obj.getClass();</span>
<span class="fc" id="L876">            java.lang.reflect.Field[] fields = clazz.getDeclaredFields();</span>
            
<span class="fc bfc" id="L878" title="All 2 branches covered.">            for (java.lang.reflect.Field field : fields) {</span>
                // نادیده گیری فیلدهای static و transient
<span class="fc bfc" id="L880" title="All 2 branches covered.">                if (java.lang.reflect.Modifier.isStatic(field.getModifiers()) ||</span>
<span class="pc bpc" id="L881" title="1 of 2 branches missed.">                    java.lang.reflect.Modifier.isTransient(field.getModifiers())) {</span>
<span class="nc" id="L882">                    continue;</span>
                }
                
<span class="fc" id="L885">                field.setAccessible(true);</span>
<span class="fc" id="L886">                Object value = field.get(obj);</span>
                
<span class="fc bfc" id="L888" title="All 2 branches covered.">                if (!first) json.append(&quot;,&quot;);</span>
<span class="fc" id="L889">                json.append(&quot;\&quot;&quot;).append(field.getName()).append(&quot;\&quot;:&quot;);</span>
<span class="fc" id="L890">                json.append(convertToJson(value));</span>
<span class="fc" id="L891">                first = false;</span>
            }
<span class="fc" id="L893">        } catch (Exception e) {</span>
            // Fallback به toString
<span class="fc" id="L895">            return &quot;\&quot;&quot; + escapeJson(obj.toString()) + &quot;\&quot;&quot;;</span>
<span class="fc" id="L896">        }</span>
        
<span class="fc" id="L898">        json.append(&quot;}&quot;);</span>
<span class="fc" id="L899">        return json.toString();</span>
    }
    
    /**
     * Escape کردن رشته برای JSON
     * 
     * @param str رشته برای escape
     * @return رشته escape شده
     */
    private String escapeJson(String str) {
<span class="pc bpc" id="L909" title="1 of 2 branches missed.">        if (str == null) return &quot;&quot;;</span>
<span class="fc" id="L910">        return str.replace(&quot;\\&quot;, &quot;\\\\&quot;)</span>
<span class="fc" id="L911">                  .replace(&quot;\&quot;&quot;, &quot;\\\&quot;&quot;)</span>
<span class="fc" id="L912">                  .replace(&quot;\n&quot;, &quot;\\n&quot;)</span>
<span class="fc" id="L913">                  .replace(&quot;\r&quot;, &quot;\\r&quot;)</span>
<span class="fc" id="L914">                  .replace(&quot;\t&quot;, &quot;\\t&quot;);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>