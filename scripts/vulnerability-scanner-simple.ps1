# Food Ordering System - Simple Vulnerability Scanner
# Phase 44: Security Hardening

Write-Host "üîç Food Ordering Vulnerability Scanner" -ForegroundColor Cyan
Write-Host "=====================================" -ForegroundColor Cyan

$ProjectRoot = Get-Location
$TimeStamp = Get-Date -Format "yyyyMMdd-HHmmss"

# Counters
$CriticalIssues = 0
$HighIssues = 0
$MediumIssues = 0
$LowIssues = 0
$AllIssues = @()

function Add-Issue {
    param($Category, $Title, $Level, $File, $Fix)
    
    $issue = [PSCustomObject]@{
        Category = $Category
        Title = $Title
        Level = $Level
        File = $File
        Fix = $Fix
    }
    
    $script:AllIssues += $issue
    
    switch ($Level) {
        "CRITICAL" { $script:CriticalIssues++; $color = "Red" }
        "HIGH" { $script:HighIssues++; $color = "Red" }
        "MEDIUM" { $script:MediumIssues++; $color = "Yellow" }
        "LOW" { $script:LowIssues++; $color = "Gray" }
    }
    
    Write-Host "‚ö†Ô∏è [$Level] $Title" -ForegroundColor $color
}

# Check Database Security
Write-Host "`nüóÑÔ∏è Checking Database..." -ForegroundColor Yellow

$dbFile = "$ProjectRoot\backend\food_ordering.db"
if (Test-Path $dbFile) {
    $dbBytes = [System.IO.File]::ReadAllBytes($dbFile)[0..15]
    $dbHeader = [System.Text.Encoding]::ASCII.GetString($dbBytes)
    
    if ($dbHeader.StartsWith("SQLite format")) {
        Add-Issue "Database" "Unencrypted Database" "HIGH" $dbFile "Implement database encryption"
    }
    
    Write-Host "‚úÖ Database checked" -ForegroundColor Green
} else {
    Add-Issue "Database" "Database Missing" "CRITICAL" $dbFile "Restore database file"
}

# Check Configuration Files
Write-Host "`n‚öôÔ∏è Checking Configuration..." -ForegroundColor Yellow

$configs = @(
    "$ProjectRoot\backend\src\main\resources\hibernate.cfg.xml",
    "$ProjectRoot\backend\src\main\resources\hibernate-production.cfg.xml"
)

foreach ($config in $configs) {
    if (Test-Path $config) {
        $content = Get-Content $config -Raw
        
        if ($content -match 'password.*=.*"(.+)"') {
            Add-Issue "Config" "Hardcoded Password" "CRITICAL" $config "Use environment variables for passwords"
        }
        
        if ($config -like "*production*" -and $content -match "http://") {
            Add-Issue "Config" "HTTP in Production" "HIGH" $config "Use HTTPS for all production URLs"
        }
    }
}

Write-Host "‚úÖ Configuration checked" -ForegroundColor Green

# Check Java Source Code
Write-Host "`n‚òï Checking Java Code..." -ForegroundColor Yellow

$javaFiles = Get-ChildItem "$ProjectRoot\backend\src" -Filter "*.java" -Recurse -ErrorAction SilentlyContinue
$javaCount = 0

foreach ($javaFile in $javaFiles) {
    $javaCount++
    $lines = Get-Content $javaFile.FullName
    
    for ($i = 0; $i -lt $lines.Count; $i++) {
        $line = $lines[$i]
        $lineNum = $i + 1
        
        # SQL Injection check
        if ($line -match "String.*=.*\+.*" -and $line -match "SELECT|INSERT|UPDATE|DELETE") {
            Add-Issue "Security" "SQL Injection Risk" "CRITICAL" "$($javaFile.FullName):$lineNum" "Use PreparedStatement instead of string concatenation"
        }
        
        # Hard-coded passwords
        if ($line -match 'password.*=.*"(.+)"') {
            Add-Issue "Security" "Hard-coded Password" "CRITICAL" "$($javaFile.FullName):$lineNum" "Use secure configuration for credentials"
        }
        
        # Debug code
        if ($line -match "System\.out\.print|printStackTrace") {
            Add-Issue "Code Quality" "Debug Code" "LOW" "$($javaFile.FullName):$lineNum" "Remove debug statements and use proper logging"
        }
        
        # Weak crypto
        if ($line -match "MD5|SHA1|DES") {
            Add-Issue "Crypto" "Weak Cryptography" "HIGH" "$($javaFile.FullName):$lineNum" "Use stronger algorithms like SHA-256 or AES-256"
        }
    }
}

Write-Host "‚úÖ $javaCount Java files scanned" -ForegroundColor Green

# Check PowerShell Scripts
Write-Host "`nüíª Checking Scripts..." -ForegroundColor Yellow

$scriptFiles = Get-ChildItem "$ProjectRoot\scripts" -Filter "*.ps1" -ErrorAction SilentlyContinue
$scriptCount = 0

foreach ($scriptFile in $scriptFiles) {
    if ($scriptFile.Name -eq "vulnerability-scanner-simple.ps1") { continue }
    
    $scriptCount++
    $lines = Get-Content $scriptFile.FullName
    
    for ($i = 0; $i -lt $lines.Count; $i++) {
        $line = $lines[$i]
        $lineNum = $i + 1
        
        # Execution policy bypass
        if ($line -match "-ExecutionPolicy.*Bypass") {
            Add-Issue "Script Security" "Execution Policy Bypass" "MEDIUM" "$($scriptFile.FullName):$lineNum" "Use proper execution policy instead of bypass"
        }
        
        # Command injection risk
        if ($line -match "Invoke-Expression|iex") {
            Add-Issue "Script Security" "Command Injection Risk" "HIGH" "$($scriptFile.FullName):$lineNum" "Avoid dynamic code execution"
        }
    }
}

Write-Host "‚úÖ $scriptCount PowerShell scripts scanned" -ForegroundColor Green

# Check for missing security features
Write-Host "`nüîí Checking Security Features..." -ForegroundColor Yellow

# Check for authentication logging
$logConfig = "$ProjectRoot\backend\src\main\resources\logback.xml"
if (Test-Path $logConfig) {
    $logContent = Get-Content $logConfig -Raw
    
    if (-not ($logContent -match "authentication" -or $logContent -match "login")) {
        Add-Issue "Logging" "Missing Auth Logging" "MEDIUM" $logConfig "Add authentication event logging"
    }
} else {
    Add-Issue "Configuration" "Missing Log Config" "MEDIUM" $logConfig "Configure proper logging"
}

# Show Results
Write-Host "`n" + "="*50 -ForegroundColor Cyan
Write-Host "üîç VULNERABILITY SCAN RESULTS" -ForegroundColor Cyan
Write-Host "="*50 -ForegroundColor Cyan

Write-Host "Total Issues Found: $($AllIssues.Count)" -ForegroundColor White
Write-Host "Critical: $CriticalIssues" -ForegroundColor Red
Write-Host "High: $HighIssues" -ForegroundColor Red
Write-Host "Medium: $MediumIssues" -ForegroundColor Yellow
Write-Host "Low: $LowIssues" -ForegroundColor Gray

$riskLevel = if ($CriticalIssues -gt 0) { "CRITICAL" }
             elseif ($HighIssues -gt 0) { "HIGH" }
             elseif ($MediumIssues -gt 0) { "MEDIUM" }
             else { "LOW" }

Write-Host "`nOverall Risk: $riskLevel" -ForegroundColor $(
    switch ($riskLevel) {
        "CRITICAL" { "Red" }
        "HIGH" { "Red" }
        "MEDIUM" { "Yellow" }
        "LOW" { "Green" }
    }
)

Write-Host "="*50 -ForegroundColor Cyan

# Generate Report
if (-not (Test-Path "logs")) {
    New-Item -Path "logs" -ItemType Directory -Force | Out-Null
}

$reportPath = "logs\vulnerability-scan-$TimeStamp.md"

$report = @"
# Vulnerability Scan Report

**Date**: $(Get-Date)  
**Total Issues**: $($AllIssues.Count)  
**Risk Level**: $riskLevel

## Summary
- Critical: $CriticalIssues
- High: $HighIssues  
- Medium: $MediumIssues
- Low: $LowIssues

## Issues Found

"@

foreach ($issue in $AllIssues) {
    $report += "`n### $($issue.Title) [$($issue.Level)]`n"
    $report += "**Category**: $($issue.Category)`n"
    $report += "**Location**: $($issue.File)`n" 
    $report += "**Recommendation**: $($issue.Fix)`n"
}

$report += @"

## Priority Actions

### Critical Issues
"@

$criticalItems = $AllIssues | Where-Object { $_.Level -eq "CRITICAL" }
foreach ($item in $criticalItems) {
    $report += "`n- **$($item.Title)**: $($item.Fix)"
}

$report += @"

### High Priority Issues
"@

$highItems = $AllIssues | Where-Object { $_.Level -eq "HIGH" }
foreach ($item in $highItems) {
    $report += "`n- $($item.Title): $($item.Fix)"
}

$nextScanDate = Get-Date -Date (Get-Date).AddDays(7) -Format "yyyy-MM-dd"
$report += "`n`n---`n**Next Scan Recommended**: $nextScanDate"

$report | Out-File $reportPath -Encoding UTF8

Write-Host "`nüìÑ Report saved: $reportPath" -ForegroundColor Green

# Exit with appropriate code
if ($CriticalIssues -gt 0) { exit 4 }
elseif ($HighIssues -gt 0) { exit 3 }
elseif ($MediumIssues -gt 0) { exit 2 }
else { exit 0 } 