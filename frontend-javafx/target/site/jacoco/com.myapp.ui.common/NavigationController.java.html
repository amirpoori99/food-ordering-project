<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NavigationController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Frontend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.ui.common</a> &gt; <span class="el_source">NavigationController.java</span></div><h1>NavigationController.java</h1><pre class="source lang-java linenums">package com.myapp.ui.common;

import javafx.fxml.FXMLLoader;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.stage.Stage;
import javafx.stage.Window;

import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

import javafx.application.Platform;

/**
 * کنترلر مدیریت navigation و تغییر صفحات
 * 
 * این کلاس مسئول مدیریت جابجایی بین صفحات مختلف برنامه شامل:
 * - بارگذاری و cache کردن FXML فایل‌ها
 * - مدیریت Scene ها و Stage اصلی
 * - پیاده‌سازی Singleton pattern
 * - مدیریت authentication و logout
 * - مدیریت عنوان پنجره
 * - error handling برای navigation
 * 
 * Pattern های استفاده شده:
 * - Singleton Pattern: یک instance در کل برنامه
 * - Cache Pattern: ذخیره Scene ها برای بهبود performance
 * - Thread Safety: اطمینان از اجرا در JavaFX Application Thread
 * 
 * ویژگی‌ها:
 * - 20+ صفحه مختلف
 * - Scene caching برای بهبود سرعت
 * - Thread-safe navigation
 * - Test mode support
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 */
public class NavigationController {
    
    /** instance singleton */
    private static NavigationController instance;
    
    /** Stage اصلی برنامه */
    private Stage primaryStage;
    
    /** Cache برای Scene ها جهت بهبود performance */
<span class="fc" id="L50">    private Map&lt;String, Scene&gt; sceneCache = new HashMap&lt;&gt;();</span>
    
    /** نام صفحه فعلی */
    private String currentScene;
    
    // ==================== ثابت‌های نام صفحات ====================
    
    /** صفحه ورود */
    public static final String LOGIN_SCENE = &quot;Login&quot;;
    
    /** صفحه ثبت نام */
    public static final String REGISTER_SCENE = &quot;Register&quot;;
    
    /** صفحه لیست رستوران‌ها */
    public static final String RESTAURANT_LIST_SCENE = &quot;RestaurantList&quot;;
    
    /** صفحه سبد خرید */
    public static final String CART_SCENE = &quot;Cart&quot;;
    
    /** صفحه تاریخچه سفارشات */
    public static final String ORDER_HISTORY_SCENE = &quot;OrderHistory&quot;;
    
    /** صفحه جزئیات سفارش */
    public static final String ORDER_DETAIL_SCENE = &quot;OrderDetail&quot;;
    
    /** صفحه پروفایل کاربر */
    public static final String PROFILE_SCENE = &quot;Profile&quot;;
    
    /** صفحه پروفایل و تاریخچه کاربر (فاز 28) */
    public static final String USER_PROFILE_SCENE = &quot;UserProfile&quot;;
    
    /** صفحه پرداخت */
    public static final String PAYMENT_SCENE = &quot;Payment&quot;;
    
    /** صفحه کیف پول */
    public static final String WALLET_SCENE = &quot;Wallet&quot;;
    
    /** صفحه داشبورد مدیر */
    public static final String ADMIN_DASHBOARD_SCENE = &quot;AdminDashboard&quot;;
    
    /** صفحه ایجاد رستوران جدید */
    public static final String CREATE_RESTAURANT_SCENE = &quot;CreateRestaurant&quot;;
    
    /** صفحه ویرایش رستوران */
    public static final String EDIT_RESTAURANT_SCENE = &quot;EditRestaurant&quot;;
    
    /** صفحه مدیریت آیتم‌های غذایی */
    public static final String ITEM_MANAGEMENT_SCENE = &quot;ItemManagement&quot;;
    
    /** صفحه مدیریت منو */
    public static final String MENU_MANAGEMENT_SCENE = &quot;MenuManagement&quot;;
    
    /** صفحه سفارشات موجود برای پیک */
    public static final String COURIER_AVAILABLE_SCENE = &quot;CourierAvailable&quot;;
    
    /** صفحه تاریخچه تحویل پیک */
    public static final String COURIER_HISTORY_SCENE = &quot;CourierHistory&quot;;
    
    /** صفحه جستجوی فروشندگان */
    public static final String VENDOR_SEARCH_SCENE = &quot;VendorSearch&quot;;
    
    /** صفحه نظرات و امتیازدهی */
    public static final String REVIEW_SCENE = &quot;Review&quot;;
    
    /** صفحه اعتبارسنجی کد تخفیف */
    public static final String COUPON_VALIDATION_SCENE = &quot;CouponValidation&quot;;
    
    /**
     * سازنده private برای پیاده‌سازی Singleton
     */
<span class="fc" id="L120">    private NavigationController() {}</span>
    
    /**
     * دریافت instance singleton
     * 
     * @return instance NavigationController
     */
    public static NavigationController getInstance() {
<span class="fc bfc" id="L128" title="All 2 branches covered.">        if (instance == null) {</span>
<span class="fc" id="L129">            instance = new NavigationController();</span>
        }
<span class="fc" id="L131">        return instance;</span>
    }
    
    /**
     * ریست کردن instance singleton (فقط برای تست)
     */
    public static void resetInstance() {
<span class="fc" id="L138">        instance = null;</span>
<span class="fc" id="L139">    }</span>
    
    /**
     * مقداردهی اولیه Navigation با Stage اصلی
     * 
     * @param primaryStage Stage اصلی برنامه
     * @throws NullPointerException اگر primaryStage null باشد
     */
    public void initialize(Stage primaryStage) {
<span class="fc bfc" id="L148" title="All 2 branches covered.">        if (primaryStage == null) {</span>
<span class="fc" id="L149">            throw new NullPointerException(&quot;Primary stage cannot be null&quot;);</span>
        }
        
<span class="fc" id="L152">        this.primaryStage = primaryStage;</span>
        
        // اطمینان از اجرا در JavaFX Application Thread
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">        if (Platform.isFxApplicationThread()) {</span>
<span class="nc" id="L156">            initializeStageProperties();</span>
        } else {
<span class="fc" id="L158">            Platform.runLater(this::initializeStageProperties);</span>
        }
<span class="fc" id="L160">    }</span>
    
    /**
     * مقداردهی ویژگی‌های Stage (باید در JavaFX thread اجرا شود)
     */
    private void initializeStageProperties() {
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">        if (this.primaryStage != null) {</span>
<span class="fc" id="L167">            this.primaryStage.setTitle(&quot;Food Ordering System&quot;);</span>
<span class="fc" id="L168">            this.primaryStage.setResizable(true);</span>
<span class="fc" id="L169">            this.primaryStage.setMinWidth(800);</span>
<span class="fc" id="L170">            this.primaryStage.setMinHeight(600);</span>
        }
<span class="fc" id="L172">    }</span>
    
    /**
     * انتقال به صفحه مشخص شده
     * 
     * این متد thread-safe است و می‌تواند از هر thread صدا زده شود
     * 
     * @param sceneName نام صفحه مقصد
     */
    public void navigateTo(String sceneName) {
        // مدیریت نام صفحه null یا خالی برای تست
<span class="fc bfc" id="L183" title="All 4 branches covered.">        if (sceneName == null || sceneName.trim().isEmpty()) {</span>
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">            if (!isTestMode()) {</span>
<span class="nc" id="L185">                showError(&quot;Navigation Error&quot;, &quot;Scene name cannot be null or empty&quot;, null);</span>
            }
<span class="fc" id="L187">            return;</span>
        }
        
        // اطمینان از اجرا در JavaFX Application Thread
<span class="fc bfc" id="L191" title="All 2 branches covered.">        if (Platform.isFxApplicationThread()) {</span>
<span class="fc" id="L192">            navigateToInternal(sceneName);</span>
        } else {
<span class="fc" id="L194">            Platform.runLater(() -&gt; navigateToInternal(sceneName));</span>
        }
<span class="fc" id="L196">    }</span>
    
    /**
     * متد داخلی navigation (باید در FX thread اجرا شود)
     * 
     * @param sceneName نام صفحه
     */
    private void navigateToInternal(String sceneName) {
        try {
<span class="fc" id="L205">            Scene scene = getScene(sceneName);</span>
<span class="fc bfc" id="L206" title="All 2 branches covered.">            if (scene != null) {</span>
<span class="fc" id="L207">                primaryStage.setScene(scene);</span>
<span class="fc" id="L208">                primaryStage.show();</span>
<span class="fc" id="L209">                currentScene = sceneName;</span>
                
                // به‌روزرسانی عنوان پنجره
<span class="fc" id="L212">                updateWindowTitle(sceneName);</span>
            }
<span class="nc" id="L214">        } catch (IOException e) {</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">            if (!isTestMode()) {</span>
<span class="nc" id="L216">                showError(&quot;Navigation Error&quot;, &quot;Could not load scene: &quot; + sceneName, e);</span>
            }
            // در حالت تست، خطا را بی‌سروصدا مدیریت کن
<span class="fc" id="L219">        }</span>
<span class="fc" id="L220">    }</span>
    
    /**
     * انتقال به صفحه با داده
     * 
     * @param sceneName نام صفحه
     * @param data داده برای انتقال
     */
    public void navigateTo(String sceneName, Object data) {
        // فعلاً فقط به صفحه منتقل می‌شود
        // در آینده می‌توان مکانیسم انتقال داده پیاده‌سازی کرد
<span class="fc" id="L231">        navigateTo(sceneName);</span>
<span class="fc" id="L232">    }</span>
    
    /**
     * دریافت Scene از cache یا بارگذاری آن
     * 
     * @param sceneName نام صفحه
     * @return Scene مربوطه
     * @throws IOException در صورت خطا در بارگذاری FXML
     */
    private Scene getScene(String sceneName) throws IOException {
        // بررسی وجود در cache
<span class="pc bpc" id="L243" title="1 of 2 branches missed.">        if (sceneCache.containsKey(sceneName)) {</span>
<span class="nc" id="L244">            return sceneCache.get(sceneName);</span>
        }
        
        // بارگذاری فایل FXML
<span class="fc" id="L248">        String fxmlPath = &quot;/fxml/&quot; + sceneName + &quot;.fxml&quot;;</span>
<span class="fc" id="L249">        FXMLLoader loader = new FXMLLoader(getClass().getResource(fxmlPath));</span>
        
<span class="fc bfc" id="L251" title="All 2 branches covered.">        if (loader.getLocation() == null) {</span>
            // در حالت تست، exception نمی‌اندازیم
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">            if (isTestMode()) {</span>
<span class="fc" id="L254">                return null;</span>
            }
<span class="nc" id="L256">            throw new IOException(&quot;FXML file not found: &quot; + fxmlPath);</span>
        }
        
<span class="fc" id="L259">        Parent root = loader.load();</span>
<span class="fc" id="L260">        Scene scene = new Scene(root);</span>
        
        // اعمال CSS در صورت وجود
<span class="fc" id="L263">        String cssPath = &quot;/css/&quot; + sceneName + &quot;.css&quot;;</span>
<span class="pc bpc" id="L264" title="1 of 2 branches missed.">        if (getClass().getResource(cssPath) != null) {</span>
<span class="nc" id="L265">            scene.getStylesheets().add(getClass().getResource(cssPath).toExternalForm());</span>
        }
        
        // cache کردن Scene
<span class="fc" id="L269">        sceneCache.put(sceneName, scene);</span>
        
<span class="fc" id="L271">        return scene;</span>
    }
    
    /**
     * پاک کردن تمام cache صفحات (برای reload مفید است)
     */
    public void clearCache() {
<span class="fc" id="L278">        sceneCache.clear();</span>
<span class="fc" id="L279">        currentScene = null; // ریست صفحه فعلی برای تست</span>
<span class="fc" id="L280">    }</span>
    
    /**
     * پاک کردن صفحه خاص از cache
     * 
     * @param sceneName نام صفحه
     */
    public void clearCache(String sceneName) {
<span class="fc" id="L288">        sceneCache.remove(sceneName);</span>
<span class="fc" id="L289">    }</span>
    
    /**
     * دریافت نام صفحه فعلی
     * 
     * @return نام صفحه فعلی
     */
    public String getCurrentScene() {
<span class="fc" id="L297">        return currentScene;</span>
    }
    
    /**
     * بررسی احراز هویت کاربر و هدایت مناسب
     */
    public void checkAuthenticationAndRedirect() {
<span class="fc bfc" id="L304" title="All 2 branches covered.">        if (HttpClientUtil.isAuthenticated()) {</span>
            // کاربر احراز هویت شده، انتقال به صفحه اصلی
<span class="fc" id="L306">            navigateTo(RESTAURANT_LIST_SCENE);</span>
        } else {
            // کاربر احراز هویت نشده، انتقال به صفحه ورود
<span class="fc" id="L309">            navigateTo(LOGIN_SCENE);</span>
        }
<span class="fc" id="L311">    }</span>
    
    /**
     * خروج از حساب کاربری و انتقال به صفحه ورود
     */
    public void logout() {
        // فراخوانی API خروج (token ها را پاک می‌کند)
<span class="fc" id="L318">        HttpClientUtil.logout();</span>
        
        // اطمینان از پاک شدن token ها محلی (اضافه ولی ایمن)
<span class="fc" id="L321">        HttpClientUtil.clearTokens();</span>
        
        // پاک کردن تمام cache صفحات
<span class="fc" id="L324">        clearCache();</span>
        
        // انتقال به صفحه ورود
<span class="fc" id="L327">        navigateTo(LOGIN_SCENE);</span>
<span class="fc" id="L328">    }</span>
    
    /**
     * نمایش dialog خطا
     * 
     * @param title عنوان
     * @param message پیام
     * @param exception خطای رخ داده
     */
    public void showError(String title, String message, Exception exception) {
        // فعلاً در console چاپ می‌شود
        // در پیاده‌سازی کامل، dialog مناسب نمایش داده می‌شود
<span class="fc" id="L340">        System.err.println(&quot;ERROR: &quot; + title);</span>
<span class="fc" id="L341">        System.err.println(&quot;Message: &quot; + message);</span>
<span class="fc bfc" id="L342" title="All 2 branches covered.">        if (exception != null) {</span>
<span class="fc" id="L343">            exception.printStackTrace();</span>
        }
<span class="fc" id="L345">    }</span>
    
    /**
     * نمایش dialog اطلاعات
     * 
     * @param title عنوان
     * @param message پیام
     */
    public void showInfo(String title, String message) {
        // فعلاً در console چاپ می‌شود
        // در پیاده‌سازی کامل، dialog مناسب نمایش داده می‌شود
<span class="fc" id="L356">        System.out.println(&quot;INFO: &quot; + title + &quot; - &quot; + message);</span>
<span class="fc" id="L357">    }</span>
    
    /**
     * نمایش dialog موفقیت
     * 
     * @param title عنوان
     * @param message پیام
     */
    public void showSuccess(String title, String message) {
        // فعلاً در console چاپ می‌شود
        // در پیاده‌سازی کامل، dialog مناسب نمایش داده می‌شود
<span class="fc" id="L368">        System.out.println(&quot;SUCCESS: &quot; + title + &quot; - &quot; + message);</span>
<span class="fc" id="L369">    }</span>
    
    /**
     * به‌روزرسانی عنوان پنجره بر اساس صفحه فعلی
     * 
     * @param sceneName نام صفحه
     */
    private void updateWindowTitle(String sceneName) {
<span class="fc" id="L377">        String title = &quot;Food Ordering System&quot;;</span>
        
<span class="pc bpc" id="L379" title="18 of 20 branches missed.">        switch (sceneName) {</span>
            case LOGIN_SCENE:
<span class="fc" id="L381">                title += &quot; - ورود&quot;;</span>
<span class="fc" id="L382">                break;</span>
            case REGISTER_SCENE:
<span class="nc" id="L384">                title += &quot; - ثبت نام&quot;;</span>
<span class="nc" id="L385">                break;</span>
            case RESTAURANT_LIST_SCENE:
<span class="fc" id="L387">                title += &quot; - رستوران‌ها&quot;;</span>
<span class="fc" id="L388">                break;</span>
            case CART_SCENE:
<span class="nc" id="L390">                title += &quot; - سبد خرید&quot;;</span>
<span class="nc" id="L391">                break;</span>
            case ORDER_HISTORY_SCENE:
<span class="nc" id="L393">                title += &quot; - تاریخچه سفارشات&quot;;</span>
<span class="nc" id="L394">                break;</span>
            case PROFILE_SCENE:
<span class="nc" id="L396">                title += &quot; - پروفایل&quot;;</span>
<span class="nc" id="L397">                break;</span>
            case USER_PROFILE_SCENE:
<span class="nc" id="L399">                title += &quot; - مدیریت پروفایل و تاریخچه&quot;;</span>
<span class="nc" id="L400">                break;</span>
            case PAYMENT_SCENE:
<span class="nc" id="L402">                title += &quot; - پرداخت&quot;;</span>
<span class="nc" id="L403">                break;</span>
            case WALLET_SCENE:
<span class="nc" id="L405">                title += &quot; - کیف پول&quot;;</span>
<span class="nc" id="L406">                break;</span>
            case ADMIN_DASHBOARD_SCENE:
<span class="nc" id="L408">                title += &quot; - داشبورد مدیر&quot;;</span>
<span class="nc" id="L409">                break;</span>
            case CREATE_RESTAURANT_SCENE:
<span class="nc" id="L411">                title += &quot; - ایجاد رستوران&quot;;</span>
<span class="nc" id="L412">                break;</span>
            case EDIT_RESTAURANT_SCENE:
<span class="nc" id="L414">                title += &quot; - ویرایش رستوران&quot;;</span>
<span class="nc" id="L415">                break;</span>
            case ITEM_MANAGEMENT_SCENE:
<span class="nc" id="L417">                title += &quot; - مدیریت آیتم‌ها&quot;;</span>
<span class="nc" id="L418">                break;</span>
            case MENU_MANAGEMENT_SCENE:
<span class="nc" id="L420">                title += &quot; - مدیریت منو&quot;;</span>
<span class="nc" id="L421">                break;</span>
            case COURIER_AVAILABLE_SCENE:
<span class="nc" id="L423">                title += &quot; - سفارشات موجود&quot;;</span>
<span class="nc" id="L424">                break;</span>
            case COURIER_HISTORY_SCENE:
<span class="nc" id="L426">                title += &quot; - تاریخچه تحویل&quot;;</span>
<span class="nc" id="L427">                break;</span>
            case VENDOR_SEARCH_SCENE:
<span class="nc" id="L429">                title += &quot; - جستجوی فروشندگان&quot;;</span>
<span class="nc" id="L430">                break;</span>
            case REVIEW_SCENE:
<span class="nc" id="L432">                title += &quot; - نظرات&quot;;</span>
<span class="nc" id="L433">                break;</span>
            case COUPON_VALIDATION_SCENE:
<span class="nc" id="L435">                title += &quot; - اعتبارسنجی کد تخفیف&quot;;</span>
<span class="nc" id="L436">                break;</span>
            default:
<span class="nc" id="L438">                title += &quot; - &quot; + sceneName;</span>
        }
        
<span class="pc bpc" id="L441" title="1 of 2 branches missed.">        if (primaryStage != null) {</span>
<span class="fc" id="L442">            primaryStage.setTitle(title);</span>
        }
<span class="fc" id="L444">    }</span>
    
    /**
     * دریافت Stage اصلی
     * 
     * @return primary stage
     */
    public Stage getPrimaryStage() {
<span class="fc" id="L452">        return primaryStage;</span>
    }
    
    /**
     * بررسی اجرا در حالت تست
     * 
     * @return true اگر در حالت تست اجرا شود
     */
    private boolean isTestMode() {
        // بررسی property مربوط به TestFX
<span class="fc" id="L462">        String testMode = System.getProperty(&quot;testfx.robot&quot;);</span>
<span class="pc bpc" id="L463" title="1 of 2 branches missed.">        if (testMode != null) {</span>
<span class="fc" id="L464">            return true;</span>
        }
        
        // بررسی وجود کلاس‌های TestFX در classpath
        try {
<span class="nc" id="L469">            Class.forName(&quot;org.testfx.framework.junit5.ApplicationTest&quot;);</span>
<span class="nc" id="L470">            return true;</span>
<span class="nc" id="L471">        } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L472">            return false;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>