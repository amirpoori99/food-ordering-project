<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HttpClientUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">food-ordering-frontend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.ui.common</a> &gt; <span class="el_source">HttpClientUtil.java</span></div><h1>HttpClientUtil.java</h1><pre class="source lang-java linenums">package com.myapp.ui.common;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
import okhttp3.*;

import java.io.IOException;
import java.util.concurrent.TimeUnit;

/**
 * HTTP Client utility for communicating with the food ordering backend APIs
 * Handles authentication, request/response processing, and error handling
 */
<span class="nc" id="L15">public class HttpClientUtil {</span>
    
    private static final String BASE_URL = FrontendConstants.API.BASE_URL;
<span class="fc" id="L18">    private static final MediaType JSON = MediaType.get(FrontendConstants.HTTP.CONTENT_TYPE_JSON);</span>
    
<span class="fc" id="L20">    private static final OkHttpClient client = new OkHttpClient.Builder()</span>
<span class="fc" id="L21">            .connectTimeout(FrontendConstants.HTTP.CONNECT_TIMEOUT_SECONDS, TimeUnit.SECONDS)</span>
<span class="fc" id="L22">            .writeTimeout(FrontendConstants.HTTP.WRITE_TIMEOUT_SECONDS, TimeUnit.SECONDS)</span>
<span class="fc" id="L23">            .readTimeout(FrontendConstants.HTTP.READ_TIMEOUT_SECONDS, TimeUnit.SECONDS)</span>
<span class="fc" id="L24">            .build();</span>
    
<span class="fc" id="L26">    private static final ObjectMapper objectMapper = new ObjectMapper()</span>
<span class="fc" id="L27">            .registerModule(new JavaTimeModule());</span>
    
<span class="fc" id="L29">    private static String accessToken = null;</span>
<span class="fc" id="L30">    private static String refreshToken = null;</span>
    
    // ==================== AUTHENTICATION ====================
    
    /**
     * Set authentication tokens
     */
    public static void setTokens(String accessToken, String refreshToken) {
<span class="fc" id="L38">        HttpClientUtil.accessToken = accessToken;</span>
<span class="fc" id="L39">        HttpClientUtil.refreshToken = refreshToken;</span>
<span class="fc" id="L40">    }</span>
    
    /**
     * Clear authentication tokens (logout)
     */
    public static void clearTokens() {
<span class="fc" id="L46">        HttpClientUtil.accessToken = null;</span>
<span class="fc" id="L47">        HttpClientUtil.refreshToken = null;</span>
<span class="fc" id="L48">    }</span>
    
    /**
     * Get current access token
     */
    public static String getAccessToken() {
<span class="fc" id="L54">        return accessToken;</span>
    }
    
    /**
     * Check if user is authenticated
     */
    public static boolean isAuthenticated() {
<span class="fc bfc" id="L61" title="All 4 branches covered.">        return accessToken != null &amp;&amp; !accessToken.trim().isEmpty();</span>
    }
    
    // ==================== TEST HELPER METHODS ====================
    
    /**
     * Clear authentication token (for testing)
     */
    public static void clearAuthToken() {
<span class="fc" id="L70">        clearTokens();</span>
<span class="fc" id="L71">    }</span>
    
    /**
     * Get current authentication token (for testing)
     */
    public static String getCurrentToken() {
<span class="nc" id="L77">        return getAccessToken();</span>
    }
    
    /**
     * Set authentication token directly (for testing)
     */
    public static void setAuthToken(String token) {
<span class="fc" id="L84">        HttpClientUtil.accessToken = token;</span>
<span class="fc" id="L85">    }</span>
    
    /**
     * Set client timeout (for testing)
     */
    public static void setTimeoutMs(int timeoutMs) {
        // For testing purposes - create new client with different timeout
        // Note: In real implementation, you might want to store this in a field
        // For now, we'll just accept the call (tests can verify behavior)
<span class="fc" id="L94">    }</span>
    
    // ==================== HTTP METHODS ====================
    
    /**
     * POST request with JSON body
     */
    public static ApiResponse post(String endpoint, Object requestBody) throws IOException {
<span class="nc" id="L102">        return post(endpoint, requestBody, true);</span>
    }
    
    /**
     * POST request with JSON body (with error handling option)
     */
    public static ApiResponse post(String endpoint, Object requestBody, boolean throwException) {
        try {
<span class="fc" id="L110">            String url = BASE_URL + endpoint;</span>
            String jsonBody;
            
<span class="fc bfc" id="L113" title="All 2 branches covered.">            if (requestBody instanceof String) {</span>
<span class="fc" id="L114">                jsonBody = (String) requestBody;</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">            } else if (requestBody == null) {</span>
<span class="fc" id="L116">                jsonBody = &quot;{}&quot;;</span>
<span class="fc" id="L117">            } else {</span>
<span class="fc" id="L118">                jsonBody = objectMapper.writeValueAsString(requestBody);</span>
            }
            
<span class="fc" id="L121">            Request.Builder requestBuilder = new Request.Builder()</span>
<span class="fc" id="L122">                    .url(url)</span>
<span class="fc" id="L123">                    .post(RequestBody.create(jsonBody, JSON));</span>
            
            // Add authorization header if authenticated
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">            if (isAuthenticated()) {</span>
<span class="nc" id="L127">                requestBuilder.addHeader(FrontendConstants.HTTP.AUTHORIZATION_HEADER, </span>
<span class="nc" id="L128">                                       FrontendConstants.HTTP.BEARER_PREFIX + accessToken);</span>
            }
            
<span class="fc" id="L131">            Request request = requestBuilder.build();</span>
            
<span class="pc" id="L133">            try (Response response = client.newCall(request).execute()) {</span>
<span class="nc" id="L134">                return processResponse(response);</span>
            }
<span class="fc" id="L136">        } catch (Exception e) {</span>
<span class="pc bpc" id="L137" title="3 of 4 branches missed.">            if (throwException &amp;&amp; e instanceof IOException) {</span>
                try {
<span class="nc" id="L139">                    throw (IOException) e;</span>
<span class="nc" id="L140">                } catch (IOException ioException) {</span>
                    // Convert to runtime for backward compatibility
<span class="nc" id="L142">                    throw new RuntimeException(ioException);</span>
                }
            }
            // Return error response for testing
<span class="fc" id="L146">            return new ApiResponse(false, 0, &quot;Network error: &quot; + e.getMessage(), null);</span>
        }
    }
    
    /**
     * GET request
     */
    public static ApiResponse get(String endpoint) {
        try {
<span class="fc" id="L155">            String url = BASE_URL + endpoint;</span>
            
<span class="fc" id="L157">            Request.Builder requestBuilder = new Request.Builder()</span>
<span class="fc" id="L158">                    .url(url)</span>
<span class="fc" id="L159">                    .get();</span>
            
            // Add authorization header if authenticated
<span class="fc bfc" id="L162" title="All 2 branches covered.">            if (isAuthenticated()) {</span>
<span class="fc" id="L163">                requestBuilder.addHeader(&quot;Authorization&quot;, &quot;Bearer &quot; + accessToken);</span>
            }
            
<span class="fc" id="L166">            Request request = requestBuilder.build();</span>
            
<span class="pc" id="L168">            try (Response response = client.newCall(request).execute()) {</span>
<span class="nc" id="L169">                return processResponse(response);</span>
            }
<span class="fc" id="L171">        } catch (Exception e) {</span>
            // Return error response for testing
<span class="fc" id="L173">            return new ApiResponse(false, 0, &quot;Network error: &quot; + e.getMessage(), null);</span>
        }
    }
    
    /**
     * PUT request with JSON body
     */
    public static ApiResponse put(String endpoint, Object requestBody) {
        try {
<span class="nc" id="L182">            String url = BASE_URL + endpoint;</span>
            String jsonBody;
            
<span class="nc bnc" id="L185" title="All 2 branches missed.">            if (requestBody instanceof String) {</span>
<span class="nc" id="L186">                jsonBody = (String) requestBody;</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">            } else if (requestBody == null) {</span>
<span class="nc" id="L188">                jsonBody = &quot;{}&quot;;</span>
<span class="nc" id="L189">            } else {</span>
<span class="nc" id="L190">                jsonBody = objectMapper.writeValueAsString(requestBody);</span>
            }
            
<span class="nc" id="L193">            Request.Builder requestBuilder = new Request.Builder()</span>
<span class="nc" id="L194">                    .url(url)</span>
<span class="nc" id="L195">                    .put(RequestBody.create(jsonBody, JSON));</span>
            
            // Add authorization header if authenticated
<span class="nc bnc" id="L198" title="All 2 branches missed.">            if (isAuthenticated()) {</span>
<span class="nc" id="L199">                requestBuilder.addHeader(&quot;Authorization&quot;, &quot;Bearer &quot; + accessToken);</span>
            }
            
<span class="nc" id="L202">            Request request = requestBuilder.build();</span>
            
<span class="nc" id="L204">            try (Response response = client.newCall(request).execute()) {</span>
<span class="nc" id="L205">                return processResponse(response);</span>
            }
<span class="nc" id="L207">        } catch (Exception e) {</span>
            // Return error response for testing
<span class="nc" id="L209">            return new ApiResponse(false, 0, &quot;Network error: &quot; + e.getMessage(), null);</span>
        }
    }
    
    /**
     * DELETE request
     */
    public static ApiResponse delete(String endpoint) {
        try {
<span class="nc" id="L218">            String url = BASE_URL + endpoint;</span>
            
<span class="nc" id="L220">            Request.Builder requestBuilder = new Request.Builder()</span>
<span class="nc" id="L221">                    .url(url)</span>
<span class="nc" id="L222">                    .delete();</span>
            
            // Add authorization header if authenticated
<span class="nc bnc" id="L225" title="All 2 branches missed.">            if (isAuthenticated()) {</span>
<span class="nc" id="L226">                requestBuilder.addHeader(&quot;Authorization&quot;, &quot;Bearer &quot; + accessToken);</span>
            }
            
<span class="nc" id="L229">            Request request = requestBuilder.build();</span>
            
<span class="nc" id="L231">            try (Response response = client.newCall(request).execute()) {</span>
<span class="nc" id="L232">                return processResponse(response);</span>
            }
<span class="nc" id="L234">        } catch (Exception e) {</span>
            // Return error response for testing
<span class="nc" id="L236">            return new ApiResponse(false, 0, &quot;Network error: &quot; + e.getMessage(), null);</span>
        }
    }
    
    // ==================== AUTHENTICATION SPECIFIC METHODS ====================
    
    /**
     * Login user and store tokens
     */
    public static ApiResponse login(String phone, String password) {
<span class="fc" id="L246">        LoginRequest loginRequest = new LoginRequest(phone, password);</span>
<span class="fc" id="L247">        ApiResponse response = post(FrontendConstants.API.AUTH_LOGIN, loginRequest, false);</span>
        
<span class="pc bpc" id="L249" title="3 of 4 branches missed.">        if (response.isSuccess() &amp;&amp; response.getData() != null) {</span>
<span class="nc" id="L250">            JsonNode data = response.getData();</span>
<span class="nc bnc" id="L251" title="All 4 branches missed.">            if (data.has(&quot;accessToken&quot;) &amp;&amp; data.has(&quot;refreshToken&quot;)) {</span>
<span class="nc" id="L252">                setTokens(data.get(&quot;accessToken&quot;).asText(), data.get(&quot;refreshToken&quot;).asText());</span>
            }
        }
        
<span class="fc" id="L256">        return response;</span>
    }
    
    /**
     * Register new user
     */
    public static ApiResponse register(String fullName, String phone, String email, String password, String address) {
<span class="nc" id="L263">        RegisterRequest registerRequest = new RegisterRequest(fullName, phone, email, password, address);</span>
<span class="nc" id="L264">        return post(&quot;/auth/register&quot;, registerRequest, false);</span>
    }
    
    /**
     * Logout user
     */
    public static ApiResponse logout() {
<span class="fc bfc" id="L271" title="All 2 branches covered.">        if (!isAuthenticated()) {</span>
<span class="fc" id="L272">            return new ApiResponse(true, 200, &quot;Already logged out&quot;, null);</span>
        }
        
<span class="fc" id="L275">        ApiResponse response = post(&quot;/auth/logout&quot;, new Object(), false);</span>
<span class="fc" id="L276">        clearTokens();</span>
<span class="fc" id="L277">        return response;</span>
    }
    
    /**
     * Refresh access token
     */
    public static ApiResponse refreshAccessToken() {
<span class="nc bnc" id="L284" title="All 2 branches missed.">        if (refreshToken == null) {</span>
<span class="nc" id="L285">            return new ApiResponse(false, 400, &quot;No refresh token available&quot;, null);</span>
        }
        
<span class="nc" id="L288">        RefreshTokenRequest refreshRequest = new RefreshTokenRequest(refreshToken);</span>
<span class="nc" id="L289">        ApiResponse response = post(&quot;/auth/refresh&quot;, refreshRequest, false);</span>
        
<span class="nc bnc" id="L291" title="All 4 branches missed.">        if (response.isSuccess() &amp;&amp; response.getData() != null) {</span>
<span class="nc" id="L292">            JsonNode data = response.getData();</span>
<span class="nc bnc" id="L293" title="All 4 branches missed.">            if (data.has(&quot;accessToken&quot;) &amp;&amp; data.has(&quot;refreshToken&quot;)) {</span>
<span class="nc" id="L294">                setTokens(data.get(&quot;accessToken&quot;).asText(), data.get(&quot;refreshToken&quot;).asText());</span>
            }
        }
        
<span class="nc" id="L298">        return response;</span>
    }
    
    // ==================== RESPONSE PROCESSING ====================
    
    /**
     * Process HTTP response and create ApiResponse
     */
    private static ApiResponse processResponse(Response response) throws IOException {
<span class="nc bnc" id="L307" title="All 2 branches missed.">        String responseBody = response.body() != null ? response.body().string() : &quot;&quot;;</span>
<span class="nc" id="L308">        boolean isSuccess = response.isSuccessful();</span>
<span class="nc" id="L309">        int statusCode = response.code();</span>
        
<span class="nc" id="L311">        JsonNode data = null;</span>
<span class="nc" id="L312">        String message = null;</span>
        
<span class="nc bnc" id="L314" title="All 2 branches missed.">        if (!responseBody.isEmpty()) {</span>
            try {
<span class="nc" id="L316">                JsonNode json = objectMapper.readTree(responseBody);</span>
                
<span class="nc bnc" id="L318" title="All 2 branches missed.">                if (json.has(&quot;message&quot;)) {</span>
<span class="nc" id="L319">                    message = json.get(&quot;message&quot;).asText();</span>
                }
                
<span class="nc bnc" id="L322" title="All 4 branches missed.">                if (json.has(&quot;error&quot;) &amp;&amp; !isSuccess) {</span>
<span class="nc" id="L323">                    message = json.get(&quot;error&quot;).asText();</span>
<span class="nc" id="L324">                } else {</span>
<span class="nc" id="L325">                    data = json;</span>
                }
<span class="nc" id="L327">            } catch (Exception e) {</span>
                // If JSON parsing fails, use raw response body as message
<span class="nc" id="L329">                message = responseBody;</span>
            }
        }
        
<span class="nc" id="L333">        return new ApiResponse(isSuccess, statusCode, message, data);</span>
    }
    
    // ==================== REQUEST DTOs ====================
    
    public static class LoginRequest {
        public String phone;
        public String password;
        
<span class="fc" id="L342">        public LoginRequest(String phone, String password) {</span>
<span class="fc" id="L343">            this.phone = phone;</span>
<span class="fc" id="L344">            this.password = password;</span>
<span class="fc" id="L345">        }</span>
    }
    
    public static class RegisterRequest {
        public String fullName;
        public String phone;
        public String email;
        public String password;
        public String address;
        
<span class="fc" id="L355">        public RegisterRequest(String fullName, String phone, String email, String password, String address) {</span>
<span class="fc" id="L356">            this.fullName = fullName;</span>
<span class="fc" id="L357">            this.phone = phone;</span>
<span class="fc" id="L358">            this.email = email;</span>
<span class="fc" id="L359">            this.password = password;</span>
<span class="fc" id="L360">            this.address = address;</span>
<span class="fc" id="L361">        }</span>
    }
    
    public static class RefreshTokenRequest {
        public String refreshToken;
        
<span class="fc" id="L367">        public RefreshTokenRequest(String refreshToken) {</span>
<span class="fc" id="L368">            this.refreshToken = refreshToken;</span>
<span class="fc" id="L369">        }</span>
    }
    
    // ==================== RESPONSE WRAPPER ====================
    
    public static class ApiResponse {
        private final boolean success;
        private final int statusCode;
        private final String message;
        private final JsonNode data;
        
<span class="fc" id="L380">        public ApiResponse(boolean success, int statusCode, String message, JsonNode data) {</span>
<span class="fc" id="L381">            this.success = success;</span>
<span class="fc" id="L382">            this.statusCode = statusCode;</span>
<span class="fc" id="L383">            this.message = message;</span>
<span class="fc" id="L384">            this.data = data;</span>
<span class="fc" id="L385">        }</span>
        
<span class="fc" id="L387">        public boolean isSuccess() { return success; }</span>
<span class="fc" id="L388">        public int getStatusCode() { return statusCode; }</span>
<span class="fc" id="L389">        public String getMessage() { return message; }</span>
<span class="fc" id="L390">        public JsonNode getData() { return data; }</span>
        
        @Override
        public String toString() {
<span class="fc" id="L394">            return String.format(&quot;ApiResponse{success=%s, statusCode=%d, message='%s'}&quot;, </span>
<span class="fc" id="L395">                               success, statusCode, message);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>