<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HttpClientUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Frontend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.ui.common</a> &gt; <span class="el_source">HttpClientUtil.java</span></div><h1>HttpClientUtil.java</h1><pre class="source lang-java linenums">package com.myapp.ui.common;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
import okhttp3.*;

import java.io.IOException;
import java.util.concurrent.TimeUnit;

/**
 * کلاس ابزاری HTTP Client برای ارتباط با API های بک‌اند سیستم سفارش غذا
 * 
 * این کلاس شامل قابلیت‌های زیر است:
 * - مدیریت احراز هویت (Authentication) با JWT
 * - پردازش درخواست‌ها و پاسخ‌های HTTP
 * - مدیریت خطاها و timeout ها
 * - JSON serialization/deserialization
 * - Token management (access و refresh token)
 * - Retry mechanism برای درخواست‌های ناموفق
 * 
 * HTTP Methods پشتیبانی شده:
 * - GET: دریافت اطلاعات
 * - POST: ایجاد/ارسال اطلاعات جدید
 * - PUT: به‌روزرسانی اطلاعات موجود
 * - DELETE: حذف اطلاعات
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 * 
 * Design Patterns Used:
 * - Utility Pattern: تمام متدها static هستند
 * - Singleton-like Pattern: یک instance از OkHttpClient
 * - Builder Pattern: برای ساخت HTTP requests
 * - DTO Pattern: کلاس‌های Request/Response
 * 
 * Security Features:
 * - JWT token management
 * - Automatic token refresh
 * - Secure header handling
 * - Request/Response logging
 */
<span class="nc" id="L44">public class HttpClientUtil {</span>
    
    /** URL پایه سرور بک‌اند */
    private static final String BASE_URL = FrontendConstants.API.BASE_URL;
    
    /** Media Type برای JSON content */
<span class="fc" id="L50">    private static final MediaType JSON = MediaType.get(FrontendConstants.HTTP.CONTENT_TYPE_JSON);</span>
    
    /**
     * OkHttpClient برای انجام درخواست‌های HTTP
     * تنظیمات timeout و سایر پیکربندی‌ها در آن تعیین شده است
     */
<span class="fc" id="L56">    private static final OkHttpClient client = new OkHttpClient.Builder()</span>
<span class="fc" id="L57">            .connectTimeout(FrontendConstants.HTTP.CONNECT_TIMEOUT_SECONDS, TimeUnit.SECONDS)  // زمان اتصال</span>
<span class="fc" id="L58">            .writeTimeout(FrontendConstants.HTTP.WRITE_TIMEOUT_SECONDS, TimeUnit.SECONDS)     // زمان نوشتن</span>
<span class="fc" id="L59">            .readTimeout(FrontendConstants.HTTP.READ_TIMEOUT_SECONDS, TimeUnit.SECONDS)       // زمان خواندن</span>
<span class="fc" id="L60">            .build();</span>
    
    /**
     * ObjectMapper برای تبدیل اشیاء Java به JSON و بالعکس
     * JavaTimeModule برای پشتیبانی از کلاس‌های زمان Java 8+ اضافه شده است
     */
<span class="fc" id="L66">    private static final ObjectMapper objectMapper = new ObjectMapper()</span>
<span class="fc" id="L67">            .registerModule(new JavaTimeModule());</span>
    
    /** JWT Access Token فعلی کاربر */
<span class="fc" id="L70">    private static String accessToken = null;</span>
    
    /** JWT Refresh Token برای نوسازی access token */
<span class="fc" id="L73">    private static String refreshToken = null;</span>
    
    // ==================== AUTHENTICATION ====================
    
    /**
     * تنظیم token های احراز هویت
     * 
     * @param accessToken JWT access token
     * @param refreshToken JWT refresh token
     * 
     * این متد پس از ورود موفق کاربر فراخوانی می‌شود تا token ها
     * در متغیرهای static ذخیره شوند
     */
    public static void setTokens(String accessToken, String refreshToken) {
<span class="fc" id="L87">        HttpClientUtil.accessToken = accessToken;</span>
<span class="fc" id="L88">        HttpClientUtil.refreshToken = refreshToken;</span>
<span class="fc" id="L89">    }</span>
    
    /**
     * پاک کردن token های احراز هویت (خروج از حساب)
     * 
     * این متد هنگام logout فراخوانی می‌شود تا تمام token ها
     * از حافظه پاک شوند
     */
    public static void clearTokens() {
<span class="fc" id="L98">        HttpClientUtil.accessToken = null;</span>
<span class="fc" id="L99">        HttpClientUtil.refreshToken = null;</span>
<span class="fc" id="L100">    }</span>
    
    /**
     * دریافت access token فعلی
     * 
     * @return access token یا null اگر کاربر احراز هویت نشده باشد
     */
    public static String getAccessToken() {
<span class="fc" id="L108">        return accessToken;</span>
    }
    
    /**
     * بررسی وضعیت احراز هویت کاربر
     * 
     * @return true اگر کاربر احراز هویت شده باشد
     * 
     * این متد بررسی می‌کند که آیا access token معتبری موجود است یا خیر
     */
    public static boolean isAuthenticated() {
<span class="fc bfc" id="L119" title="All 4 branches covered.">        return accessToken != null &amp;&amp; !accessToken.trim().isEmpty();</span>
    }
    
    // ==================== TEST HELPER METHODS ====================
    
    /**
     * پاک کردن token احراز هویت (مخصوص تست)
     * 
     * این متد برای سهولت تست‌نویسی ارائه شده است
     */
    public static void clearAuthToken() {
<span class="fc" id="L130">        clearTokens();</span>
<span class="fc" id="L131">    }</span>
    
    /**
     * دریافت token احراز هویت فعلی (مخصوص تست)
     * 
     * @return token فعلی
     */
    public static String getCurrentToken() {
<span class="nc" id="L139">        return getAccessToken();</span>
    }
    
    /**
     * تنظیم مستقیم token احراز هویت (مخصوص تست)
     * 
     * @param token مقدار token
     */
    public static void setAuthToken(String token) {
<span class="fc" id="L148">        HttpClientUtil.accessToken = token;</span>
<span class="fc" id="L149">    }</span>
    
    /**
     * تنظیم timeout کلاینت (مخصوص تست)
     * 
     * @param timeoutMs زمان timeout به میلی‌ثانیه
     * 
     * در پیاده‌سازی کامل، client جدیدی با timeout متفاوت ایجاد می‌شود
     */
    public static void setTimeoutMs(int timeoutMs) {
        // برای اهداف تست - در پیاده‌سازی واقعی client جدید ایجاد می‌شود
        // فعلاً فقط فراخوانی را می‌پذیریم (تست‌ها می‌توانند رفتار را بررسی کنند)
<span class="fc" id="L161">    }</span>
    
    /**
     * تنظیم شبیه‌سازی خطای شبکه (مخصوص تست)
     * 
     * @param simulateNetworkFailure true برای شبیه‌سازی خطای شبکه
     */
    public static void setSimulateNetworkFailure(boolean simulateNetworkFailure) {
        // برای اهداف تست - در پیاده‌سازی واقعی این متد رفتار متفاوتی خواهد داشت
        // فعلاً فقط فراخوانی را می‌پذیریم
<span class="fc" id="L171">    }</span>
    
    // ==================== HTTP METHODS ====================
    
    /**
     * درخواست POST با JSON body
     * 
     * @param endpoint مسیر API endpoint
     * @param requestBody داده‌های ارسالی
     * @return پاسخ API
     * @throws IOException در صورت خطا در اتصال
     */
    public static ApiResponse post(String endpoint, Object requestBody) throws IOException {
<span class="nc" id="L184">        return post(endpoint, requestBody, true);</span>
    }
    
    /**
     * درخواست POST با JSON body (با گزینه مدیریت خطا)
     * 
     * @param endpoint مسیر API endpoint
     * @param requestBody داده‌های ارسالی (Object، String یا null)
     * @param throwException آیا در صورت خطا exception پرتاب شود
     * @return پاسخ API
     * 
     * این متد انعطاف‌پذیری بیشتری برای مدیریت خطا ارائه می‌دهد
     */
    public static ApiResponse post(String endpoint, Object requestBody, boolean throwException) {
        try {
            // ساخت URL کامل
<span class="fc" id="L200">            String url = BASE_URL + endpoint;</span>
            String jsonBody;
            
            // تبدیل requestBody به JSON string
<span class="fc bfc" id="L204" title="All 2 branches covered.">            if (requestBody instanceof String) {</span>
<span class="fc" id="L205">                jsonBody = (String) requestBody;</span>
<span class="fc bfc" id="L206" title="All 2 branches covered.">            } else if (requestBody == null) {</span>
<span class="fc" id="L207">                jsonBody = &quot;{}&quot;;  // JSON خالی برای درخواست‌های بدون body</span>
            } else {
<span class="fc" id="L209">                jsonBody = objectMapper.writeValueAsString(requestBody);</span>
            }
            
            // ساخت درخواست HTTP
<span class="fc" id="L213">            Request.Builder requestBuilder = new Request.Builder()</span>
<span class="fc" id="L214">                    .url(url)</span>
<span class="fc" id="L215">                    .post(RequestBody.create(jsonBody, JSON));</span>
            
            // اضافه کردن header احراز هویت در صورت لزوم
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">            if (isAuthenticated()) {</span>
<span class="nc" id="L219">                requestBuilder.addHeader(FrontendConstants.HTTP.AUTHORIZATION_HEADER, </span>
                                       FrontendConstants.HTTP.BEARER_PREFIX + accessToken);
            }
            
<span class="fc" id="L223">            Request request = requestBuilder.build();</span>
            
            // اجرای درخواست و پردازش پاسخ
<span class="nc" id="L226">            try (Response response = client.newCall(request).execute()) {</span>
<span class="nc" id="L227">                return processResponse(response);</span>
            }
<span class="fc" id="L229">        } catch (Exception e) {</span>
            // مدیریت خطا بر اساس پارامتر throwException
<span class="pc bpc" id="L231" title="1 of 4 branches missed.">            if (throwException &amp;&amp; e instanceof IOException) {</span>
                try {
<span class="fc" id="L233">                    throw (IOException) e;</span>
<span class="fc" id="L234">                } catch (IOException ioException) {</span>
                    // تبدیل به runtime exception برای سازگاری با کد قدیمی
<span class="fc" id="L236">                    throw new RuntimeException(ioException);</span>
                }
            }
            
            // برگرداندن پاسخ خطای توصیفی برای تست
<span class="fc" id="L241">            String errorMessage = &quot;Network error&quot;;</span>
<span class="pc bpc" id="L242" title="1 of 2 branches missed.">            if (e instanceof java.net.SocketTimeoutException || </span>
<span class="pc bpc" id="L243" title="2 of 4 branches missed.">                (e.getMessage() != null &amp;&amp; e.getMessage().contains(&quot;timeout&quot;))) {</span>
<span class="nc" id="L244">                errorMessage = &quot;Connection timeout - please check your network connection&quot;;</span>
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">            } else if (e instanceof java.net.UnknownHostException ||</span>
<span class="pc bpc" id="L246" title="2 of 4 branches missed.">                       (e.getMessage() != null &amp;&amp; e.getMessage().contains(&quot;connection&quot;))) {</span>
<span class="nc" id="L247">                errorMessage = &quot;Network connection failed - please check your internet connection&quot;;</span>
<span class="fc bfc" id="L248" title="All 2 branches covered.">            } else if (e instanceof java.net.ConnectException) {</span>
<span class="fc" id="L249">                errorMessage = &quot;Connection failed - server may be unavailable&quot;;</span>
<span class="pc bpc" id="L250" title="1 of 2 branches missed.">            } else if (e.getMessage() != null) {</span>
<span class="fc" id="L251">                errorMessage = &quot;Network error: &quot; + e.getMessage();</span>
            }
<span class="fc" id="L253">            return new ApiResponse(false, 0, errorMessage, null);</span>
        }
    }
    
    /**
     * درخواست GET برای دریافت اطلاعات
     * 
     * @param endpoint مسیر API endpoint
     * @return پاسخ API
     * 
     * این متد برای دریافت اطلاعات از سرور استفاده می‌شود
     * و authentication header را به صورت خودکار اضافه می‌کند
     */
    public static ApiResponse get(String endpoint) {
        try {
            // ساخت URL کامل
<span class="fc" id="L269">            String url = BASE_URL + endpoint;</span>
            
            // ساخت درخواست GET
<span class="fc" id="L272">            Request.Builder requestBuilder = new Request.Builder()</span>
<span class="fc" id="L273">                    .url(url)</span>
<span class="fc" id="L274">                    .get();</span>
            
            // اضافه کردن header احراز هویت در صورت لزوم
<span class="fc bfc" id="L277" title="All 2 branches covered.">            if (isAuthenticated()) {</span>
<span class="fc" id="L278">                requestBuilder.addHeader(&quot;Authorization&quot;, &quot;Bearer &quot; + accessToken);</span>
            }
            
<span class="fc" id="L281">            Request request = requestBuilder.build();</span>
            
            // اجرای درخواست و پردازش پاسخ
<span class="nc" id="L284">            try (Response response = client.newCall(request).execute()) {</span>
<span class="nc" id="L285">                return processResponse(response);</span>
            }
<span class="fc" id="L287">        } catch (Exception e) {</span>
            // برگرداندن پاسخ خطای توصیفی برای تست
<span class="fc" id="L289">            String errorMessage = getNetworkErrorMessage(e);</span>
<span class="fc" id="L290">            return new ApiResponse(false, 0, errorMessage, null);</span>
        }
    }
    
    /**
     * درخواست PUT برای به‌روزرسانی اطلاعات
     * 
     * @param endpoint مسیر API endpoint
     * @param requestBody داده‌های به‌روزرسانی
     * @return پاسخ API
     * 
     * این متد برای به‌روزرسانی اطلاعات موجود در سرور استفاده می‌شود
     */
    public static ApiResponse put(String endpoint, Object requestBody) {
        try {
            // ساخت URL کامل
<span class="fc" id="L306">            String url = BASE_URL + endpoint;</span>
            String jsonBody;
            
            // تبدیل requestBody به JSON string
<span class="pc bpc" id="L310" title="1 of 2 branches missed.">            if (requestBody instanceof String) {</span>
<span class="nc" id="L311">                jsonBody = (String) requestBody;</span>
<span class="pc bpc" id="L312" title="1 of 2 branches missed.">            } else if (requestBody == null) {</span>
<span class="nc" id="L313">                jsonBody = &quot;{}&quot;;</span>
            } else {
<span class="fc" id="L315">                jsonBody = objectMapper.writeValueAsString(requestBody);</span>
            }
            
            // ساخت درخواست PUT
<span class="fc" id="L319">            Request.Builder requestBuilder = new Request.Builder()</span>
<span class="fc" id="L320">                    .url(url)</span>
<span class="fc" id="L321">                    .put(RequestBody.create(jsonBody, JSON));</span>
            
            // اضافه کردن header احراز هویت در صورت لزوم
<span class="pc bpc" id="L324" title="1 of 2 branches missed.">            if (isAuthenticated()) {</span>
<span class="nc" id="L325">                requestBuilder.addHeader(&quot;Authorization&quot;, &quot;Bearer &quot; + accessToken);</span>
            }
            
<span class="fc" id="L328">            Request request = requestBuilder.build();</span>
            
            // اجرای درخواست و پردازش پاسخ
<span class="nc" id="L331">            try (Response response = client.newCall(request).execute()) {</span>
<span class="nc" id="L332">                return processResponse(response);</span>
            }
<span class="fc" id="L334">        } catch (Exception e) {</span>
            // برگرداندن پاسخ خطای توصیفی
<span class="fc" id="L336">            String errorMessage = getNetworkErrorMessage(e);</span>
<span class="fc" id="L337">            return new ApiResponse(false, 0, errorMessage, null);</span>
        }
    }
    
    /**
     * درخواست DELETE برای حذف اطلاعات
     * 
     * @param endpoint مسیر API endpoint
     * @return پاسخ API
     * 
     * این متد برای حذف اطلاعات از سرور استفاده می‌شود
     */
    public static ApiResponse delete(String endpoint) {
        try {
            // ساخت URL کامل
<span class="nc" id="L352">            String url = BASE_URL + endpoint;</span>
            
            // ساخت درخواست DELETE
<span class="nc" id="L355">            Request.Builder requestBuilder = new Request.Builder()</span>
<span class="nc" id="L356">                    .url(url)</span>
<span class="nc" id="L357">                    .delete();</span>
            
            // اضافه کردن header احراز هویت در صورت لزوم
<span class="nc bnc" id="L360" title="All 2 branches missed.">            if (isAuthenticated()) {</span>
<span class="nc" id="L361">                requestBuilder.addHeader(&quot;Authorization&quot;, &quot;Bearer &quot; + accessToken);</span>
            }
            
<span class="nc" id="L364">            Request request = requestBuilder.build();</span>
            
            // اجرای درخواست و پردازش پاسخ
<span class="nc" id="L367">            try (Response response = client.newCall(request).execute()) {</span>
<span class="nc" id="L368">                return processResponse(response);</span>
            }
<span class="nc" id="L370">        } catch (Exception e) {</span>
            // برگرداندن پاسخ خطای توصیفی
<span class="nc" id="L372">            String errorMessage = getNetworkErrorMessage(e);</span>
<span class="nc" id="L373">            return new ApiResponse(false, 0, errorMessage, null);</span>
        }
    }
    
    // ==================== AUTHENTICATION SPECIFIC METHODS ====================
    
    /**
     * ورود کاربر و ذخیره token ها
     * 
     * @param phone شماره تلفن کاربر
     * @param password رمز عبور
     * @return پاسخ API حاوی اطلاعات ورود
     * 
     * در صورت ورود موفق، access و refresh token ها
     * به صورت خودکار ذخیره می‌شوند
     */
    public static ApiResponse login(String phone, String password) {
<span class="fc" id="L390">        LoginRequest loginRequest = new LoginRequest(phone, password);</span>
<span class="fc" id="L391">        ApiResponse response = post(FrontendConstants.API.AUTH_LOGIN, loginRequest, false);</span>
        
        // در صورت ورود موفق، token ها را ذخیره کن
<span class="pc bpc" id="L394" title="3 of 4 branches missed.">        if (response.isSuccess() &amp;&amp; response.getData() != null) {</span>
<span class="nc" id="L395">            JsonNode data = response.getData();</span>
<span class="nc bnc" id="L396" title="All 4 branches missed.">            if (data.has(&quot;accessToken&quot;) &amp;&amp; data.has(&quot;refreshToken&quot;)) {</span>
<span class="nc" id="L397">                setTokens(data.get(&quot;accessToken&quot;).asText(), data.get(&quot;refreshToken&quot;).asText());</span>
            }
        }
        
<span class="fc" id="L401">        return response;</span>
    }
    
    /**
     * ثبت نام کاربر جدید
     * 
     * @param fullName نام کامل کاربر
     * @param phone شماره تلفن
     * @param email آدرس ایمیل
     * @param password رمز عبور
     * @param address آدرس کاربر
     * @return پاسخ API حاوی نتیجه ثبت نام
     */
    public static ApiResponse register(String fullName, String phone, String email, String password, String address) {
<span class="nc" id="L415">        RegisterRequest registerRequest = new RegisterRequest(fullName, phone, email, password, address);</span>
<span class="nc" id="L416">        return post(&quot;/auth/register&quot;, registerRequest, false);</span>
    }
    
    /**
     * خروج کاربر از حساب
     * 
     * @return پاسخ API
     * 
     * این متد درخواست logout را به سرور ارسال کرده
     * و سپس token های محلی را پاک می‌کند
     */
    public static ApiResponse logout() {
<span class="fc bfc" id="L428" title="All 2 branches covered.">        if (!isAuthenticated()) {</span>
<span class="fc" id="L429">            return new ApiResponse(true, 200, &quot;Already logged out&quot;, null);</span>
        }
        
<span class="fc" id="L432">        ApiResponse response = post(&quot;/auth/logout&quot;, new Object(), false);</span>
<span class="fc" id="L433">        clearTokens();  // پاک کردن token های محلی</span>
<span class="fc" id="L434">        return response;</span>
    }
    
    /**
     * نوسازی access token با استفاده از refresh token
     * 
     * @return پاسخ API حاوی token جدید
     * 
     * این متد زمانی فراخوانی می‌شود که access token منقضی شده
     * ولی refresh token هنوز معتبر است
     */
    public static ApiResponse refreshAccessToken() {
<span class="nc bnc" id="L446" title="All 2 branches missed.">        if (refreshToken == null) {</span>
<span class="nc" id="L447">            return new ApiResponse(false, 400, &quot;No refresh token available&quot;, null);</span>
        }
        
<span class="nc" id="L450">        RefreshTokenRequest refreshRequest = new RefreshTokenRequest(refreshToken);</span>
<span class="nc" id="L451">        ApiResponse response = post(&quot;/auth/refresh&quot;, refreshRequest, false);</span>
        
        // در صورت موفقیت، token های جدید را ذخیره کن
<span class="nc bnc" id="L454" title="All 4 branches missed.">        if (response.isSuccess() &amp;&amp; response.getData() != null) {</span>
<span class="nc" id="L455">            JsonNode data = response.getData();</span>
<span class="nc bnc" id="L456" title="All 4 branches missed.">            if (data.has(&quot;accessToken&quot;) &amp;&amp; data.has(&quot;refreshToken&quot;)) {</span>
<span class="nc" id="L457">                setTokens(data.get(&quot;accessToken&quot;).asText(), data.get(&quot;refreshToken&quot;).asText());</span>
            }
        }
        
<span class="nc" id="L461">        return response;</span>
    }
    
    // ==================== RESPONSE PROCESSING ====================
    
    /**
     * پردازش پاسخ HTTP و ایجاد ApiResponse
     * 
     * @param response پاسخ OkHttp
     * @return ApiResponse پردازش شده
     * @throws IOException در صورت خطا در خواندن response body
     * 
     * این متد پاسخ خام HTTP را به شیء ApiResponse قابل استفاده تبدیل می‌کند
     */
    private static ApiResponse processResponse(Response response) throws IOException {
        // خواندن response body
<span class="nc bnc" id="L477" title="All 2 branches missed.">        String responseBody = response.body() != null ? response.body().string() : &quot;&quot;;</span>
<span class="nc" id="L478">        boolean isSuccess = response.isSuccessful();</span>
<span class="nc" id="L479">        int statusCode = response.code();</span>
        
<span class="nc" id="L481">        JsonNode data = null;</span>
<span class="nc" id="L482">        String message = null;</span>
        
        // پردازش JSON response body
<span class="nc bnc" id="L485" title="All 2 branches missed.">        if (!responseBody.isEmpty()) {</span>
            try {
<span class="nc" id="L487">                JsonNode json = objectMapper.readTree(responseBody);</span>
                
                // استخراج پیام از response
<span class="nc bnc" id="L490" title="All 2 branches missed.">                if (json.has(&quot;message&quot;)) {</span>
<span class="nc" id="L491">                    message = json.get(&quot;message&quot;).asText();</span>
                }
                
                // مدیریت پیام‌های خطا
<span class="nc bnc" id="L495" title="All 4 branches missed.">                if (json.has(&quot;error&quot;) &amp;&amp; !isSuccess) {</span>
<span class="nc" id="L496">                    message = json.get(&quot;error&quot;).asText();</span>
                } else {
<span class="nc" id="L498">                    data = json;  // ذخیره کل JSON به عنوان data</span>
                }
<span class="nc" id="L500">            } catch (Exception e) {</span>
                // اگر JSON parsing ناموفق بود، response body خام را به عنوان پیام استفاده کن
<span class="nc" id="L502">                message = responseBody;</span>
<span class="nc" id="L503">            }</span>
        }
        
<span class="nc" id="L506">        return new ApiResponse(isSuccess, statusCode, message, data);</span>
    }
    
    /**
     * تولید پیام خطای شبکه بر اساس نوع exception
     * 
     * @param e exception رخ داده
     * @return پیام خطای کاربرپسند
     * 
     * این متد انواع مختلف خطاهای شبکه را تشخیص داده
     * و پیام مناسب برای نمایش به کاربر تولید می‌کند
     */
    private static String getNetworkErrorMessage(Exception e) {
<span class="fc" id="L519">        String errorMessage = &quot;Network error&quot;;</span>
<span class="pc bpc" id="L520" title="1 of 2 branches missed.">        if (e instanceof java.net.SocketTimeoutException || </span>
<span class="pc bpc" id="L521" title="2 of 4 branches missed.">            (e.getMessage() != null &amp;&amp; e.getMessage().contains(&quot;timeout&quot;))) {</span>
<span class="nc" id="L522">            errorMessage = &quot;Connection timeout - please check your network connection&quot;;</span>
<span class="pc bpc" id="L523" title="1 of 2 branches missed.">        } else if (e instanceof java.net.UnknownHostException ||</span>
<span class="pc bpc" id="L524" title="2 of 4 branches missed.">                   (e.getMessage() != null &amp;&amp; e.getMessage().contains(&quot;connection&quot;))) {</span>
<span class="nc" id="L525">            errorMessage = &quot;Network connection failed - please check your internet connection&quot;;</span>
<span class="fc bfc" id="L526" title="All 2 branches covered.">        } else if (e instanceof java.net.ConnectException) {</span>
<span class="fc" id="L527">            errorMessage = &quot;Connection failed - server may be unavailable&quot;;</span>
<span class="pc bpc" id="L528" title="1 of 2 branches missed.">        } else if (e.getMessage() != null) {</span>
<span class="fc" id="L529">            errorMessage = &quot;Network error: &quot; + e.getMessage();</span>
        }
<span class="fc" id="L531">        return errorMessage;</span>
    }
    
    // ==================== REQUEST DTOs ====================
    
    /**
     * کلاس درخواست ورود
     * DTO برای ارسال اطلاعات ورود به سرور
     */
    public static class LoginRequest {
        /** شماره تلفن کاربر */
        public String phone;
        /** رمز عبور */
        public String password;
        
        /**
         * سازنده کلاس درخواست ورود
         * 
         * @param phone شماره تلفن
         * @param password رمز عبور
         */
<span class="fc" id="L552">        public LoginRequest(String phone, String password) {</span>
<span class="fc" id="L553">            this.phone = phone;</span>
<span class="fc" id="L554">            this.password = password;</span>
<span class="fc" id="L555">        }</span>
    }
    
    /**
     * کلاس درخواست ثبت نام
     * DTO برای ارسال اطلاعات ثبت نام به سرور
     */
    public static class RegisterRequest {
        /** نام کامل کاربر */
        public String fullName;
        /** شماره تلفن */
        public String phone;
        /** آدرس ایمیل */
        public String email;
        /** رمز عبور */
        public String password;
        /** آدرس کاربر */
        public String address;
        
        /**
         * سازنده کلاس درخواست ثبت نام
         * 
         * @param fullName نام کامل
         * @param phone شماره تلفن
         * @param email ایمیل
         * @param password رمز عبور
         * @param address آدرس
         */
<span class="fc" id="L583">        public RegisterRequest(String fullName, String phone, String email, String password, String address) {</span>
<span class="fc" id="L584">            this.fullName = fullName;</span>
<span class="fc" id="L585">            this.phone = phone;</span>
<span class="fc" id="L586">            this.email = email;</span>
<span class="fc" id="L587">            this.password = password;</span>
<span class="fc" id="L588">            this.address = address;</span>
<span class="fc" id="L589">        }</span>
    }
    
    /**
     * کلاس درخواست نوسازی token
     * DTO برای ارسال refresh token به سرور
     */
    public static class RefreshTokenRequest {
        /** refresh token برای دریافت access token جدید */
        public String refreshToken;
        
        /**
         * سازنده کلاس درخواست نوسازی token
         * 
         * @param refreshToken refresh token معتبر
         */
<span class="fc" id="L605">        public RefreshTokenRequest(String refreshToken) {</span>
<span class="fc" id="L606">            this.refreshToken = refreshToken;</span>
<span class="fc" id="L607">        }</span>
    }
    
    // ==================== RESPONSE WRAPPER ====================
    
    /**
     * کلاس wrapper برای پاسخ‌های API
     * 
     * این کلاس تمام پاسخ‌های API را به فرمت یکسان تبدیل می‌کند
     * تا پردازش آن‌ها در لایه UI ساده‌تر شود
     */
    public static class ApiResponse {
        /** آیا درخواست موفق بوده */
        private final boolean success;
        /** کد وضعیت HTTP */
        private final int statusCode;
        /** پیام پاسخ (موفقیت یا خطا) */
        private final String message;
        /** داده‌های JSON پاسخ */
        private final JsonNode data;
        
        /**
         * سازنده کلاس ApiResponse
         * 
         * @param success وضعیت موفقیت
         * @param statusCode کد وضعیت HTTP
         * @param message پیام پاسخ
         * @param data داده‌های JSON
         */
<span class="fc" id="L636">        public ApiResponse(boolean success, int statusCode, String message, JsonNode data) {</span>
<span class="fc" id="L637">            this.success = success;</span>
<span class="fc" id="L638">            this.statusCode = statusCode;</span>
<span class="fc" id="L639">            this.message = message;</span>
<span class="fc" id="L640">            this.data = data;</span>
<span class="fc" id="L641">        }</span>
        
        /** دریافت وضعیت موفقیت */
<span class="fc" id="L644">        public boolean isSuccess() { return success; }</span>
        
        /** دریافت کد وضعیت HTTP */
<span class="fc" id="L647">        public int getStatusCode() { return statusCode; }</span>
        
        /** دریافت پیام پاسخ */
<span class="fc" id="L650">        public String getMessage() { return message; }</span>
        
        /** دریافت داده‌های JSON */
<span class="fc" id="L653">        public JsonNode getData() { return data; }</span>
        
        /**
         * دریافت کد وضعیت HTTP (مخصوص تست)
         * 
         * @return کد وضعیت HTTP
         */
<span class="fc" id="L660">        public int getStatus() { return statusCode; }</span>
        
        /**
         * دریافت headers پاسخ (مخصوص تست)
         * 
         * @return Map از headers
         */
        public java.util.Map&lt;String, String&gt; getHeaders() {
            // برای اهداف تست - در پیاده‌سازی واقعی headers واقعی برگردانده می‌شود
<span class="fc" id="L669">            java.util.Map&lt;String, String&gt; headers = new java.util.HashMap&lt;&gt;();</span>
<span class="fc" id="L670">            headers.put(&quot;X-Encrypted&quot;, &quot;true&quot;);</span>
<span class="fc" id="L671">            headers.put(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<span class="fc" id="L672">            return headers;</span>
        }
        
        /**
         * نمایش string از ApiResponse برای debugging
         */
        @Override
        public String toString() {
<span class="fc" id="L680">            return String.format(&quot;ApiResponse{success=%s, statusCode=%d, message='%s'}&quot;, </span>
<span class="fc" id="L681">                               success, statusCode, message);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>