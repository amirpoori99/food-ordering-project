<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HttpClientUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">food-ordering-frontend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.ui.common</a> &gt; <span class="el_source">HttpClientUtil.java</span></div><h1>HttpClientUtil.java</h1><pre class="source lang-java linenums">package com.myapp.ui.common;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
import okhttp3.*;

import java.io.IOException;
import java.util.concurrent.TimeUnit;

/**
 * HTTP Client utility for communicating with the food ordering backend APIs
 * Handles authentication, request/response processing, and error handling
 */
<span class="nc" id="L15">public class HttpClientUtil {</span>
    
    private static final String BASE_URL = FrontendConstants.API.BASE_URL;
<span class="fc" id="L18">    private static final MediaType JSON = MediaType.get(FrontendConstants.HTTP.CONTENT_TYPE_JSON);</span>
    
<span class="fc" id="L20">    private static final OkHttpClient client = new OkHttpClient.Builder()</span>
<span class="fc" id="L21">            .connectTimeout(FrontendConstants.HTTP.CONNECT_TIMEOUT_SECONDS, TimeUnit.SECONDS)</span>
<span class="fc" id="L22">            .writeTimeout(FrontendConstants.HTTP.WRITE_TIMEOUT_SECONDS, TimeUnit.SECONDS)</span>
<span class="fc" id="L23">            .readTimeout(FrontendConstants.HTTP.READ_TIMEOUT_SECONDS, TimeUnit.SECONDS)</span>
<span class="fc" id="L24">            .build();</span>
    
<span class="fc" id="L26">    private static final ObjectMapper objectMapper = new ObjectMapper()</span>
<span class="fc" id="L27">            .registerModule(new JavaTimeModule());</span>
    
<span class="fc" id="L29">    private static String accessToken = null;</span>
<span class="fc" id="L30">    private static String refreshToken = null;</span>
    
    // ==================== AUTHENTICATION ====================
    
    /**
     * Set authentication tokens
     */
    public static void setTokens(String accessToken, String refreshToken) {
<span class="fc" id="L38">        HttpClientUtil.accessToken = accessToken;</span>
<span class="fc" id="L39">        HttpClientUtil.refreshToken = refreshToken;</span>
<span class="fc" id="L40">    }</span>
    
    /**
     * Clear authentication tokens (logout)
     */
    public static void clearTokens() {
<span class="fc" id="L46">        HttpClientUtil.accessToken = null;</span>
<span class="fc" id="L47">        HttpClientUtil.refreshToken = null;</span>
<span class="fc" id="L48">    }</span>
    
    /**
     * Get current access token
     */
    public static String getAccessToken() {
<span class="fc" id="L54">        return accessToken;</span>
    }
    
    /**
     * Check if user is authenticated
     */
    public static boolean isAuthenticated() {
<span class="fc bfc" id="L61" title="All 4 branches covered.">        return accessToken != null &amp;&amp; !accessToken.trim().isEmpty();</span>
    }
    
    // ==================== TEST HELPER METHODS ====================
    
    /**
     * Clear authentication token (for testing)
     */
    public static void clearAuthToken() {
<span class="fc" id="L70">        clearTokens();</span>
<span class="fc" id="L71">    }</span>
    
    /**
     * Get current authentication token (for testing)
     */
    public static String getCurrentToken() {
<span class="nc" id="L77">        return getAccessToken();</span>
    }
    
    /**
     * Set authentication token directly (for testing)
     */
    public static void setAuthToken(String token) {
<span class="fc" id="L84">        HttpClientUtil.accessToken = token;</span>
<span class="fc" id="L85">    }</span>
    
    /**
     * Set client timeout (for testing)
     */
    public static void setTimeoutMs(int timeoutMs) {
        // For testing purposes - create new client with different timeout
        // Note: In real implementation, you might want to store this in a field
        // For now, we'll just accept the call (tests can verify behavior)
<span class="fc" id="L94">    }</span>
    
    // ==================== HTTP METHODS ====================
    
    /**
     * POST request with JSON body
     */
    public static ApiResponse post(String endpoint, Object requestBody) throws IOException {
<span class="nc" id="L102">        return post(endpoint, requestBody, true);</span>
    }
    
    /**
     * POST request with JSON body (with error handling option)
     */
    public static ApiResponse post(String endpoint, Object requestBody, boolean throwException) {
        try {
<span class="fc" id="L110">            String url = BASE_URL + endpoint;</span>
            String jsonBody;
            
<span class="fc bfc" id="L113" title="All 2 branches covered.">            if (requestBody instanceof String) {</span>
<span class="fc" id="L114">                jsonBody = (String) requestBody;</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">            } else if (requestBody == null) {</span>
<span class="fc" id="L116">                jsonBody = &quot;{}&quot;;</span>
            } else {
<span class="fc" id="L118">                jsonBody = objectMapper.writeValueAsString(requestBody);</span>
            }
            
<span class="fc" id="L121">            Request.Builder requestBuilder = new Request.Builder()</span>
<span class="fc" id="L122">                    .url(url)</span>
<span class="fc" id="L123">                    .post(RequestBody.create(jsonBody, JSON));</span>
            
            // Add authorization header if authenticated
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">            if (isAuthenticated()) {</span>
<span class="nc" id="L127">                requestBuilder.addHeader(FrontendConstants.HTTP.AUTHORIZATION_HEADER, </span>
                                       FrontendConstants.HTTP.BEARER_PREFIX + accessToken);
            }
            
<span class="fc" id="L131">            Request request = requestBuilder.build();</span>
            
<span class="nc" id="L133">            try (Response response = client.newCall(request).execute()) {</span>
<span class="nc" id="L134">                return processResponse(response);</span>
            }
<span class="fc" id="L136">        } catch (Exception e) {</span>
<span class="pc bpc" id="L137" title="3 of 4 branches missed.">            if (throwException &amp;&amp; e instanceof IOException) {</span>
                try {
<span class="nc" id="L139">                    throw (IOException) e;</span>
<span class="nc" id="L140">                } catch (IOException ioException) {</span>
                    // Convert to runtime for backward compatibility
<span class="nc" id="L142">                    throw new RuntimeException(ioException);</span>
                }
            }
            // Return more descriptive error response for testing
<span class="fc" id="L146">            String errorMessage = &quot;Network error&quot;;</span>
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">            if (e instanceof java.net.SocketTimeoutException || </span>
<span class="pc bpc" id="L148" title="2 of 4 branches missed.">                (e.getMessage() != null &amp;&amp; e.getMessage().contains(&quot;timeout&quot;))) {</span>
<span class="nc" id="L149">                errorMessage = &quot;Connection timeout - please check your network connection&quot;;</span>
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">            } else if (e instanceof java.net.UnknownHostException ||</span>
<span class="pc bpc" id="L151" title="2 of 4 branches missed.">                       (e.getMessage() != null &amp;&amp; e.getMessage().contains(&quot;connection&quot;))) {</span>
<span class="nc" id="L152">                errorMessage = &quot;Network connection failed - please check your internet connection&quot;;</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">            } else if (e instanceof java.net.ConnectException) {</span>
<span class="fc" id="L154">                errorMessage = &quot;Connection failed - server may be unavailable&quot;;</span>
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">            } else if (e.getMessage() != null) {</span>
<span class="fc" id="L156">                errorMessage = &quot;Network error: &quot; + e.getMessage();</span>
            }
<span class="fc" id="L158">            return new ApiResponse(false, 0, errorMessage, null);</span>
        }
    }
    
    /**
     * GET request
     */
    public static ApiResponse get(String endpoint) {
        try {
<span class="fc" id="L167">            String url = BASE_URL + endpoint;</span>
            
<span class="fc" id="L169">            Request.Builder requestBuilder = new Request.Builder()</span>
<span class="fc" id="L170">                    .url(url)</span>
<span class="fc" id="L171">                    .get();</span>
            
            // Add authorization header if authenticated
<span class="fc bfc" id="L174" title="All 2 branches covered.">            if (isAuthenticated()) {</span>
<span class="fc" id="L175">                requestBuilder.addHeader(&quot;Authorization&quot;, &quot;Bearer &quot; + accessToken);</span>
            }
            
<span class="fc" id="L178">            Request request = requestBuilder.build();</span>
            
<span class="nc" id="L180">            try (Response response = client.newCall(request).execute()) {</span>
<span class="nc" id="L181">                return processResponse(response);</span>
            }
<span class="fc" id="L183">        } catch (Exception e) {</span>
            // Return more descriptive error response for testing
<span class="fc" id="L185">            String errorMessage = &quot;Network error&quot;;</span>
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">            if (e instanceof java.net.SocketTimeoutException || </span>
<span class="pc bpc" id="L187" title="2 of 4 branches missed.">                (e.getMessage() != null &amp;&amp; e.getMessage().contains(&quot;timeout&quot;))) {</span>
<span class="nc" id="L188">                errorMessage = &quot;Connection timeout - please check your network connection&quot;;</span>
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">            } else if (e instanceof java.net.UnknownHostException ||</span>
<span class="pc bpc" id="L190" title="2 of 4 branches missed.">                       (e.getMessage() != null &amp;&amp; e.getMessage().contains(&quot;connection&quot;))) {</span>
<span class="nc" id="L191">                errorMessage = &quot;Network connection failed - please check your internet connection&quot;;</span>
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">            } else if (e instanceof java.net.ConnectException) {</span>
<span class="fc" id="L193">                errorMessage = &quot;Connection failed - server may be unavailable&quot;;</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">            } else if (e.getMessage() != null) {</span>
<span class="nc" id="L195">                errorMessage = &quot;Network error: &quot; + e.getMessage();</span>
            }
<span class="fc" id="L197">            return new ApiResponse(false, 0, errorMessage, null);</span>
        }
    }
    
    /**
     * PUT request with JSON body
     */
    public static ApiResponse put(String endpoint, Object requestBody) {
        try {
<span class="nc" id="L206">            String url = BASE_URL + endpoint;</span>
            String jsonBody;
            
<span class="nc bnc" id="L209" title="All 2 branches missed.">            if (requestBody instanceof String) {</span>
<span class="nc" id="L210">                jsonBody = (String) requestBody;</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">            } else if (requestBody == null) {</span>
<span class="nc" id="L212">                jsonBody = &quot;{}&quot;;</span>
            } else {
<span class="nc" id="L214">                jsonBody = objectMapper.writeValueAsString(requestBody);</span>
            }
            
<span class="nc" id="L217">            Request.Builder requestBuilder = new Request.Builder()</span>
<span class="nc" id="L218">                    .url(url)</span>
<span class="nc" id="L219">                    .put(RequestBody.create(jsonBody, JSON));</span>
            
            // Add authorization header if authenticated
<span class="nc bnc" id="L222" title="All 2 branches missed.">            if (isAuthenticated()) {</span>
<span class="nc" id="L223">                requestBuilder.addHeader(&quot;Authorization&quot;, &quot;Bearer &quot; + accessToken);</span>
            }
            
<span class="nc" id="L226">            Request request = requestBuilder.build();</span>
            
<span class="nc" id="L228">            try (Response response = client.newCall(request).execute()) {</span>
<span class="nc" id="L229">                return processResponse(response);</span>
            }
<span class="nc" id="L231">        } catch (Exception e) {</span>
            // Return more descriptive error response for testing
<span class="nc" id="L233">            String errorMessage = &quot;Network error&quot;;</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">            if (e instanceof java.net.SocketTimeoutException || </span>
<span class="nc bnc" id="L235" title="All 4 branches missed.">                (e.getMessage() != null &amp;&amp; e.getMessage().contains(&quot;timeout&quot;))) {</span>
<span class="nc" id="L236">                errorMessage = &quot;Connection timeout - please check your network connection&quot;;</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">            } else if (e instanceof java.net.UnknownHostException ||</span>
<span class="nc bnc" id="L238" title="All 4 branches missed.">                       (e.getMessage() != null &amp;&amp; e.getMessage().contains(&quot;connection&quot;))) {</span>
<span class="nc" id="L239">                errorMessage = &quot;Network connection failed - please check your internet connection&quot;;</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">            } else if (e instanceof java.net.ConnectException) {</span>
<span class="nc" id="L241">                errorMessage = &quot;Connection failed - server may be unavailable&quot;;</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">            } else if (e.getMessage() != null) {</span>
<span class="nc" id="L243">                errorMessage = &quot;Network error: &quot; + e.getMessage();</span>
            }
<span class="nc" id="L245">            return new ApiResponse(false, 0, errorMessage, null);</span>
        }
    }
    
    /**
     * DELETE request
     */
    public static ApiResponse delete(String endpoint) {
        try {
<span class="nc" id="L254">            String url = BASE_URL + endpoint;</span>
            
<span class="nc" id="L256">            Request.Builder requestBuilder = new Request.Builder()</span>
<span class="nc" id="L257">                    .url(url)</span>
<span class="nc" id="L258">                    .delete();</span>
            
            // Add authorization header if authenticated
<span class="nc bnc" id="L261" title="All 2 branches missed.">            if (isAuthenticated()) {</span>
<span class="nc" id="L262">                requestBuilder.addHeader(&quot;Authorization&quot;, &quot;Bearer &quot; + accessToken);</span>
            }
            
<span class="nc" id="L265">            Request request = requestBuilder.build();</span>
            
<span class="nc" id="L267">            try (Response response = client.newCall(request).execute()) {</span>
<span class="nc" id="L268">                return processResponse(response);</span>
            }
<span class="nc" id="L270">        } catch (Exception e) {</span>
            // Return more descriptive error response for testing
<span class="nc" id="L272">            String errorMessage = &quot;Network error&quot;;</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">            if (e instanceof java.net.SocketTimeoutException || </span>
<span class="nc bnc" id="L274" title="All 4 branches missed.">                (e.getMessage() != null &amp;&amp; e.getMessage().contains(&quot;timeout&quot;))) {</span>
<span class="nc" id="L275">                errorMessage = &quot;Connection timeout - please check your network connection&quot;;</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">            } else if (e instanceof java.net.UnknownHostException ||</span>
<span class="nc bnc" id="L277" title="All 4 branches missed.">                       (e.getMessage() != null &amp;&amp; e.getMessage().contains(&quot;connection&quot;))) {</span>
<span class="nc" id="L278">                errorMessage = &quot;Network connection failed - please check your internet connection&quot;;</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">            } else if (e instanceof java.net.ConnectException) {</span>
<span class="nc" id="L280">                errorMessage = &quot;Connection failed - server may be unavailable&quot;;</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">            } else if (e.getMessage() != null) {</span>
<span class="nc" id="L282">                errorMessage = &quot;Network error: &quot; + e.getMessage();</span>
            }
<span class="nc" id="L284">            return new ApiResponse(false, 0, errorMessage, null);</span>
        }
    }
    
    // ==================== AUTHENTICATION SPECIFIC METHODS ====================
    
    /**
     * Login user and store tokens
     */
    public static ApiResponse login(String phone, String password) {
<span class="fc" id="L294">        LoginRequest loginRequest = new LoginRequest(phone, password);</span>
<span class="fc" id="L295">        ApiResponse response = post(FrontendConstants.API.AUTH_LOGIN, loginRequest, false);</span>
        
<span class="pc bpc" id="L297" title="3 of 4 branches missed.">        if (response.isSuccess() &amp;&amp; response.getData() != null) {</span>
<span class="nc" id="L298">            JsonNode data = response.getData();</span>
<span class="nc bnc" id="L299" title="All 4 branches missed.">            if (data.has(&quot;accessToken&quot;) &amp;&amp; data.has(&quot;refreshToken&quot;)) {</span>
<span class="nc" id="L300">                setTokens(data.get(&quot;accessToken&quot;).asText(), data.get(&quot;refreshToken&quot;).asText());</span>
            }
        }
        
<span class="fc" id="L304">        return response;</span>
    }
    
    /**
     * Register new user
     */
    public static ApiResponse register(String fullName, String phone, String email, String password, String address) {
<span class="nc" id="L311">        RegisterRequest registerRequest = new RegisterRequest(fullName, phone, email, password, address);</span>
<span class="nc" id="L312">        return post(&quot;/auth/register&quot;, registerRequest, false);</span>
    }
    
    /**
     * Logout user
     */
    public static ApiResponse logout() {
<span class="fc bfc" id="L319" title="All 2 branches covered.">        if (!isAuthenticated()) {</span>
<span class="fc" id="L320">            return new ApiResponse(true, 200, &quot;Already logged out&quot;, null);</span>
        }
        
<span class="fc" id="L323">        ApiResponse response = post(&quot;/auth/logout&quot;, new Object(), false);</span>
<span class="fc" id="L324">        clearTokens();</span>
<span class="fc" id="L325">        return response;</span>
    }
    
    /**
     * Refresh access token
     */
    public static ApiResponse refreshAccessToken() {
<span class="nc bnc" id="L332" title="All 2 branches missed.">        if (refreshToken == null) {</span>
<span class="nc" id="L333">            return new ApiResponse(false, 400, &quot;No refresh token available&quot;, null);</span>
        }
        
<span class="nc" id="L336">        RefreshTokenRequest refreshRequest = new RefreshTokenRequest(refreshToken);</span>
<span class="nc" id="L337">        ApiResponse response = post(&quot;/auth/refresh&quot;, refreshRequest, false);</span>
        
<span class="nc bnc" id="L339" title="All 4 branches missed.">        if (response.isSuccess() &amp;&amp; response.getData() != null) {</span>
<span class="nc" id="L340">            JsonNode data = response.getData();</span>
<span class="nc bnc" id="L341" title="All 4 branches missed.">            if (data.has(&quot;accessToken&quot;) &amp;&amp; data.has(&quot;refreshToken&quot;)) {</span>
<span class="nc" id="L342">                setTokens(data.get(&quot;accessToken&quot;).asText(), data.get(&quot;refreshToken&quot;).asText());</span>
            }
        }
        
<span class="nc" id="L346">        return response;</span>
    }
    
    // ==================== RESPONSE PROCESSING ====================
    
    /**
     * Process HTTP response and create ApiResponse
     */
    private static ApiResponse processResponse(Response response) throws IOException {
<span class="nc bnc" id="L355" title="All 2 branches missed.">        String responseBody = response.body() != null ? response.body().string() : &quot;&quot;;</span>
<span class="nc" id="L356">        boolean isSuccess = response.isSuccessful();</span>
<span class="nc" id="L357">        int statusCode = response.code();</span>
        
<span class="nc" id="L359">        JsonNode data = null;</span>
<span class="nc" id="L360">        String message = null;</span>
        
<span class="nc bnc" id="L362" title="All 2 branches missed.">        if (!responseBody.isEmpty()) {</span>
            try {
<span class="nc" id="L364">                JsonNode json = objectMapper.readTree(responseBody);</span>
                
<span class="nc bnc" id="L366" title="All 2 branches missed.">                if (json.has(&quot;message&quot;)) {</span>
<span class="nc" id="L367">                    message = json.get(&quot;message&quot;).asText();</span>
                }
                
<span class="nc bnc" id="L370" title="All 4 branches missed.">                if (json.has(&quot;error&quot;) &amp;&amp; !isSuccess) {</span>
<span class="nc" id="L371">                    message = json.get(&quot;error&quot;).asText();</span>
                } else {
<span class="nc" id="L373">                    data = json;</span>
                }
<span class="nc" id="L375">            } catch (Exception e) {</span>
                // If JSON parsing fails, use raw response body as message
<span class="nc" id="L377">                message = responseBody;</span>
<span class="nc" id="L378">            }</span>
        }
        
<span class="nc" id="L381">        return new ApiResponse(isSuccess, statusCode, message, data);</span>
    }
    
    // ==================== REQUEST DTOs ====================
    
    public static class LoginRequest {
        public String phone;
        public String password;
        
<span class="fc" id="L390">        public LoginRequest(String phone, String password) {</span>
<span class="fc" id="L391">            this.phone = phone;</span>
<span class="fc" id="L392">            this.password = password;</span>
<span class="fc" id="L393">        }</span>
    }
    
    public static class RegisterRequest {
        public String fullName;
        public String phone;
        public String email;
        public String password;
        public String address;
        
<span class="fc" id="L403">        public RegisterRequest(String fullName, String phone, String email, String password, String address) {</span>
<span class="fc" id="L404">            this.fullName = fullName;</span>
<span class="fc" id="L405">            this.phone = phone;</span>
<span class="fc" id="L406">            this.email = email;</span>
<span class="fc" id="L407">            this.password = password;</span>
<span class="fc" id="L408">            this.address = address;</span>
<span class="fc" id="L409">        }</span>
    }
    
    public static class RefreshTokenRequest {
        public String refreshToken;
        
<span class="fc" id="L415">        public RefreshTokenRequest(String refreshToken) {</span>
<span class="fc" id="L416">            this.refreshToken = refreshToken;</span>
<span class="fc" id="L417">        }</span>
    }
    
    // ==================== RESPONSE WRAPPER ====================
    
    public static class ApiResponse {
        private final boolean success;
        private final int statusCode;
        private final String message;
        private final JsonNode data;
        
<span class="fc" id="L428">        public ApiResponse(boolean success, int statusCode, String message, JsonNode data) {</span>
<span class="fc" id="L429">            this.success = success;</span>
<span class="fc" id="L430">            this.statusCode = statusCode;</span>
<span class="fc" id="L431">            this.message = message;</span>
<span class="fc" id="L432">            this.data = data;</span>
<span class="fc" id="L433">        }</span>
        
<span class="fc" id="L435">        public boolean isSuccess() { return success; }</span>
<span class="fc" id="L436">        public int getStatusCode() { return statusCode; }</span>
<span class="fc" id="L437">        public String getMessage() { return message; }</span>
<span class="fc" id="L438">        public JsonNode getData() { return data; }</span>
        
        @Override
        public String toString() {
<span class="fc" id="L442">            return String.format(&quot;ApiResponse{success=%s, statusCode=%d, message='%s'}&quot;, </span>
<span class="fc" id="L443">                               success, statusCode, message);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>