<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PaymentController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">food-ordering-frontend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.ui.payment</a> &gt; <span class="el_source">PaymentController.java</span></div><h1>PaymentController.java</h1><pre class="source lang-java linenums">package com.myapp.ui.payment;

import com.myapp.ui.common.NavigationController;
import javafx.application.Platform;
import javafx.concurrent.Task;
import javafx.fxml.FXML;
import javafx.fxml.Initializable;
import javafx.geometry.Insets;
import javafx.scene.control.*;
import javafx.scene.layout.VBox;
import javafx.scene.layout.HBox;
import javafx.scene.text.Font;
import javafx.scene.text.FontWeight;

import java.net.URL;
import java.text.NumberFormat;
import java.util.*;

/**
 * Controller for Payment screen
 * Handles payment method selection, validation, and processing
 */
<span class="fc" id="L23">public class PaymentController implements Initializable {</span>

    // Payment Method Radio Buttons
    @FXML private ToggleGroup paymentMethodGroup;
    @FXML private RadioButton cardPaymentRadio;
    @FXML private RadioButton walletPaymentRadio;
    @FXML private RadioButton codPaymentRadio;
    
    // Payment Sections
    @FXML private VBox cardPaymentSection;
    @FXML private VBox walletPaymentSection;
    @FXML private VBox codPaymentSection;
    
    // Card Payment Fields
    @FXML private TextField cardNumberField;
    @FXML private TextField cardHolderNameField;
    @FXML private TextField cardExpiryMonthField;
    @FXML private TextField cardExpiryYearField;
    @FXML private TextField cardCvvField;
    
    // Wallet Payment Fields
    @FXML private Label walletBalanceLabel;
    @FXML private Button refreshWalletButton;
    @FXML private Label walletStatusLabel;
    
    // Delivery Information Display
    @FXML private TextArea deliveryAddressDisplay;
    @FXML private TextField deliveryPhoneDisplay;
    @FXML private TextArea orderNotesDisplay;
    
    // Order Summary
    @FXML private ScrollPane orderItemsScrollPane;
    @FXML private VBox orderItemsContainer;
    @FXML private Label subtotalLabel;
    @FXML private Label deliveryFeeLabel;
    @FXML private Label discountLabel;
    @FXML private Label totalAmountLabel;
    
    // Action Buttons
    @FXML private Button confirmPaymentButton;
    @FXML private Button backToCartButton;
    
    // Menu Items
    @FXML private MenuItem backToCartMenuItem;
    @FXML private MenuItem profileMenuItem;
    @FXML private MenuItem orderHistoryMenuItem;
    @FXML private MenuItem logoutMenuItem;
    
    // Status Components
    @FXML private Label statusLabel;
    @FXML private ProgressIndicator loadingIndicator;

    private NavigationController navigationController;
<span class="fc" id="L76">    private final NumberFormat currencyFormat = NumberFormat.getInstance(new Locale(&quot;fa&quot;, &quot;IR&quot;));</span>
    
    // Order data (in real app, this would come from previous screen)
<span class="fc" id="L79">    private List&lt;OrderItem&gt; orderItems = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L80">    private double subtotal = 0.0;</span>
<span class="fc" id="L81">    private double deliveryFee = 0.0;</span>
<span class="fc" id="L82">    private double discount = 0.0;</span>
<span class="fc" id="L83">    private double walletBalance = 75000.0; // Mock wallet balance</span>

    @Override
    public void initialize(URL location, ResourceBundle resources) {
<span class="fc" id="L87">        this.navigationController = NavigationController.getInstance();</span>
        
<span class="fc" id="L89">        setupUI();</span>
<span class="fc" id="L90">        loadOrderData();</span>
<span class="fc" id="L91">        loadDeliveryInfo();</span>
<span class="fc" id="L92">    }</span>

    /**
     * Setup UI components and event handlers
     */
    private void setupUI() {
        // Initialize currency format
<span class="fc" id="L99">        currencyFormat.setGroupingUsed(true);</span>
        
        // Setup payment method listeners
<span class="fc" id="L102">        setupPaymentMethodListeners();</span>
        
        // Setup card number formatting
<span class="fc" id="L105">        setupCardNumberFormatting();</span>
        
        // Setup validation listeners
<span class="fc" id="L108">        setupValidationListeners();</span>
        
        // Initial status
<span class="fc" id="L111">        setStatus(&quot;آماده برای پرداخت&quot;);</span>
        
        // Initially show COD section
<span class="fc" id="L114">        updatePaymentSectionVisibility();</span>
<span class="fc" id="L115">    }</span>

    /**
     * Setup payment method change listeners
     */
    private void setupPaymentMethodListeners() {
<span class="fc" id="L121">        paymentMethodGroup.selectedToggleProperty().addListener((obs, oldToggle, newToggle) -&gt; {</span>
<span class="nc" id="L122">            updatePaymentSectionVisibility();</span>
<span class="nc" id="L123">            validatePaymentForm();</span>
<span class="nc" id="L124">        });</span>
<span class="fc" id="L125">    }</span>

    /**
     * Setup card number formatting
     */
    private void setupCardNumberFormatting() {
<span class="fc" id="L131">        cardNumberField.textProperty().addListener((obs, oldVal, newVal) -&gt; {</span>
            // Format card number with dashes
<span class="nc" id="L133">            String formatted = newVal.replaceAll(&quot;\\D&quot;, &quot;&quot;); // Remove non-digits</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">            if (formatted.length() &gt; 16) {</span>
<span class="nc" id="L135">                formatted = formatted.substring(0, 16);</span>
            }
            
<span class="nc" id="L138">            StringBuilder sb = new StringBuilder();</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">            for (int i = 0; i &lt; formatted.length(); i++) {</span>
<span class="nc bnc" id="L140" title="All 4 branches missed.">                if (i &gt; 0 &amp;&amp; i % 4 == 0) {</span>
<span class="nc" id="L141">                    sb.append(&quot;-&quot;);</span>
                }
<span class="nc" id="L143">                sb.append(formatted.charAt(i));</span>
            }
            
<span class="nc bnc" id="L146" title="All 2 branches missed.">            if (!sb.toString().equals(newVal)) {</span>
<span class="nc" id="L147">                cardNumberField.setText(sb.toString());</span>
            }
<span class="nc" id="L149">        });</span>
        
        // Restrict CVV to 3-4 digits
<span class="fc" id="L152">        cardCvvField.textProperty().addListener((obs, oldVal, newVal) -&gt; {</span>
<span class="nc" id="L153">            String filtered = newVal.replaceAll(&quot;\\D&quot;, &quot;&quot;);</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">            if (filtered.length() &gt; 4) {</span>
<span class="nc" id="L155">                filtered = filtered.substring(0, 4);</span>
            }
<span class="nc bnc" id="L157" title="All 2 branches missed.">            if (!filtered.equals(newVal)) {</span>
<span class="nc" id="L158">                cardCvvField.setText(filtered);</span>
            }
<span class="nc" id="L160">        });</span>
        
        // Restrict month/year fields
<span class="fc" id="L163">        cardExpiryMonthField.textProperty().addListener((obs, oldVal, newVal) -&gt; {</span>
<span class="nc" id="L164">            String filtered = newVal.replaceAll(&quot;\\D&quot;, &quot;&quot;);</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">            if (filtered.length() &gt; 2) {</span>
<span class="nc" id="L166">                filtered = filtered.substring(0, 2);</span>
            }
<span class="nc bnc" id="L168" title="All 2 branches missed.">            if (!filtered.equals(newVal)) {</span>
<span class="nc" id="L169">                cardExpiryMonthField.setText(filtered);</span>
            }
<span class="nc" id="L171">        });</span>
        
<span class="fc" id="L173">        cardExpiryYearField.textProperty().addListener((obs, oldVal, newVal) -&gt; {</span>
<span class="nc" id="L174">            String filtered = newVal.replaceAll(&quot;\\D&quot;, &quot;&quot;);</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">            if (filtered.length() &gt; 4) {</span>
<span class="nc" id="L176">                filtered = filtered.substring(0, 4);</span>
            }
<span class="nc bnc" id="L178" title="All 2 branches missed.">            if (!filtered.equals(newVal)) {</span>
<span class="nc" id="L179">                cardExpiryYearField.setText(filtered);</span>
            }
<span class="nc" id="L181">        });</span>
<span class="fc" id="L182">    }</span>

    /**
     * Setup validation listeners
     */
    private void setupValidationListeners() {
        // Card payment validation
<span class="pc" id="L189">        cardNumberField.textProperty().addListener((obs, oldVal, newVal) -&gt; validatePaymentForm());</span>
<span class="pc" id="L190">        cardHolderNameField.textProperty().addListener((obs, oldVal, newVal) -&gt; validatePaymentForm());</span>
<span class="pc" id="L191">        cardExpiryMonthField.textProperty().addListener((obs, oldVal, newVal) -&gt; validatePaymentForm());</span>
<span class="pc" id="L192">        cardExpiryYearField.textProperty().addListener((obs, oldVal, newVal) -&gt; validatePaymentForm());</span>
<span class="pc" id="L193">        cardCvvField.textProperty().addListener((obs, oldVal, newVal) -&gt; validatePaymentForm());</span>
<span class="fc" id="L194">    }</span>

    /**
     * Load order data (mock data for now)
     */
    private void loadOrderData() {
        // Mock order data (in real app, get from previous screen or session)
<span class="fc" id="L201">        orderItems.clear();</span>
<span class="fc" id="L202">        orderItems.add(new OrderItem(&quot;پیتزا مارگاریتا&quot;, 25000.0, 2, &quot;رستوران ایتالیایی&quot;));</span>
<span class="fc" id="L203">        orderItems.add(new OrderItem(&quot;برگر کلاسیک&quot;, 18000.0, 1, &quot;فست فود سارا&quot;));</span>
        
        // Calculate totals
<span class="fc" id="L206">        subtotal = orderItems.stream().mapToDouble(item -&gt; item.getPrice() * item.getQuantity()).sum();</span>
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">        deliveryFee = subtotal &gt;= 50000 ? 0.0 : 5000.0;</span>
<span class="fc" id="L208">        discount = 5000.0; // Mock discount</span>
        
        // Display order items
<span class="fc" id="L211">        displayOrderItems();</span>
<span class="fc" id="L212">        updatePricingDisplay();</span>
<span class="fc" id="L213">    }</span>

    /**
     * Load delivery information (mock data)
     */
    private void loadDeliveryInfo() {
        // Mock delivery info (in real app, get from cart screen)
<span class="fc" id="L220">        deliveryAddressDisplay.setText(&quot;تهران، خیابان ولیعصر، پلاک 123&quot;);</span>
<span class="fc" id="L221">        deliveryPhoneDisplay.setText(&quot;09123456789&quot;);</span>
<span class="fc" id="L222">        orderNotesDisplay.setText(&quot;لطفاً زنگ در طبقه دوم را بزنید&quot;);</span>
<span class="fc" id="L223">    }</span>

    /**
     * Display order items in the summary
     */
    private void displayOrderItems() {
<span class="fc" id="L229">        orderItemsContainer.getChildren().clear();</span>
        
<span class="fc bfc" id="L231" title="All 2 branches covered.">        for (OrderItem item : orderItems) {</span>
<span class="fc" id="L232">            VBox itemBox = createOrderItemDisplay(item);</span>
<span class="fc" id="L233">            orderItemsContainer.getChildren().add(itemBox);</span>
        }
<span class="fc" id="L235">    }</span>

    /**
     * Create display for a single order item
     */
    private VBox createOrderItemDisplay(OrderItem item) {
<span class="fc" id="L241">        VBox itemBox = new VBox(5);</span>
<span class="fc" id="L242">        itemBox.setPadding(new Insets(8));</span>
<span class="fc" id="L243">        itemBox.setStyle(&quot;-fx-border-color: #e9ecef; -fx-border-width: 0 0 1 0;&quot;);</span>
        
        // Item name and restaurant
<span class="fc" id="L246">        Label nameLabel = new Label(item.getName());</span>
<span class="fc" id="L247">        nameLabel.setFont(Font.font(&quot;System&quot;, FontWeight.BOLD, 14));</span>
        
<span class="fc" id="L249">        Label restaurantLabel = new Label(item.getRestaurantName());</span>
<span class="fc" id="L250">        restaurantLabel.setStyle(&quot;-fx-text-fill: #6c757d; -fx-font-size: 12;&quot;);</span>
        
        // Quantity and price
<span class="fc" id="L253">        HBox detailsBox = new HBox(10);</span>
<span class="fc" id="L254">        detailsBox.setAlignment(javafx.geometry.Pos.CENTER_LEFT);</span>
        
<span class="fc" id="L256">        Label quantityLabel = new Label(&quot;تعداد: &quot; + item.getQuantity());</span>
<span class="fc" id="L257">        Label priceLabel = new Label(formatCurrency(item.getPrice() * item.getQuantity()) + &quot; تومان&quot;);</span>
<span class="fc" id="L258">        priceLabel.setStyle(&quot;-fx-text-fill: #28a745; -fx-font-weight: bold;&quot;);</span>
        
<span class="fc" id="L260">        detailsBox.getChildren().addAll(quantityLabel, priceLabel);</span>
        
<span class="fc" id="L262">        itemBox.getChildren().addAll(nameLabel, restaurantLabel, detailsBox);</span>
        
<span class="fc" id="L264">        return itemBox;</span>
    }

    /**
     * Update pricing display
     */
    private void updatePricingDisplay() {
<span class="fc" id="L271">        subtotalLabel.setText(formatCurrency(subtotal) + &quot; تومان&quot;);</span>
<span class="pc bpc" id="L272" title="1 of 2 branches missed.">        deliveryFeeLabel.setText(deliveryFee == 0 ? &quot;رایگان&quot; : formatCurrency(deliveryFee) + &quot; تومان&quot;);</span>
<span class="fc" id="L273">        discountLabel.setText(formatCurrency(discount) + &quot; تومان&quot;);</span>
        
<span class="fc" id="L275">        double total = subtotal + deliveryFee - discount;</span>
<span class="fc" id="L276">        totalAmountLabel.setText(formatCurrency(total) + &quot; تومان&quot;);</span>
<span class="fc" id="L277">    }</span>

    /**
     * Update payment section visibility based on selected method
     */
    private void updatePaymentSectionVisibility() {
        // Hide all sections first
<span class="fc" id="L284">        cardPaymentSection.setVisible(false);</span>
<span class="fc" id="L285">        walletPaymentSection.setVisible(false);</span>
<span class="fc" id="L286">        codPaymentSection.setVisible(true); // Default visible</span>
        
<span class="fc" id="L288">        RadioButton selected = (RadioButton) paymentMethodGroup.getSelectedToggle();</span>
<span class="pc bpc" id="L289" title="1 of 2 branches missed.">        if (selected != null) {</span>
<span class="pc bpc" id="L290" title="1 of 2 branches missed.">            if (selected == cardPaymentRadio) {</span>
<span class="nc" id="L291">                cardPaymentSection.setVisible(true);</span>
<span class="nc" id="L292">                codPaymentSection.setVisible(false);</span>
<span class="pc bpc" id="L293" title="1 of 2 branches missed.">            } else if (selected == walletPaymentRadio) {</span>
<span class="nc" id="L294">                walletPaymentSection.setVisible(true);</span>
<span class="nc" id="L295">                codPaymentSection.setVisible(false);</span>
<span class="nc" id="L296">                updateWalletDisplay();</span>
            }
            // COD is visible by default
        }
<span class="fc" id="L300">    }</span>

    /**
     * Update wallet display
     */
    private void updateWalletDisplay() {
<span class="nc" id="L306">        walletBalanceLabel.setText(formatCurrency(walletBalance) + &quot; تومان&quot;);</span>
        
<span class="nc" id="L308">        double total = subtotal + deliveryFee - discount;</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">        if (walletBalance &gt;= total) {</span>
<span class="nc" id="L310">            walletStatusLabel.setText(&quot;موجودی کافی برای پرداخت&quot;);</span>
<span class="nc" id="L311">            walletStatusLabel.setStyle(&quot;-fx-text-fill: #28a745;&quot;);</span>
<span class="nc" id="L312">        } else {</span>
<span class="nc" id="L313">            walletStatusLabel.setText(&quot;موجودی ناکافی - نیاز به شارژ: &quot; + </span>
<span class="nc" id="L314">                                    formatCurrency(total - walletBalance) + &quot; تومان&quot;);</span>
<span class="nc" id="L315">            walletStatusLabel.setStyle(&quot;-fx-text-fill: #dc3545;&quot;);</span>
        }
<span class="nc" id="L317">    }</span>

    /**
     * Validate payment form based on selected method
     */
    private void validatePaymentForm() {
<span class="nc" id="L323">        boolean isValid = false;</span>
        
<span class="nc" id="L325">        RadioButton selected = (RadioButton) paymentMethodGroup.getSelectedToggle();</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">        if (selected != null) {</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">            if (selected == cardPaymentRadio) {</span>
<span class="nc" id="L328">                isValid = validateCardPayment();</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">            } else if (selected == walletPaymentRadio) {</span>
<span class="nc" id="L330">                isValid = validateWalletPayment();</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">            } else if (selected == codPaymentRadio) {</span>
<span class="nc" id="L332">                isValid = true; // COD is always valid</span>
            }
        }
        
<span class="nc bnc" id="L336" title="All 2 branches missed.">        confirmPaymentButton.setDisable(!isValid);</span>
<span class="nc" id="L337">    }</span>

    /**
     * Validate card payment form
     */
    private boolean validateCardPayment() {
<span class="nc" id="L343">        String cardNumber = cardNumberField.getText().replaceAll(&quot;-&quot;, &quot;&quot;);</span>
<span class="nc" id="L344">        String holderName = cardHolderNameField.getText().trim();</span>
<span class="nc" id="L345">        String month = cardExpiryMonthField.getText().trim();</span>
<span class="nc" id="L346">        String year = cardExpiryYearField.getText().trim();</span>
<span class="nc" id="L347">        String cvv = cardCvvField.getText().trim();</span>
        
<span class="nc bnc" id="L349" title="All 4 branches missed.">        return cardNumber.length() == 16 &amp;&amp; </span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">               !holderName.isEmpty() &amp;&amp; </span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">               month.length() == 2 &amp;&amp; </span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">               year.length() == 4 &amp;&amp; </span>
<span class="nc" id="L353">               cvv.length() &gt;= 3;</span>
    }

    /**
     * Validate wallet payment
     */
    private boolean validateWalletPayment() {
<span class="nc" id="L360">        double total = subtotal + deliveryFee - discount;</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">        return walletBalance &gt;= total;</span>
    }

    /**
     * Format currency value
     */
    private String formatCurrency(double amount) {
<span class="fc" id="L368">        return currencyFormat.format(amount);</span>
    }

    // ==================== EVENT HANDLERS ====================

    /**
     * Handle refresh wallet balance
     */
    @FXML
    private void handleRefreshWallet() {
<span class="nc" id="L378">        setLoading(true);</span>
<span class="nc" id="L379">        setStatus(&quot;در حال بروزرسانی موجودی کیف پول...&quot;);</span>
        
        // Mock refresh operation
<span class="nc" id="L382">        Task&lt;Double&gt; refreshTask = new Task&lt;Double&gt;() {</span>
            @Override
            protected Double call() throws Exception {
<span class="nc" id="L385">                Thread.sleep(1500); // Simulate API call</span>
<span class="nc" id="L386">                return 85000.0; // Mock updated balance</span>
            }
        };
        
<span class="nc" id="L390">        refreshTask.setOnSucceeded(e -&gt; Platform.runLater(() -&gt; {</span>
<span class="nc" id="L391">            setLoading(false);</span>
<span class="nc" id="L392">            walletBalance = refreshTask.getValue();</span>
<span class="nc" id="L393">            updateWalletDisplay();</span>
<span class="nc" id="L394">            validatePaymentForm();</span>
<span class="nc" id="L395">            setStatus(&quot;موجودی کیف پول بروزرسانی شد&quot;);</span>
<span class="nc" id="L396">        }));</span>
        
<span class="nc" id="L398">        refreshTask.setOnFailed(e -&gt; Platform.runLater(() -&gt; {</span>
<span class="nc" id="L399">            setLoading(false);</span>
<span class="nc" id="L400">            setStatus(&quot;خطا در بروزرسانی موجودی&quot;);</span>
<span class="nc" id="L401">        }));</span>
        
<span class="nc" id="L403">        new Thread(refreshTask).start();</span>
<span class="nc" id="L404">    }</span>

    /**
     * Handle confirm payment
     */
    @FXML
    private void handleConfirmPayment() {
<span class="nc" id="L411">        RadioButton selected = (RadioButton) paymentMethodGroup.getSelectedToggle();</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">        if (selected == null) {</span>
<span class="nc" id="L413">            showError(&quot;خطا&quot;, &quot;لطفاً روش پرداخت را انتخاب کنید&quot;);</span>
<span class="nc" id="L414">            return;</span>
        }
        
<span class="nc" id="L417">        setLoading(true);</span>
<span class="nc" id="L418">        setStatus(&quot;در حال پردازش پرداخت...&quot;);</span>
        
<span class="nc" id="L420">        Task&lt;String&gt; paymentTask = new Task&lt;String&gt;() {</span>
            @Override
            protected String call() throws Exception {
<span class="nc" id="L423">                Thread.sleep(3000); // Simulate payment processing</span>
                
<span class="nc bnc" id="L425" title="All 2 branches missed.">                if (selected == cardPaymentRadio) {</span>
<span class="nc" id="L426">                    return processCardPayment();</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">                } else if (selected == walletPaymentRadio) {</span>
<span class="nc" id="L428">                    return processWalletPayment();</span>
                } else {
<span class="nc" id="L430">                    return processCODPayment();</span>
                }
            }
        };
        
<span class="nc" id="L435">        paymentTask.setOnSucceeded(e -&gt; Platform.runLater(() -&gt; {</span>
<span class="nc" id="L436">            setLoading(false);</span>
<span class="nc" id="L437">            String result = paymentTask.getValue();</span>
<span class="nc" id="L438">            setStatus(&quot;پرداخت موفق&quot;);</span>
            
<span class="nc" id="L440">            Alert successAlert = new Alert(Alert.AlertType.INFORMATION);</span>
<span class="nc" id="L441">            successAlert.setTitle(&quot;پرداخت موفق&quot;);</span>
<span class="nc" id="L442">            successAlert.setHeaderText(&quot;سفارش شما با موفقیت ثبت شد!&quot;);</span>
<span class="nc" id="L443">            successAlert.setContentText(result);</span>
            
<span class="nc" id="L445">            successAlert.showAndWait().ifPresent(response -&gt; {</span>
                // Navigate to order history or main page
<span class="nc" id="L447">                navigationController.navigateTo(NavigationController.ORDER_HISTORY_SCENE);</span>
<span class="nc" id="L448">            });</span>
<span class="nc" id="L449">        }));</span>
        
<span class="nc" id="L451">        paymentTask.setOnFailed(e -&gt; Platform.runLater(() -&gt; {</span>
<span class="nc" id="L452">            setLoading(false);</span>
<span class="nc" id="L453">            setStatus(&quot;خطا در پرداخت&quot;);</span>
<span class="nc" id="L454">            showError(&quot;خطا در پرداخت&quot;, paymentTask.getException().getMessage());</span>
<span class="nc" id="L455">        }));</span>
        
<span class="nc" id="L457">        new Thread(paymentTask).start();</span>
<span class="nc" id="L458">    }</span>

    /**
     * Process card payment
     */
    private String processCardPayment() throws Exception {
        // Mock card payment processing
<span class="nc" id="L465">        String cardNumber = cardNumberField.getText();</span>
<span class="nc" id="L466">        String lastFourDigits = cardNumber.substring(cardNumber.length() - 4);</span>
        
        // Simulate potential failure
<span class="nc bnc" id="L469" title="All 2 branches missed.">        if (cardNumber.contains(&quot;0000&quot;)) {</span>
<span class="nc" id="L470">            throw new Exception(&quot;کارت بانکی نامعتبر است&quot;);</span>
        }
        
<span class="nc" id="L473">        return &quot;پرداخت با کارت ****&quot; + lastFourDigits + &quot; انجام شد.\n&quot; +</span>
<span class="nc" id="L474">               &quot;شماره پیگیری: &quot; + generateTrackingNumber() + &quot;\n&quot; +</span>
               &quot;سفارش شما تا 45 دقیقه آینده تحویل داده خواهد شد.&quot;;
    }

    /**
     * Process wallet payment
     */
    private String processWalletPayment() throws Exception {
<span class="nc" id="L482">        double total = subtotal + deliveryFee - discount;</span>
        
<span class="nc bnc" id="L484" title="All 2 branches missed.">        if (walletBalance &lt; total) {</span>
<span class="nc" id="L485">            throw new Exception(&quot;موجودی کیف پول کافی نیست&quot;);</span>
        }
        
        // Deduct from wallet balance
<span class="nc" id="L489">        walletBalance -= total;</span>
        
<span class="nc" id="L491">        return &quot;پرداخت از کیف پول انجام شد.\n&quot; +</span>
<span class="nc" id="L492">               &quot;مبلغ پرداخت شده: &quot; + formatCurrency(total) + &quot; تومان\n&quot; +</span>
<span class="nc" id="L493">               &quot;موجودی باقی‌مانده: &quot; + formatCurrency(walletBalance) + &quot; تومان\n&quot; +</span>
<span class="nc" id="L494">               &quot;شماره پیگیری: &quot; + generateTrackingNumber();</span>
    }

    /**
     * Process COD payment
     */
    private String processCODPayment() {
<span class="nc" id="L501">        double total = subtotal + deliveryFee - discount;</span>
        
<span class="nc" id="L503">        return &quot;سفارش شما ثبت شد و پرداخت در محل انجام خواهد شد.\n&quot; +</span>
<span class="nc" id="L504">               &quot;مبلغ قابل پرداخت: &quot; + formatCurrency(total) + &quot; تومان\n&quot; +</span>
<span class="nc" id="L505">               &quot;شماره سفارش: &quot; + generateTrackingNumber() + &quot;\n&quot; +</span>
               &quot;لطفاً مبلغ دقیق آماده داشته باشید.&quot;;
    }

    /**
     * Generate random tracking number
     */
    private String generateTrackingNumber() {
<span class="nc" id="L513">        return &quot;FO&quot; + System.currentTimeMillis() % 1000000;</span>
    }

    /**
     * Handle back to cart
     */
    @FXML
    private void handleBackToCart() {
<span class="nc" id="L521">        navigationController.navigateTo(NavigationController.CART_SCENE);</span>
<span class="nc" id="L522">    }</span>

    /**
     * Handle profile navigation
     */
    @FXML
    private void handleProfile() {
<span class="nc" id="L529">        navigationController.navigateTo(NavigationController.PROFILE_SCENE);</span>
<span class="nc" id="L530">    }</span>

    /**
     * Handle order history navigation
     */
    @FXML
    private void handleOrderHistory() {
<span class="nc" id="L537">        navigationController.navigateTo(NavigationController.ORDER_HISTORY_SCENE);</span>
<span class="nc" id="L538">    }</span>

    /**
     * Handle logout
     */
    @FXML
    private void handleLogout() {
<span class="nc" id="L545">        Alert confirmAlert = new Alert(Alert.AlertType.CONFIRMATION);</span>
<span class="nc" id="L546">        confirmAlert.setTitle(&quot;تأیید خروج&quot;);</span>
<span class="nc" id="L547">        confirmAlert.setHeaderText(&quot;آیا مطمئن هستید؟&quot;);</span>
<span class="nc" id="L548">        confirmAlert.setContentText(&quot;آیا می‌خواهید از حساب کاربری خود خارج شوید؟&quot;);</span>
        
<span class="nc" id="L550">        confirmAlert.showAndWait().ifPresent(response -&gt; {</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">            if (response == ButtonType.OK) {</span>
<span class="nc" id="L552">                navigationController.logout();</span>
            }
<span class="nc" id="L554">        });</span>
<span class="nc" id="L555">    }</span>

    // ==================== UTILITY METHODS ====================

    /**
     * Set loading state
     */
    private void setLoading(boolean loading) {
<span class="nc" id="L563">        loadingIndicator.setVisible(loading);</span>
<span class="nc" id="L564">        confirmPaymentButton.setDisable(loading);</span>
<span class="nc" id="L565">        refreshWalletButton.setDisable(loading);</span>
<span class="nc" id="L566">    }</span>

    /**
     * Set status message
     */
    private void setStatus(String message) {
<span class="pc bpc" id="L572" title="1 of 2 branches missed.">        if (statusLabel != null) {</span>
<span class="fc" id="L573">            statusLabel.setText(message);</span>
        }
<span class="fc" id="L575">    }</span>

    /**
     * Show error dialog
     */
    private void showError(String title, String message) {
<span class="nc" id="L581">        Alert alert = new Alert(Alert.AlertType.ERROR);</span>
<span class="nc" id="L582">        alert.setTitle(title);</span>
<span class="nc" id="L583">        alert.setHeaderText(null);</span>
<span class="nc" id="L584">        alert.setContentText(message);</span>
<span class="nc" id="L585">        alert.showAndWait();</span>
<span class="nc" id="L586">    }</span>

    // ==================== DATA MODEL ====================

    /**
     * Order item data model
     */
    public static class OrderItem {
        private String name;
        private double price;
        private int quantity;
        private String restaurantName;

<span class="fc" id="L599">        public OrderItem(String name, double price, int quantity, String restaurantName) {</span>
<span class="fc" id="L600">            this.name = name;</span>
<span class="fc" id="L601">            this.price = price;</span>
<span class="fc" id="L602">            this.quantity = quantity;</span>
<span class="fc" id="L603">            this.restaurantName = restaurantName;</span>
<span class="fc" id="L604">        }</span>

        // Getters
<span class="fc" id="L607">        public String getName() { return name; }</span>
<span class="fc" id="L608">        public double getPrice() { return price; }</span>
<span class="fc" id="L609">        public int getQuantity() { return quantity; }</span>
<span class="fc" id="L610">        public String getRestaurantName() { return restaurantName; }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>