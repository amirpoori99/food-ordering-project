<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MenuManagementController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Food Ordering Frontend</a> &gt; <a href="index.source.html" class="el_package">com.myapp.ui.menu</a> &gt; <span class="el_source">MenuManagementController.java</span></div><h1>MenuManagementController.java</h1><pre class="source lang-java linenums">package com.myapp.ui.menu;

import com.myapp.ui.common.HttpClientUtil;
import com.myapp.ui.common.NavigationController;
import com.myapp.ui.common.NotificationService;
import com.fasterxml.jackson.databind.JsonNode;
import javafx.application.Platform;
import javafx.concurrent.Task;
import javafx.fxml.FXML;
import javafx.fxml.Initializable;
import javafx.scene.control.*;
import javafx.scene.layout.VBox;

import java.io.IOException;
import java.net.URL;
import java.util.ArrayList;
import java.util.List;
import java.util.ResourceBundle;

/**
 * کنترلر مدیریت منوی رستوران
 * 
 * این کلاس مسئول مدیریت منوی رستوران توسط صاحب رستوران شامل:
 * - مدیریت دسته‌های منو (ایجاد، ویرایش، حذف)
 * - مدیریت آیتم‌های منو در هر دسته
 * - مرتب‌سازی و تنظیم ترتیب نمایش
 * - فعال/غیرفعال کردن دسته‌ها و آیتم‌ها
 * - پیش‌نمایش و انتشار منو
 * 
 * ویژگی‌ها:
 * - رابط کاربری درختی برای نمایش ساختار منو
 * - فرم‌های ویرایش تعاملی
 * - جستجو و فیلتر در منو
 * - آمار و گزارش‌گیری از منو
 * - خروجی PDF از منو
 * 
 * @author Food Ordering System Team
 * @version 1.0
 * @since 2024
 */
<span class="fc" id="L41">public class MenuManagementController implements Initializable {</span>

    // UI Components - Header
    @FXML private Button backButton;
    @FXML private Button addCategoryButton;
    @FXML private Button reorderMenuButton;
    @FXML private TextField searchMenuField;
    @FXML private ComboBox&lt;String&gt; menuViewComboBox;
    @FXML private Button refreshMenuButton;

    // UI Components - Menu Tree
    @FXML private VBox menuTreeContainer;
    @FXML private Button expandCategory1;
    @FXML private Button expandCategory2;
    @FXML private Button editCategory1;
    @FXML private Button editCategory2;
    @FXML private Button deleteCategory1;
    @FXML private Button deleteCategory2;
    @FXML private VBox category1Items;
    @FXML private VBox category2Items;
    @FXML private Button addNewCategoryButton;

    // UI Components - Category Form
    @FXML private Label detailsTitleLabel;
    @FXML private VBox categoryFormContainer;
    @FXML private TextField categoryNameField;
    @FXML private ComboBox&lt;String&gt; categoryIconComboBox;
    @FXML private TextArea categoryDescriptionArea;
    @FXML private TextField categoryOrderField;
    @FXML private CheckBox categoryActiveCheckBox;

    // UI Components - Category Items
    @FXML private Button addItemToCategoryButton;
    @FXML private VBox categoryItemsList;
    @FXML private Button moveUpItem1;
    @FXML private Button moveDownItem1;
    @FXML private Button removeFromCategoryButton1;
    @FXML private VBox emptyCategoryMessage;

    // UI Components - Category Actions
    @FXML private Button deleteCategoryButton;
    @FXML private Button clearCategoryFormButton;
    @FXML private Button saveCategoryButton;

    // UI Components - Statistics
    @FXML private Label totalCategoriesLabel;
    @FXML private Label totalItemsLabel;
    @FXML private Label activeItemsInMenuLabel;
    @FXML private Label lastMenuUpdateLabel;

    // UI Components - Menu Actions
    @FXML private Button previewMenuButton;
    @FXML private Button exportMenuButton;
    @FXML private Button publishMenuButton;

    // Services
    private NavigationController navigationController;
    private NotificationService notificationService;

    // Data
<span class="fc" id="L101">    private List&lt;MenuCategory&gt; menuCategories = new ArrayList&lt;&gt;();</span>
    private MenuCategory selectedCategory;
    private Long restaurantId;

    @Override
    public void initialize(URL location, ResourceBundle resources) {
<span class="nc" id="L107">        this.navigationController = NavigationController.getInstance();</span>
<span class="nc" id="L108">        this.notificationService = NotificationService.getInstance();</span>
        
<span class="nc" id="L110">        setupUI();</span>
<span class="nc" id="L111">        loadMenuData();</span>
<span class="nc" id="L112">    }</span>

    /**
     * راه‌اندازی اولیه UI components
     */
    private void setupUI() {
        // راه‌اندازی فیلد جستجو
<span class="nc" id="L119">        searchMenuField.textProperty().addListener((obs, oldText, newText) -&gt; {</span>
<span class="nc" id="L120">            filterMenuCategories(newText.trim());</span>
<span class="nc" id="L121">        });</span>
        
        // راه‌اندازی ComboBox نمایش
<span class="nc" id="L124">        menuViewComboBox.setOnAction(e -&gt; updateMenuView());</span>
        
        // وضعیت اولیه فرم
<span class="nc" id="L127">        clearCategoryForm();</span>
<span class="nc" id="L128">    }</span>

    /**
     * بارگذاری داده‌های منو از backend
     */
    private void loadMenuData() {
        // دریافت restaurant ID از session یا navigation
<span class="nc" id="L135">        this.restaurantId = getCurrentRestaurantId();</span>
        
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (restaurantId == null) {</span>
<span class="nc" id="L138">            notificationService.showError(&quot;شناسه رستوران مشخص نشده است&quot;);</span>
<span class="nc" id="L139">            return;</span>
        }
        
<span class="nc" id="L142">        Task&lt;List&lt;MenuCategory&gt;&gt; loadTask = new Task&lt;List&lt;MenuCategory&gt;&gt;() {</span>
            @Override
            protected List&lt;MenuCategory&gt; call() throws Exception {
<span class="nc" id="L145">                HttpClientUtil.ApiResponse response = HttpClientUtil.get(&quot;/restaurants/&quot; + restaurantId + &quot;/menu&quot;);</span>
                
<span class="nc bnc" id="L147" title="All 4 branches missed.">                if (response.isSuccess() &amp;&amp; response.getData() != null) {</span>
<span class="nc" id="L148">                    List&lt;MenuCategory&gt; categories = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L149">                    JsonNode dataArray = response.getData();</span>
                    
<span class="nc bnc" id="L151" title="All 2 branches missed.">                    if (dataArray.isArray()) {</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">                        for (JsonNode categoryNode : dataArray) {</span>
<span class="nc" id="L153">                            MenuCategory category = parseMenuCategory(categoryNode);</span>
<span class="nc" id="L154">                            categories.add(category);</span>
<span class="nc" id="L155">                        }</span>
                    }
                    
<span class="nc" id="L158">                    return categories;</span>
                } else {
<span class="nc bnc" id="L160" title="All 2 branches missed.">                    throw new RuntimeException(response.getMessage() != null ? </span>
<span class="nc" id="L161">                                               response.getMessage() : &quot;خطا در بارگذاری منو&quot;);</span>
                }
            }
        };
        
<span class="nc" id="L166">        loadTask.setOnSucceeded(e -&gt; {</span>
<span class="nc" id="L167">            Platform.runLater(() -&gt; {</span>
<span class="nc" id="L168">                menuCategories = loadTask.getValue();</span>
<span class="nc" id="L169">                updateMenuDisplay();</span>
<span class="nc" id="L170">                updateStatistics();</span>
<span class="nc" id="L171">            });</span>
<span class="nc" id="L172">        });</span>
        
<span class="nc" id="L174">        loadTask.setOnFailed(e -&gt; {</span>
<span class="nc" id="L175">            Platform.runLater(() -&gt; {</span>
<span class="nc" id="L176">                Throwable exception = loadTask.getException();</span>
<span class="nc" id="L177">                String errorMessage = &quot;خطا در بارگذاری منو&quot;;</span>
<span class="nc bnc" id="L178" title="All 4 branches missed.">                if (exception != null &amp;&amp; exception.getMessage() != null) {</span>
<span class="nc" id="L179">                    errorMessage = exception.getMessage();</span>
                }
<span class="nc" id="L181">                notificationService.showError(errorMessage);</span>
<span class="nc" id="L182">            });</span>
<span class="nc" id="L183">        });</span>
        
<span class="nc" id="L185">        Thread loadThread = new Thread(loadTask);</span>
<span class="nc" id="L186">        loadThread.setDaemon(true);</span>
<span class="nc" id="L187">        loadThread.start();</span>
<span class="nc" id="L188">    }</span>

    /**
     * به‌روزرسانی نمایش منو
     */
    private void updateMenuDisplay() {
        // پیاده‌سازی نمایش دسته‌ها در tree container
        // این بخش برای سادگی در فازهای بعدی تکمیل می‌شود
<span class="nc" id="L196">    }</span>

    /**
     * به‌روزرسانی آمار منو
     */
    private void updateStatistics() {
<span class="nc" id="L202">        int totalCategories = menuCategories.size();</span>
<span class="nc" id="L203">        int totalItems = menuCategories.stream()</span>
<span class="nc" id="L204">            .mapToInt(cat -&gt; cat.getItems().size())</span>
<span class="nc" id="L205">            .sum();</span>
<span class="nc" id="L206">        int activeItems = menuCategories.stream()</span>
<span class="nc" id="L207">            .mapToInt(cat -&gt; (int) cat.getItems().stream()</span>
<span class="nc" id="L208">                .filter(item -&gt; item.isActive())</span>
<span class="nc" id="L209">                .count())</span>
<span class="nc" id="L210">            .sum();</span>
        
<span class="nc" id="L212">        Platform.runLater(() -&gt; {</span>
<span class="nc" id="L213">            totalCategoriesLabel.setText(&quot;مجموع دسته‌ها: &quot; + totalCategories);</span>
<span class="nc" id="L214">            totalItemsLabel.setText(&quot;مجموع آیتم‌ها: &quot; + totalItems);</span>
<span class="nc" id="L215">            activeItemsInMenuLabel.setText(&quot;آیتم‌های فعال: &quot; + activeItems);</span>
<span class="nc" id="L216">            lastMenuUpdateLabel.setText(&quot;آخرین بروزرسانی: اکنون&quot;);</span>
<span class="nc" id="L217">        });</span>
<span class="nc" id="L218">    }</span>

    /**
     * فیلتر دسته‌های منو بر اساس متن جستجو
     */
    private void filterMenuCategories(String searchText) {
        // پیاده‌سازی فیلتر در فازهای بعدی
<span class="nc" id="L225">    }</span>

    /**
     * تغییر نمای منو
     */
    private void updateMenuView() {
<span class="nc" id="L231">        String selectedView = menuViewComboBox.getValue();</span>
        // پیاده‌سازی تغییر نما در فازهای بعدی
<span class="nc" id="L233">    }</span>

    // ==================== EVENT HANDLERS ====================

    /**
     * بازگشت به صفحه قبل
     */
    @FXML
    private void handleBack() {
<span class="nc" id="L242">        navigationController.navigateTo(NavigationController.RESTAURANT_LIST_SCENE);</span>
<span class="nc" id="L243">    }</span>

    /**
     * افزودن دسته جدید
     */
    @FXML
    private void handleAddCategory() {
<span class="nc" id="L250">        clearCategoryForm();</span>
<span class="nc" id="L251">        detailsTitleLabel.setText(&quot;دسته جدید&quot;);</span>
<span class="nc" id="L252">        categoryFormContainer.setVisible(true);</span>
<span class="nc" id="L253">        categoryFormContainer.setManaged(true);</span>
<span class="nc" id="L254">    }</span>

    /**
     * مرتب‌سازی منو
     */
    @FXML
    private void handleReorderMenu() {
<span class="nc" id="L261">        notificationService.showInfo(&quot;قابلیت مرتب‌سازی در حال توسعه است&quot;);</span>
<span class="nc" id="L262">    }</span>

    /**
     * بروزرسانی منو
     */
    @FXML
    private void handleRefreshMenu() {
<span class="nc" id="L269">        loadMenuData();</span>
<span class="nc" id="L270">    }</span>

    /**
     * گسترش/جمع کردن دسته
     */
    @FXML
    private void handleExpandCategory() {
        // پیاده‌سازی expand/collapse در فازهای بعدی
<span class="nc" id="L278">    }</span>

    /**
     * ویرایش دسته
     */
    @FXML
    private void handleEditCategory() {
        // پیاده‌سازی ویرایش دسته در فازهای بعدی
<span class="nc" id="L286">    }</span>

    /**
     * حذف دسته
     */
    @FXML
    private void handleDeleteCategory() {
        // پیاده‌سازی حذف دسته در فازهای بعدی
<span class="nc" id="L294">    }</span>

    /**
     * افزودن دسته جدید از دکمه پایینی
     */
    @FXML
    private void handleAddNewCategory() {
<span class="nc" id="L301">        handleAddCategory();</span>
<span class="nc" id="L302">    }</span>

    /**
     * افزودن آیتم به دسته
     */
    @FXML
    private void handleAddItemToCategory() {
<span class="nc bnc" id="L309" title="All 2 branches missed.">        if (selectedCategory == null) {</span>
<span class="nc" id="L310">            notificationService.showWarning(&quot;لطفاً ابتدا دسته‌ای را انتخاب کنید&quot;);</span>
<span class="nc" id="L311">            return;</span>
        }
        
        // پیاده‌سازی افزودن آیتم در فازهای بعدی
<span class="nc" id="L315">        notificationService.showInfo(&quot;قابلیت افزودن آیتم در حال توسعه است&quot;);</span>
<span class="nc" id="L316">    }</span>

    /**
     * انتقال آیتم به بالا
     */
    @FXML
    private void handleMoveItemUp() {
        // پیاده‌سازی انتقال آیتم در فازهای بعدی
<span class="nc" id="L324">    }</span>

    /**
     * انتقال آیتم به پایین
     */
    @FXML
    private void handleMoveItemDown() {
        // پیاده‌سازی انتقال آیتم در فازهای بعدی
<span class="nc" id="L332">    }</span>

    /**
     * حذف آیتم از دسته
     */
    @FXML
    private void handleRemoveFromCategory() {
        // پیاده‌سازی حذف آیتم در فازهای بعدی
<span class="nc" id="L340">    }</span>

    /**
     * حذف دسته از فرم
     */
    @FXML
    private void handleDeleteCategoryForm() {
<span class="nc bnc" id="L347" title="All 2 branches missed.">        if (selectedCategory == null) {</span>
<span class="nc" id="L348">            notificationService.showWarning(&quot;هیچ دسته‌ای برای حذف انتخاب نشده است&quot;);</span>
<span class="nc" id="L349">            return;</span>
        }
        
<span class="nc" id="L352">        Alert confirmAlert = new Alert(Alert.AlertType.CONFIRMATION);</span>
<span class="nc" id="L353">        confirmAlert.setTitle(&quot;تأیید حذف&quot;);</span>
<span class="nc" id="L354">        confirmAlert.setHeaderText(&quot;حذف دسته&quot;);</span>
<span class="nc" id="L355">        confirmAlert.setContentText(&quot;آیا مطمئن هستید که می‌خواهید این دسته را حذف کنید؟&quot;);</span>
        
<span class="nc" id="L357">        confirmAlert.showAndWait().ifPresent(response -&gt; {</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">            if (response == ButtonType.OK) {</span>
<span class="nc" id="L359">                deleteCategoryFromServer();</span>
            }
<span class="nc" id="L361">        });</span>
<span class="nc" id="L362">    }</span>

    /**
     * پاک کردن فرم دسته
     */
    @FXML
    private void handleClearCategoryForm() {
<span class="nc" id="L369">        clearCategoryForm();</span>
<span class="nc" id="L370">    }</span>

    /**
     * ذخیره دسته
     */
    @FXML
    private void handleSaveCategory() {
<span class="nc bnc" id="L377" title="All 2 branches missed.">        if (!validateCategoryForm()) {</span>
<span class="nc" id="L378">            return;</span>
        }
        
<span class="nc" id="L381">        MenuCategory category = createCategoryFromForm();</span>
<span class="nc" id="L382">        saveCategoryToServer(category);</span>
<span class="nc" id="L383">    }</span>

    /**
     * پیش‌نمایش منو
     */
    @FXML
    private void handlePreviewMenu() {
<span class="nc" id="L390">        notificationService.showInfo(&quot;قابلیت پیش‌نمایش در حال توسعه است&quot;);</span>
<span class="nc" id="L391">    }</span>

    /**
     * خروجی PDF منو
     */
    @FXML
    private void handleExportMenu() {
<span class="nc" id="L398">        notificationService.showInfo(&quot;قابلیت خروجی PDF در حال توسعه است&quot;);</span>
<span class="nc" id="L399">    }</span>

    /**
     * انتشار منو
     */
    @FXML
    private void handlePublishMenu() {
<span class="nc" id="L406">        Alert confirmAlert = new Alert(Alert.AlertType.CONFIRMATION);</span>
<span class="nc" id="L407">        confirmAlert.setTitle(&quot;تأیید انتشار&quot;);</span>
<span class="nc" id="L408">        confirmAlert.setHeaderText(&quot;انتشار منو&quot;);</span>
<span class="nc" id="L409">        confirmAlert.setContentText(&quot;آیا مطمئن هستید که می‌خواهید منو را منتشر کنید؟&quot;);</span>
        
<span class="nc" id="L411">        confirmAlert.showAndWait().ifPresent(response -&gt; {</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">            if (response == ButtonType.OK) {</span>
<span class="nc" id="L413">                publishMenuToServer();</span>
            }
<span class="nc" id="L415">        });</span>
<span class="nc" id="L416">    }</span>

    // ==================== HELPER METHODS ====================

    /**
     * پاک کردن فرم دسته
     */
    private void clearCategoryForm() {
<span class="nc" id="L424">        categoryNameField.clear();</span>
<span class="nc" id="L425">        categoryIconComboBox.setValue(null);</span>
<span class="nc" id="L426">        categoryDescriptionArea.clear();</span>
<span class="nc" id="L427">        categoryOrderField.clear();</span>
<span class="nc" id="L428">        categoryActiveCheckBox.setSelected(true);</span>
<span class="nc" id="L429">        selectedCategory = null;</span>
<span class="nc" id="L430">    }</span>

    /**
     * اعتبارسنجی فرم دسته
     */
    private boolean validateCategoryForm() {
<span class="nc bnc" id="L436" title="All 2 branches missed.">        if (categoryNameField.getText().trim().isEmpty()) {</span>
<span class="nc" id="L437">            notificationService.showWarning(&quot;نام دسته الزامی است&quot;);</span>
<span class="nc" id="L438">            categoryNameField.requestFocus();</span>
<span class="nc" id="L439">            return false;</span>
        }
        
<span class="nc" id="L442">        return true;</span>
    }

    /**
     * ایجاد category از اطلاعات فرم
     */
    private MenuCategory createCategoryFromForm() {
<span class="nc" id="L449">        MenuCategory category = new MenuCategory();</span>
<span class="nc" id="L450">        category.setName(categoryNameField.getText().trim());</span>
<span class="nc" id="L451">        category.setDescription(categoryDescriptionArea.getText().trim());</span>
<span class="nc" id="L452">        category.setActive(categoryActiveCheckBox.isSelected());</span>
        
        try {
<span class="nc bnc" id="L455" title="All 2 branches missed.">            if (!categoryOrderField.getText().trim().isEmpty()) {</span>
<span class="nc" id="L456">                category.setDisplayOrder(Integer.parseInt(categoryOrderField.getText().trim()));</span>
            }
<span class="nc" id="L458">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L459">            category.setDisplayOrder(1);</span>
<span class="nc" id="L460">        }</span>
        
<span class="nc" id="L462">        return category;</span>
    }

    /**
     * ذخیره دسته در server
     */
    private void saveCategoryToServer(MenuCategory category) {
<span class="nc" id="L469">        Task&lt;Void&gt; saveTask = new Task&lt;Void&gt;() {</span>
            @Override
            protected Void call() throws Exception {
<span class="nc" id="L472">                String endpoint = &quot;/restaurants/&quot; + restaurantId + &quot;/menu/categories&quot;;</span>
                HttpClientUtil.ApiResponse response;
                
<span class="nc bnc" id="L475" title="All 4 branches missed.">                if (selectedCategory != null &amp;&amp; selectedCategory.getId() != null) {</span>
                    // ویرایش دسته موجود
<span class="nc" id="L477">                    endpoint += &quot;/&quot; + selectedCategory.getId();</span>
<span class="nc" id="L478">                    response = HttpClientUtil.put(endpoint, category);</span>
                } else {
                    // ایجاد دسته جدید
<span class="nc" id="L481">                    response = HttpClientUtil.post(endpoint, category);</span>
                }
                
<span class="nc bnc" id="L484" title="All 2 branches missed.">                if (!response.isSuccess()) {</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">                    throw new RuntimeException(response.getMessage() != null ? </span>
<span class="nc" id="L486">                                               response.getMessage() : &quot;خطا در ذخیره دسته&quot;);</span>
                }
                
<span class="nc" id="L489">                return null;</span>
            }
        };
        
<span class="nc" id="L493">        saveTask.setOnSucceeded(e -&gt; {</span>
<span class="nc" id="L494">            Platform.runLater(() -&gt; {</span>
<span class="nc" id="L495">                notificationService.showSuccess(&quot;دسته با موفقیت ذخیره شد&quot;);</span>
<span class="nc" id="L496">                loadMenuData();</span>
<span class="nc" id="L497">                clearCategoryForm();</span>
<span class="nc" id="L498">            });</span>
<span class="nc" id="L499">        });</span>
        
<span class="nc" id="L501">        saveTask.setOnFailed(e -&gt; {</span>
<span class="nc" id="L502">            Platform.runLater(() -&gt; {</span>
<span class="nc" id="L503">                Throwable exception = saveTask.getException();</span>
<span class="nc" id="L504">                String errorMessage = &quot;خطا در ذخیره دسته&quot;;</span>
<span class="nc bnc" id="L505" title="All 4 branches missed.">                if (exception != null &amp;&amp; exception.getMessage() != null) {</span>
<span class="nc" id="L506">                    errorMessage = exception.getMessage();</span>
                }
<span class="nc" id="L508">                notificationService.showError(errorMessage);</span>
<span class="nc" id="L509">            });</span>
<span class="nc" id="L510">        });</span>
        
<span class="nc" id="L512">        Thread saveThread = new Thread(saveTask);</span>
<span class="nc" id="L513">        saveThread.setDaemon(true);</span>
<span class="nc" id="L514">        saveThread.start();</span>
<span class="nc" id="L515">    }</span>

    /**
     * حذف دسته از server
     */
    private void deleteCategoryFromServer() {
<span class="nc bnc" id="L521" title="All 4 branches missed.">        if (selectedCategory == null || selectedCategory.getId() == null) {</span>
<span class="nc" id="L522">            return;</span>
        }
        
<span class="nc" id="L525">        Task&lt;Void&gt; deleteTask = new Task&lt;Void&gt;() {</span>
            @Override
            protected Void call() throws Exception {
<span class="nc" id="L528">                String endpoint = &quot;/restaurants/&quot; + restaurantId + &quot;/menu/categories/&quot; + selectedCategory.getId();</span>
<span class="nc" id="L529">                HttpClientUtil.ApiResponse response = HttpClientUtil.delete(endpoint);</span>
                
<span class="nc bnc" id="L531" title="All 2 branches missed.">                if (!response.isSuccess()) {</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">                    throw new RuntimeException(response.getMessage() != null ? </span>
<span class="nc" id="L533">                                               response.getMessage() : &quot;خطا در حذف دسته&quot;);</span>
                }
                
<span class="nc" id="L536">                return null;</span>
            }
        };
        
<span class="nc" id="L540">        deleteTask.setOnSucceeded(e -&gt; {</span>
<span class="nc" id="L541">            Platform.runLater(() -&gt; {</span>
<span class="nc" id="L542">                notificationService.showSuccess(&quot;دسته با موفقیت حذف شد&quot;);</span>
<span class="nc" id="L543">                loadMenuData();</span>
<span class="nc" id="L544">                clearCategoryForm();</span>
<span class="nc" id="L545">            });</span>
<span class="nc" id="L546">        });</span>
        
<span class="nc" id="L548">        deleteTask.setOnFailed(e -&gt; {</span>
<span class="nc" id="L549">            Platform.runLater(() -&gt; {</span>
<span class="nc" id="L550">                Throwable exception = deleteTask.getException();</span>
<span class="nc" id="L551">                String errorMessage = &quot;خطا در حذف دسته&quot;;</span>
<span class="nc bnc" id="L552" title="All 4 branches missed.">                if (exception != null &amp;&amp; exception.getMessage() != null) {</span>
<span class="nc" id="L553">                    errorMessage = exception.getMessage();</span>
                }
<span class="nc" id="L555">                notificationService.showError(errorMessage);</span>
<span class="nc" id="L556">            });</span>
<span class="nc" id="L557">        });</span>
        
<span class="nc" id="L559">        Thread deleteThread = new Thread(deleteTask);</span>
<span class="nc" id="L560">        deleteThread.setDaemon(true);</span>
<span class="nc" id="L561">        deleteThread.start();</span>
<span class="nc" id="L562">    }</span>

    /**
     * انتشار منو در server
     */
    private void publishMenuToServer() {
<span class="nc" id="L568">        Task&lt;Void&gt; publishTask = new Task&lt;Void&gt;() {</span>
            @Override
            protected Void call() throws Exception {
<span class="nc" id="L571">                String endpoint = &quot;/restaurants/&quot; + restaurantId + &quot;/menu/publish&quot;;</span>
<span class="nc" id="L572">                HttpClientUtil.ApiResponse response = HttpClientUtil.post(endpoint, null);</span>
                
<span class="nc bnc" id="L574" title="All 2 branches missed.">                if (!response.isSuccess()) {</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">                    throw new RuntimeException(response.getMessage() != null ? </span>
<span class="nc" id="L576">                                               response.getMessage() : &quot;خطا در انتشار منو&quot;);</span>
                }
                
<span class="nc" id="L579">                return null;</span>
            }
        };
        
<span class="nc" id="L583">        publishTask.setOnSucceeded(e -&gt; {</span>
<span class="nc" id="L584">            Platform.runLater(() -&gt; {</span>
<span class="nc" id="L585">                notificationService.showSuccess(&quot;منو با موفقیت منتشر شد&quot;);</span>
<span class="nc" id="L586">                updateStatistics();</span>
<span class="nc" id="L587">            });</span>
<span class="nc" id="L588">        });</span>
        
<span class="nc" id="L590">        publishTask.setOnFailed(e -&gt; {</span>
<span class="nc" id="L591">            Platform.runLater(() -&gt; {</span>
<span class="nc" id="L592">                Throwable exception = publishTask.getException();</span>
<span class="nc" id="L593">                String errorMessage = &quot;خطا در انتشار منو&quot;;</span>
<span class="nc bnc" id="L594" title="All 4 branches missed.">                if (exception != null &amp;&amp; exception.getMessage() != null) {</span>
<span class="nc" id="L595">                    errorMessage = exception.getMessage();</span>
                }
<span class="nc" id="L597">                notificationService.showError(errorMessage);</span>
<span class="nc" id="L598">            });</span>
<span class="nc" id="L599">        });</span>
        
<span class="nc" id="L601">        Thread publishThread = new Thread(publishTask);</span>
<span class="nc" id="L602">        publishThread.setDaemon(true);</span>
<span class="nc" id="L603">        publishThread.start();</span>
<span class="nc" id="L604">    }</span>

    /**
     * دریافت ID رستوران فعلی
     */
    private Long getCurrentRestaurantId() {
        // در عملی، این از session یا navigation parameter دریافت می‌شود
<span class="nc" id="L611">        return 1L; // مقدار موقت برای تست</span>
    }

    /**
     * Parse menu category از JSON
     */
    private MenuCategory parseMenuCategory(JsonNode node) {
<span class="nc" id="L618">        MenuCategory category = new MenuCategory();</span>
<span class="nc" id="L619">        category.setId(node.get(&quot;id&quot;).asLong());</span>
<span class="nc" id="L620">        category.setName(node.get(&quot;name&quot;).asText());</span>
<span class="nc" id="L621">        category.setDescription(node.get(&quot;description&quot;).asText(&quot;&quot;));</span>
<span class="nc" id="L622">        category.setActive(node.get(&quot;active&quot;).asBoolean(true));</span>
        
<span class="nc bnc" id="L624" title="All 2 branches missed.">        if (node.has(&quot;displayOrder&quot;)) {</span>
<span class="nc" id="L625">            category.setDisplayOrder(node.get(&quot;displayOrder&quot;).asInt(1));</span>
        }
        
<span class="nc" id="L628">        List&lt;MenuItem&gt; items = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L629" title="All 4 branches missed.">        if (node.has(&quot;items&quot;) &amp;&amp; node.get(&quot;items&quot;).isArray()) {</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">            for (JsonNode itemNode : node.get(&quot;items&quot;)) {</span>
<span class="nc" id="L631">                MenuItem item = parseMenuItem(itemNode);</span>
<span class="nc" id="L632">                items.add(item);</span>
<span class="nc" id="L633">            }</span>
        }
<span class="nc" id="L635">        category.setItems(items);</span>
        
<span class="nc" id="L637">        return category;</span>
    }

    /**
     * Parse menu item از JSON
     */
    private MenuItem parseMenuItem(JsonNode node) {
<span class="nc" id="L644">        MenuItem item = new MenuItem();</span>
<span class="nc" id="L645">        item.setId(node.get(&quot;id&quot;).asLong());</span>
<span class="nc" id="L646">        item.setName(node.get(&quot;name&quot;).asText());</span>
<span class="nc" id="L647">        item.setDescription(node.get(&quot;description&quot;).asText(&quot;&quot;));</span>
<span class="nc" id="L648">        item.setPrice(node.get(&quot;price&quot;).asDouble());</span>
<span class="nc" id="L649">        item.setActive(node.get(&quot;active&quot;).asBoolean(true));</span>
        
<span class="nc" id="L651">        return item;</span>
    }

    // ==================== DATA MODELS ====================

    /**
     * مدل داده دسته منو
     */
<span class="fc" id="L659">    public static class MenuCategory {</span>
        private Long id;
        private String name;
        private String description;
<span class="fc" id="L663">        private boolean active = true;</span>
<span class="fc" id="L664">        private int displayOrder = 1;</span>
<span class="fc" id="L665">        private List&lt;MenuItem&gt; items = new ArrayList&lt;&gt;();</span>

        // Getters and setters
<span class="fc" id="L668">        public Long getId() { return id; }</span>
<span class="fc" id="L669">        public void setId(Long id) { this.id = id; }</span>

<span class="fc" id="L671">        public String getName() { return name; }</span>
<span class="fc" id="L672">        public void setName(String name) { this.name = name; }</span>

<span class="fc" id="L674">        public String getDescription() { return description; }</span>
<span class="fc" id="L675">        public void setDescription(String description) { this.description = description; }</span>

<span class="fc" id="L677">        public boolean isActive() { return active; }</span>
<span class="fc" id="L678">        public void setActive(boolean active) { this.active = active; }</span>

<span class="fc" id="L680">        public int getDisplayOrder() { return displayOrder; }</span>
<span class="fc" id="L681">        public void setDisplayOrder(int displayOrder) { this.displayOrder = displayOrder; }</span>

<span class="fc" id="L683">        public List&lt;MenuItem&gt; getItems() { return items; }</span>
<span class="nc" id="L684">        public void setItems(List&lt;MenuItem&gt; items) { this.items = items; }</span>
    }

    /**
     * مدل داده آیتم منو
     */
<span class="fc" id="L690">    public static class MenuItem {</span>
        private Long id;
        private String name;
        private String description;
        private Double price;
<span class="fc" id="L695">        private boolean active = true;</span>

        // Getters and setters
<span class="fc" id="L698">        public Long getId() { return id; }</span>
<span class="fc" id="L699">        public void setId(Long id) { this.id = id; }</span>

<span class="fc" id="L701">        public String getName() { return name; }</span>
<span class="fc" id="L702">        public void setName(String name) { this.name = name; }</span>

<span class="fc" id="L704">        public String getDescription() { return description; }</span>
<span class="fc" id="L705">        public void setDescription(String description) { this.description = description; }</span>

<span class="fc" id="L707">        public Double getPrice() { return price; }</span>
<span class="fc" id="L708">        public void setPrice(Double price) { this.price = price; }</span>

<span class="fc" id="L710">        public boolean isActive() { return active; }</span>
<span class="fc" id="L711">        public void setActive(boolean active) { this.active = active; }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>